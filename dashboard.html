
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tharua Firm Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 230px;
  background-color: #2c3e50;
  color: white;
  padding-top: 20px;
  overflow-y: auto;
  transition: transform 0.3s ease;
}
.sidebar.collapsed {
  transform: translateX(-100%);
}
.sidebar h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 18px;
}
.sidebar a {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  color: white;
  text-decoration: none;
  transition: background 0.3s ease;
  font-size: 14px;
  cursor: pointer;
}
.main-content {
  margin-left: 230px;
  padding: 20px;
  transition: margin-left 0.3s ease;
}
.main-content.collapsed {
  margin-left: 0;
}
.toggle-btn {
  position: fixed; /* Changed to fixed to ensure visibility regardless of main-content position */
  top: 20px;
  left: 10px; /* Positioned on the left side of the screen when sidebar is collapsed */
  background-color: #2c3e50;
  color: white;
  padding: 4px;
  cursor: pointer;
  border: none;
  z-index: 2000; /* Increased z-index to ensure it’s above other elements */
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: transform 0.2s ease, background-color 0.2s ease;
  outline: 2px solid red; /* Temporary outline for debugging visibility */
}
.toggle-btn:hover {
  background-color: #34495e;
  transform: scale(1.1); /* Slightly enlarge on hover for visibility */
}
.toggle-btn i.rotate-90 {
  transform: rotate(90deg);
  transition: transform 0.3s ease;
}
.sidebar.collapsed ~ .main-content .toggle-btn {
  left: 10px; /* Ensure button stays visible when sidebar is collapsed */
}
    .content-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 8px; margin: 8px 0 16px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #2c3e50; color: white; cursor: pointer; }
    button:hover { background-color: #34495e; }
    .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; text-align: center; }
    .button-grid div { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: transform 0.2s ease; }
    .button-grid div:hover { transform: scale(1.05); }
    .button-grid img { width: 50px; height: 50px; margin-bottom: 10px; }
	.edit-input {
  width: 80px;
  padding: 4px;
}

.btn-edit, .btn-save, .btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-edit {
  background-color: #2980b9;
}
.btn-save {
  background-color: #27ae60;
}
.btn-cancel {
  background-color: #c0392b;
}
/* General styles */
.user-form {
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.user-form input,
.user-form select,
.user-form button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.submit-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  cursor: pointer;
  padding: 8px 16px;
}

.submit-btn:hover {
  background-color: #34495e;
}

.table-container {
  overflow-x: auto;
}

.users-table {
  width: 100%;
  border-collapse: collapse;
}

.users-table th,
.users-table td {
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
}

.users-table th {
  background-color: #eee;
}

/* Desktop mode (default) */
.desktop-cell {
  white-space: nowrap;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.desktop-actions {
  white-space: nowrap;
}

/* Mobile mode */
@media (max-width: 768px) {
  .form-group {
    flex-direction: column;
  }

  .user-form input,
  .user-form select,
  .user-form button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 16px;
  }

  .table-container {
    overflow-x: auto;
  }

  .users-table {
    min-width: 600px;
  }

  .desktop-cell {
    display: block;
    word-wrap: break-word;
    max-width: 120px;
    padding: 6px;
  }

  .desktop-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 5px;
  }

  .desktop-actions span {
    margin: 0 !important;
    font-size: 18px;
  }

  .edit-input {
    width: 100px;
    padding: 6px;
    font-size: 14px;
  }
}

/* Ensure buttons are tappable */
button {
  min-height: 40px;
  touch-action: manipulation;
}

/* Edit mode buttons */
.btn-save,
.btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-save {
  background-color: #27ae60;
}

.btn-cancel {
  background-color: #c0392b;
}

 <!-- Inline CSS -->
 
      .spinner {
        display: inline-block;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2c3e50;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .edit-input {
        width: 100%;
        padding: 4px;
        box-sizing: border-box;
      }
      .error-row {
        color: red;
        text-align: center;
      }
	  .actions-cell button {
  font-size: 10px;    /* tiny icons */
  padding: 2px 4px;   /* shrink button area */
  margin: 0 1px;
  line-height: 1;     /* keep buttons compact */
}


.loading-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  background: rgba(255, 255, 255, 0.9);
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.form-container {
  max-width: 600px;
  width: 90%;
  margin: 20px auto;
  padding: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.form-container h2 {
  color: #333;
  font-size: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
  font-size: 14px;
}

.form-group input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  box-sizing: border-box;
}

.form-group button {
  padding: 10px;
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.form-group button:hover {
  background: #2980b9;
}

#locationMessage {
  text-align: center;
  font-size: 14px;
}

.table-container {
  max-height: 400px;
  overflow-y: auto;
  width: 100%;
  position: relative;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.table-container table {
  width: 100%;
  border-collapse: collapse;
}

.table-container thead {
  position: sticky;
  top: 0;
  background: #f0f0f0;
  z-index: 1;
}

.table-container th, .table-container td {
  padding: 12px;
  border: 1px solid #ddd;
  font-size: 14px;
}

.table-container th {
  font-weight: 600;
  color: #333;
}

.pagination-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  font-size: 14px;
}

.pagination-section button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.pagination-section button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.pagination-section .prev-btn, .pagination-section .next-btn {
  background: #007bff;
  color: white;
}

.pagination-section .prev-btn:hover:not(:disabled), .pagination-section .next-btn:hover:not(:disabled) {
  background: #0056b3;
}

.pagination-section select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  position: relative;
}

.modal-content h2 {
  margin-top: 0;
  color: #333;
  font-size: 20px;
}

.modal-content p {
  font-size: 14px;
  color: #333;
  margin: 10px 0;
}

.modal-content .modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.modal-content button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.modal-content .btn-danger {
  background: #dc3545;
  color: white;
}

.modal-content .btn-danger:hover {
  background: #c82333;
}

.modal-content .btn-secondary {
  background: #6c757d;
  color: white;
}

.modal-content .btn-secondary:hover {
  background: #5a6268;
}

.modal-content .close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 20px;
  cursor: pointer;
  color: #333;
}

@media (max-width: 600px) {
  .form-container {
    width: 95%;
    padding: 15px;
  }
  .form-container h2 {
    font-size: 20px;
  }
  .form-group {
    flex-direction: column;
  }
  .form-group input {
    font-size: 12px;
    padding: 8px;
  }
  .form-group button {
    font-size: 14px;
    padding: 10px;
  }
  .table-container th, .table-container td {
    font-size: 12px;
    padding: 8px;
  }
  .pagination-section {
    flex-direction: column;
    gap: 10px;
  }
}

  </style>
</head>
<body>
<div class="sidebar" id="sidebar">
    <h2>THARUA</h2>
    <a onclick="showHome()"><i class="fas fa-home"></i> <span>Home</span></a>
    <div class="dropdown">
      <a onclick="toggleUserManagement()" id="userMgmtMenu"><i class="fas fa-users-cog"></i> <span>User Management</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="userMgmtSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showUsers()"><span>Users</span></a>
        <a onclick="showRoles()"><span>Roles</span></a>
        <a onclick="showFieldSales()"><span>Field Salespersons</span></a>
      </div>
    </div>
    <div class="dropdown">
      <a onclick="toggleContacts()" id="contactsMenu"><i class="fas fa-address-book"></i> <span>Contacts</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="contactsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showSuppliers()"><span>Suppliers</span></a>
        <a onclick="showCustomers()"><span>Customers</span></a>
        <a onclick="clearContent()"><span>Customer Groups</span></a>
        <a onclick="clearContent()"><span>Import Contacts</span></a>
      </div>
    </div>
    <div class="dropdown">
      <a onclick="toggleProducts()" id="productsMenu"><i class="fas fa-boxes"></i> <span>Products</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="productsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showAddProduct()"><span>Add Product</span></a>
        <a onclick="showListProducts()"><span>List of Products</span></a>
        <a onclick="showBusinessLocations()"><span>Business Location</span></a>
        <a onclick="showCategory()"><span>Category</span></a>
        <a onclick="showBrand()"><span>Brand</span></a>
      </div>
    </div>
    <a onclick="clearContent()"><i class="fas fa-industry"></i> <span>Manufacturing</span></a>
    <div class="dropdown">
      <a onclick="togglePurchases()" id="purchasesMenu">
        <i class="fas fa-shopping-cart"></i>
        <span>Purchases</span>
        <i class="fas fa-caret-down" style="margin-left:auto;"></i>
      </a>
      <div id="purchasesSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showAddPurchase()"><span>Add Purchase</span></a>
        <a onclick="showListPurchases()"><span>List of Purchases</span></a>
        <a onclick="showPurchaseReturn()"><span>Purchase Return</span></a>
      </div>
    </div>
    <a onclick="clearContent()"><i class="fas fa-cash-register"></i> <span>Sell</span></a>
    <a onclick="clearContent()"><i class="fas fa-truck-moving"></i> <span>Stock Transfers</span></a>
    <a onclick="clearContent()"><i class="fas fa-balance-scale-left"></i> <span>Stock Adjustment</span></a>
    <a onclick="clearContent()"><i class="fas fa-file-invoice-dollar"></i> <span>Expenses</span></a>
    <a onclick="clearContent()"><i class="fas fa-calculator"></i> <span>Accounting</span></a>
    <a onclick="clearContent()"><i class="fas fa-robot"></i> <span>AI Assistance</span></a>
    <a onclick="clearContent()"><i class="fas fa-chart-line"></i> <span>Reports</span></a>
    <a onclick="clearContent()"><i class="fas fa-envelope"></i> <span>Notification Templates</span></a>
    <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
</div>

<div class="main-content" id="mainContent">
  <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle Sidebar">
    <i class="fas fa-arrows-alt-h"></i>
  </button>
  <div id="content" class="content-section">
    <h1>Welcome to Tharua Firm</h1>
    <p>Click a menu item on the left to view more details.</p>
  </div>
</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /* ---------- Toast + Sound helpers ---------- */
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime); // low pitch
    g.gain.setValueAtTime(0.002, ctx.currentTime);    // very low volume

    o.connect(g);
    g.connect(ctx.destination);
    o.start();

    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);

    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showSuccessNotification(message = "Success") {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;

  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: "#27ae60",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });

  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });

  playSuccessSound();

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

    const firebaseConfig = {
      apiKey: "AIzaSyCLRiUG0ePdP68nbjtptb5pbY34ohiUP30",
      authDomain: "tharuasystem.firebaseapp.com",
      projectId: "tharuasystem",
      storageBucket: "tharuasystem.appspot.com",
      messagingSenderId: "438210516373",
      appId: "1:438210516373:web:83c188e315a69165d5129c"
    };
    firebase.initializeApp(firebaseConfig);

    function saveLastPage(name) { localStorage.setItem("lastPage", name); }
    function saveSidebarState(state) { localStorage.setItem("sidebarState", state); }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; return; }
      restoreUIState();
    });

    function restoreUIState() {
      const sidebarState = localStorage.getItem("sidebarState");
      if (sidebarState === "collapsed") {
        document.getElementById("sidebar").classList.add("collapsed");
        document.getElementById("mainContent").classList.add("collapsed");
      }
      const lastPage = localStorage.getItem("lastPage");
      if (lastPage && typeof window[lastPage] === "function") {
        window[lastPage]();
      } else { showHome(); }
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        alert("Logged out successfully.");
        window.location.href = "login.html";
      }).catch(err => alert("Error logging out: " + err.message));
    }

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.getElementById("mainContent");
  const toggleBtn = document.querySelector(".toggle-btn i");

  sidebar.classList.toggle("collapsed");
  mainContent.classList.toggle("collapsed");

  if (sidebar.classList.contains("collapsed")) {
    toggleBtn.classList.add("rotate-90");
  } else {
    toggleBtn.classList.remove("rotate-90");
  }

  saveSidebarState(sidebar.classList.contains("collapsed") ? "collapsed" : "expanded");
}

    function showHome() {
      saveLastPage("showHome");

      const savedLocation = localStorage.getItem("dashboardLocation") || "all";
      const savedStartDate = localStorage.getItem("dashboardStartDate") || "";
      const savedEndDate = localStorage.getItem("dashboardEndDate") || "";

      document.getElementById("content").innerHTML = `
        <h2>Dashboard Overview</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
          <select id="locationFilter" style="flex:1;">
            <option value="all">All Locations</option>
          </select>
          <input type="date" id="startDateFilter" style="flex:1;" />
          <input type="date" id="endDateFilter" style="flex:1;" />
          <button onclick="applyFilters()">Apply</button>
        </div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Sales</h3>
            <p id="salesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Purchases</h3>
            <p id="purchasesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Expenses</h3>
            <p id="expensesTotal">Loading...</p>
          </div>
        </div>
      `;

      document.getElementById("startDateFilter").value = savedStartDate;
      document.getElementById("endDateFilter").value = savedEndDate;

      loadLocations(savedLocation);
      loadTotal("sales", "salesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("purchases", "purchasesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("expenses", "expensesTotal", savedLocation, savedStartDate, savedEndDate);
    }

 async function loadLocations(selectedValue) {
  const locationSelect = document.getElementById("locationFilter");
  if (!locationSelect) {
    console.error("Location filter element (#locationFilter) not found in DOM");
    return;
  }

  // Set initial state
  locationSelect.innerHTML = `<option value="all">All Locations</option>`;
  locationSelect.disabled = true; // Disable while loading

  try {
    const snapshot = await firebase.firestore().collection("businessLocations").orderBy("name").get();
    
    if (snapshot.empty) {
      console.warn("No locations found in businessLocations collection");
      locationSelect.disabled = false;
      return;
    }

    snapshot.forEach(doc => {
      const loc = doc.data();
      if (loc.name) { // Ensure name exists
        const opt = document.createElement("option");
        opt.value = loc.name;
        opt.textContent = loc.name;
        if (loc.name === selectedValue) opt.selected = true;
        locationSelect.appendChild(opt);
      }
    });

    locationSelect.disabled = false;
  } catch (err) {
    console.error("Error loading locations:", err);
    locationSelect.innerHTML = `<option value="all">Error loading locations</option>`;
    locationSelect.disabled = true;
    showNotification("Failed to load locations: " + err.message, "error"); // Use existing notification function
  }
}

    function applyFilters() {
      const loc = document.getElementById("locationFilter").value;
      const start = document.getElementById("startDateFilter").value;
      const end = document.getElementById("endDateFilter").value;

      localStorage.setItem("dashboardLocation", loc);
      localStorage.setItem("dashboardStartDate", start);
      localStorage.setItem("dashboardEndDate", end);

      showHome();
    }

    function loadTotal(type, elementId, location, startDate, endDate) {
  // Map each collection to its date and amount fields
  const dateFieldMap = { sales: "saleDate", purchases: "purchaseDate", expenses: "expenseDate" };
  const amountFieldMap = { sales: "totalAmount", purchases: "totalAmount", expenses: "amount" };

  const dateField = dateFieldMap[type] || "date";
  const amountField = amountFieldMap[type] || "amount";

  let query = firebase.firestore().collection(type);

  if (location && location !== "all") {
    query = query.where("location", "==", location);
  }

  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setDate(end.getDate() + 1); // make end exclusive
    query = query.where(dateField, ">=", start).where(dateField, "<", end);
  }

  query.get().then(snap => {
    let total = 0;
    snap.forEach(doc => {
      const data = doc.data();
      // Prefer the mapped amount field, but fall back gracefully
      const value =
        (data && (
          (amountField in data ? data[amountField] : undefined) ??
          data.totalAmount ??
          data.amount ??
          data.net ??
          0
        )) || 0;
      total += Number(value) || 0;
    });

    const el = document.getElementById(elementId);
    if (el) el.textContent = "KES " + total.toLocaleString();
  }).catch(err => {
    console.error("loadTotal error:", err);
    const el = document.getElementById(elementId);
    if (el) el.textContent = "Error";
  });
}

function clearContent() { saveLastPage("clearContent"); document.getElementById("content").innerHTML = `<h2>Section Under Development</h2><p>Content will be added soon. Please check back later.</p>`; }
    function toggleContacts() { const s = document.getElementById("contactsSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
    function toggleUserManagement() { const s = document.getElementById("userMgmtSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
	
function showUsers() {
  saveLastPage("showUsers");
  document.getElementById("content").innerHTML = `
    <h2>Manage Users</h2>

    <!-- Create User Form -->
    <div class="user-form">
      <div class="form-group">
        <input type="text" id="newName" placeholder="Full Name" required>
        <input type="email" id="newEmail" placeholder="Email" required>
        <input type="password" id="newPassword" placeholder="Password" required>
        <select id="newRole">
          <option value="">Select Role</option>
          <option value="admin">Admin</option>
          <option value="cashier">Cashier</option>
          <option value="salesperson">Salesperson</option>
        </select>
        <button onclick="createUser()" class="submit-btn">Create User</button>
      </div>
    </div>

    <!-- Existing Users Table -->
    <h3>Existing Users</h3>
    <div class="table-container">
      <table border="1" cellpadding="8" cellspacing="0" class="users-table">
        <thead>
          <tr style="background:#eee;">
            <th>Username</th>
            <th>Name</th>
            <th>Role</th>
            <th>Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  `;

  loadUsers();
}

function loadUsers() {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("users").get()
    .then(snapshot => {
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const u = doc.data();
        tbody.innerHTML += `
          <tr data-id="${doc.id}">
            <td class="desktop-cell">${doc.id || ""}</td>
            <td class="editable desktop-cell" data-field="name">${u.name || ""}</td>
            <td class="editable desktop-cell" data-field="role">${u.role || ""}</td>
            <td class="editable desktop-cell" data-field="email">${u.email || ""}</td>
            <td class="desktop-actions">
              <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
              <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${doc.id}')">👁</span>
              <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${doc.id}')">🗑</span>
            </td>
          </tr>
        `;
      });
    })
    .catch(err => {
      tbody.innerHTML = `<tr><td colspan='5'>Error loading users: ${err.message}</td></tr>`;
    });
}

// Enter edit mode for a user row
function enterEditMode(editSpan) {
  const row = editSpan.closest('tr');
  const userId = row.getAttribute('data-id');
  const cells = row.querySelectorAll('.editable');

  const originalData = {};
  cells.forEach(cell => {
    originalData[cell.getAttribute('data-field')] = cell.textContent;
  });

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    let input;
    if (field === 'role') {
      input = document.createElement('select');
      input.className = 'edit-input';
      ['admin', 'cashier', 'salesperson'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (role === cell.textContent) option.selected = true;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = field === 'email' ? 'email' : 'text';
      input.className = 'edit-input';
      input.value = cell.textContent || '';
    }
    cell.innerHTML = '';
    cell.appendChild(input);
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <button class="btn-save submit-btn" onclick="saveUser('${userId}', this)">Save</button>
    <button class="btn-cancel submit-btn" onclick="cancelEdit(this, ${JSON.stringify(originalData)})">Cancel</button>
  `;
}

// Save edited user data
async function saveUser(userId, saveButton) {
  const row = saveButton.closest('tr');
  const cells = row.querySelectorAll('.editable');
  const updatedData = {};

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    const input = cell.querySelector('input, select');
    updatedData[field] = input.value;
  });

  try {
    await firebase.firestore().collection("users").doc(userId).update(updatedData);
    showSuccessNotification("User updated successfully.");
    loadUsers();
  } catch (err) {
    alert("Error updating user: " + err.message);
  }
}

// Cancel edit mode and revert to original values
function cancelEdit(cancelButton, originalData) {
  const row = cancelButton.closest('tr');
  const cells = row.querySelectorAll('.editable');

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    cell.innerHTML = originalData[field] || '';
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
    <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${row.getAttribute('data-id')}')">👁</span>
    <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${row.getAttribute('data-id')}')">🗑</span>
  `;
}

// Existing functions remain unchanged
function createUser() {
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if (!name || !email || !password || !role) {
    alert("Please fill in all fields and select a role.");
    return;
  }

  firebase.firestore().collection("users").add({
    name: name,
    email: email,
    password: password,
    role: role,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("User created successfully.");
    document.getElementById("newName").value = "";
    document.getElementById("newEmail").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("newRole").value = "";
    loadUsers();
  })
  .catch(error => {
    alert("Error creating user: " + error.message);
  });
}

function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  firebase.firestore().collection("users").doc(userId).delete()
  .then(() => {
    alert("User deleted successfully.");
    loadUsers();
  })
  .catch(err => alert("Error deleting user: " + err.message));
}

function editUser(userId) {
  alert("Edit feature coming soon for user ID: " + userId);
}

function viewUser(userId) {
  alert("View feature coming soon for user ID: " + userId);
}

function toggleProducts() {
  const submenu = document.getElementById("productsSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

// Initialize page on load to restore last page
window.addEventListener("load", async () => {
  const lastPage = localStorage.getItem("lastPage");
  if (lastPage === "showAddProduct") {
    await showAddProduct();
  }
});

async function showAddProduct() {
  // Save page state
  saveLastPage("showAddProduct");

  // Show loading overlay
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading product form...</p>
    </div>
  `;

  // Load categories, brands, and locations from Firestore
  const categories = await getCollectionOptions("categories");
  const brands = await getCollectionOptions("brands");
  const locations = await getCollectionOptions("businessLocations");

  // Render professional, responsive form
  document.getElementById("content").innerHTML = `
    <style>
      .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .form-container {
        max-width: 600px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group select[multiple] {
        height: 100px;
        padding: 5px;
      }
      .form-group input[type="checkbox"],
      .form-group input[type="radio"] {
        width: auto;
        margin-right: 10px;
      }
      .form-group .radio-group {
        display: flex;
        flex-direction: row;
        gap: 20px;
        flex-wrap: wrap;
      }
      .submit-btn {
        background: #3498db;
        color: #fff;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background 0.3s;
      }
      .submit-btn:hover {
        background: #2980b9;
      }
      #addProductMessage {
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
      }
      /* Mobile responsiveness */
      @media (max-width: 600px) {
        .form-container {
          width: 95%;
          padding: 15px;
        }
        .form-container h2 {
          font-size: 20px;
        }
        .form-group label {
          font-size: 12px;
        }
        .form-group input,
        .form-group select {
          font-size: 12px;
          padding: 8px;
        }
        .form-group select[multiple] {
          height: 80px;
        }
        .submit-btn {
          font-size: 14px;
          padding: 10px;
        }
        .radio-group {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
    <div class="form-container">
      <h2>Add New Product</h2>
      <form id="addProductForm">
        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input type="text" id="productName" placeholder="Enter product name" required aria-label="Product Name" />
        </div>

        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required aria-label="Category">
            <option value="">Select category</option>
            ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="brand">Brand *</label>
          <select id="brand" required aria-label="Brand">
            <option value="">Select brand</option>
            ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="buyingPrice">Buying Price (KES) *</label>
          <input type="number" id="buyingPrice" min="0" step="0.01" placeholder="Enter buying price" required aria-label="Buying Price" />
        </div>

        <div class="form-group">
          <label for="sellingPrice">Selling Price (KES) *</label>
          <input type="number" id="sellingPrice" min="0" step="0.01" placeholder="Enter selling price" required aria-label="Selling Price" />
        </div>

        <div class="form-group">
          <label for="openingStock">Opening Stock</label>
          <input type="number" id="openingStock" min="0" step="1" placeholder="Enter opening stock" aria-label="Opening Stock" />
        </div>

        <div class="form-group">
          <label for="businessLocations">Business Locations *</label>
          <select id="businessLocations" multiple required aria-label="Business Locations">
            ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="vatable" aria-label="Vatable Product" /> Vatable Product
          </label>
        </div>

        <div class="form-group" id="vatOptions" style="display: none;">
          <label for="vatPercentage">VAT Percentage (%)</label>
          <input type="number" id="vatPercentage" min="0" max="100" step="0.01" value="16" placeholder="Enter VAT percentage" aria-label="VAT Percentage" />

          <label>VAT Inclusion *</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="vatInclusion" value="inclusive" checked /> Inclusive of Buying Price
            </label>
            <label>
              <input type="radio" name="vatInclusion" value="exclusive" /> Exclusive of Buying Price
            </label>
          </div>
        </div>

        <button type="submit" class="submit-btn">Add Product</button>
      </form>
      <div id="addProductMessage" style="color: red;"></div>
    </div>
  `;

  // Show/hide VAT options based on vatable checkbox
  const vatableCheckbox = document.getElementById("vatable");
  const vatOptions = document.getElementById("vatOptions");
  vatableCheckbox.addEventListener("change", () => {
    vatOptions.style.display = vatableCheckbox.checked ? "block" : "none";
  });

  document.getElementById("addProductForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addProductSubmit();
  });
}

async function getCollectionOptions(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).get();
    return snapshot.docs.map(doc => doc.data().name || doc.id);
  } catch (error) {
    console.error(`Error loading ${collectionName}:`, error);
    return [];
  }
}

async function addProductSubmit() {
  const name = escapeHTML(document.getElementById("productName").value.trim());
  const category = document.getElementById("category").value;
  const brand = document.getElementById("brand").value;
  const buyingPrice = parseFloat(document.getElementById("buyingPrice").value);
  const sellingPrice = parseFloat(document.getElementById("sellingPrice").value);
  const openingStock = parseInt(document.getElementById("openingStock").value) || 0;
  const locationSelect = document.getElementById("businessLocations");
  const locations = Array.from(locationSelect.selectedOptions).map(option => option.value);
  const vatable = document.getElementById("vatable").checked;
  const vatPercentage = vatable ? parseFloat(document.getElementById("vatPercentage").value) : 0;
  const vatInclusion = vatable ? document.querySelector('input[name="vatInclusion"]:checked').value : null;

  const messageEl = document.getElementById("addProductMessage");
  messageEl.style.color = "red";

  // Basic validation
  if (!name || !category || !brand || isNaN(buyingPrice) || isNaN(sellingPrice) || locations.length === 0) {
    messageEl.textContent = "Please fill in all required fields correctly.";
    return;
  }

  if (buyingPrice < 0 || sellingPrice < 0 || openingStock < 0) {
    messageEl.textContent = "Prices and stock cannot be negative.";
    return;
  }

  // Validate selling price >= buying price
  if (sellingPrice < buyingPrice) {
    messageEl.textContent = "Selling price cannot be less than buying price.";
    return;
  }

  // Validate VAT percentage and inclusion
  if (vatable) {
    if (isNaN(vatPercentage) || vatPercentage < 0 || vatPercentage > 100) {
      messageEl.textContent = "VAT percentage must be between 0 and 100.";
      return;
    }
    if (!vatInclusion) {
      messageEl.textContent = "Please select whether VAT is inclusive or exclusive.";
      return;
    }
  }

  // Check for duplicate product by name
  const existing = await firebase.firestore().collection("products")
    .where("name", "==", name)
    .get();
  if (!existing.empty) {
    messageEl.textContent = "Product name already exists.";
    return;
  }

  // Generate SKU with category code
  const catCode = category.substring(0, 3).toUpperCase();
  const sku = `PROD-${catCode}-${Date.now()}`;

  const productData = {
    name,
    sku,
    category,
    brand,
    buyingPrice,
    sellingPrice,
    openingStock,
    locations, // Store as array
    vatable,
    vatRate: vatable ? vatPercentage / 100 : 0, // Store as decimal
    vatInclusion: vatable ? vatInclusion : null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  messageEl.innerHTML = `<span class="spinner"></span> Saving...`;
  try {
    await firebase.firestore().collection("products").add(productData);
    messageEl.style.color = "green";
    messageEl.textContent = `Product added successfully with SKU: ${sku}`;
    showSuccessNotification(`Product added successfully with SKU: ${sku}`);
    document.getElementById("addProductForm").reset();
    document.getElementById("vatOptions").style.display = "none"; // Reset VAT options visibility
  } catch (error) {
    messageEl.style.color = "red";
    messageEl.textContent = error.code === "permission-denied"
      ? "You do not have permission to add products."
      : `Error adding product: ${error.message}`;
    console.error("Error adding product:", error);
  }
}


// Initialize productManager with default filter values and pagination
const productManager = {
  products: [],
  locations: [],
  categories: [],
  brands: [],
  selectedLocation: "",
  selectedCategory: "",
  selectedBrand: "",
  currentPage: 1,
  itemsPerPage: 10
};

// Toast notification functions
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime);
    g.gain.setValueAtTime(0.8, ctx.currentTime); // Increased volume for louder sound
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);
    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showToast(message, type) {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;
  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: type === "success" ? "#27ae60" : "#dc3545",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });
  if (type === "success") playSuccessSound();
  if (type === "error") document.getElementById("errorSound").play();
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

function showListProducts() {
  if (typeof saveLastPage === "function") saveLastPage("showListProducts");

  document.getElementById("content").innerHTML = `
    <style>
      .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        border: 1px solid #e0e0e0;
      }
      .filter-section label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-right: 8px;
      }
      .filter-section select, .filter-section input[type="text"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .filter-section select {
        width: 140px;
      }
      .filter-section input[type="text"] {
        width: 180px;
      }
      .filter-section select:focus, .filter-section input[type="text"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
      }
      .filter-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .filter-section button:hover {
        transform: translateY(-1px);
      }
      .filter-section .apply-btn {
        background: #0056b3;
        color: white;
      }
      .filter-section .apply-btn:hover {
        background: #003d82;
      }
      .filter-section .export-btn {
        background: #218838;
        color: white;
      }
      .filter-section .export-btn:hover {
        background: #1a6d2e;
      }
      .filter-section .search-help {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
      .filter-section .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
        width: 100%;
        position: relative;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .table-container table {
        width: 100%;
        border-collapse: collapse;
      }
      .table-container thead {
        position: sticky;
        top: 0;
        background: #f0f0f0;
        z-index: 1;
      }
      .table-container th, .table-container td {
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      .table-container th {
        font-weight: 600;
        color: #333;
      }
      .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        font-size: 14px;
      }
      .pagination-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .pagination-section button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .pagination-section .prev-btn, .pagination-section .next-btn {
        background: #007bff;
        color: white;
      }
      .pagination-section .prev-btn:hover:not(:disabled), .pagination-section .next-btn:hover:not(:disabled) {
        background: #0056b3;
      }
      .pagination-section select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        position: relative;
      }
      .modal-content h2 {
        margin-top: 0;
        color: #333;
        font-size: 20px;
      }
      .modal-content p, .modal-content label {
        font-size: 14px;
        color: #333;
        margin: 10px 0;
      }
      .modal-content input, .modal-content select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
      }
      .modal-content .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-content button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .modal-content .btn-primary {
        background: #007bff;
        color: white;
      }
      .modal-content .btn-primary:hover {
        background: #0056b3;
      }
      .modal-content .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .modal-content .btn-secondary:hover {
        background: #5a6268;
      }
      .modal-content .btn-danger {
        background: #dc3545;
        color: white;
      }
      .modal-content .btn-danger:hover {
        background: #c82333;
      }
      .modal-content .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        color: #333;
      }
      .modal-content .error-text {
        color: #dc3545;
        font-size: 12px;
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
      }
      @media (min-width: 601px) {
        .filter-section {
          flex-wrap: nowrap;
          justify-content: space-between;
        }
        .filter-section .filter-group {
          flex: 1;
          max-width: 200px;
        }
        .filter-section input[type="text"] {
          width: 180px;
        }
        .filter-section .search-group {
          display: flex;
          align-items: center;
          gap: 8px;
        }
      }
      @media (max-width: 600px) {
        .filter-section {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-section select, .filter-section input[type="text"] {
          width: 100%;
        }
        .filter-section .filter-group {
          width: 100%;
        }
        .pagination-section {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
    <h2>List of Products</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-group">
        <label for="locationFilter">Location:</label>
        <select id="locationFilter" aria-label="Filter by location">
          <option value="">Select Location</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="categoryFilter">Category:</label>
        <select id="categoryFilter" aria-label="Filter by category">
          <option value="">Select Category</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="brandFilter">Brand:</label>
        <select id="brandFilter" aria-label="Filter by brand">
          <option value="">Select Brand</option>
        </select>
      </div>
      <div class="search-group">
        <label for="searchProduct">Search:</label>
        <input
          type="text"
          id="searchProduct"
          placeholder="3+ chars..."
          aria-label="Search products by name"
          aria-describedby="searchHelpText"
        />
        <span id="searchHelpText" class="search-help">3+ chars</span>
      </div>
      <button id="applyProductFilterBtn" class="apply-btn">Apply</button>
      <button id="exportBtn" class="export-btn">Export</button>
    </div>

    <!-- Products Table -->
    <div class="table-container">
      <table role="grid" border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th scope="col">Product Name</th>
            <th scope="col">Category</th>
            <th scope="col">Brand</th>
            <th scope="col">Buying Price (KES)</th>
            <th scope="col">Selling Price (KES)</th>
            <th scope="col">Opening Stock</th>
            <th scope="col">Location</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTbody" aria-live="polite" aria-busy="true">
          <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Section -->
    <div class="pagination-section">
      <div>
        <label for="itemsPerPage">Show:</label>
        <select id="itemsPerPage" aria-label="Select items per page">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="1000">1000</option>
          <option value="all">All</option>
        </select>
        <span id="paginationInfo"></span>
      </div>
      <div>
        <button id="prevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextPageBtn" class="next-btn">Next</button>
      </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('viewModal')">&times;</span>
        <h2>Product Details</h2>
        <div id="viewModalContent"></div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="closeModal('viewModal')">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
  // Update the edit modal HTML in showListProducts
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editModal')">&times;</span>
    <h2>Edit Product</h2>
    <form id="editProductForm">
      <label for="editName">Product Name:</label>
      <input type="text" id="editName" required>
      <label for="editCategory">Category:</label>
      <select id="editCategory" required>
        <option value="">Select Category</option>
      </select>
      <label for="editBrand">Brand:</label>
      <select id="editBrand" required>
        <option value="">Select Brand</option>
      </select>
      <label for="editBuyingPrice">Buying Price (KES):</label>
      <input type="number" id="editBuyingPrice" min="0" step="0.01" required>
      <label for="editSellingPrice">Selling Price (KES):</label>
      <input type="number" id="editSellingPrice" min="0" step="0.01" required>
      <span id="priceError" class="error-text">Selling price must be greater than buying price.</span>
      <label for="editStock">Opening Stock:</label>
      <input type="number" id="editStock" min="0" step="1" required>
      <label for="editLocation">Locations:</label>
      <select id="editLocation" multiple required>
        <option value="">Select Locations</option>
      </select>
      <div class="modal-buttons">
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" class="btn-secondary" onclick="closeModal('editModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteModalMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Load all data and then render the table
  Promise.all([
    loadLocations(),
    loadCategories(),
    loadBrands(),
    loadProducts()
  ]).then(() => {
    renderProductsTable();
  }).catch(err => {
    console.error("Error loading data:", err);
    const tbody = document.getElementById("productsTbody");
    tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load data: ${escapeHTML(err.message)}</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
    showToast(`Failed to load data: ${err.message}`, "error");
  });

  // Debounced search (3+ chars)
  let debounceTimeout;
  document.getElementById("searchProduct").addEventListener("input", () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      productManager.currentPage = 1;
      const searchText = document.getElementById("searchProduct").value.toLowerCase();
      renderProductsTable(searchText);
    }, 300);
  });

  // Apply filter button
  document.getElementById("applyProductFilterBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    applyFilters(searchText);
  });

  // Instant filter on location change
  document.getElementById("locationFilter").addEventListener("change", () => {
    productManager.selectedLocation = document.getElementById("locationFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on category change
  document.getElementById("categoryFilter").addEventListener("change", () => {
    productManager.selectedCategory = document.getElementById("categoryFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on brand change
  document.getElementById("brandFilter").addEventListener("change", () => {
    productManager.selectedBrand = document.getElementById("brandFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Items per page change
  document.getElementById("itemsPerPage").addEventListener("change", () => {
    const value = document.getElementById("itemsPerPage").value;
    productManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Previous page button
  document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (productManager.currentPage > 1) {
      productManager.currentPage--;
      const searchText = document.getElementById("searchProduct").value.toLowerCase();
      renderProductsTable(searchText);
    }
  });

  // Next page button
  document.getElementById("nextPageBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    const filteredProducts = getFilteredProducts(searchText);
    const maxPage = Math.ceil(filteredProducts.length / productManager.itemsPerPage);
    if (productManager.currentPage < maxPage) {
      productManager.currentPage++;
      renderProductsTable(searchText);
    }
  });

  // Export (uses filtered + searched list)
  document.getElementById("exportBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    exportProductsCSV(searchText);
    showToast("Products exported successfully!", "success");
  });
}

// Helpers / Config
const MIN_SEARCH_CHARS = 3;
const fmtKES = (v) => (Number(v) || 0).toLocaleString("en-KE", { style: "currency", currency: "KES" });

// Modal helper functions
function openModal(modalId) {
  document.getElementById(modalId).style.display = "flex";
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}

// Apply filters
function applyFilters(searchText) {
  productManager.selectedLocation = document.getElementById("locationFilter").value;
  productManager.selectedCategory = document.getElementById("categoryFilter").value;
  productManager.selectedBrand = document.getElementById("brandFilter").value;
  productManager.currentPage = 1;
  renderProductsTable(searchText);
}

// Load Locations
function loadLocations() {
  return firebase.firestore().collection("businessLocations").get()
    .then(snapshot => {
      productManager.locations = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.name) productManager.locations.push(data.name);
      });

      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="">Select Location</option>`;
      productManager.locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });

      // Update edit modal location dropdown
      const editLocationSelect = document.getElementById("editLocation");
      editLocationSelect.innerHTML = `<option value="">Select Location</option>`;
      productManager.locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        editLocationSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading locations:", err);
      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="">Select Location</option>`;
      showToast(`Error loading locations: ${err.message}`, "error");
    });
}

// Load Categories
function loadCategories() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.categories = [];
      const categorySet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.category) categorySet.add(data.category);
      });
      productManager.categories = Array.from(categorySet).sort();

      const filterSelect = document.getElementById("categoryFilter");
      filterSelect.innerHTML = `<option value="">Select Category</option>`;
      productManager.categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
      });

      // Update edit modal category dropdown
      const editCategorySelect = document.getElementById("editCategory");
      editCategorySelect.innerHTML = `<option value="">Select Category</option>`;
      productManager.categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        editCategorySelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading categories:", err);
      const filterSelect = document.getElementById("categoryFilter");
      filterSelect.innerHTML = `<option value="">Select Category</option>`;
      const editCategorySelect = document.getElementById("editCategory");
      editCategorySelect.innerHTML = `<option value="">Select Category</option>`;
      showToast(`Error loading categories: ${err.message}`, "error");
    });
}

// Load Brands
function loadBrands() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.brands = [];
      const brandSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.brand) brandSet.add(data.brand);
      });
      productManager.brands = Array.from(brandSet).sort();

      const filterSelect = document.getElementById("brandFilter");
      filterSelect.innerHTML = `<option value="">Select Brand</option>`;
      productManager.brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        filterSelect.appendChild(option);
      });

      // Update edit modal brand dropdown
      const editBrandSelect = document.getElementById("editBrand");
      editBrandSelect.innerHTML = `<option value="">Select Brand</option>`;
      productManager.brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        editBrandSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading brands:", err);
      const filterSelect = document.getElementById("brandFilter");
      filterSelect.innerHTML = `<option value="">Select Brand</option>`;
      const editBrandSelect = document.getElementById("editBrand");
      editBrandSelect.innerHTML = `<option value="">Select Brand</option>`;
      showToast(`Error loading brands: ${err.message}`, "error");
    });
}

// Load Products
function loadProducts() {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");
  tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><span class="spinner"></span>Loading...</td></tr>`;

  return firebase.firestore().collection("products").orderBy("name").get()
    .then(snapshot => {
      productManager.products = [];
      snapshot.forEach(doc => {
        productManager.products.push({ id: doc.id, ...doc.data() });
      });
    })
    .catch(err => {
      console.error("Error loading products:", err);
      const tbody = document.getElementById("productsTbody");
      tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load products: ${escapeHTML(err.message)}</td></tr>`;
      tbody.setAttribute("aria-busy", "false");
      showToast(`Error loading products: ${err.message}`, "error");
    });
}

// Common filter logic
function getFilteredProducts(searchText = "") {
  let filtered = productManager.products;

  if (productManager.selectedLocation) {
    filtered = filtered.filter(p => Array.isArray(p.locations) && p.locations.includes(productManager.selectedLocation));
  }

  if (productManager.selectedCategory) {
    filtered = filtered.filter(p => p.category === productManager.selectedCategory);
  }

  if (productManager.selectedBrand) {
    filtered = filtered.filter(p => p.brand === productManager.selectedBrand);
  }

  const q = (searchText || "").toLowerCase();
  if (q.length >= MIN_SEARCH_CHARS) {
    filtered = filtered.filter(p =>
      (p.name && String(p.name).toLowerCase().includes(q))
    );
  }
  return filtered;
}

// Render Products + Totals
function renderProductsTable(searchText = "") {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");

  const filteredProducts = getFilteredProducts(searchText);
  const totalItems = filteredProducts.length;
  const itemsPerPage = productManager.itemsPerPage;
  const currentPage = productManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("paginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No products found.";

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  if (!paginatedProducts.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No products found.</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  paginatedProducts.forEach(product => {
    fragment.appendChild(createProductRow(product));

    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;
  });

  if (paginatedProducts.length > 0) {
    const tr = document.createElement("tr");
    tr.style.background = "#f9f9f9";
    tr.style.fontWeight = "bold";
    tr.innerHTML = `
      <td colspan="3" style="text-align:right;">Totals:</td>
      <td>${fmtKES(totalBuying)}</td>
      <td>${fmtKES(totalSelling)}</td>
      <td>${totalStock}</td>
      <td colspan="2"></td>
    `;
    fragment.appendChild(tr);
  }

  tbody.innerHTML = "";
  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Create Row
function createProductRow(product) {
  const buying = fmtKES(product.buyingPrice);
  const selling = fmtKES(product.sellingPrice);
  const stock = Number(product.openingStock) || 0;
  // Join the locations array into a comma-separated string
  const locationsDisplay = Array.isArray(product.locations) ? product.locations.join(", ") : product.location || "";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="name-cell">${escapeHTML(product.name)}</td>
    <td class="category-cell">${escapeHTML(product.category)}</td>
    <td class="brand-cell">${escapeHTML(product.brand)}</td>
    <td class="buying-price-cell">${buying}</td>
    <td class="selling-price-cell">${selling}</td>
    <td class="stock-cell">${stock}</td>
    <td class="location-cell">${escapeHTML(locationsDisplay)}</td>
    <td class="actions-cell" style="white-space:nowrap;">
      <span title="View" style="cursor:pointer; color:green; margin-right:8px;">👁</span>
      <span title="Edit" style="cursor:pointer; color:#2980b9; margin-right:8px;">✏</span>
      <span title="Delete" style="cursor:pointer; color:red;">🗑</span>
    </td>
  `;

  // View action
  tr.querySelector('[title="View"]').addEventListener("click", () => {
    const viewModalContent = document.getElementById("viewModalContent");
    viewModalContent.innerHTML = `
      <p><strong>Name:</strong> ${escapeHTML(product.name)}</p>
      <p><strong>Category:</strong> ${escapeHTML(product.category)}</p>
      <p><strong>Brand:</strong> ${escapeHTML(product.brand)}</p>
      <p><strong>Buying Price:</strong> ${buying}</p>
      <p><strong>Selling Price:</strong> ${selling}</p>
      <p><strong>Opening Stock:</strong> ${stock}</p>
      <p><strong>Locations:</strong> ${escapeHTML(locationsDisplay)}</p>
    `;
    openModal("viewModal");
  });

  // Edit action
  tr.querySelector('[title="Edit"]').addEventListener("click", () => {
    document.getElementById("editName").value = product.name;
    document.getElementById("editCategory").value = product.category;
    document.getElementById("editBrand").value = product.brand;
    document.getElementById("editBuyingPrice").value = Number(product.buyingPrice) || 0;
    document.getElementById("editSellingPrice").value = Number(product.sellingPrice) || 0;
    document.getElementById("editStock").value = Number(product.openingStock) || 0;
    // Update editLocation to support multiple selections
    const editLocationSelect = document.getElementById("editLocation");
    editLocationSelect.innerHTML = productManager.locations.map(loc => `
      <option value="${loc}" ${Array.isArray(product.locations) && product.locations.includes(loc) ? "selected" : ""}>${loc}</option>
    `).join("");
    document.getElementById("priceError").style.display = "none";

    const editForm = document.getElementById("editProductForm");
    editForm.onsubmit = async (e) => {
      e.preventDefault();
      const newData = {
        name: document.getElementById("editName").value.trim(),
        category: document.getElementById("editCategory").value,
        brand: document.getElementById("editBrand").value,
        buyingPrice: Number(document.getElementById("editBuyingPrice").value),
        sellingPrice: Number(document.getElementById("editSellingPrice").value),
        openingStock: parseInt(document.getElementById("editStock").value, 10),
        locations: Array.from(document.getElementById("editLocation").selectedOptions).map(opt => opt.value),
      };

      if (!newData.name || !newData.category || !newData.brand || newData.locations.length === 0) {
        showToast("Please fill in all required fields.", "error");
        return;
      }
      if (isNaN(newData.buyingPrice) || newData.buyingPrice < 0) {
        showToast("Buying price must be a valid non-negative number.", "error");
        return;
      }
      if (isNaN(newData.sellingPrice) || newData.sellingPrice < 0) {
        showToast("Selling price must be a valid non-negative number.", "error");
        return;
      }
      if (newData.sellingPrice <= newData.buyingPrice) {
        document.getElementById("priceError").style.display = "block";
        showToast("Selling price must be greater than buying price.", "error");
        return;
      }
      if (isNaN(newData.openingStock) || newData.openingStock < 0) {
        showToast("Opening stock must be a valid non-negative number.", "error");
        return;
      }

      try {
        await firebase.firestore().collection("products").doc(product.id).update(newData);
        Object.assign(product, newData);
        Promise.all([loadCategories(), loadBrands()]).then(() => {
          closeModal("editModal");
          renderProductsTable(document.getElementById("searchProduct").value.toLowerCase());
          showToast("Product updated successfully!", "success");
        });
      } catch (err) {
        showToast(`Error updating product: ${err.message}`, "error");
      }
    };
    openModal("editModal");
  });

  // Delete action
  tr.querySelector('[title="Delete"]').addEventListener("click", () => {
    document.getElementById("deleteModalMessage").textContent = `Are you sure you want to delete ${escapeHTML(product.name)}?`;
    openModal("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
    confirmDeleteBtn.replaceWith(newConfirmDeleteBtn);
    newConfirmDeleteBtn.addEventListener("click", async () => {
      try {
        await firebase.firestore().collection("products").doc(product.id).delete();
        productManager.products = productManager.products.filter(p => p.id !== product.id);
        const searchText = document.getElementById("searchProduct").value.toLowerCase();
        const filteredProducts = getFilteredProducts(searchText);
        const maxPage = Math.ceil(filteredProducts.length / productManager.itemsPerPage);
        if (productManager.currentPage > maxPage && maxPage > 0) {
          productManager.currentPage = maxPage;
        }
        closeModal("deleteModal");
        renderProductsTable(searchText);
        showToast("Product deleted successfully!", "success");
      } catch (err) {
        showToast(`Error deleting product: ${err.message}`, "error");
      }
    });
  });

  return tr;
}

// Export CSV with Current Filters
function exportProductsCSV(searchText = "") {
  const headers = ["Name", "Category", "Brand", "Buying Price", "Selling Price", "Opening Stock", "Locations"];
  const csvRows = [headers.join(",")];

  const list = getFilteredProducts(searchText);

  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  list.forEach(product => {
    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;

    const row = [
      `"${(product.name ?? "").replace(/"/g, '""')}"`,
      `"${(product.category ?? "").replace(/"/g, '""')}"`,
      `"${(product.brand ?? "").replace(/"/g, '""')}"`,
      (Number(product.buyingPrice) || 0).toFixed(2),
      (Number(product.sellingPrice) || 0).toFixed(2),
      stock,
      `"${(Array.isArray(product.locations) ? product.locations.join(";") : product.location ?? "").replace(/"/g, '""')}"`,
    ];
    csvRows.push(row.join(","));
  });

  csvRows.push([
    "Totals", "", "",
    totalBuying.toFixed(2),
    totalSelling.toFixed(2),
    totalStock,
    ""
  ].join(","));

  const csvContent = csvRows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "products.csv";
  link.click();
  URL.revokeObjectURL(link.href);
}

// Escape HTML
function escapeHTML(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  })[m]);
}


// Initialize locationManager for pagination
const locationManager = {
  locations: [],
  currentPage: 1,
  itemsPerPage: 10
};

async function showBusinessLocations() {
  saveLastPage("showBusinessLocations");

  // Show loading state
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading business locations...</p>
    </div>
  `;

  // Load existing business locations
  const locations = await loadCollection("businessLocations");

  // Render the business locations management interface
  document.getElementById("content").innerHTML = `
    <div class="form-container">
      <h2>Manage Business Locations</h2>
      <form id="addLocationForm">
        <div class="form-group">
          <div>
            <label for="newLocationName">Location Name *</label>
            <input type="text" id="newLocationName" placeholder="Location Name" required aria-label="Location Name">
          </div>
          <div>
            <label for="newLocationAddress">Address (Optional)</label>
            <input type="text" id="newLocationAddress" placeholder="Address" aria-label="Location Address">
          </div>
          <button type="submit" class="submit-btn">Add Location</button>
        </div>
      </form>
      <div id="locationMessage" style="color: red;"></div>
    </div>
    <h3>Existing Locations</h3>
    <div class="table-container">
      <table class="users-table" role="grid" border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Address</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="locationsTable" aria-live="polite" aria-busy="true"></tbody>
      </table>
    </div>
    <div class="pagination-section">
      <div>
        <label for="locationsPerPage">Show:</label>
        <select id="locationsPerPage" aria-label="Select items per page">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="paginationInfo"></span>
      </div>
      <div>
        <button id="prevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextPageBtn" class="next-btn">Next</button>
      </div>
    </div>
    <div id="deleteLocationModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteLocationModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteLocationMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteLocationBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteLocationModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Initialize pagination controls
  document.getElementById("locationsPerPage").addEventListener("change", () => {
    const value = document.getElementById("locationsPerPage").value;
    locationManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    locationManager.currentPage = 1;
    renderLocationList(locations);
  });

  document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (locationManager.currentPage > 1) {
      locationManager.currentPage--;
      renderLocationList(locations);
    }
  });

  document.getElementById("nextPageBtn").addEventListener("click", () => {
    const maxPage = Math.ceil(locationManager.locations.length / locationManager.itemsPerPage);
    if (locationManager.currentPage < maxPage) {
      locationManager.currentPage++;
      renderLocationList(locations);
    }
  });

  // Initialize form submission
  document.getElementById("addLocationForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addBusinessLocation();
  });

  // Render the list of locations
  locationManager.locations = locations;
  renderLocationList(locations);
}

// Render the list of business locations with pagination
function renderLocationList(locations) {
  const tbody = document.getElementById("locationsTable");
  tbody.setAttribute("aria-busy", "true");

  const totalItems = locations.length;
  const itemsPerPage = locationManager.itemsPerPage;
  const currentPage = locationManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedLocations = locations.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("paginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No locations found.";

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  tbody.innerHTML = "";
  if (paginatedLocations.length === 0) {
    tbody.innerHTML = "<tr><td colspan='3'>No locations found.</td></tr>";
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  paginatedLocations.forEach(loc => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", loc.id);
    tr.innerHTML = `
      <td class="desktop-cell">${escapeHTML(loc.name || "")}</td>
      <td class="desktop-cell">${escapeHTML(loc.address || "")}</td>
      <td class="desktop-actions">
        <span title="Delete" style="cursor:pointer; color:red;" onclick="deleteBusinessLocation('${loc.id}', '${escapeHTML(loc.name)}')">🗑</span>
      </td>
    `;
    fragment.appendChild(tr);
  });

  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Add a new business location
async function addBusinessLocation() {
  const nameInput = document.getElementById("newLocationName");
  const addressInput = document.getElementById("newLocationAddress");
  const messageEl = document.getElementById("locationMessage");

  const name = nameInput.value.trim();
  const address = addressInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Location name is required.";
    showToast("Location name is required.", "error");
    return;
  }

  try {
    // Check for duplicate location name
    const existing = await firebase.firestore().collection("businessLocations")
      .where("name", "==", name)
      .get();
    if (!existing.empty) {
      messageEl.textContent = "Location name already exists.";
      showToast("Location name already exists.", "error");
      return;
    }

    // Add new location to Firebase
    await firebase.firestore().collection("businessLocations").add({
      name,
      address: address || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Show success message and reset form
    messageEl.style.color = "green";
    messageEl.textContent = `Location "${name}" added successfully.`;
    showSuccessNotification(`Location "${name}" added successfully.`);
    nameInput.value = "";
    addressInput.value = "";

    // Reload and render the updated list
    const locations = await loadCollection("businessLocations");
    locationManager.locations = locations;
    renderLocationList(locations);
  } catch (error) {
    console.error("Error adding location:", error);
    messageEl.textContent = `Error adding location: ${error.message}`;
    showToast(`Error adding location: ${error.message}`, "error");
  }
}

// Delete a business location
async function deleteBusinessLocation(id, name) {
  document.getElementById("deleteLocationMessage").textContent = `Are you sure you want to delete the location "${name}"?`;
  openModal("deleteLocationModal");

  const confirmDeleteBtn = document.getElementById("confirmDeleteLocationBtn");
  const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
  confirmDeleteBtn.replaceWith(newConfirmDeleteBtn);

  newConfirmDeleteBtn.addEventListener("click", async () => {
    try {
      await firebase.firestore().collection("businessLocations").doc(id).delete();
      closeModal("deleteLocationModal");
      showSuccessNotification("Location deleted successfully.");
      const locations = await loadCollection("businessLocations");
      locationManager.locations = locations;
      renderLocationList(locations);
    } catch (error) {
      console.error("Error deleting location:", error);
      closeModal("deleteLocationModal");
      showToast(`Error deleting location: ${error.message}`, "error");
    }
  });
}

async function showCategory() {
  saveLastPage("showCategory");

  // Load existing categories
  const categories = await loadCollection("categories");

  document.getElementById("content").innerHTML = `
    <h2>Manage Categories</h2>
    <input type="text" id="newCategoryName" placeholder="New category name" />
    <button onclick="addCategory()">Add Category</button>
    <div id="categoryMessage" style="margin-top:10px;"></div>

    <h3>Existing Categories</h3>
    <ul id="categoryList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderCategoryList(categories);
}

async function loadCollection(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).orderBy("name").get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    console.error(`Error loading ${collectionName}:`, err);
    return [];
  }
}

function renderCategoryList(categories) {
  const ul = document.getElementById("categoryList");
  ul.innerHTML = "";
  if (categories.length === 0) {
    ul.innerHTML = "<li>No categories found.</li>";
    return;
  }
  categories.forEach(cat => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${cat.name} 
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteCategory('${cat.id}')">Delete</button>
      </li>`;
  });
}

async function addCategory() {
  const nameInput = document.getElementById("newCategoryName");
  const messageEl = document.getElementById("categoryMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Category name cannot be empty.";
    return;
  }

  // Check if category already exists (optional)
  const existing = await firebase.firestore().collection("categories").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Category already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("categories").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Category "${name}" added successfully.`;
    nameInput.value = "";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    console.error("Error adding category:", error);
    messageEl.textContent = "Error adding category: " + error.message;
  }
}

async function deleteCategory(id) {
  if (!confirm("Are you sure you want to delete this category?")) return;

  try {
    await firebase.firestore().collection("categories").doc(id).delete();
    const messageEl = document.getElementById("categoryMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Category deleted.";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    alert("Error deleting category: " + error.message);
  }
}


async function showBrand() {
  saveLastPage("showBrand");
  const brands = await loadCollection("brands");

  document.getElementById("content").innerHTML = `
    <h2>Manage Brands</h2>
    <input type="text" id="newBrandName" placeholder="New brand name" />
    <button onclick="addBrand()">Add Brand</button>
    <div id="brandMessage" style="margin-top:10px;"></div>

    <h3>Existing Brands</h3>
    <ul id="brandList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderBrandList(brands);
}

function renderBrandList(brands) {
  const ul = document.getElementById("brandList");
  ul.innerHTML = "";
  if (brands.length === 0) {
    ul.innerHTML = "<li>No brands found.</li>";
    return;
  }
  brands.forEach(brand => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${brand.name}
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteBrand('${brand.id}')">Delete</button>
      </li>`;
  });
}

async function addBrand() {
  const nameInput = document.getElementById("newBrandName");
  const messageEl = document.getElementById("brandMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Brand name cannot be empty.";
    return;
  }

  const existing = await firebase.firestore().collection("brands").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Brand already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("brands").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Brand "${name}" added successfully.`;
    nameInput.value = "";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    console.error("Error adding brand:", error);
    messageEl.textContent = "Error adding brand: " + error.message;
  }
}

async function deleteBrand(id) {
  if (!confirm("Are you sure you want to delete this brand?")) return;

  try {
    await firebase.firestore().collection("brands").doc(id).delete();
    const messageEl = document.getElementById("brandMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Brand deleted.";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    alert("Error deleting brand: " + error.message);
  }
}
function togglePurchases() {
  const submenu = document.getElementById("purchasesSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddPurchase() {
  saveLastPage("showAddPurchase");

  const suppliers = await getCollectionOptions("suppliers");
  const locations = await getCollectionOptions("businessLocations");
  const products = await getCollectionOptions("products");

  document.getElementById("content").innerHTML = `
    <h2>Add Purchase</h2>
    <form id="addPurchaseForm">
      <label>Supplier *</label>
      <select id="supplier" required>
        <option value="">Select supplier</option>
        ${suppliers.map(s => `<option value="${s}">${s}</option>`).join("")}
      </select>

      <label>Purchase Date *</label>
      <input type="date" id="purchaseDate" required>

      <label>Business Location *</label>
      <select id="location" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <label>Reference No.</label>
      <input type="text" id="referenceNo" placeholder="Optional">

      <h3>Products</h3>
      <div id="purchaseItems"></div>
      <button type="button" onclick="addPurchaseItem('${products.join(",")}')">+ Add Item</button>

      <p><strong>Total Amount:</strong> KES <span id="totalAmount">0</span></p>

      <label>Amount Paid</label>
      <input type="number" id="amountPaid" min="0" step="0.01" value="0">

      <label>Payment Method</label>
      <select id="paymentMethod">
        <option value="Cash">Cash</option>
        <option value="MPesa">MPesa</option>
        <option value="Bank">Bank</option>
        <option value="Credit">Credit</option>
      </select>

      <label>Notes</label>
      <textarea id="notes"></textarea>

      <button type="submit">Save Purchase</button>
    </form>
    <div id="purchaseMessage" style="margin-top:10px; color:red;"></div>
  `;

  document.getElementById("addPurchaseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await savePurchase();
  });
}

function addPurchaseItem(productsList) {
  let table = document.getElementById("purchaseItemsTable");

  // If table doesn't exist yet, create it
  if (!table) {
    const itemsDiv = document.getElementById("purchaseItems");
    itemsDiv.innerHTML = `
      <table id="purchaseItemsTable" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead style="background:#f0f0f0;">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price (KES)</th>
            <th>Subtotal (KES)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="purchaseItemsBody"></tbody>
      </table>
    `;
    table = document.getElementById("purchaseItemsTable");
  }

  const tbody = document.getElementById("purchaseItemsBody");

  // Create a new row
  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="item-index"></td>
    <td>
      <select class="purchaseProduct">
        ${productsList.split(",").map(p => `<option value="${p}">${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" class="purchaseQty" min="1" value="1" style="width:70px;"></td>
    <td><input type="number" class="purchasePrice" min="0" step="0.01" value="0" style="width:90px;"></td>
    <td class="itemSubtotal">0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove(); updatePurchaseIndexes(); updatePurchaseTotal()">Remove</button></td>
  `;

  // Insert row at the TOP (latest item = #1)
  if (tbody.firstChild) {
    tbody.insertBefore(row, tbody.firstChild);
  } else {
    tbody.appendChild(row);
  }

  // Bind input events
  row.querySelector(".purchaseQty").addEventListener("input", () => updateRowSubtotal(row));
  row.querySelector(".purchasePrice").addEventListener("input", () => updateRowSubtotal(row));

  // Update numbering and totals
  updatePurchaseIndexes();
  updateRowSubtotal(row);
  updatePurchaseTotal();
}

function updateRowSubtotal(row) {
  const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
  const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
  const subtotal = qty * price;
  row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  updatePurchaseTotal();
}

function updatePurchaseIndexes() {
  const rows = document.querySelectorAll("#purchaseItemsBody tr");
  rows.forEach((r, i) => {
    r.querySelector(".item-index").textContent = i + 1;
  });
}

function updatePurchaseTotal() {
  let total = 0;

  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
    const subtotal = qty * price;
    total += subtotal;

    // Update the row subtotal cell
    row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}


async function savePurchase() {
  const supplier = document.getElementById("supplier").value;
  const date = document.getElementById("purchaseDate").value;
  const location = document.getElementById("location").value;
  const referenceNo = document.getElementById("referenceNo").value;
  const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
  const paymentMethod = document.getElementById("paymentMethod").value;
  const notes = document.getElementById("notes").value;

  const items = [];
  let totalAmount = 0;

  // Collect data from the table rows
  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const productName = row.querySelector(".purchaseProduct")?.value;
    const quantity = parseFloat(row.querySelector(".purchaseQty")?.value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice")?.value) || 0;
    const subtotal = quantity * price;

    if (productName && quantity > 0 && price >= 0) {
      items.push({ productName, quantity, price, subtotal });
      totalAmount += subtotal;
    }
  });

  if (!supplier || !date || !location || items.length === 0) {
    document.getElementById("purchaseMessage").textContent =
      "Please fill in all required fields and add at least one valid item.";
    return;
  }

  try {
    // 1️⃣ Save purchase in Firestore
    await firebase.firestore().collection("purchases").add({
      supplier,
      purchaseDate: new Date(date),
      location,
      referenceNo,
      items,
      totalAmount,
      amountPaid,
      paymentMethod,
      notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2️⃣ Update stock and buying price for each product
    for (const item of items) {
      const productRef = firebase.firestore().collection("products").where("name", "==", item.productName);
      const snapshot = await productRef.get();

      snapshot.forEach(async doc => {
        const productData = doc.data();
        const currentStock = productData.openingStock || 0;
        const currentBuyingPrice = productData.buyingPrice || 0;

        const newStock = currentStock + item.quantity;
        const newBuyingPrice = newStock > 0
          ? ((currentStock * currentBuyingPrice) + (item.quantity * item.price)) / newStock
          : item.price;

        await firebase.firestore().collection("products").doc(doc.id).update({
          openingStock: newStock,
          buyingPrice: parseFloat(newBuyingPrice.toFixed(2))
        });
      });
    }

    // 3️⃣ Reset form
    document.getElementById("addPurchaseForm").reset();
    document.getElementById("purchaseItems").innerHTML = "";
    document.getElementById("totalAmount").textContent = "0";
    const messageEl = document.getElementById("purchaseMessage");
    if (messageEl) {
      messageEl.style.color = "green";
      messageEl.textContent = ""; // keep toast as primary feedback
    }

    // Show green toast + play low success sound
    showSuccessNotification("Purchase saved successfully.");

  } catch (error) {
    document.getElementById("purchaseMessage").textContent =
      "Error saving purchase: " + error.message;
  }
}

async function showListPurchases() {
  saveLastPage("showListPurchases");

  document.getElementById("content").innerHTML = `
    <h2>List of Purchases</h2>

    <!-- Filter Section -->
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <select id="filterLocation" style="min-width:160px; padding:5px;">
        <option value="all">All Locations</option>
      </select>
      <select id="filterSupplier" style="min-width:160px; padding:5px;">
        <option value="all">All Suppliers</option>
      </select>

      <!-- Date filter -->
      <div style="position:relative;">
        <button id="dateFilterBtn" style="padding:6px 12px; cursor:pointer;">Date: All</button>
        <div id="dateFilterMenu" 
          style="display:none; position:absolute; top:35px; left:0; background:white; border:1px solid #ccc; 
                 box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:100; min-width:180px;">
          <div class="date-option" data-range="today">Today</div>
          <div class="date-option" data-range="yesterday">Yesterday</div>
          <div class="date-option" data-range="thisWeek">This Week</div>
          <div class="date-option" data-range="lastWeek">Last Week</div>
          <div class="date-option" data-range="thisMonth">This Month</div>
          <div class="date-option" data-range="lastMonth">Last Month</div>
          <div class="date-option" data-range="thisYear">This Year</div>
          <div class="date-option" data-range="lastYear">Last Year</div>
          <div class="date-option" data-range="custom">Custom...</div>
        </div>
      </div>

      <!-- Custom date pickers -->
      <input type="date" id="startDate" style="display:none;">
      <input type="date" id="endDate" style="display:none;">

      <button id="applyFilterBtn" style="padding:6px 12px; cursor:pointer; background:#2c3e50; color:white;">Apply Filter</button>
      <button onclick="exportPurchasesCSV()" style="margin-left:auto; padding:6px 12px; cursor:pointer;">Export</button>
    </div>

    <!-- Purchases Table -->
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Supplier</th>
          <th>Total (KES)</th>
          <th>Paid (KES)</th>
          <th>Balance (KES)</th>
          <th>Payment Method</th>
          <th>Reference No</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchasesTable">
        <tr><td colspan="10">Loading...</td></tr>
      </tbody>
    </table>

    <!-- Purchase Details Modal -->
    <div id="purchaseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
      <div style="background:white; padding:20px; width:500px; max-height:80%; overflow:auto; border-radius:8px;">
        <h3>Purchase Details</h3>
        <div id="purchaseModalContent"></div>
        <div style="text-align:right; margin-top:15px;">
          <button onclick="closePurchaseModal()">Close</button>
        </div>
      </div>
    </div>
  `;

  // Load dropdowns for suppliers & locations
  loadFilterOptions();

  // Setup date filter menu toggle
  const dateBtn = document.getElementById("dateFilterBtn");
  const dateMenu = document.getElementById("dateFilterMenu");
  dateBtn.addEventListener("click", () => {
    dateMenu.style.display = (dateMenu.style.display === "none" ? "block" : "none");
  });

  // Handle date menu clicks
  dateMenu.querySelectorAll(".date-option").forEach(opt => {
    opt.addEventListener("click", (e) => {
      const range = e.target.dataset.range;
      selectedDateRange = range;
      dateBtn.textContent = "Date: " + e.target.textContent;
      dateMenu.style.display = "none";

      if (range === "custom") {
        document.getElementById("startDate").style.display = "inline-block";
        document.getElementById("endDate").style.display = "inline-block";
      } else {
        document.getElementById("startDate").style.display = "none";
        document.getElementById("endDate").style.display = "none";
      }
    });
  });

  // Apply filter button
  document.getElementById("applyFilterBtn").addEventListener("click", () => {
    loadFilteredPurchases();
  });

  // Load all purchases initially
  loadFilteredPurchases();
}
let selectedDateRange = "all";

async function loadFilterOptions() {
  const locSelect = document.getElementById("filterLocation");
  const supSelect = document.getElementById("filterSupplier");

  const snapshot = await firebase.firestore().collection("purchases").get();

  const locations = new Set();
  const suppliers = new Set();

  snapshot.forEach(doc => {
    const p = doc.data();
    if (p.location) locations.add(p.location.trim());
    if (p.supplier) suppliers.add(p.supplier.trim());
  });

  locations.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc;
    opt.textContent = loc;
    locSelect.appendChild(opt);
  });

  suppliers.forEach(sup => {
    const opt = document.createElement("option");
    opt.value = sup;
    opt.textContent = sup;
    supSelect.appendChild(opt);
  });
}


async function loadFilteredPurchases() {
  const table = document.getElementById("purchasesTable");
  table.innerHTML = "<tr><td colspan='10'>Loading...</td></tr>";

  let query = firebase.firestore().collection("purchases");

  // Apply Location filter
  const loc = document.getElementById("filterLocation").value;
  if (loc && loc !== "all") {
    query = query.where("location", "==", loc);
  }

  // Apply Supplier filter
  const sup = document.getElementById("filterSupplier").value;
  if (sup && sup !== "all") {
    query = query.where("supplier", "==", sup);
  }

  // Apply Date filter
  const { start, end } = getDateRange(selectedDateRange);
  if (start && end) {
    query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
  }

  query = query.orderBy("purchaseDate", "desc");

  try {
    const snapshot = await query.get();
    table.innerHTML = "";

    if (snapshot.empty) {
      table.innerHTML = "<tr><td colspan='10'>No purchases found.</td></tr>";
      return;
    }

    // ✅ Totals accumulators
    let totalSum = 0;
    let paidSum = 0;
    let balanceSum = 0;

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      // ✅ Ensure numeric values
      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      totalSum += total;
      paidSum += paid;
      balanceSum += balance;

      // ✅ Smarter status handling
      let status = "";
      if (balance > 0) {
        status = `<span style="color:red;font-weight:bold;">Due</span>`;
      } else if (balance < 0) {
        status = `<span style="color:#27ae60;font-weight:bold;">Overpaid</span>`; // lighter green
      } else {
        status = `<span style="color:green;">Paid</span>`;
      }

      table.innerHTML += `
        <tr>
          <td>${date}</td>
          <td>${p.location || ""}</td>
          <td>${p.supplier || ""}</td>
          <td>${total.toFixed(2)}</td>
          <td>${paid.toFixed(2)}</td>
          <td style="color:${balance > 0 ? 'red' : balance < 0 ? '#27ae60' : 'black'};">
            ${balance.toFixed(2)}
          </td>
          <td>${p.paymentMethod || ""}</td>
          <td>${p.referenceNo || ""}</td>
          <td>${status}</td>
          <td>
            <span title="View" style="cursor:pointer; color:green;" onclick="viewPurchase('${doc.id}')">👁</span>
            <span title="Print" style="cursor:pointer; color:orange; margin-left:5px;" onclick="printPurchase('${doc.id}')">🖨</span>
            <span title="Edit" style="cursor:pointer; color:blue; margin-left:5px;" onclick="editPurchase('${doc.id}')">✏</span>
            <span title="Delete" style="cursor:pointer; color:red; margin-left:5px;" onclick="deletePurchase('${doc.id}')">🗑</span>
          </td>
        </tr>
      `;
    });

    // ✅ Totals row at bottom
    table.innerHTML += `
      <tr style="background:#f9f9f9; font-weight:bold;">
        <td colspan="3" style="text-align:right;">Totals:</td>
        <td>${totalSum.toFixed(2)}</td>
        <td>${paidSum.toFixed(2)}</td>
        <td>${balanceSum.toFixed(2)}</td>
        <td colspan="4"></td>
      </tr>
    `;

  } catch (err) {
    table.innerHTML = `<tr><td colspan="10">Error: ${err.message}</td></tr>`;
  }
}


async function exportPurchasesCSV() {
  const rows = [];
  
  // CSV headers
  rows.push([
    "Date",
    "Location",
    "Supplier",
    "Total (KES)",
    "Paid (KES)",
    "Balance (KES)",
    "Payment Method",
    "Reference No",
    "Status"
  ]);

  try {
    let query = firebase.firestore().collection("purchases");

    // Apply Location filter
    const loc = document.getElementById("filterLocation").value;
    if (loc && loc !== "all") {
      query = query.where("location", "==", loc);
    }

    // Apply Supplier filter
    const sup = document.getElementById("filterSupplier").value;
    if (sup && sup !== "all") {
      query = query.where("supplier", "==", sup);
    }

    // Apply Date filter
    const { start, end } = getDateRange(selectedDateRange);
    if (start && end) {
      query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
    }

    query = query.orderBy("purchaseDate", "desc");

    const snapshot = await query.get();

    if (snapshot.empty) {
      alert("No purchases found to export with current filters.");
      return;
    }

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      let status = "";
      if (balance > 0) {
        status = "Due";
      } else if (balance < 0) {
        status = "Overpaid";
      } else {
        status = "Paid";
      }

      rows.push([
        date,
        p.location || "",
        p.supplier || "",
        total.toFixed(2),
        paid.toFixed(2),
        balance.toFixed(2),
        p.paymentMethod || "",
        p.referenceNo || "",
        status
      ]);
    });

    // Build CSV string
    const csvContent = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

    // Trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "purchases_export.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // ✅ Show success toast
    if (typeof showSuccess === "function") {
      showSuccess("Purchases exported successfully!");
    }

  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function getDateRange(range) {
  const today = new Date();
  let start = null, end = null;

  switch (range) {
    case "today":
      start = new Date(today.setHours(0,0,0,0));
      end = new Date(today.setHours(23,59,59,999));
      break;
    case "yesterday":
      const y = new Date();
      y.setDate(y.getDate() - 1);
      start = new Date(y.setHours(0,0,0,0));
      end = new Date(y.setHours(23,59,59,999));
      break;
    case "thisWeek":
      const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
      start = new Date(firstDay.setHours(0,0,0,0));
      end = new Date();
      break;
    case "lastWeek":
      const lastWeekStart = new Date();
      lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
      start = new Date(lastWeekStart.setHours(0,0,0,0));
      const lastWeekEnd = new Date(start);
      lastWeekEnd.setDate(start.getDate() + 6);
      end = new Date(lastWeekEnd.setHours(23,59,59,999));
      break;
    case "thisMonth":
      start = new Date(today.getFullYear(), today.getMonth(), 1);
      end = new Date();
      break;
    case "lastMonth":
      start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      end = new Date(today.getFullYear(), today.getMonth(), 0, 23,59,59,999);
      break;
    case "thisYear":
      start = new Date(today.getFullYear(), 0, 1);
      end = new Date();
      break;
    case "lastYear":
      start = new Date(today.getFullYear() - 1, 0, 1);
      end = new Date(today.getFullYear() - 1, 11, 31, 23,59,59,999);
      break;
    case "custom":
      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (s && e) {
        start = new Date(s);
        end = new Date(e);
        end.setHours(23,59,59,999);
      }
      break;
  }
  return { start, end };
}


// Modal functions
async function viewPurchase(purchaseId) {
  try {
    const docSnap = await firebase.firestore().collection("purchases").doc(purchaseId).get();
    if (!docSnap.exists) {
      alert("Purchase not found");
      return;
    }

    const p = docSnap.data();
    const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
    const balance = (p.totalAmount || 0) - (p.amountPaid || 0);

    let itemsHTML = "";
    if (p.items && p.items.length > 0) {
      itemsHTML = `
        <table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead style="background:#f0f0f0;">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price (KES)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${p.items.map(item => `
              <tr>
                <td>${item.productName}</td>
                <td>${item.quantity}</td>
                <td>${item.price}</td>
                <td>${(item.quantity * item.price).toFixed(2)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    document.getElementById("purchaseModalContent").innerHTML = `
      <p><strong>Date:</strong> ${date}</p>
      <p><strong>Supplier:</strong> ${p.supplier || ""}</p>
      <p><strong>Location:</strong> ${p.location || ""}</p>
      <p><strong>Reference No:</strong> ${p.referenceNo || ""}</p>
      <p><strong>Payment Method:</strong> ${p.paymentMethod || ""}</p>
      <p><strong>Total Amount:</strong> ${p.totalAmount || 0}</p>
      <p><strong>Amount Paid:</strong> ${p.amountPaid || 0}</p>
      <p><strong>Balance:</strong> <span style="color:${balance > 0 ? 'red' : 'black'};">${balance}</span></p>
      <p><strong>Notes:</strong> ${p.notes || ""}</p>
      ${itemsHTML}
    `;

    document.getElementById("purchaseModal").style.display = "flex";

  } catch (error) {
    alert("Error loading purchase: " + error.message);
  }
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").style.display = "none";
}

// Firestore actions
async function printPurchase(id) {
  const docSnap = await firebase.firestore().collection("purchases").doc(id).get();
  if (!docSnap.exists) return alert("Purchase not found");
  const p = docSnap.data();

  const paid = p.amountPaid || 0;
  const balance = (p.totalAmount || 0) - paid;

  const html = `
    <html>
      <head>
        <title>Purchase Receipt</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
          h1, h2, h3 { margin: 0; }
          .header { text-align: center; margin-bottom: 20px; }
          .header h1 { font-size: 22px; color: #2c3e50; }
          .header p { margin: 2px 0; font-size: 12px; color: #555; }
          .info { margin-bottom: 20px; }
          .info p { margin: 4px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f4f4f4; }
          tr:nth-child(even) { background: #fafafa; }
          .totals { margin-top: 20px; text-align: right; }
          .totals p { margin: 4px 0; font-size: 14px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1><!-- Business Name here --></h1>
          <p><!-- Address line here --></p>
          <p><!-- Phone | Email here --></p>
          <hr/>
        </div>

        <div class="info">
          <p><b>Date:</b> ${p.purchaseDate.toDate().toLocaleDateString()}</p>
          <p><b>Supplier:</b> ${p.supplier}</p>
          <p><b>Reference:</b> ${p.referenceNo || "-"}</p>
          <p><b>Payment Method:</b> ${p.paymentMethod || "-"}</p>
          <p><b>Location:</b> ${p.location || "-"}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price (KES)</th>
              <th>Subtotal (KES)</th>
            </tr>
          </thead>
          <tbody>
            ${p.items && p.items.length > 0
              ? p.items.map((i, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${i.productName}</td>
                  <td>${i.quantity}</td>
                  <td style="text-align:right;">${i.price.toFixed(2)}</td>
                  <td style="text-align:right;">${i.subtotal ? i.subtotal.toFixed(2) : (i.quantity * i.price).toFixed(2)}</td>
                </tr>`).join("")
              : "<tr><td colspan='5'>No items</td></tr>"}
          </tbody>
        </table>

        <div class="totals">
          <p><b>Total:</b> KES ${p.totalAmount.toFixed(2)}</p>
          <p><b>Paid:</b> KES ${paid.toFixed(2)}</p>
          <p><b>Balance:</b> KES ${balance.toFixed(2)}</p>
        </div>

        <div class="footer">
          <p><!-- Footer message here --></p>
        </div>
      </body>
    </html>
  `;

  const w = window.open("", "_blank", "width=800,height=600");
  w.document.write(html);
  w.document.close();
  w.print();
}



function editPurchase(id) {
  alert(`Open edit form for purchase: ${id}`);
}

async function deletePurchase(id) {
  if (!confirm("Are you sure you want to delete this purchase?")) return;
  await firebase.firestore().collection("purchases").doc(id).delete();
  alert("Purchase deleted");
  showListPurchases();
}

async function exportPurchasesCSV() {
  try {
    const snapshot = await firebase.firestore().collection("purchases")
      .orderBy("purchaseDate", "desc")
      .get();

    if (snapshot.empty) {
      alert("No purchases to export");
      return;
    }

    let csv = "Date,Supplier,Total Amount,Amount Paid,Balance,Payment Method,Reference No\n";
    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
      const balance = (p.totalAmount || 0) - (p.amountPaid || 0);
      csv += `${date},"${p.supplier}",${p.totalAmount || 0},${p.amountPaid || 0},${balance},"${p.paymentMethod || ""}","${p.referenceNo || ""}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `purchases_${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function showPurchaseReturn() {
  saveLastPage("showPurchaseReturn");
  document.getElementById("content").innerHTML = `<h2>Purchase Return</h2><p>Coming soon...</p>`;
}


    function showRoles() { saveLastPage("showRoles"); document.getElementById("content").innerHTML = `<h2>Roles</h2><p>Define and manage user roles and permissions.</p>`; }
    function showFieldSales() { saveLastPage("showFieldSales"); document.getElementById("content").innerHTML = `<h2>Field Salespersons</h2><p>Assign and track sales agents working in the field.</p>`; }
    
	function showSuppliers() {
  saveLastPage("showSuppliers");
  document.getElementById("content").innerHTML = `
    <h2>Suppliers</h2>
    <input type="text" id="supplierName" placeholder="Supplier Name" required>
    <input type="text" id="supplierPhone" placeholder="Phone">
    <input type="email" id="supplierEmail" placeholder="Email">
    <input type="text" id="supplierAddress" placeholder="Address">
    <button onclick="addSupplier()">Add Supplier</button>
    <div id="supplierMessage" style="margin-top:10px; color:red;"></div>

    <h3>Existing Suppliers</h3>
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#eee;">
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="suppliersTable"></tbody>
    </table>
  `;

  loadSuppliers();
}

function addSupplier() {
  const name = document.getElementById("supplierName").value.trim();
  const phone = document.getElementById("supplierPhone").value.trim();
  const email = document.getElementById("supplierEmail").value.trim();
  const address = document.getElementById("supplierAddress").value.trim();
  const msg = document.getElementById("supplierMessage");

  if (!name) {
    msg.textContent = "Supplier name is required.";
    return;
  }

  firebase.firestore().collection("suppliers").add({
    name, phone, email, address,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    msg.style.color = "green";
    msg.textContent = "Supplier added successfully.";
    document.getElementById("supplierName").value = "";
    document.getElementById("supplierPhone").value = "";
    document.getElementById("supplierEmail").value = "";
    document.getElementById("supplierAddress").value = "";
    loadSuppliers();
  })
  .catch(err => {
    msg.style.color = "red";
    msg.textContent = "Error: " + err.message;
  });
}

function loadSuppliers() {
  const table = document.getElementById("suppliersTable");
  table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("suppliers").orderBy("name").get()
    .then(snapshot => {
      table.innerHTML = "";
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='5'>No suppliers found.</td></tr>";
        return;
      }
      snapshot.forEach(doc => {
        const s = doc.data();
        table.innerHTML += `
          <tr>
            <td>${s.name}</td>
            <td>${s.phone || ""}</td>
            <td>${s.email || ""}</td>
            <td>${s.address || ""}</td>
            <td><button style="background:red;color:white;" onclick="deleteSupplier('${doc.id}')">Delete</button></td>
          </tr>
        `;
      });
    })
    .catch(err => {
      table.innerHTML = `<tr><td colspan='5'>Error loading suppliers: ${err.message}</td></tr>`;
    });
}

function deleteSupplier(id) {
  if (!confirm("Delete this supplier?")) return;
  firebase.firestore().collection("suppliers").doc(id).delete()
    .then(() => loadSuppliers())
    .catch(err => alert("Error deleting: " + err.message));
}
 
	function showCustomers() { saveLastPage("showCustomers"); document.getElementById("content").innerHTML = `<h2>Customers</h2><p>View and manage your customer records here.</p>`; }
  </script>
</body>
</html>
