<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tharua Firm Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
   
   /* General styles */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #f4f4f4;
}
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 230px;
  background-color: #2c3e50;
  color: white;
  padding-top: 20px;
  overflow-y: auto;
  transition: width 0.3s ease;
}
.sidebar.collapsed {
  width: 60px;
}
.sidebar h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 18px;
  transition: opacity 0.3s ease;
}
.sidebar.collapsed h2 {
  opacity: 0;
}
.sidebar a {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  color: white;
  text-decoration: none;
  transition: background 0.3s ease;
  font-size: 14px;
  cursor: pointer;
}
.sidebar a i {
  margin-right: 12px;
  font-size: 16px;
}
.sidebar a span {
  transition: opacity 0.3s ease;
}
.sidebar.collapsed a span {
  opacity: 0;
  pointer-events: none;
}
.sidebar a:hover {
  background-color: #34495e;
}
.dropdown a {
  font-size: 14px;
  color: white;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  text-decoration: none;
  cursor: pointer;
}
.dropdown a:hover {
  background-color: #34495e;
}
.main-content {
  margin-left: 230px;
  padding: 20px;
  transition: margin-left 0.3s ease;
}
.main-content.collapsed {
  margin-left: 60px;
}
.toggle-btn {
  position: absolute;
  top: 10px;
  right: -15px;
  background-color: #2c3e50;
  color: white;
  border-radius: 50%;
  padding: 5px 7px;
  cursor: pointer;
  border: none;
  font-size: 14px;
}
.content-section {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
input,
select,
button {
  width: 100%;
  padding: 8px;
  margin: 8px 0 16px 0;
  border: 1px solid #ccc;
  border-radius: 4px;
}
button {
  background-color: #2c3e50;
  color: white;
  cursor: pointer;
}
button:hover {
  background-color: #34495e;
}
.button-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 20px;
  text-align: center;
}
.button-grid div {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #f9f9f9;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.button-grid div:hover {
  transform: scale(1.05);
}
.button-grid img {
  width: 50px;
  height: 50px;
  margin-bottom: 10px;
}
.edit-input {
  width: 80px;
  padding: 4px;
}
.btn-edit,
.btn-save,
.btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}
.btn-edit {
  background-color: #2980b9;
}
.btn-save {
  background-color: #27ae60;
}
.btn-cancel {
  background-color: #c0392b;
}
.user-form {
  margin-bottom: 20px;
}
.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.user-form input,
.user-form select,
.user-form button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}
.submit-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  cursor: pointer;
  padding: 8px 16px;
}
.submit-btn:hover {
  background-color: #34495e;
}
.table-container {
  overflow-x: auto;
}
.users-table {
  width: 100%;
  border-collapse: collapse;
}
.users-table th,
.users-table td {
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
}
.users-table th {
  background-color: #eee;
}
.desktop-cell {
  white-space: nowrap;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.desktop-actions {
  white-space: nowrap;
}
@media (max-width: 768px) {
  .form-group {
    flex-direction: column;
  }
  .user-form input,
  .user-form select,
  .user-form button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 16px;
  }
  .table-container {
    overflow-x: auto;
  }
  .users-table {
    min-width: 600px;
  }
  .desktop-cell {
    display: block;
    word-wrap: break-word;
    max-width: 120px;
    padding: 6px;
  }
  .desktop-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 5px;
  }
  .desktop-actions span {
    margin: 0 !important;
    font-size: 18px;
  }
  .edit-input {
    width: 100px;
    padding: 6px;
    font-size: 14px;
  }
}
button {
  min-height: 40px;
  touch-action: manipulation;
}

/* New styles for List of Products enhancements */
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #2c3e50;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  max-width: 90%;
}
.modal-content label {
  display: block;
  margin: 10px 0 5px;
  font-size: 14px;
}
.modal-content input,
.modal-content select {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}
.modal-content button {
  width: auto;
  padding: 8px 16px;
  margin: 0 5px;
}
.btn-delete {
  background-color: #c0392b;
}
.btn-delete:hover {
  background-color: #a53024;
}
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">&#9776;</button>
    <h2>THARUA</h2>
    <a onclick="showHome()"><i class="fas fa-home"></i> <span>Home</span></a>

    <div class="dropdown">
      <a onclick="toggleUserManagement()" id="userMgmtMenu"><i class="fas fa-users-cog"></i> <span>User Management</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="userMgmtSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showUsers()"><span>Users</span></a>
        <a onclick="showRoles()"><span>Roles</span></a>
        <a onclick="showFieldSales()"><span>Field Salespersons</span></a>
      </div>
    </div>

    <div class="dropdown">
      <a onclick="toggleContacts()" id="contactsMenu"><i class="fas fa-address-book"></i> <span>Contacts</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="contactsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showSuppliers()"><span>Suppliers</span></a>
        <a onclick="showCustomers()"><span>Customers</span></a>
        <a onclick="clearContent()"><span>Customer Groups</span></a>
        <a onclick="clearContent()"><span>Import Contacts</span></a>
      </div>
    </div>

    <div class="dropdown">
  <a onclick="toggleProducts()" id="productsMenu"><i class="fas fa-boxes"></i> <span>Products</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
  <div id="productsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddProduct()"><span>Add Product</span></a>
    <a onclick="showListProducts()"><span>List of Products</span></a>
    <a onclick="showBusinessLocations()"><span>Business Location</span></a>
    <a onclick="showCategory()"><span>Category</span></a>
    <a onclick="showBrand()"><span>Brand</span></a>
  </div>
</div>

    <a onclick="clearContent()"><i class="fas fa-industry"></i> <span>Manufacturing</span></a>
	
<div class="dropdown">
  <a onclick="togglePurchases()" id="purchasesMenu">
    <i class="fas fa-shopping-cart"></i> 
    <span>Purchases</span> 
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="purchasesSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddPurchase()"><span>Add Purchase</span></a>
    <a onclick="showListPurchases()"><span>List of Purchases</span></a>
    <a onclick="showPurchaseReturn()"><span>Purchase Return</span></a>
  </div>
</div>


    <a onclick="clearContent()"><i class="fas fa-cash-register"></i> <span>Sell</span></a>
    <a onclick="clearContent()"><i class="fas fa-truck-moving"></i> <span>Stock Transfers</span></a>
    <a onclick="clearContent()"><i class="fas fa-balance-scale-left"></i> <span>Stock Adjustment</span></a>
    <a onclick="clearContent()"><i class="fas fa-file-invoice-dollar"></i> <span>Expenses</span></a>
    <a onclick="clearContent()"><i class="fas fa-calculator"></i> <span>Accounting</span></a>
    <a onclick="clearContent()"><i class="fas fa-robot"></i> <span>AI Assistance</span></a>
    <a onclick="clearContent()"><i class="fas fa-chart-line"></i> <span>Reports</span></a>
    <a onclick="clearContent()"><i class="fas fa-envelope"></i> <span>Notification Templates</span></a>
    <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
  </div>

  <div class="main-content" id="mainContent">
    <div id="content" class="content-section">
      <h1>Welcome to Tharua Firm</h1>
      <p>Click a menu item on the left to view more details.</p>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /* ---------- Toast + Sound helpers ---------- */
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime); // low pitch
    g.gain.setValueAtTime(0.002, ctx.currentTime);    // very low volume

    o.connect(g);
    g.connect(ctx.destination);
    o.start();

    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);

    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showSuccessNotification(message = "Success") {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;

  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: "#27ae60",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });

  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });

  playSuccessSound();

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

    const firebaseConfig = {
      apiKey: "AIzaSyCLRiUG0ePdP68nbjtptb5pbY34ohiUP30",
      authDomain: "tharuasystem.firebaseapp.com",
      projectId: "tharuasystem",
      storageBucket: "tharuasystem.appspot.com",
      messagingSenderId: "438210516373",
      appId: "1:438210516373:web:83c188e315a69165d5129c"
    };
    firebase.initializeApp(firebaseConfig);

    function saveLastPage(name) { localStorage.setItem("lastPage", name); }
    function saveSidebarState(state) { localStorage.setItem("sidebarState", state); }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; return; }
      restoreUIState();
    });

    function restoreUIState() {
      const sidebarState = localStorage.getItem("sidebarState");
      if (sidebarState === "collapsed") {
        document.getElementById("sidebar").classList.add("collapsed");
        document.getElementById("mainContent").classList.add("collapsed");
      }
      const lastPage = localStorage.getItem("lastPage");
      if (lastPage && typeof window[lastPage] === "function") {
        window[lastPage]();
      } else { showHome(); }
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        alert("Logged out successfully.");
        window.location.href = "login.html";
      }).catch(err => alert("Error logging out: " + err.message));
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("collapsed");
      document.getElementById("mainContent").classList.toggle("collapsed");
      saveSidebarState(document.getElementById("sidebar").classList.contains("collapsed") ? "collapsed" : "expanded");
    }

    function showHome() {
      saveLastPage("showHome");

      const savedLocation = localStorage.getItem("dashboardLocation") || "all";
      const savedStartDate = localStorage.getItem("dashboardStartDate") || "";
      const savedEndDate = localStorage.getItem("dashboardEndDate") || "";

      document.getElementById("content").innerHTML = `
        <h2>Dashboard Overview</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
          <select id="locationFilter" style="flex:1;">
            <option value="all">All Locations</option>
          </select>
          <input type="date" id="startDateFilter" style="flex:1;" />
          <input type="date" id="endDateFilter" style="flex:1;" />
          <button onclick="applyFilters()">Apply</button>
        </div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Sales</h3>
            <p id="salesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Purchases</h3>
            <p id="purchasesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Expenses</h3>
            <p id="expensesTotal">Loading...</p>
          </div>
        </div>
      `;

      document.getElementById("startDateFilter").value = savedStartDate;
      document.getElementById("endDateFilter").value = savedEndDate;

      loadLocations(savedLocation);
      loadTotal("sales", "salesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("purchases", "purchasesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("expenses", "expensesTotal", savedLocation, savedStartDate, savedEndDate);
    }

    function loadLocations(selectedValue) {
      const locationSelect = document.getElementById("locationFilter");
      locationSelect.innerHTML = `<option value="all">All Locations</option>`;

      firebase.firestore().collection("businessLocations").get().then(snapshot => {
        snapshot.forEach(doc => {
          const loc = doc.data();
          const opt = document.createElement("option");
          opt.value = loc.name;
          opt.textContent = loc.name;
          if (loc.name === selectedValue) opt.selected = true;
          locationSelect.appendChild(opt);
        });
      }).catch(err => console.error("Error loading locations:", err));
    }

    function applyFilters() {
      const loc = document.getElementById("locationFilter").value;
      const start = document.getElementById("startDateFilter").value;
      const end = document.getElementById("endDateFilter").value;

      localStorage.setItem("dashboardLocation", loc);
      localStorage.setItem("dashboardStartDate", start);
      localStorage.setItem("dashboardEndDate", end);

      showHome();
    }

    function loadTotal(type, elementId, location, startDate, endDate) {
  // Map each collection to its date and amount fields
  const dateFieldMap = { sales: "saleDate", purchases: "purchaseDate", expenses: "expenseDate" };
  const amountFieldMap = { sales: "totalAmount", purchases: "totalAmount", expenses: "amount" };

  const dateField = dateFieldMap[type] || "date";
  const amountField = amountFieldMap[type] || "amount";

  let query = firebase.firestore().collection(type);

  if (location && location !== "all") {
    query = query.where("location", "==", location);
  }

  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setDate(end.getDate() + 1); // make end exclusive
    query = query.where(dateField, ">=", start).where(dateField, "<", end);
  }

  query.get().then(snap => {
    let total = 0;
    snap.forEach(doc => {
      const data = doc.data();
      // Prefer the mapped amount field, but fall back gracefully
      const value =
        (data && (
          (amountField in data ? data[amountField] : undefined) ??
          data.totalAmount ??
          data.amount ??
          data.net ??
          0
        )) || 0;
      total += Number(value) || 0;
    });

    const el = document.getElementById(elementId);
    if (el) el.textContent = "KES " + total.toLocaleString();
  }).catch(err => {
    console.error("loadTotal error:", err);
    const el = document.getElementById(elementId);
    if (el) el.textContent = "Error";
  });
}

function clearContent() { saveLastPage("clearContent"); document.getElementById("content").innerHTML = `<h2>Section Under Development</h2><p>Content will be added soon. Please check back later.</p>`; }
    function toggleContacts() { const s = document.getElementById("contactsSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
    function toggleUserManagement() { const s = document.getElementById("userMgmtSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
	
function showUsers() {
  saveLastPage("showUsers");
  document.getElementById("content").innerHTML = `
    <h2>Manage Users</h2>

    <!-- Create User Form -->
    <div class="user-form">
      <div class="form-group">
        <input type="text" id="newName" placeholder="Full Name" required>
        <input type="email" id="newEmail" placeholder="Email" required>
        <input type="password" id="newPassword" placeholder="Password" required>
        <select id="newRole">
          <option value="">Select Role</option>
          <option value="admin">Admin</option>
          <option value="cashier">Cashier</option>
          <option value="salesperson">Salesperson</option>
        </select>
        <button onclick="createUser()" class="submit-btn">Create User</button>
      </div>
    </div>

    <!-- Existing Users Table -->
    <h3>Existing Users</h3>
    <div class="table-container">
      <table border="1" cellpadding="8" cellspacing="0" class="users-table">
        <thead>
          <tr style="background:#eee;">
            <th>Username</th>
            <th>Name</th>
            <th>Role</th>
            <th>Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  `;

  loadUsers();
}

function loadUsers() {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("users").get()
    .then(snapshot => {
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const u = doc.data();
        tbody.innerHTML += `
          <tr data-id="${doc.id}">
            <td class="desktop-cell">${doc.id || ""}</td>
            <td class="editable desktop-cell" data-field="name">${u.name || ""}</td>
            <td class="editable desktop-cell" data-field="role">${u.role || ""}</td>
            <td class="editable desktop-cell" data-field="email">${u.email || ""}</td>
            <td class="desktop-actions">
              <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
              <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${doc.id}')">👁</span>
              <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${doc.id}')">🗑</span>
            </td>
          </tr>
        `;
      });
    })
    .catch(err => {
      tbody.innerHTML = `<tr><td colspan='5'>Error loading users: ${err.message}</td></tr>`;
    });
}

// Enter edit mode for a user row
function enterEditMode(editSpan) {
  const row = editSpan.closest('tr');
  const userId = row.getAttribute('data-id');
  const cells = row.querySelectorAll('.editable');

  const originalData = {};
  cells.forEach(cell => {
    originalData[cell.getAttribute('data-field')] = cell.textContent;
  });

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    let input;
    if (field === 'role') {
      input = document.createElement('select');
      input.className = 'edit-input';
      ['admin', 'cashier', 'salesperson'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (role === cell.textContent) option.selected = true;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = field === 'email' ? 'email' : 'text';
      input.className = 'edit-input';
      input.value = cell.textContent || '';
    }
    cell.innerHTML = '';
    cell.appendChild(input);
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <button class="btn-save submit-btn" onclick="saveUser('${userId}', this)">Save</button>
    <button class="btn-cancel submit-btn" onclick="cancelEdit(this, ${JSON.stringify(originalData)})">Cancel</button>
  `;
}

// Save edited user data
async function saveUser(userId, saveButton) {
  const row = saveButton.closest('tr');
  const cells = row.querySelectorAll('.editable');
  const updatedData = {};

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    const input = cell.querySelector('input, select');
    updatedData[field] = input.value;
  });

  try {
    await firebase.firestore().collection("users").doc(userId).update(updatedData);
    showSuccessNotification("User updated successfully.");
    loadUsers();
  } catch (err) {
    alert("Error updating user: " + err.message);
  }
}

// Cancel edit mode and revert to original values
function cancelEdit(cancelButton, originalData) {
  const row = cancelButton.closest('tr');
  const cells = row.querySelectorAll('.editable');

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    cell.innerHTML = originalData[field] || '';
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
    <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${row.getAttribute('data-id')}')">👁</span>
    <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${row.getAttribute('data-id')}')">🗑</span>
  `;
}

// Existing functions remain unchanged
function createUser() {
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if (!name || !email || !password || !role) {
    alert("Please fill in all fields and select a role.");
    return;
  }

  firebase.firestore().collection("users").add({
    name: name,
    email: email,
    password: password,
    role: role,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("User created successfully.");
    document.getElementById("newName").value = "";
    document.getElementById("newEmail").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("newRole").value = "";
    loadUsers();
  })
  .catch(error => {
    alert("Error creating user: " + error.message);
  });
}

function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  firebase.firestore().collection("users").doc(userId).delete()
  .then(() => {
    alert("User deleted successfully.");
    loadUsers();
  })
  .catch(err => alert("Error deleting user: " + err.message));
}

function editUser(userId) {
  alert("Edit feature coming soon for user ID: " + userId);
}

function viewUser(userId) {
  alert("View feature coming soon for user ID: " + userId);
}

function toggleProducts() {
  const submenu = document.getElementById("productsSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddProduct() {
  saveLastPage("showAddProduct");

  // Load categories, brands, and locations from Firestore
  const categories = await getCollectionOptions("categories");
  const brands = await getCollectionOptions("brands");
  const locations = await getCollectionOptions("businessLocations");

  document.getElementById("content").innerHTML = `
    <h2>Add Product</h2>
    <form id="addProductForm">
      <label>Product Name *</label>
      <input type="text" id="productName" placeholder="Enter product name" required />

      <!-- SKU will be generated automatically, no input -->

      <label>Category *</label>
      <select id="category" required>
        <option value="">Select category</option>
        ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
      </select>

      <label>Brand *</label>
      <select id="brand" required>
        <option value="">Select brand</option>
        ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}
      </select>

      <label>Buying Price (KES) *</label>
      <input type="number" id="buyingPrice" min="0" step="0.01" placeholder="Enter buying price" required />

      <label>Selling Price (KES) *</label>
      <input type="number" id="sellingPrice" min="0" step="0.01" placeholder="Enter selling price" required />

      <label>Opening Stock</label>
      <input type="number" id="openingStock" min="0" step="1" placeholder="Enter opening stock" />

      <label>Business Location *</label>
      <select id="businessLocation" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <button type="submit">Add Product</button>
    </form>
    <div id="addProductMessage" style="color: red; margin-top: 10px;"></div>
  `;

  document.getElementById("addProductForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addProductSubmit();
  });
}

async function getCollectionOptions(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).get();
    return snapshot.docs.map(doc => doc.data().name || doc.id);
  } catch (error) {
    console.error(`Error loading ${collectionName}:`, error);
    return [];
  }
}

async function addProductSubmit() {
  const name = document.getElementById("productName").value.trim();
  const category = document.getElementById("category").value;
  const brand = document.getElementById("brand").value;
  const buyingPrice = parseFloat(document.getElementById("buyingPrice").value);
  const sellingPrice = parseFloat(document.getElementById("sellingPrice").value);
  const openingStock = parseInt(document.getElementById("openingStock").value) || 0;
  const location = document.getElementById("businessLocation").value;

  const messageEl = document.getElementById("addProductMessage");
  messageEl.style.color = "red";

  // Basic validation
  if (!name || !category || !brand || isNaN(buyingPrice) || isNaN(sellingPrice) || !location) {
    messageEl.textContent = "Please fill in all required fields correctly.";
    return;
  }

  if (buyingPrice < 0 || sellingPrice < 0 || openingStock < 0) {
    messageEl.textContent = "Prices and stock cannot be negative.";
    return;
  }

  // Generate SKU - e.g. PROD + timestamp + random number
  const sku = `PROD-${Date.now()}-${Math.floor(Math.random() * 9000 + 1000)}`;

  const productData = {
    name,
    sku,
    category,
    brand,
    buyingPrice,
    sellingPrice,
    openingStock,
    location,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await firebase.firestore().collection("products").add(productData);
    messageEl.style.color = "green";
    messageEl.textContent = `Product added successfully with SKU: ${sku}`;

    // Clear form
    document.getElementById("addProductForm").reset();
  } catch (error) {
    console.error("Error adding product:", error);
    messageEl.textContent = "Error adding product: " + error.message;
  }
}


// Globals
let products = [];
let selectedLocation = "all";
let sortField = "name";
let sortDirection = "asc";
let lastDoc = null;
const pageSize = 20;

function showListProducts(page = 1) {
  saveLastPage("showListProducts");
  const content = document.getElementById("content");
  content.innerHTML = `
    <h2>List of Products</h2>
    <div style="margin-bottom: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
      <input type="text" id="searchInput" placeholder="Search by name or SKU" style="min-width: 160px; padding: 5px;" aria-label="Search products">
      <label for="locationFilter">Filter by Location:</label>
      <select id="locationFilter" style="min-width: 160px; padding: 5px;" aria-label="Filter by location">
        <option value="all">All Locations</option>
      </select>
      <button id="exportBtn" style="margin-left:auto; padding: 6px 12px; cursor: pointer;" aria-label="Export products to CSV">Export</button>
    </div>
    <div class="table-container">
      <table id="productsTable" aria-label="Products Table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr style="background-color: #2c3e50; color: white;">
            <th onclick="sortTable('name')" style="cursor:pointer;">Product Name <span id="sortName">↑</span></th>
            <th onclick="sortTable('sku')" style="cursor:pointer;">SKU <span id="sortSku"></span></th>
            <th onclick="sortTable('category')" style="cursor:pointer;">Category <span id="sortCategory"></span></th>
            <th onclick="sortTable('brand')" style="cursor:pointer;">Brand <span id="sortBrand"></span></th>
            <th onclick="sortTable('buyingPrice')" style="cursor:pointer;">Buying Price (KES) <span id="sortBuyingPrice"></span></th>
            <th onclick="sortTable('sellingPrice')" style="cursor:pointer;">Selling Price (KES) <span id="sortSellingPrice"></span></th>
            <th onclick="sortTable('openingStock')" style="cursor:pointer;">Opening Stock <span id="sortOpeningStock"></span></th>
            <th onclick="sortTable('location')" style="cursor:pointer;">Location <span id="sortLocation"></span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productsTbody">
          <tr><td colspan="9" style="text-align:center;"><div class="spinner"></div></td></tr>
        </tbody>
      </table>
    </div>
    <div id="pagination" style="margin-top: 10px;"></div>
  `;

  loadLocations();
  loadProducts(page);

  document.getElementById("exportBtn").addEventListener("click", exportProductsCSV);
  document.getElementById("locationFilter").addEventListener("change", (e) => {
    selectedLocation = e.target.value;
    renderProductsTable();
  });
  document.getElementById("searchInput").addEventListener("input", (e) => {
    renderProductsTable(e.target.value.toLowerCase());
  });
}

function loadLocations() {
  const locationSelect = document.getElementById("locationFilter");
  locationSelect.innerHTML = `<option value="all">All Locations</option>`;

  firebase.firestore().collection("businessLocations").get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const loc = doc.data();
        const option = document.createElement("option");
        option.value = loc.name;
        option.textContent = loc.name;
        locationSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading locations:", err);
      showSuccessNotification("Failed to load locations.", true);
    });
}

function loadProducts(page = 1) {
  const tbody = document.getElementById("productsTbody");
  tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;"><div class="spinner"></div></td></tr>`;

  let query = firebase.firestore().collection("products").orderBy("name").limit(pageSize);
  if (lastDoc && page > 1) {
    query = query.startAfter(lastDoc);
  }

  firebase.firestore().collection("products").orderBy("name").onSnapshot(snapshot => {
    products = [];
    snapshot.forEach(doc => {
      products.push({ id: doc.id, ...doc.data() });
    });
    lastDoc = snapshot.docs[snapshot.docs.length - 1];
    renderProductsTable();

    // Add pagination controls
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = `
      <button onclick="loadProducts(${page - 1})" ${page === 1 ? "disabled" : ""} aria-label="Previous page">Previous</button>
      <span>Page ${page}</span>
      <button onclick="loadProducts(${page + 1})" ${snapshot.docs.length < pageSize ? "disabled" : ""} aria-label="Next page">Next</button>
    `;
  }, err => {
    console.error("Error loading products:", err);
    tbody.innerHTML = `<tr><td colspan="9" style="color:red; text-align:center;">Error loading products.</td></tr>`;
    showSuccessNotification("Error loading products.", true);
  });
}

function renderProductsTable(searchTerm = "") {
  const tbody = document.getElementById("productsTbody");
  let filteredProducts = selectedLocation === "all" ? products : products.filter(p => p.location === selectedLocation);

  if (searchTerm) {
    filteredProducts = filteredProducts.filter(p => 
      p.name.toLowerCase().includes(searchTerm) || p.sku.toLowerCase().includes(searchTerm)
    );
  }

  filteredProducts.sort((a, b) => {
    const valA = a[sortField] || "";
    const valB = b[sortField] || "";
    if (typeof valA === "number") {
      return sortDirection === "asc" ? valA - valB : valB - valA;
    }
    return sortDirection === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  if (filteredProducts.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No products found.</td></tr>`;
    return;
  }

  tbody.innerHTML = "";
  filteredProducts.forEach(product => {
    tbody.appendChild(createProductRow(product));
  });
}

function sortTable(field) {
  if (sortField === field) {
    sortDirection = sortDirection === "asc" ? "desc" : "asc";
  } else {
    sortField = field;
    sortDirection = "asc";
  }

  document.querySelectorAll("th span").forEach(span => span.textContent = "");
  document.getElementById(`sort${field.charAt(0).toUpperCase() + field.slice(1)}`).textContent = sortDirection === "asc" ? "↑" : "↓";
  renderProductsTable(document.getElementById("searchInput")?.value?.toLowerCase() || "");
}

function createProductRow(product) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${escapeHTML(product.name)}</td>
    <td>${escapeHTML(product.sku)}</td>
    <td>${escapeHTML(product.category)}</td>
    <td>${escapeHTML(product.brand)}</td>
    <td>KES ${product.buyingPrice?.toFixed(2) ?? "0.00"}</td>
    <td>KES ${product.sellingPrice?.toFixed(2) ?? "0.00"}</td>
    <td>${product.openingStock ?? 0}</td>
    <td>${escapeHTML(product.location)}</td>
    <td>
      <button class="btn-edit" aria-label="Edit product ${escapeHTML(product.name)}">Edit</button>
      <button class="btn-delete" style="background:red;color:white;" aria-label="Delete product ${escapeHTML(product.name)}">Delete</button>
    </td>
  `;
  tr.querySelector(".btn-edit").addEventListener("click", () => enterEditMode(tr, product));
  tr.querySelector(".btn-delete").addEventListener("click", () => deleteProduct(product.id));
  tr.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        btn.click();
      }
    });
  });
  return tr;
}

function escapeHTML(str) {
  if (!str) return "";
  return str.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  })[m]);
}

async function getCollectionOptions(collection) {
  const snapshot = await firebase.firestore().collection(collection).orderBy("name").get();
  return snapshot.docs.map(doc => doc.data().name);
}

function enterEditMode(row, product) {
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.id = "editProductModal";
  modal.innerHTML = `
    <div class="modal-content">
      <h3>Edit Product</h3>
      <label for="editName">Product Name</label>
      <input type="text" id="editName" value="${escapeHTML(product.name)}" aria-label="Product Name">
      <label for="editCategory">Category</label>
      <select id="editCategory" aria-label="Category"></select>
      <label for="editBrand">Brand</label>
      <select id="editBrand" aria-label="Brand"></select>
      <label for="editBuyingPrice">Buying Price (KES)</label>
      <input type="number" id="editBuyingPrice" min="0" step="0.01" value="${product.buyingPrice?.toFixed(2) ?? "0.00"}" aria-label="Buying Price">
      <label for="editSellingPrice">Selling Price (KES)</label>
      <input type="number" id="editSellingPrice" min="0" step="0.01" value="${product.sellingPrice?.toFixed(2) ?? "0.00"}" aria-label="Selling Price">
      <label for="editStock">Opening Stock</label>
      <input type="number" id="editStock" min="0" step="1" value="${product.openingStock ?? 0}" aria-label="Opening Stock">
      <label for="editLocation">Location</label>
      <select id="editLocation" aria-label="Location"></select>
      <div style="margin-top: 10px; text-align: right;">
        <button onclick="saveProductEdit('${product.id}')" aria-label="Save product changes">Save</button>
        <button onclick="document.getElementById('editProductModal').remove()" aria-label="Cancel editing">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // Populate dropdowns
  Promise.all([
    getCollectionOptions("categories").then(categories => {
      const select = document.getElementById("editCategory");
      select.innerHTML = `<option value="">Select category</option>${categories.map(c => `<option value="${c}">${c}</option>`).join("")}`;
      select.value = product.category || "";
    }),
    getCollectionOptions("brands").then(brands => {
      const select = document.getElementById("editBrand");
      select.innerHTML = `<option value="">Select brand</option>${brands.map(b => `<option value="${b}">${b}</option>`).join("")}`;
      select.value = product.brand || "";
    }),
    getCollectionOptions("businessLocations").then(locations => {
      const select = document.getElementById("editLocation");
      select.innerHTML = `<option value="">Select location</option>${locations.map(l => `<option value="${l}">${l}</option>`).join("")}`;
      select.value = product.location || "";
    })
  ]).catch(err => {
    showSuccessNotification("Error loading dropdowns: " + err.message, true);
  });
}

async function saveProductEdit(productId) {
  const updatedData = {
    name: document.getElementById("editName").value.trim(),
    category: document.getElementById("editCategory").value,
    brand: document.getElementById("editBrand").value,
    buyingPrice: parseFloat(document.getElementById("editBuyingPrice").value) || 0,
    sellingPrice: parseFloat(document.getElementById("editSellingPrice").value) || 0,
    openingStock: parseInt(document.getElementById("editStock").value) || 0,
    location: document.getElementById("editLocation").value,
  };

  if (!updatedData.name || !updatedData.category || !updatedData.brand || !updatedData.location) {
    showSuccessNotification("Please fill in all required fields.", true);
    return;
  }

  if (updatedData.sellingPrice < updatedData.buyingPrice) {
    showSuccessNotification("Selling price cannot be less than buying price.", true);
    return;
  }

  try {
    await firebase.firestore().collection("products").doc(productId).update(updatedData);
    showSuccessNotification("Product updated successfully.");
    document.getElementById("editProductModal").remove();
    // No need to call loadProducts since real-time listener updates it
  } catch (err) {
    showSuccessNotification("Error updating product: " + err.message, true);
  }
}

async function deleteProduct(productId) {
  if (!confirm("Are you sure you want to delete this product?")) return;
  try {
    await firebase.firestore().collection("products").doc(productId).delete();
    showSuccessNotification("Product deleted successfully.");
  } catch (err) {
    showSuccessNotification("Error deleting product: " + err.message, true);
  }
}

function exportProductsCSV() {
  const headers = ["Product Name", "SKU", "Category", "Brand", "Buying Price", "Selling Price", "Opening Stock", "Location"];
  const searchTerm = document.getElementById("searchInput")?.value?.toLowerCase() || "";
  let filteredProducts = selectedLocation === "all" ? products : products.filter(p => p.location === selectedLocation);

  if (searchTerm) {
    filteredProducts = filteredProducts.filter(p => 
      p.name.toLowerCase().includes(searchTerm) || p.sku.toLowerCase().includes(searchTerm)
    );
  }

  filteredProducts.sort((a, b) => {
    const valA = a[sortField] || "";
    const valB = b[sortField] || "";
    if (typeof valA === "number") {
      return sortDirection === "asc" ? valA - valB : valB - valA;
    }
    return sortDirection === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  const rows = filteredProducts.map(p => [
    `"${escapeCSV(p.name)}"`,
    `"${escapeCSV(p.sku)}"`,
    `"${escapeCSV(p.category)}"`,
    `"${escapeCSV(p.brand)}"`,
    p.buyingPrice?.toFixed(2) ?? "0.00",
    p.sellingPrice?.toFixed(2) ?? "0.00",
    p.openingStock ?? 0,
    `"${escapeCSV(p.location)}"`
  ].join(","));

  const csvContent = [
    headers.join(","),
    ...rows,
    `Total Products,${filteredProducts.length},,,,,,`
  ].join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `products_export_${new Date().toISOString().split("T")[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showSuccessNotification("Products exported successfully.");
}

function escapeCSV(str) {
  if (!str) return "";
  return str.replace(/"/g, '""').replace(/,/g, "\\,");
}

function showSuccessNotification(message, isError = false) {
  const notification = document.createElement("div");
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; padding: 10px 20px; 
    background: ${isError ? "#e74c3c" : "#2ecc71"}; color: white; 
    border-radius: 4px; z-index: 1000; min-width: 200px;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}


async function showBusinessLocations() {
  saveLastPage("showBusinessLocations");

  const locations = await loadCollection("businessLocations");

  document.getElementById("content").innerHTML = `
    <h2>Manage Business Locations</h2>
    <input type="text" id="newLocationName" placeholder="Location name" />
    <input type="text" id="newLocationAddress" placeholder="Address (optional)" />
    <button onclick="addBusinessLocation()">Add Location</button>
    <div id="locationMessage" style="margin-top:10px;"></div>

    <h3>Existing Locations</h3>
    <ul id="locationList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderLocationList(locations);
}

function renderLocationList(locations) {
  const ul = document.getElementById("locationList");
  ul.innerHTML = "";
  if (locations.length === 0) {
    ul.innerHTML = "<li>No locations found.</li>";
    return;
  }
  locations.forEach(loc => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        <div>
          <strong>${loc.name}</strong><br/>
          <small>${loc.address || ""}</small>
        </div>
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteBusinessLocation('${loc.id}')">Delete</button>
      </li>`;
  });
}
function exportProductsCSV() {
  // Prepare CSV header
  const headers = ["Product Name", "SKU", "Category", "Brand", "Buying Price", "Selling Price", "Opening Stock", "Location"];
  
  // Filter products according to selected location
  const filteredProducts = selectedLocation === "all" ? products : products.filter(p => p.location === selectedLocation);

  // Prepare rows
  const rows = filteredProducts.map(p => [
    `"${p.name}"`,
    `"${p.sku}"`,
    `"${p.category}"`,
    `"${p.brand}"`,
    p.buyingPrice?.toFixed(2) ?? "0.00",
    p.sellingPrice?.toFixed(2) ?? "0.00",
    p.openingStock ?? 0,
    `"${p.location}"`
  ].join(","));

  const csvContent = [headers.join(","), ...rows].join("\n");

  // Create a blob and trigger download
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "products_export.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


async function addBusinessLocation() {
  const nameInput = document.getElementById("newLocationName");
  const addressInput = document.getElementById("newLocationAddress");
  const messageEl = document.getElementById("locationMessage");

  const name = nameInput.value.trim();
  const address = addressInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Location name cannot be empty.";
    return;
  }

  const existing = await firebase.firestore().collection("businessLocations").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Location already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("businessLocations").add({
      name,
      address: address || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Location "${name}" added successfully.`;
    nameInput.value = "";
    addressInput.value = "";

    const locations = await loadCollection("businessLocations");
    renderLocationList(locations);
  } catch (error) {
    console.error("Error adding location:", error);
    messageEl.textContent = "Error adding location: " + error.message;
  }
}

async function deleteBusinessLocation(id) {
  if (!confirm("Are you sure you want to delete this location?")) return;

  try {
    await firebase.firestore().collection("businessLocations").doc(id).delete();
    const messageEl = document.getElementById("locationMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Location deleted.";

    const locations = await loadCollection("businessLocations");
    renderLocationList(locations);
  } catch (error) {
    alert("Error deleting location: " + error.message);
  }
}

async function showCategory() {
  saveLastPage("showCategory");

  // Load existing categories
  const categories = await loadCollection("categories");

  document.getElementById("content").innerHTML = `
    <h2>Manage Categories</h2>
    <input type="text" id="newCategoryName" placeholder="New category name" />
    <button onclick="addCategory()">Add Category</button>
    <div id="categoryMessage" style="margin-top:10px;"></div>

    <h3>Existing Categories</h3>
    <ul id="categoryList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderCategoryList(categories);
}

async function loadCollection(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).orderBy("name").get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    console.error(`Error loading ${collectionName}:`, err);
    return [];
  }
}

function renderCategoryList(categories) {
  const ul = document.getElementById("categoryList");
  ul.innerHTML = "";
  if (categories.length === 0) {
    ul.innerHTML = "<li>No categories found.</li>";
    return;
  }
  categories.forEach(cat => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${cat.name} 
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteCategory('${cat.id}')">Delete</button>
      </li>`;
  });
}

async function addCategory() {
  const nameInput = document.getElementById("newCategoryName");
  const messageEl = document.getElementById("categoryMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Category name cannot be empty.";
    return;
  }

  // Check if category already exists (optional)
  const existing = await firebase.firestore().collection("categories").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Category already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("categories").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Category "${name}" added successfully.`;
    nameInput.value = "";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    console.error("Error adding category:", error);
    messageEl.textContent = "Error adding category: " + error.message;
  }
}

async function deleteCategory(id) {
  if (!confirm("Are you sure you want to delete this category?")) return;

  try {
    await firebase.firestore().collection("categories").doc(id).delete();
    const messageEl = document.getElementById("categoryMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Category deleted.";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    alert("Error deleting category: " + error.message);
  }
}


async function showBrand() {
  saveLastPage("showBrand");
  const brands = await loadCollection("brands");

  document.getElementById("content").innerHTML = `
    <h2>Manage Brands</h2>
    <input type="text" id="newBrandName" placeholder="New brand name" />
    <button onclick="addBrand()">Add Brand</button>
    <div id="brandMessage" style="margin-top:10px;"></div>

    <h3>Existing Brands</h3>
    <ul id="brandList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderBrandList(brands);
}

function renderBrandList(brands) {
  const ul = document.getElementById("brandList");
  ul.innerHTML = "";
  if (brands.length === 0) {
    ul.innerHTML = "<li>No brands found.</li>";
    return;
  }
  brands.forEach(brand => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${brand.name}
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteBrand('${brand.id}')">Delete</button>
      </li>`;
  });
}

async function addBrand() {
  const nameInput = document.getElementById("newBrandName");
  const messageEl = document.getElementById("brandMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Brand name cannot be empty.";
    return;
  }

  const existing = await firebase.firestore().collection("brands").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Brand already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("brands").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Brand "${name}" added successfully.`;
    nameInput.value = "";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    console.error("Error adding brand:", error);
    messageEl.textContent = "Error adding brand: " + error.message;
  }
}

async function deleteBrand(id) {
  if (!confirm("Are you sure you want to delete this brand?")) return;

  try {
    await firebase.firestore().collection("brands").doc(id).delete();
    const messageEl = document.getElementById("brandMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Brand deleted.";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    alert("Error deleting brand: " + error.message);
  }
}
function togglePurchases() {
  const submenu = document.getElementById("purchasesSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddPurchase() {
  saveLastPage("showAddPurchase");

  const suppliers = await getCollectionOptions("suppliers");
  const locations = await getCollectionOptions("businessLocations");
  const products = await getCollectionOptions("products");

  document.getElementById("content").innerHTML = `
    <h2>Add Purchase</h2>
    <form id="addPurchaseForm">
      <label>Supplier *</label>
      <select id="supplier" required>
        <option value="">Select supplier</option>
        ${suppliers.map(s => `<option value="${s}">${s}</option>`).join("")}
      </select>

      <label>Purchase Date *</label>
      <input type="date" id="purchaseDate" required>

      <label>Business Location *</label>
      <select id="location" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <label>Reference No.</label>
      <input type="text" id="referenceNo" placeholder="Optional">

      <h3>Products</h3>
      <div id="purchaseItems"></div>
      <button type="button" onclick="addPurchaseItem('${products.join(",")}')">+ Add Item</button>

      <p><strong>Total Amount:</strong> KES <span id="totalAmount">0</span></p>

      <label>Amount Paid</label>
      <input type="number" id="amountPaid" min="0" step="0.01" value="0">

      <label>Payment Method</label>
      <select id="paymentMethod">
        <option value="Cash">Cash</option>
        <option value="MPesa">MPesa</option>
        <option value="Bank">Bank</option>
        <option value="Credit">Credit</option>
      </select>

      <label>Notes</label>
      <textarea id="notes"></textarea>

      <button type="submit">Save Purchase</button>
    </form>
    <div id="purchaseMessage" style="margin-top:10px; color:red;"></div>
  `;

  document.getElementById("addPurchaseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await savePurchase();
  });
}

function addPurchaseItem(productsList) {
  let table = document.getElementById("purchaseItemsTable");

  // If table doesn't exist yet, create it
  if (!table) {
    const itemsDiv = document.getElementById("purchaseItems");
    itemsDiv.innerHTML = `
      <table id="purchaseItemsTable" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead style="background:#f0f0f0;">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price (KES)</th>
            <th>Subtotal (KES)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="purchaseItemsBody"></tbody>
      </table>
    `;
    table = document.getElementById("purchaseItemsTable");
  }

  const tbody = document.getElementById("purchaseItemsBody");

  // Create a new row
  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="item-index"></td>
    <td>
      <select class="purchaseProduct">
        ${productsList.split(",").map(p => `<option value="${p}">${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" class="purchaseQty" min="1" value="1" style="width:70px;"></td>
    <td><input type="number" class="purchasePrice" min="0" step="0.01" value="0" style="width:90px;"></td>
    <td class="itemSubtotal">0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove(); updatePurchaseIndexes(); updatePurchaseTotal()">Remove</button></td>
  `;

  // Insert row at the TOP (latest item = #1)
  if (tbody.firstChild) {
    tbody.insertBefore(row, tbody.firstChild);
  } else {
    tbody.appendChild(row);
  }

  // Bind input events
  row.querySelector(".purchaseQty").addEventListener("input", () => updateRowSubtotal(row));
  row.querySelector(".purchasePrice").addEventListener("input", () => updateRowSubtotal(row));

  // Update numbering and totals
  updatePurchaseIndexes();
  updateRowSubtotal(row);
  updatePurchaseTotal();
}

function updateRowSubtotal(row) {
  const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
  const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
  const subtotal = qty * price;
  row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  updatePurchaseTotal();
}

function updatePurchaseIndexes() {
  const rows = document.querySelectorAll("#purchaseItemsBody tr");
  rows.forEach((r, i) => {
    r.querySelector(".item-index").textContent = i + 1;
  });
}

function updatePurchaseTotal() {
  let total = 0;

  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
    const subtotal = qty * price;
    total += subtotal;

    // Update the row subtotal cell
    row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}


async function savePurchase() {
  const supplier = document.getElementById("supplier").value;
  const date = document.getElementById("purchaseDate").value;
  const location = document.getElementById("location").value;
  const referenceNo = document.getElementById("referenceNo").value;
  const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
  const paymentMethod = document.getElementById("paymentMethod").value;
  const notes = document.getElementById("notes").value;

  const items = [];
  let totalAmount = 0;

  // Collect data from the table rows
  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const productName = row.querySelector(".purchaseProduct")?.value;
    const quantity = parseFloat(row.querySelector(".purchaseQty")?.value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice")?.value) || 0;
    const subtotal = quantity * price;

    if (productName && quantity > 0 && price >= 0) {
      items.push({ productName, quantity, price, subtotal });
      totalAmount += subtotal;
    }
  });

  if (!supplier || !date || !location || items.length === 0) {
    document.getElementById("purchaseMessage").textContent =
      "Please fill in all required fields and add at least one valid item.";
    return;
  }

  try {
    // 1️⃣ Save purchase in Firestore
    await firebase.firestore().collection("purchases").add({
      supplier,
      purchaseDate: new Date(date),
      location,
      referenceNo,
      items,
      totalAmount,
      amountPaid,
      paymentMethod,
      notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2️⃣ Update stock and buying price for each product
    for (const item of items) {
      const productRef = firebase.firestore().collection("products").where("name", "==", item.productName);
      const snapshot = await productRef.get();

      snapshot.forEach(async doc => {
        const productData = doc.data();
        const currentStock = productData.openingStock || 0;
        const currentBuyingPrice = productData.buyingPrice || 0;

        const newStock = currentStock + item.quantity;
        const newBuyingPrice = newStock > 0
          ? ((currentStock * currentBuyingPrice) + (item.quantity * item.price)) / newStock
          : item.price;

        await firebase.firestore().collection("products").doc(doc.id).update({
          openingStock: newStock,
          buyingPrice: parseFloat(newBuyingPrice.toFixed(2))
        });
      });
    }

    // 3️⃣ Reset form
    document.getElementById("addPurchaseForm").reset();
    document.getElementById("purchaseItems").innerHTML = "";
    document.getElementById("totalAmount").textContent = "0";
    const messageEl = document.getElementById("purchaseMessage");
    if (messageEl) {
      messageEl.style.color = "green";
      messageEl.textContent = ""; // keep toast as primary feedback
    }

    // Show green toast + play low success sound
    showSuccessNotification("Purchase saved successfully.");

  } catch (error) {
    document.getElementById("purchaseMessage").textContent =
      "Error saving purchase: " + error.message;
  }
}

async function showListPurchases() {
  saveLastPage("showListPurchases");

  document.getElementById("content").innerHTML = `
    <h2>List of Purchases</h2>

    <!-- Filter Section -->
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <select id="filterLocation" style="min-width:160px; padding:5px;">
        <option value="all">All Locations</option>
      </select>
      <select id="filterSupplier" style="min-width:160px; padding:5px;">
        <option value="all">All Suppliers</option>
      </select>

      <!-- Date filter -->
      <div style="position:relative;">
        <button id="dateFilterBtn" style="padding:6px 12px; cursor:pointer;">Date: All</button>
        <div id="dateFilterMenu" 
          style="display:none; position:absolute; top:35px; left:0; background:white; border:1px solid #ccc; 
                 box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:100; min-width:180px;">
          <div class="date-option" data-range="today">Today</div>
          <div class="date-option" data-range="yesterday">Yesterday</div>
          <div class="date-option" data-range="thisWeek">This Week</div>
          <div class="date-option" data-range="lastWeek">Last Week</div>
          <div class="date-option" data-range="thisMonth">This Month</div>
          <div class="date-option" data-range="lastMonth">Last Month</div>
          <div class="date-option" data-range="thisYear">This Year</div>
          <div class="date-option" data-range="lastYear">Last Year</div>
          <div class="date-option" data-range="custom">Custom...</div>
        </div>
      </div>

      <!-- Custom date pickers -->
      <input type="date" id="startDate" style="display:none;">
      <input type="date" id="endDate" style="display:none;">

      <button id="applyFilterBtn" style="padding:6px 12px; cursor:pointer; background:#2c3e50; color:white;">Apply Filter</button>
      <button onclick="exportPurchasesCSV()" style="margin-left:auto; padding:6px 12px; cursor:pointer;">Export</button>
    </div>

    <!-- Purchases Table -->
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Supplier</th>
          <th>Total (KES)</th>
          <th>Paid (KES)</th>
          <th>Balance (KES)</th>
          <th>Payment Method</th>
          <th>Reference No</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchasesTable">
        <tr><td colspan="10">Loading...</td></tr>
      </tbody>
    </table>

    <!-- Purchase Details Modal -->
    <div id="purchaseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
      <div style="background:white; padding:20px; width:500px; max-height:80%; overflow:auto; border-radius:8px;">
        <h3>Purchase Details</h3>
        <div id="purchaseModalContent"></div>
        <div style="text-align:right; margin-top:15px;">
          <button onclick="closePurchaseModal()">Close</button>
        </div>
      </div>
    </div>
  `;

  // Load dropdowns for suppliers & locations
  loadFilterOptions();

  // Setup date filter menu toggle
  const dateBtn = document.getElementById("dateFilterBtn");
  const dateMenu = document.getElementById("dateFilterMenu");
  dateBtn.addEventListener("click", () => {
    dateMenu.style.display = (dateMenu.style.display === "none" ? "block" : "none");
  });

  // Handle date menu clicks
  dateMenu.querySelectorAll(".date-option").forEach(opt => {
    opt.addEventListener("click", (e) => {
      const range = e.target.dataset.range;
      selectedDateRange = range;
      dateBtn.textContent = "Date: " + e.target.textContent;
      dateMenu.style.display = "none";

      if (range === "custom") {
        document.getElementById("startDate").style.display = "inline-block";
        document.getElementById("endDate").style.display = "inline-block";
      } else {
        document.getElementById("startDate").style.display = "none";
        document.getElementById("endDate").style.display = "none";
      }
    });
  });

  // Apply filter button
  document.getElementById("applyFilterBtn").addEventListener("click", () => {
    loadFilteredPurchases();
  });

  // Load all purchases initially
  loadFilteredPurchases();
}
let selectedDateRange = "all";

async function loadFilterOptions() {
  const locSelect = document.getElementById("filterLocation");
  const supSelect = document.getElementById("filterSupplier");

  const snapshot = await firebase.firestore().collection("purchases").get();

  const locations = new Set();
  const suppliers = new Set();

  snapshot.forEach(doc => {
    const p = doc.data();
    if (p.location) locations.add(p.location.trim());
    if (p.supplier) suppliers.add(p.supplier.trim());
  });

  locations.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc;
    opt.textContent = loc;
    locSelect.appendChild(opt);
  });

  suppliers.forEach(sup => {
    const opt = document.createElement("option");
    opt.value = sup;
    opt.textContent = sup;
    supSelect.appendChild(opt);
  });
}


async function loadFilteredPurchases() {
  const table = document.getElementById("purchasesTable");
  table.innerHTML = "<tr><td colspan='10'>Loading...</td></tr>";

  let query = firebase.firestore().collection("purchases");

  // Apply Location filter
  const loc = document.getElementById("filterLocation").value;
  if (loc && loc !== "all") {
    query = query.where("location", "==", loc);
  }

  // Apply Supplier filter
  const sup = document.getElementById("filterSupplier").value;
  if (sup && sup !== "all") {
    query = query.where("supplier", "==", sup);
  }

  // Apply Date filter
  const { start, end } = getDateRange(selectedDateRange);
  if (start && end) {
    query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
  }

  query = query.orderBy("purchaseDate", "desc");

  try {
    const snapshot = await query.get();
    table.innerHTML = "";

    if (snapshot.empty) {
      table.innerHTML = "<tr><td colspan='10'>No purchases found.</td></tr>";
      return;
    }

    // ✅ Totals accumulators
    let totalSum = 0;
    let paidSum = 0;
    let balanceSum = 0;

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      // ✅ Ensure numeric values
      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      totalSum += total;
      paidSum += paid;
      balanceSum += balance;

      // ✅ Smarter status handling
      let status = "";
      if (balance > 0) {
        status = `<span style="color:red;font-weight:bold;">Due</span>`;
      } else if (balance < 0) {
        status = `<span style="color:#27ae60;font-weight:bold;">Overpaid</span>`; // lighter green
      } else {
        status = `<span style="color:green;">Paid</span>`;
      }

      table.innerHTML += `
        <tr>
          <td>${date}</td>
          <td>${p.location || ""}</td>
          <td>${p.supplier || ""}</td>
          <td>${total.toFixed(2)}</td>
          <td>${paid.toFixed(2)}</td>
          <td style="color:${balance > 0 ? 'red' : balance < 0 ? '#27ae60' : 'black'};">
            ${balance.toFixed(2)}
          </td>
          <td>${p.paymentMethod || ""}</td>
          <td>${p.referenceNo || ""}</td>
          <td>${status}</td>
          <td>
            <span title="View" style="cursor:pointer; color:green;" onclick="viewPurchase('${doc.id}')">👁</span>
            <span title="Print" style="cursor:pointer; color:orange; margin-left:5px;" onclick="printPurchase('${doc.id}')">🖨</span>
            <span title="Edit" style="cursor:pointer; color:blue; margin-left:5px;" onclick="editPurchase('${doc.id}')">✏</span>
            <span title="Delete" style="cursor:pointer; color:red; margin-left:5px;" onclick="deletePurchase('${doc.id}')">🗑</span>
          </td>
        </tr>
      `;
    });

    // ✅ Totals row at bottom
    table.innerHTML += `
      <tr style="background:#f9f9f9; font-weight:bold;">
        <td colspan="3" style="text-align:right;">Totals:</td>
        <td>${totalSum.toFixed(2)}</td>
        <td>${paidSum.toFixed(2)}</td>
        <td>${balanceSum.toFixed(2)}</td>
        <td colspan="4"></td>
      </tr>
    `;

  } catch (err) {
    table.innerHTML = `<tr><td colspan="10">Error: ${err.message}</td></tr>`;
  }
}


async function exportPurchasesCSV() {
  const rows = [];
  
  // CSV headers
  rows.push([
    "Date",
    "Location",
    "Supplier",
    "Total (KES)",
    "Paid (KES)",
    "Balance (KES)",
    "Payment Method",
    "Reference No",
    "Status"
  ]);

  try {
    let query = firebase.firestore().collection("purchases");

    // Apply Location filter
    const loc = document.getElementById("filterLocation").value;
    if (loc && loc !== "all") {
      query = query.where("location", "==", loc);
    }

    // Apply Supplier filter
    const sup = document.getElementById("filterSupplier").value;
    if (sup && sup !== "all") {
      query = query.where("supplier", "==", sup);
    }

    // Apply Date filter
    const { start, end } = getDateRange(selectedDateRange);
    if (start && end) {
      query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
    }

    query = query.orderBy("purchaseDate", "desc");

    const snapshot = await query.get();

    if (snapshot.empty) {
      alert("No purchases found to export with current filters.");
      return;
    }

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      let status = "";
      if (balance > 0) {
        status = "Due";
      } else if (balance < 0) {
        status = "Overpaid";
      } else {
        status = "Paid";
      }

      rows.push([
        date,
        p.location || "",
        p.supplier || "",
        total.toFixed(2),
        paid.toFixed(2),
        balance.toFixed(2),
        p.paymentMethod || "",
        p.referenceNo || "",
        status
      ]);
    });

    // Build CSV string
    const csvContent = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

    // Trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "purchases_export.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // ✅ Show success toast
    if (typeof showSuccess === "function") {
      showSuccess("Purchases exported successfully!");
    }

  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function getDateRange(range) {
  const today = new Date();
  let start = null, end = null;

  switch (range) {
    case "today":
      start = new Date(today.setHours(0,0,0,0));
      end = new Date(today.setHours(23,59,59,999));
      break;
    case "yesterday":
      const y = new Date();
      y.setDate(y.getDate() - 1);
      start = new Date(y.setHours(0,0,0,0));
      end = new Date(y.setHours(23,59,59,999));
      break;
    case "thisWeek":
      const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
      start = new Date(firstDay.setHours(0,0,0,0));
      end = new Date();
      break;
    case "lastWeek":
      const lastWeekStart = new Date();
      lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
      start = new Date(lastWeekStart.setHours(0,0,0,0));
      const lastWeekEnd = new Date(start);
      lastWeekEnd.setDate(start.getDate() + 6);
      end = new Date(lastWeekEnd.setHours(23,59,59,999));
      break;
    case "thisMonth":
      start = new Date(today.getFullYear(), today.getMonth(), 1);
      end = new Date();
      break;
    case "lastMonth":
      start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      end = new Date(today.getFullYear(), today.getMonth(), 0, 23,59,59,999);
      break;
    case "thisYear":
      start = new Date(today.getFullYear(), 0, 1);
      end = new Date();
      break;
    case "lastYear":
      start = new Date(today.getFullYear() - 1, 0, 1);
      end = new Date(today.getFullYear() - 1, 11, 31, 23,59,59,999);
      break;
    case "custom":
      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (s && e) {
        start = new Date(s);
        end = new Date(e);
        end.setHours(23,59,59,999);
      }
      break;
  }
  return { start, end };
}


// Modal functions
async function viewPurchase(purchaseId) {
  try {
    const docSnap = await firebase.firestore().collection("purchases").doc(purchaseId).get();
    if (!docSnap.exists) {
      alert("Purchase not found");
      return;
    }

    const p = docSnap.data();
    const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
    const balance = (p.totalAmount || 0) - (p.amountPaid || 0);

    let itemsHTML = "";
    if (p.items && p.items.length > 0) {
      itemsHTML = `
        <table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead style="background:#f0f0f0;">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price (KES)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${p.items.map(item => `
              <tr>
                <td>${item.productName}</td>
                <td>${item.quantity}</td>
                <td>${item.price}</td>
                <td>${(item.quantity * item.price).toFixed(2)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    document.getElementById("purchaseModalContent").innerHTML = `
      <p><strong>Date:</strong> ${date}</p>
      <p><strong>Supplier:</strong> ${p.supplier || ""}</p>
      <p><strong>Location:</strong> ${p.location || ""}</p>
      <p><strong>Reference No:</strong> ${p.referenceNo || ""}</p>
      <p><strong>Payment Method:</strong> ${p.paymentMethod || ""}</p>
      <p><strong>Total Amount:</strong> ${p.totalAmount || 0}</p>
      <p><strong>Amount Paid:</strong> ${p.amountPaid || 0}</p>
      <p><strong>Balance:</strong> <span style="color:${balance > 0 ? 'red' : 'black'};">${balance}</span></p>
      <p><strong>Notes:</strong> ${p.notes || ""}</p>
      ${itemsHTML}
    `;

    document.getElementById("purchaseModal").style.display = "flex";

  } catch (error) {
    alert("Error loading purchase: " + error.message);
  }
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").style.display = "none";
}

// Firestore actions
async function printPurchase(id) {
  const docSnap = await firebase.firestore().collection("purchases").doc(id).get();
  if (!docSnap.exists) return alert("Purchase not found");
  const p = docSnap.data();

  const paid = p.amountPaid || 0;
  const balance = (p.totalAmount || 0) - paid;

  const html = `
    <html>
      <head>
        <title>Purchase Receipt</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
          h1, h2, h3 { margin: 0; }
          .header { text-align: center; margin-bottom: 20px; }
          .header h1 { font-size: 22px; color: #2c3e50; }
          .header p { margin: 2px 0; font-size: 12px; color: #555; }
          .info { margin-bottom: 20px; }
          .info p { margin: 4px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f4f4f4; }
          tr:nth-child(even) { background: #fafafa; }
          .totals { margin-top: 20px; text-align: right; }
          .totals p { margin: 4px 0; font-size: 14px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1><!-- Business Name here --></h1>
          <p><!-- Address line here --></p>
          <p><!-- Phone | Email here --></p>
          <hr/>
        </div>

        <div class="info">
          <p><b>Date:</b> ${p.purchaseDate.toDate().toLocaleDateString()}</p>
          <p><b>Supplier:</b> ${p.supplier}</p>
          <p><b>Reference:</b> ${p.referenceNo || "-"}</p>
          <p><b>Payment Method:</b> ${p.paymentMethod || "-"}</p>
          <p><b>Location:</b> ${p.location || "-"}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price (KES)</th>
              <th>Subtotal (KES)</th>
            </tr>
          </thead>
          <tbody>
            ${p.items && p.items.length > 0
              ? p.items.map((i, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${i.productName}</td>
                  <td>${i.quantity}</td>
                  <td style="text-align:right;">${i.price.toFixed(2)}</td>
                  <td style="text-align:right;">${i.subtotal ? i.subtotal.toFixed(2) : (i.quantity * i.price).toFixed(2)}</td>
                </tr>`).join("")
              : "<tr><td colspan='5'>No items</td></tr>"}
          </tbody>
        </table>

        <div class="totals">
          <p><b>Total:</b> KES ${p.totalAmount.toFixed(2)}</p>
          <p><b>Paid:</b> KES ${paid.toFixed(2)}</p>
          <p><b>Balance:</b> KES ${balance.toFixed(2)}</p>
        </div>

        <div class="footer">
          <p><!-- Footer message here --></p>
        </div>
      </body>
    </html>
  `;

  const w = window.open("", "_blank", "width=800,height=600");
  w.document.write(html);
  w.document.close();
  w.print();
}



function editPurchase(id) {
  alert(`Open edit form for purchase: ${id}`);
}

async function deletePurchase(id) {
  if (!confirm("Are you sure you want to delete this purchase?")) return;
  await firebase.firestore().collection("purchases").doc(id).delete();
  alert("Purchase deleted");
  showListPurchases();
}

async function exportPurchasesCSV() {
  try {
    const snapshot = await firebase.firestore().collection("purchases")
      .orderBy("purchaseDate", "desc")
      .get();

    if (snapshot.empty) {
      alert("No purchases to export");
      return;
    }

    let csv = "Date,Supplier,Total Amount,Amount Paid,Balance,Payment Method,Reference No\n";
    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
      const balance = (p.totalAmount || 0) - (p.amountPaid || 0);
      csv += `${date},"${p.supplier}",${p.totalAmount || 0},${p.amountPaid || 0},${balance},"${p.paymentMethod || ""}","${p.referenceNo || ""}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `purchases_${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function showPurchaseReturn() {
  saveLastPage("showPurchaseReturn");
  document.getElementById("content").innerHTML = `<h2>Purchase Return</h2><p>Coming soon...</p>`;
}


    function showRoles() { saveLastPage("showRoles"); document.getElementById("content").innerHTML = `<h2>Roles</h2><p>Define and manage user roles and permissions.</p>`; }
    function showFieldSales() { saveLastPage("showFieldSales"); document.getElementById("content").innerHTML = `<h2>Field Salespersons</h2><p>Assign and track sales agents working in the field.</p>`; }
    
	function showSuppliers() {
  saveLastPage("showSuppliers");
  document.getElementById("content").innerHTML = `
    <h2>Suppliers</h2>
    <input type="text" id="supplierName" placeholder="Supplier Name" required>
    <input type="text" id="supplierPhone" placeholder="Phone">
    <input type="email" id="supplierEmail" placeholder="Email">
    <input type="text" id="supplierAddress" placeholder="Address">
    <button onclick="addSupplier()">Add Supplier</button>
    <div id="supplierMessage" style="margin-top:10px; color:red;"></div>

    <h3>Existing Suppliers</h3>
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#eee;">
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="suppliersTable"></tbody>
    </table>
  `;

  loadSuppliers();
}

function addSupplier() {
  const name = document.getElementById("supplierName").value.trim();
  const phone = document.getElementById("supplierPhone").value.trim();
  const email = document.getElementById("supplierEmail").value.trim();
  const address = document.getElementById("supplierAddress").value.trim();
  const msg = document.getElementById("supplierMessage");

  if (!name) {
    msg.textContent = "Supplier name is required.";
    return;
  }

  firebase.firestore().collection("suppliers").add({
    name, phone, email, address,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    msg.style.color = "green";
    msg.textContent = "Supplier added successfully.";
    document.getElementById("supplierName").value = "";
    document.getElementById("supplierPhone").value = "";
    document.getElementById("supplierEmail").value = "";
    document.getElementById("supplierAddress").value = "";
    loadSuppliers();
  })
  .catch(err => {
    msg.style.color = "red";
    msg.textContent = "Error: " + err.message;
  });
}

function loadSuppliers() {
  const table = document.getElementById("suppliersTable");
  table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("suppliers").orderBy("name").get()
    .then(snapshot => {
      table.innerHTML = "";
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='5'>No suppliers found.</td></tr>";
        return;
      }
      snapshot.forEach(doc => {
        const s = doc.data();
        table.innerHTML += `
          <tr>
            <td>${s.name}</td>
            <td>${s.phone || ""}</td>
            <td>${s.email || ""}</td>
            <td>${s.address || ""}</td>
            <td><button style="background:red;color:white;" onclick="deleteSupplier('${doc.id}')">Delete</button></td>
          </tr>
        `;
      });
    })
    .catch(err => {
      table.innerHTML = `<tr><td colspan='5'>Error loading suppliers: ${err.message}</td></tr>`;
    });
}

function deleteSupplier(id) {
  if (!confirm("Delete this supplier?")) return;
  firebase.firestore().collection("suppliers").doc(id).delete()
    .then(() => loadSuppliers())
    .catch(err => alert("Error deleting: " + err.message));
}

    
	function showCustomers() { saveLastPage("showCustomers"); document.getElementById("content").innerHTML = `<h2>Customers</h2><p>View and manage your customer records here.</p>`; }
  </script>
</body>
</html>
