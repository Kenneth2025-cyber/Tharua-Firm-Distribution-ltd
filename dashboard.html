<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tharua Firm Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
    .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 230px; background-color: #2c3e50; color: white; padding-top: 20px; overflow-y: auto; transition: width 0.3s ease; }
    .sidebar.collapsed { width: 60px; }
    .sidebar h2 { text-align: center; margin-bottom: 20px; font-size: 18px; transition: opacity 0.3s ease; }
    .sidebar.collapsed h2 { opacity: 0; }
    .sidebar a { display: flex; align-items: center; padding: 12px 20px; color: white; text-decoration: none; transition: background 0.3s ease; font-size: 14px; cursor: pointer; }
    .sidebar a i { margin-right: 12px; font-size: 16px; }
    .sidebar a span { transition: opacity 0.3s ease; }
    .sidebar.collapsed a span { opacity: 0; pointer-events: none; }
    .sidebar a:hover { background-color: #34495e; }
    .dropdown a { font-size: 14px; color: white; padding: 10px 20px; display: flex; align-items: center; text-decoration: none; cursor: pointer; }
    .dropdown a:hover { background-color: #34495e; }
    .main-content { margin-left: 230px; padding: 20px; transition: margin-left 0.3s ease; }
    .main-content.collapsed { margin-left: 60px; }
    .toggle-btn { position: absolute; top: 10px; right: -15px; background-color: #2c3e50; color: white; border-radius: 50%; padding: 5px 7px; cursor: pointer; border: none; font-size: 14px; }
    .content-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 8px; margin: 8px 0 16px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #2c3e50; color: white; cursor: pointer; }
    button:hover { background-color: #34495e; }
    .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; text-align: center; }
    .button-grid div { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: transform 0.2s ease; }
    .button-grid div:hover { transform: scale(1.05); }
    .button-grid img { width: 50px; height: 50px; margin-bottom: 10px; }
	.edit-input {
  width: 80px;
  padding: 4px;
}

.btn-edit, .btn-save, .btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-edit {
  background-color: #2980b9;
}
.btn-save {
  background-color: #27ae60;
}
.btn-cancel {
  background-color: #c0392b;
}
/* General styles */
.user-form {
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.user-form input,
.user-form select,
.user-form button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.submit-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  cursor: pointer;
  padding: 8px 16px;
}

.submit-btn:hover {
  background-color: #34495e;
}

.table-container {
  overflow-x: auto;
}

.users-table {
  width: 100%;
  border-collapse: collapse;
}

.users-table th,
.users-table td {
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
}

.users-table th {
  background-color: #eee;
}

/* Desktop mode (default) */
.desktop-cell {
  white-space: nowrap;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.desktop-actions {
  white-space: nowrap;
}

/* Mobile mode */
@media (max-width: 768px) {
  .form-group {
    flex-direction: column;
  }

  .user-form input,
  .user-form select,
  .user-form button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 16px;
  }

  .table-container {
    overflow-x: auto;
  }

  .users-table {
    min-width: 600px;
  }

  .desktop-cell {
    display: block;
    word-wrap: break-word;
    max-width: 120px;
    padding: 6px;
  }

  .desktop-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 5px;
  }

  .desktop-actions span {
    margin: 0 !important;
    font-size: 18px;
  }

  .edit-input {
    width: 100px;
    padding: 6px;
    font-size: 14px;
  }
}

/* Ensure buttons are tappable */
button {
  min-height: 40px;
  touch-action: manipulation;
}

/* Edit mode buttons */
.btn-save,
.btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-save {
  background-color: #27ae60;
}

.btn-cancel {
  background-color: #c0392b;
}

 <!-- Inline CSS -->
 
      .spinner {
        display: inline-block;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2c3e50;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .edit-input {
        width: 100%;
        padding: 4px;
        box-sizing: border-box;
      }
      .error-row {
        color: red;
        text-align: center;
      }
	  .actions-cell button {
  font-size: 10px;    /* tiny icons */
  padding: 2px 4px;   /* shrink button area */
  margin: 0 1px;
  line-height: 1;     /* keep buttons compact */
}


  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">&#9776;</button>
    <h2>THARUA</h2>
    <a onclick="showHome()"><i class="fas fa-home"></i> <span>Home</span></a>

    <div class="dropdown">
      <a onclick="toggleUserManagement()" id="userMgmtMenu"><i class="fas fa-users-cog"></i> <span>User Management</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="userMgmtSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showUsers()"><span>Users</span></a>
        <a onclick="showRoles()"><span>Roles</span></a>
        <a onclick="showFieldSales()"><span>Field Salespersons</span></a>
      </div>
    </div>

    <div class="dropdown">
      <a onclick="toggleContacts()" id="contactsMenu"><i class="fas fa-address-book"></i> <span>Contacts</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="contactsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showSuppliers()"><span>Suppliers</span></a>
        <a onclick="showCustomers()"><span>Customers</span></a>
        <a onclick="clearContent()"><span>Customer Groups</span></a>
        <a onclick="clearContent()"><span>Import Contacts</span></a>
      </div>
    </div>

    <div class="dropdown">
  <a onclick="toggleProducts()" id="productsMenu"><i class="fas fa-boxes"></i> <span>Products</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
  <div id="productsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddProduct()"><span>Add Product</span></a>
    <a onclick="showListProducts()"><span>List of Products</span></a>
    <a onclick="showBusinessLocations()"><span>Business Location</span></a>
    <a onclick="showCategory()"><span>Category</span></a>
    <a onclick="showBrand()"><span>Brand</span></a>
  </div>
</div>

    <a onclick="clearContent()"><i class="fas fa-industry"></i> <span>Manufacturing</span></a>
	
<div class="dropdown">
  <a onclick="togglePurchases()" id="purchasesMenu">
    <i class="fas fa-shopping-cart"></i> 
    <span>Purchases</span> 
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="purchasesSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddPurchase()"><span>Add Purchase</span></a>
    <a onclick="showListPurchases()"><span>List of Purchases</span></a>
    <a onclick="showPurchaseReturn()"><span>Purchase Return</span></a>
  </div>
</div>


    <a onclick="clearContent()"><i class="fas fa-cash-register"></i> <span>Sell</span></a>
    <a onclick="clearContent()"><i class="fas fa-truck-moving"></i> <span>Stock Transfers</span></a>
    <a onclick="clearContent()"><i class="fas fa-balance-scale-left"></i> <span>Stock Adjustment</span></a>
    <a onclick="clearContent()"><i class="fas fa-file-invoice-dollar"></i> <span>Expenses</span></a>
    <a onclick="clearContent()"><i class="fas fa-calculator"></i> <span>Accounting</span></a>
    <a onclick="clearContent()"><i class="fas fa-robot"></i> <span>AI Assistance</span></a>
    <a onclick="clearContent()"><i class="fas fa-chart-line"></i> <span>Reports</span></a>
    <a onclick="clearContent()"><i class="fas fa-envelope"></i> <span>Notification Templates</span></a>
    <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
  </div>

  <div class="main-content" id="mainContent">
    <div id="content" class="content-section">
      <h1>Welcome to Tharua Firm</h1>
      <p>Click a menu item on the left to view more details.</p>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /* ---------- Toast + Sound helpers ---------- */
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime); // low pitch
    g.gain.setValueAtTime(0.002, ctx.currentTime);    // very low volume

    o.connect(g);
    g.connect(ctx.destination);
    o.start();

    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);

    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showSuccessNotification(message = "Success") {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;

  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: "#27ae60",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });

  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });

  playSuccessSound();

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

    const firebaseConfig = {
      apiKey: "AIzaSyCLRiUG0ePdP68nbjtptb5pbY34ohiUP30",
      authDomain: "tharuasystem.firebaseapp.com",
      projectId: "tharuasystem",
      storageBucket: "tharuasystem.appspot.com",
      messagingSenderId: "438210516373",
      appId: "1:438210516373:web:83c188e315a69165d5129c"
    };
    firebase.initializeApp(firebaseConfig);

    function saveLastPage(name) { localStorage.setItem("lastPage", name); }
    function saveSidebarState(state) { localStorage.setItem("sidebarState", state); }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; return; }
      restoreUIState();
    });

    function restoreUIState() {
      const sidebarState = localStorage.getItem("sidebarState");
      if (sidebarState === "collapsed") {
        document.getElementById("sidebar").classList.add("collapsed");
        document.getElementById("mainContent").classList.add("collapsed");
      }
      const lastPage = localStorage.getItem("lastPage");
      if (lastPage && typeof window[lastPage] === "function") {
        window[lastPage]();
      } else { showHome(); }
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        alert("Logged out successfully.");
        window.location.href = "login.html";
      }).catch(err => alert("Error logging out: " + err.message));
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("collapsed");
      document.getElementById("mainContent").classList.toggle("collapsed");
      saveSidebarState(document.getElementById("sidebar").classList.contains("collapsed") ? "collapsed" : "expanded");
    }

    function showHome() {
      saveLastPage("showHome");

      const savedLocation = localStorage.getItem("dashboardLocation") || "all";
      const savedStartDate = localStorage.getItem("dashboardStartDate") || "";
      const savedEndDate = localStorage.getItem("dashboardEndDate") || "";

      document.getElementById("content").innerHTML = `
        <h2>Dashboard Overview</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
          <select id="locationFilter" style="flex:1;">
            <option value="all">All Locations</option>
          </select>
          <input type="date" id="startDateFilter" style="flex:1;" />
          <input type="date" id="endDateFilter" style="flex:1;" />
          <button onclick="applyFilters()">Apply</button>
        </div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Sales</h3>
            <p id="salesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Purchases</h3>
            <p id="purchasesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Expenses</h3>
            <p id="expensesTotal">Loading...</p>
          </div>
        </div>
      `;

      document.getElementById("startDateFilter").value = savedStartDate;
      document.getElementById("endDateFilter").value = savedEndDate;

      loadLocations(savedLocation);
      loadTotal("sales", "salesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("purchases", "purchasesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("expenses", "expensesTotal", savedLocation, savedStartDate, savedEndDate);
    }

    function loadLocations(selectedValue) {
      const locationSelect = document.getElementById("locationFilter");
      locationSelect.innerHTML = `<option value="all">All Locations</option>`;

      firebase.firestore().collection("businessLocations").get().then(snapshot => {
        snapshot.forEach(doc => {
          const loc = doc.data();
          const opt = document.createElement("option");
          opt.value = loc.name;
          opt.textContent = loc.name;
          if (loc.name === selectedValue) opt.selected = true;
          locationSelect.appendChild(opt);
        });
      }).catch(err => console.error("Error loading locations:", err));
    }

    function applyFilters() {
      const loc = document.getElementById("locationFilter").value;
      const start = document.getElementById("startDateFilter").value;
      const end = document.getElementById("endDateFilter").value;

      localStorage.setItem("dashboardLocation", loc);
      localStorage.setItem("dashboardStartDate", start);
      localStorage.setItem("dashboardEndDate", end);

      showHome();
    }

    function loadTotal(type, elementId, location, startDate, endDate) {
  // Map each collection to its date and amount fields
  const dateFieldMap = { sales: "saleDate", purchases: "purchaseDate", expenses: "expenseDate" };
  const amountFieldMap = { sales: "totalAmount", purchases: "totalAmount", expenses: "amount" };

  const dateField = dateFieldMap[type] || "date";
  const amountField = amountFieldMap[type] || "amount";

  let query = firebase.firestore().collection(type);

  if (location && location !== "all") {
    query = query.where("location", "==", location);
  }

  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setDate(end.getDate() + 1); // make end exclusive
    query = query.where(dateField, ">=", start).where(dateField, "<", end);
  }

  query.get().then(snap => {
    let total = 0;
    snap.forEach(doc => {
      const data = doc.data();
      // Prefer the mapped amount field, but fall back gracefully
      const value =
        (data && (
          (amountField in data ? data[amountField] : undefined) ??
          data.totalAmount ??
          data.amount ??
          data.net ??
          0
        )) || 0;
      total += Number(value) || 0;
    });

    const el = document.getElementById(elementId);
    if (el) el.textContent = "KES " + total.toLocaleString();
  }).catch(err => {
    console.error("loadTotal error:", err);
    const el = document.getElementById(elementId);
    if (el) el.textContent = "Error";
  });
}

function clearContent() { saveLastPage("clearContent"); document.getElementById("content").innerHTML = `<h2>Section Under Development</h2><p>Content will be added soon. Please check back later.</p>`; }
    function toggleContacts() { const s = document.getElementById("contactsSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
    function toggleUserManagement() { const s = document.getElementById("userMgmtSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
	
function showUsers() {
  saveLastPage("showUsers");
  document.getElementById("content").innerHTML = `
    <h2>Manage Users</h2>

    <!-- Create User Form -->
    <div class="user-form">
      <div class="form-group">
        <input type="text" id="newName" placeholder="Full Name" required>
        <input type="email" id="newEmail" placeholder="Email" required>
        <input type="password" id="newPassword" placeholder="Password" required>
        <select id="newRole">
          <option value="">Select Role</option>
          <option value="admin">Admin</option>
          <option value="cashier">Cashier</option>
          <option value="salesperson">Salesperson</option>
        </select>
        <button onclick="createUser()" class="submit-btn">Create User</button>
      </div>
    </div>

    <!-- Existing Users Table -->
    <h3>Existing Users</h3>
    <div class="table-container">
      <table border="1" cellpadding="8" cellspacing="0" class="users-table">
        <thead>
          <tr style="background:#eee;">
            <th>Username</th>
            <th>Name</th>
            <th>Role</th>
            <th>Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  `;

  loadUsers();
}

function loadUsers() {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("users").get()
    .then(snapshot => {
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const u = doc.data();
        tbody.innerHTML += `
          <tr data-id="${doc.id}">
            <td class="desktop-cell">${doc.id || ""}</td>
            <td class="editable desktop-cell" data-field="name">${u.name || ""}</td>
            <td class="editable desktop-cell" data-field="role">${u.role || ""}</td>
            <td class="editable desktop-cell" data-field="email">${u.email || ""}</td>
            <td class="desktop-actions">
              <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
              <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${doc.id}')">👁</span>
              <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${doc.id}')">🗑</span>
            </td>
          </tr>
        `;
      });
    })
    .catch(err => {
      tbody.innerHTML = `<tr><td colspan='5'>Error loading users: ${err.message}</td></tr>`;
    });
}

// Enter edit mode for a user row
function enterEditMode(editSpan) {
  const row = editSpan.closest('tr');
  const userId = row.getAttribute('data-id');
  const cells = row.querySelectorAll('.editable');

  const originalData = {};
  cells.forEach(cell => {
    originalData[cell.getAttribute('data-field')] = cell.textContent;
  });

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    let input;
    if (field === 'role') {
      input = document.createElement('select');
      input.className = 'edit-input';
      ['admin', 'cashier', 'salesperson'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (role === cell.textContent) option.selected = true;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = field === 'email' ? 'email' : 'text';
      input.className = 'edit-input';
      input.value = cell.textContent || '';
    }
    cell.innerHTML = '';
    cell.appendChild(input);
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <button class="btn-save submit-btn" onclick="saveUser('${userId}', this)">Save</button>
    <button class="btn-cancel submit-btn" onclick="cancelEdit(this, ${JSON.stringify(originalData)})">Cancel</button>
  `;
}

// Save edited user data
async function saveUser(userId, saveButton) {
  const row = saveButton.closest('tr');
  const cells = row.querySelectorAll('.editable');
  const updatedData = {};

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    const input = cell.querySelector('input, select');
    updatedData[field] = input.value;
  });

  try {
    await firebase.firestore().collection("users").doc(userId).update(updatedData);
    showSuccessNotification("User updated successfully.");
    loadUsers();
  } catch (err) {
    alert("Error updating user: " + err.message);
  }
}

// Cancel edit mode and revert to original values
function cancelEdit(cancelButton, originalData) {
  const row = cancelButton.closest('tr');
  const cells = row.querySelectorAll('.editable');

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    cell.innerHTML = originalData[field] || '';
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
    <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${row.getAttribute('data-id')}')">👁</span>
    <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${row.getAttribute('data-id')}')">🗑</span>
  `;
}

// Existing functions remain unchanged
function createUser() {
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if (!name || !email || !password || !role) {
    alert("Please fill in all fields and select a role.");
    return;
  }

  firebase.firestore().collection("users").add({
    name: name,
    email: email,
    password: password,
    role: role,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("User created successfully.");
    document.getElementById("newName").value = "";
    document.getElementById("newEmail").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("newRole").value = "";
    loadUsers();
  })
  .catch(error => {
    alert("Error creating user: " + error.message);
  });
}

function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  firebase.firestore().collection("users").doc(userId).delete()
  .then(() => {
    alert("User deleted successfully.");
    loadUsers();
  })
  .catch(err => alert("Error deleting user: " + err.message));
}

function editUser(userId) {
  alert("Edit feature coming soon for user ID: " + userId);
}

function viewUser(userId) {
  alert("View feature coming soon for user ID: " + userId);
}

function toggleProducts() {
  const submenu = document.getElementById("productsSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddProduct() {
  saveLastPage("showAddProduct");

  // Load categories, brands, and locations from Firestore
  const categories = await getCollectionOptions("categories");
  const brands = await getCollectionOptions("brands");
  const locations = await getCollectionOptions("businessLocations");

  document.getElementById("content").innerHTML = `
    <h2>Add Product</h2>
    <form id="addProductForm">
      <label>Product Name *</label>
      <input type="text" id="productName" placeholder="Enter product name" required />

      <!-- SKU will be generated automatically, no input -->

      <label>Category *</label>
      <select id="category" required>
        <option value="">Select category</option>
        ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
      </select>

      <label>Brand *</label>
      <select id="brand" required>
        <option value="">Select brand</option>
        ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}
      </select>

      <label>Buying Price (KES) *</label>
      <input type="number" id="buyingPrice" min="0" step="0.01" placeholder="Enter buying price" required />

      <label>Selling Price (KES) *</label>
      <input type="number" id="sellingPrice" min="0" step="0.01" placeholder="Enter selling price" required />

      <label>Opening Stock</label>
      <input type="number" id="openingStock" min="0" step="1" placeholder="Enter opening stock" />

      <label>Business Location *</label>
      <select id="businessLocation" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <button type="submit">Add Product</button>
    </form>
    <div id="addProductMessage" style="color: red; margin-top: 10px;"></div>
  `;

  document.getElementById("addProductForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addProductSubmit();
  });
}

async function getCollectionOptions(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).get();
    return snapshot.docs.map(doc => doc.data().name || doc.id);
  } catch (error) {
    console.error(`Error loading ${collectionName}:`, error);
    return [];
  }
}

async function addProductSubmit() {
  const name = document.getElementById("productName").value.trim();
  const category = document.getElementById("category").value;
  const brand = document.getElementById("brand").value;
  const buyingPrice = parseFloat(document.getElementById("buyingPrice").value);
  const sellingPrice = parseFloat(document.getElementById("sellingPrice").value);
  const openingStock = parseInt(document.getElementById("openingStock").value) || 0;
  const location = document.getElementById("businessLocation").value;

  const messageEl = document.getElementById("addProductMessage");
  messageEl.style.color = "red";

  // Basic validation
  if (!name || !category || !brand || isNaN(buyingPrice) || isNaN(sellingPrice) || !location) {
    messageEl.textContent = "Please fill in all required fields correctly.";
    return;
  }

  if (buyingPrice < 0 || sellingPrice < 0 || openingStock < 0) {
    messageEl.textContent = "Prices and stock cannot be negative.";
    return;
  }

  // Generate SKU - e.g. PROD + timestamp + random number
  const sku = `PROD-${Date.now()}-${Math.floor(Math.random() * 9000 + 1000)}`;

  const productData = {
    name,
    sku,
    category,
    brand,
    buyingPrice,
    sellingPrice,
    openingStock,
    location,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await firebase.firestore().collection("products").add(productData);
    messageEl.style.color = "green";
    messageEl.textContent = `Product added successfully with SKU: ${sku}`;

    // Clear form
    document.getElementById("addProductForm").reset();
  } catch (error) {
    console.error("Error adding product:", error);
    messageEl.textContent = "Error adding product: " + error.message;
  }
}


// Initialize productManager with default filter values
const productManager = {
  products: [],
  locations: [],
  categories: [],
  brands: [],
  selectedLocation: "all",
  selectedCategory: "all",
  selectedBrand: "all"
};

function showListProducts() {
  if (typeof saveLastPage === "function") saveLastPage("showListProducts");

  document.getElementById("content").innerHTML = `
    <style>
      .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        border: 1px solid #e0e0e0;
      }
      .filter-section label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }
      .filter-section select, .filter-section input[type="text"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        min-width: 180px;
        background: #fff;
        transition: border-color 0.2s;
      }
      .filter-section select:focus, .filter-section input[type="text"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
      }
      .filter-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .filter-section .apply-btn {
        background: #007bff;
        color: white;
      }
      .filter-section .apply-btn:hover {
        background: #0056b3;
      }
      .filter-section .export-btn {
        background: #28a745;
        color: white;
      }
      .filter-section .export-btn:hover {
        background: #218838;
      }
      .filter-section .search-help {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
      @media (max-width: 600px) {
        .filter-section select, .filter-section input[type="text"] {
          min-width: 100%;
        }
        .filter-section {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
    <h2>List of Products</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <label for="locationFilter">Filter by Location:</label>
      <select id="locationFilter" aria-label="Filter by location">
        <option value="all">All Locations</option>
      </select>

      <label for="categoryFilter">Filter by Category:</label>
      <select id="categoryFilter" aria-label="Filter by category">
        <option value="all">All Categories</option>
      </select>

      <label for="brandFilter">Filter by Brand:</label>
      <select id="brandFilter" aria-label="Filter by brand">
        <option value="all">All Brands</option>
      </select>

      <label for="searchProduct">Search Product:</label>
      <input
        type="text"
        id="searchProduct"
        placeholder="Type at least 3 characters..."
        aria-label="Search products by name"
        aria-describedby="searchHelpText"
      />
      <span id="searchHelpText" class="search-help">Search activates at 3+ characters</span>

      <button id="applyProductFilterBtn" class="apply-btn">Apply Filter</button>
      <button id="exportBtn" class="export-btn">Export</button>
    </div>

    <!-- Products Table -->
    <table role="grid" border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th scope="col">Product Name</th>
          <th scope="col">Category</th>
          <th scope="col">Brand</th>
          <th scope="col">Buying Price (KES)</th>
          <th scope="col">Selling Price (KES)</th>
          <th scope="col">Opening Stock</th>
          <th scope="col">Location</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="productsTbody" aria-live="polite" aria-busy="true">
        <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  `;

  // Load all data and then render the table
  Promise.all([
    loadLocations(),
    loadCategories(),
    loadBrands(),
    loadProducts()
  ]).then(() => {
    renderProductsTable(); // Render only after all data is loaded
  }).catch(err => {
    console.error("Error loading data:", err);
    const tbody = document.getElementById("productsTbody");
    tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load data: ${escapeHTML(err.message)}</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
  });

  // Debounced search (3+ chars)
  let debounceTimeout;
  document.getElementById("searchProduct").addEventListener("input", () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      const searchText = document.getElementById("searchProduct").value.toLowerCase();
      renderProductsTable(searchText);
    }, 300);
  });

  // Apply filter button
  document.getElementById("applyProductFilterBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    productManager.selectedLocation = document.getElementById("locationFilter").value;
    productManager.selectedCategory = document.getElementById("categoryFilter").value;
    productManager.selectedBrand = document.getElementById("brandFilter").value;
    renderProductsTable(searchText);
  });

  // Instant filter on location change
  document.getElementById("locationFilter").addEventListener("change", () => {
    productManager.selectedLocation = document.getElementById("locationFilter").value;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on category change
  document.getElementById("categoryFilter").addEventListener("change", () => {
    productManager.selectedCategory = document.getElementById("categoryFilter").value;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on brand change
  document.getElementById("brandFilter").addEventListener("change", () => {
    productManager.selectedBrand = document.getElementById("brandFilter").value;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Export (uses filtered + searched list)
  document.getElementById("exportBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    exportProductsCSV(searchText);
  });
}

// ==========================
// Helpers / Config
// ==========================
const MIN_SEARCH_CHARS = 3;
const fmtKES = (v) => (Number(v) || 0).toLocaleString("en-KE", { style: "currency", currency: "KES" });

// ==========================
// Load Locations
// ==========================
function loadLocations() {
  return firebase.firestore().collection("businessLocations").get()
    .then(snapshot => {
      productManager.locations = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.name) productManager.locations.push(data.name);
      });

      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="all">All Locations</option>`;
      productManager.locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading locations:", err);
      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="all">All Locations</option>`;
    });
}

// ==========================
// Load Categories
// ==========================
function loadCategories() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.categories = [];
      const categorySet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.category) categorySet.add(data.category);
      });
      productManager.categories = Array.from(categorySet).sort();

      const select = document.getElementById("categoryFilter");
      select.innerHTML = `<option value="all">All Categories</option>`;
      productManager.categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading categories:", err);
      const select = document.getElementById("categoryFilter");
      select.innerHTML = `<option value="all">All Categories</option>`;
    });
}

// ==========================
// Load Brands
// ==========================
function loadBrands() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.brands = [];
      const brandSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.brand) brandSet.add(data.brand);
      });
      productManager.brands = Array.from(brandSet).sort();

      const select = document.getElementById("brandFilter");
      select.innerHTML = `<option value="all">All Brands</option>`;
      productManager.brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        select.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading brands:", err);
      const select = document.getElementById("brandFilter");
      select.innerHTML = `<option value="all">All Brands</option>`;
    });
}

// ==========================
// Load Products
// ==========================
function loadProducts() {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");
  tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><span class="spinner"></span>Loading...</td></tr>`;

  return firebase.firestore().collection("products").orderBy("name").get()
    .then(snapshot => {
      productManager.products = [];
      snapshot.forEach(doc => {
        productManager.products.push({ id: doc.id, ...doc.data() });
      });
    })
    .catch(err => {
      console.error("Error loading products:", err);
      const tbody = document.getElementById("productsTbody");
      tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load products: ${escapeHTML(err.message)}</td></tr>`;
      tbody.setAttribute("aria-busy", "false");
    });
}

// ==========================
// Common filter logic
// ==========================
function getFilteredProducts(searchText = "") {
  let filtered = productManager.products;

  // Filter by location
  if (productManager.selectedLocation && productManager.selectedLocation !== "all") {
    filtered = filtered.filter(p => p.location === productManager.selectedLocation);
  }

  // Filter by category
  if (productManager.selectedCategory && productManager.selectedCategory !== "all") {
    filtered = filtered.filter(p => p.category === productManager.selectedCategory);
  }

  // Filter by brand
  if (productManager.selectedBrand && productManager.selectedBrand !== "all") {
    filtered = filtered.filter(p => p.brand === productManager.selectedBrand);
  }

  // Apply search filter
  const q = (searchText || "").toLowerCase();
  if (q.length >= MIN_SEARCH_CHARS) {
    filtered = filtered.filter(p =>
      (p.name && String(p.name).toLowerCase().includes(q))
    );
  }
  return filtered;
}

// ==========================
// Render Products + Totals
// ==========================
function renderProductsTable(searchText = "") {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");

  const filteredProducts = getFilteredProducts(searchText);

  if (!filteredProducts.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No products found.</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  filteredProducts.forEach(product => {
    fragment.appendChild(createProductRow(product));

    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;
  });

  const tr = document.createElement("tr");
  tr.style.background = "#f9f9f9";
  tr.style.fontWeight = "bold";
  tr.innerHTML = `
    <td colspan="3" style="text-align:right;">Totals:</td>
    <td>${fmtKES(totalBuying)}</td>
    <td>${fmtKES(totalSelling)}</td>
    <td>${totalStock}</td>
    <td colspan="2"></td>
  `;
  fragment.appendChild(tr);

  tbody.innerHTML = "";
  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// ==========================
// Create Row (emoji icons)
// ==========================
function createProductRow(product) {
  const buying = fmtKES(product.buyingPrice);
  const selling = fmtKES(product.sellingPrice);
  const stock = Number(product.openingStock) || 0;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="name-cell">${escapeHTML(product.name)}</td>
    <td class="category-cell">${escapeHTML(product.category)}</td>
    <td class="brand-cell">${escapeHTML(product.brand)}</td>
    <td class="buying-price-cell">${buying}</td>
    <td class="selling-price-cell">${selling}</td>
    <td class="stock-cell">${stock}</td>
    <td class="location-cell">${escapeHTML(product.location)}</td>
    <td class="actions-cell" style="white-space:nowrap;">
      <span title="View" style="cursor:pointer; color:green; margin-right:6px;">👁</span>
      <span title="Edit" style="cursor:pointer; color:#2980b9; margin-right:6px;">✏</span>
      <span title="Delete" style="cursor:pointer; color:red;">🗑</span>
    </td>
  `;

  // View action
  tr.querySelector('[title="View"]').addEventListener("click", () => {
    alert(`
      Product Details:
      Name: ${escapeHTML(product.name)}
      Category: ${escapeHTML(product.category)}
      Brand: ${escapeHTML(product.brand)}
      Buying Price: ${buying}
      Selling Price: ${selling}
      Opening Stock: ${stock}
      Location: ${escapeHTML(product.location)}
    `);
  });

  // Edit action
  tr.querySelector('[title="Edit"]').addEventListener("click", () => {
    enterEditMode(tr, product);
  });

  // Delete action
  tr.querySelector('[title="Delete"]').addEventListener("click", async () => {
    if ( personallyconfirm(`Are you sure you want to delete ${escapeHTML(product.name)}?`)) {
      try {
        await firebase.firestore().collection("products").doc(product.id).delete();
        productManager.products = productManager.products.filter(p => p.id !== product.id);
        renderProductsTable(document.getElementById("searchProduct").value.toLowerCase());
      } catch (err) {
        alert(`Error deleting product: ${err.message}`);
      }
    }
  });

  return tr;
}

// ==========================
// Edit Mode (emoji save/cancel)
// ==========================
function enterEditMode(row, product) {
  row.querySelector(".name-cell").innerHTML = `<input type="text" class="edit-input name-input" value="${escapeHTML(product.name)}" aria-label="Edit Product Name" />`;
  row.querySelector(".category-cell").innerHTML = `<input type="text" class="edit-input category-input" value="${escapeHTML(product.category)}" aria-label="Edit Category" />`;
  row.querySelector(".brand-cell").innerHTML = `<input type="text" class="edit-input brand-input" value="${escapeHTML(product.brand)}" aria-label="Edit Brand" />`;
  row.querySelector(".buying-price-cell").innerHTML = `<input type="number" min="0" step="0.01" class="edit-input buying-input" value="${Number(product.buyingPrice) || 0}" aria-label="Edit Buying Price" />`;
  row.querySelector(".selling-price-cell").innerHTML = `<input type="number" min="0" step="0.01" class="edit-input selling-input" value="${Number(product.sellingPrice) || 0}" aria-label="Edit Selling Price" />`;
  row.querySelector(".stock-cell").innerHTML = `<input type="number" min="0" step="1" class="edit-input stock-input" value="${Number(product.openingStock) || 0}" aria-label="Edit Opening Stock" />`;
  row.querySelector(".location-cell").innerHTML = `
    <select class="edit-input location-input" aria-label="Edit Location">
      <option value="">Select Location</option>
      ${productManager.locations.map(loc => `<option value="${escapeHTML(loc)}" ${loc === product.location ? "selected" : ""}>${escapeHTML(loc)}</option>`).join("")}
    </select>
  `;

  const actionsCell = row.querySelector(".actions-cell");
  actionsCell.innerHTML = `
    <span class="btn-save" title="Save" style="cursor:pointer; color:green; margin-right:6px;">💾</span>
    <span class="btn-cancel" title="Cancel" style="cursor:pointer; color:red;">❌</span>
  `;
  row.querySelector(".name-input").focus();

  actionsCell.querySelector(".btn-save").addEventListener("click", async () => {
    const newData = {
      name: row.querySelector(".name-input").value.trim(),
      category: row.querySelector(".category-input").value.trim(),
      brand: row.querySelector(".brand-input").value.trim(),
      buyingPrice: Number(row.querySelector(".buying-input").value),
      sellingPrice: Number(row.querySelector(".selling-input").value),
      openingStock: parseInt(row.querySelector(".stock-input").value, 10),
      location: row.querySelector(".location-input").value,
    };

    if (!newData.name || !newData.category || !newData.brand || !newData.location) {
      alert("Please fill in all required fields.");
      return;
    }
    if (isNaN(newData.buyingPrice) || newData.buyingPrice < 0) {
      alert("Buying price must be a valid non-negative number.");
      return;
    }
    if (isNaN(newData.sellingPrice) || newData.sellingPrice < 0) {
      alert("Selling price must be a valid non-negative number.");
      return;
    }
    if (isNaN(newData.openingStock) || newData.openingStock < 0) {
      alert("Opening stock must be a valid non-negative number.");
      return;
    }

    try {
      await firebase.firestore().collection("products").doc(product.id).update(newData);
      Object.assign(product, newData);
      // Reload categories and brands to reflect any changes
      Promise.all([loadCategories(), loadBrands()]).then(() => {
        renderProductsTable(document.getElementById("searchProduct").value.toLowerCase());
      });
    } catch (err) {
      alert(`Error updating product: ${err.message}`);
    }
  });

  actionsCell.querySelector(".btn-cancel").addEventListener("click", () => {
    const newRow = createProductRow(product);
    row.replaceWith(newRow);
  });
}

// ==========================
// Export CSV with Current Filters
// ==========================
function exportProductsCSV(searchText = "") {
  const headers = ["Name", "Category", "Brand", "Buying Price", "Selling Price", "Opening Stock", "Location"];
  const csvRows = [headers.join(",")];

  const list = getFilteredProducts(searchText);

  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  list.forEach(product => {
    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;

    const row = [
      `"${(product.name ?? "").replace(/"/g, '""')}"`,
      `"${(product.category ?? "").replace(/"/g, '""')}"`,
      `"${(product.brand ?? "").replace(/"/g, '""')}"`,
      (Number(product.buyingPrice) || 0).toFixed(2),
      (Number(product.sellingPrice) || 0).toFixed(2),
      stock,
      `"${(product.location ?? "").replace(/"/g, '""')}"`,
    ];
    csvRows.push(row.join(","));
  });

  csvRows.push([
    "Totals", "", "",
    totalBuying.toFixed(2),
    totalSelling.toFixed(2),
    totalStock,
    ""
  ].join(","));

  const csvContent = csvRows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "products.csv";
  link.click();
  URL.revokeObjectURL(link.href);
}

// ==========================
// Escape HTML
// ==========================
function escapeHTML(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  })[m]);
}



async function addBusinessLocation() {
  const nameInput = document.getElementById("newLocationName");
  const addressInput = document.getElementById("newLocationAddress");
  const messageEl = document.getElementById("locationMessage");

  const name = nameInput.value.trim();
  const address = addressInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Location name cannot be empty.";
    return;
  }

  const existing = await firebase.firestore().collection("businessLocations").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Location already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("businessLocations").add({
      name,
      address: address || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Location "${name}" added successfully.`;
    nameInput.value = "";
    addressInput.value = "";

    const locations = await loadCollection("businessLocations");
    renderLocationList(locations);
  } catch (error) {
    console.error("Error adding location:", error);
    messageEl.textContent = "Error adding location: " + error.message;
  }
}

async function deleteBusinessLocation(id) {
  if (!confirm("Are you sure you want to delete this location?")) return;

  try {
    await firebase.firestore().collection("businessLocations").doc(id).delete();
    const messageEl = document.getElementById("locationMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Location deleted.";

    const locations = await loadCollection("businessLocations");
    renderLocationList(locations);
  } catch (error) {
    alert("Error deleting location: " + error.message);
  }
}

async function showCategory() {
  saveLastPage("showCategory");

  // Load existing categories
  const categories = await loadCollection("categories");

  document.getElementById("content").innerHTML = `
    <h2>Manage Categories</h2>
    <input type="text" id="newCategoryName" placeholder="New category name" />
    <button onclick="addCategory()">Add Category</button>
    <div id="categoryMessage" style="margin-top:10px;"></div>

    <h3>Existing Categories</h3>
    <ul id="categoryList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderCategoryList(categories);
}

async function loadCollection(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).orderBy("name").get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    console.error(`Error loading ${collectionName}:`, err);
    return [];
  }
}

function renderCategoryList(categories) {
  const ul = document.getElementById("categoryList");
  ul.innerHTML = "";
  if (categories.length === 0) {
    ul.innerHTML = "<li>No categories found.</li>";
    return;
  }
  categories.forEach(cat => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${cat.name} 
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteCategory('${cat.id}')">Delete</button>
      </li>`;
  });
}

async function addCategory() {
  const nameInput = document.getElementById("newCategoryName");
  const messageEl = document.getElementById("categoryMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Category name cannot be empty.";
    return;
  }

  // Check if category already exists (optional)
  const existing = await firebase.firestore().collection("categories").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Category already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("categories").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Category "${name}" added successfully.`;
    nameInput.value = "";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    console.error("Error adding category:", error);
    messageEl.textContent = "Error adding category: " + error.message;
  }
}

async function deleteCategory(id) {
  if (!confirm("Are you sure you want to delete this category?")) return;

  try {
    await firebase.firestore().collection("categories").doc(id).delete();
    const messageEl = document.getElementById("categoryMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Category deleted.";

    // Reload list
    const categories = await loadCollection("categories");
    renderCategoryList(categories);
  } catch (error) {
    alert("Error deleting category: " + error.message);
  }
}


async function showBrand() {
  saveLastPage("showBrand");
  const brands = await loadCollection("brands");

  document.getElementById("content").innerHTML = `
    <h2>Manage Brands</h2>
    <input type="text" id="newBrandName" placeholder="New brand name" />
    <button onclick="addBrand()">Add Brand</button>
    <div id="brandMessage" style="margin-top:10px;"></div>

    <h3>Existing Brands</h3>
    <ul id="brandList" style="list-style:none; padding-left:0;"></ul>
  `;

  renderBrandList(brands);
}

function renderBrandList(brands) {
  const ul = document.getElementById("brandList");
  ul.innerHTML = "";
  if (brands.length === 0) {
    ul.innerHTML = "<li>No brands found.</li>";
    return;
  }
  brands.forEach(brand => {
    ul.innerHTML += `
      <li style="display:flex; justify-content:space-between; align-items:center; padding:4px 0;">
        ${brand.name}
        <button style="background:red;color:white; border:none; cursor:pointer;" onclick="deleteBrand('${brand.id}')">Delete</button>
      </li>`;
  });
}

async function addBrand() {
  const nameInput = document.getElementById("newBrandName");
  const messageEl = document.getElementById("brandMessage");
  const name = nameInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Brand name cannot be empty.";
    return;
  }

  const existing = await firebase.firestore().collection("brands").where("name", "==", name).get();
  if (!existing.empty) {
    messageEl.textContent = "Brand already exists.";
    return;
  }

  try {
    await firebase.firestore().collection("brands").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageEl.style.color = "green";
    messageEl.textContent = `Brand "${name}" added successfully.`;
    nameInput.value = "";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    console.error("Error adding brand:", error);
    messageEl.textContent = "Error adding brand: " + error.message;
  }
}

async function deleteBrand(id) {
  if (!confirm("Are you sure you want to delete this brand?")) return;

  try {
    await firebase.firestore().collection("brands").doc(id).delete();
    const messageEl = document.getElementById("brandMessage");
    messageEl.style.color = "green";
    messageEl.textContent = "Brand deleted.";

    const brands = await loadCollection("brands");
    renderBrandList(brands);
  } catch (error) {
    alert("Error deleting brand: " + error.message);
  }
}
function togglePurchases() {
  const submenu = document.getElementById("purchasesSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddPurchase() {
  saveLastPage("showAddPurchase");

  const suppliers = await getCollectionOptions("suppliers");
  const locations = await getCollectionOptions("businessLocations");
  const products = await getCollectionOptions("products");

  document.getElementById("content").innerHTML = `
    <h2>Add Purchase</h2>
    <form id="addPurchaseForm">
      <label>Supplier *</label>
      <select id="supplier" required>
        <option value="">Select supplier</option>
        ${suppliers.map(s => `<option value="${s}">${s}</option>`).join("")}
      </select>

      <label>Purchase Date *</label>
      <input type="date" id="purchaseDate" required>

      <label>Business Location *</label>
      <select id="location" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <label>Reference No.</label>
      <input type="text" id="referenceNo" placeholder="Optional">

      <h3>Products</h3>
      <div id="purchaseItems"></div>
      <button type="button" onclick="addPurchaseItem('${products.join(",")}')">+ Add Item</button>

      <p><strong>Total Amount:</strong> KES <span id="totalAmount">0</span></p>

      <label>Amount Paid</label>
      <input type="number" id="amountPaid" min="0" step="0.01" value="0">

      <label>Payment Method</label>
      <select id="paymentMethod">
        <option value="Cash">Cash</option>
        <option value="MPesa">MPesa</option>
        <option value="Bank">Bank</option>
        <option value="Credit">Credit</option>
      </select>

      <label>Notes</label>
      <textarea id="notes"></textarea>

      <button type="submit">Save Purchase</button>
    </form>
    <div id="purchaseMessage" style="margin-top:10px; color:red;"></div>
  `;

  document.getElementById("addPurchaseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await savePurchase();
  });
}

function addPurchaseItem(productsList) {
  let table = document.getElementById("purchaseItemsTable");

  // If table doesn't exist yet, create it
  if (!table) {
    const itemsDiv = document.getElementById("purchaseItems");
    itemsDiv.innerHTML = `
      <table id="purchaseItemsTable" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead style="background:#f0f0f0;">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price (KES)</th>
            <th>Subtotal (KES)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="purchaseItemsBody"></tbody>
      </table>
    `;
    table = document.getElementById("purchaseItemsTable");
  }

  const tbody = document.getElementById("purchaseItemsBody");

  // Create a new row
  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="item-index"></td>
    <td>
      <select class="purchaseProduct">
        ${productsList.split(",").map(p => `<option value="${p}">${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" class="purchaseQty" min="1" value="1" style="width:70px;"></td>
    <td><input type="number" class="purchasePrice" min="0" step="0.01" value="0" style="width:90px;"></td>
    <td class="itemSubtotal">0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove(); updatePurchaseIndexes(); updatePurchaseTotal()">Remove</button></td>
  `;

  // Insert row at the TOP (latest item = #1)
  if (tbody.firstChild) {
    tbody.insertBefore(row, tbody.firstChild);
  } else {
    tbody.appendChild(row);
  }

  // Bind input events
  row.querySelector(".purchaseQty").addEventListener("input", () => updateRowSubtotal(row));
  row.querySelector(".purchasePrice").addEventListener("input", () => updateRowSubtotal(row));

  // Update numbering and totals
  updatePurchaseIndexes();
  updateRowSubtotal(row);
  updatePurchaseTotal();
}

function updateRowSubtotal(row) {
  const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
  const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
  const subtotal = qty * price;
  row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  updatePurchaseTotal();
}

function updatePurchaseIndexes() {
  const rows = document.querySelectorAll("#purchaseItemsBody tr");
  rows.forEach((r, i) => {
    r.querySelector(".item-index").textContent = i + 1;
  });
}

function updatePurchaseTotal() {
  let total = 0;

  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
    const subtotal = qty * price;
    total += subtotal;

    // Update the row subtotal cell
    row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}


async function savePurchase() {
  const supplier = document.getElementById("supplier").value;
  const date = document.getElementById("purchaseDate").value;
  const location = document.getElementById("location").value;
  const referenceNo = document.getElementById("referenceNo").value;
  const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
  const paymentMethod = document.getElementById("paymentMethod").value;
  const notes = document.getElementById("notes").value;

  const items = [];
  let totalAmount = 0;

  // Collect data from the table rows
  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const productName = row.querySelector(".purchaseProduct")?.value;
    const quantity = parseFloat(row.querySelector(".purchaseQty")?.value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice")?.value) || 0;
    const subtotal = quantity * price;

    if (productName && quantity > 0 && price >= 0) {
      items.push({ productName, quantity, price, subtotal });
      totalAmount += subtotal;
    }
  });

  if (!supplier || !date || !location || items.length === 0) {
    document.getElementById("purchaseMessage").textContent =
      "Please fill in all required fields and add at least one valid item.";
    return;
  }

  try {
    // 1️⃣ Save purchase in Firestore
    await firebase.firestore().collection("purchases").add({
      supplier,
      purchaseDate: new Date(date),
      location,
      referenceNo,
      items,
      totalAmount,
      amountPaid,
      paymentMethod,
      notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2️⃣ Update stock and buying price for each product
    for (const item of items) {
      const productRef = firebase.firestore().collection("products").where("name", "==", item.productName);
      const snapshot = await productRef.get();

      snapshot.forEach(async doc => {
        const productData = doc.data();
        const currentStock = productData.openingStock || 0;
        const currentBuyingPrice = productData.buyingPrice || 0;

        const newStock = currentStock + item.quantity;
        const newBuyingPrice = newStock > 0
          ? ((currentStock * currentBuyingPrice) + (item.quantity * item.price)) / newStock
          : item.price;

        await firebase.firestore().collection("products").doc(doc.id).update({
          openingStock: newStock,
          buyingPrice: parseFloat(newBuyingPrice.toFixed(2))
        });
      });
    }

    // 3️⃣ Reset form
    document.getElementById("addPurchaseForm").reset();
    document.getElementById("purchaseItems").innerHTML = "";
    document.getElementById("totalAmount").textContent = "0";
    const messageEl = document.getElementById("purchaseMessage");
    if (messageEl) {
      messageEl.style.color = "green";
      messageEl.textContent = ""; // keep toast as primary feedback
    }

    // Show green toast + play low success sound
    showSuccessNotification("Purchase saved successfully.");

  } catch (error) {
    document.getElementById("purchaseMessage").textContent =
      "Error saving purchase: " + error.message;
  }
}

async function showListPurchases() {
  saveLastPage("showListPurchases");

  document.getElementById("content").innerHTML = `
    <h2>List of Purchases</h2>

    <!-- Filter Section -->
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <select id="filterLocation" style="min-width:160px; padding:5px;">
        <option value="all">All Locations</option>
      </select>
      <select id="filterSupplier" style="min-width:160px; padding:5px;">
        <option value="all">All Suppliers</option>
      </select>

      <!-- Date filter -->
      <div style="position:relative;">
        <button id="dateFilterBtn" style="padding:6px 12px; cursor:pointer;">Date: All</button>
        <div id="dateFilterMenu" 
          style="display:none; position:absolute; top:35px; left:0; background:white; border:1px solid #ccc; 
                 box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:100; min-width:180px;">
          <div class="date-option" data-range="today">Today</div>
          <div class="date-option" data-range="yesterday">Yesterday</div>
          <div class="date-option" data-range="thisWeek">This Week</div>
          <div class="date-option" data-range="lastWeek">Last Week</div>
          <div class="date-option" data-range="thisMonth">This Month</div>
          <div class="date-option" data-range="lastMonth">Last Month</div>
          <div class="date-option" data-range="thisYear">This Year</div>
          <div class="date-option" data-range="lastYear">Last Year</div>
          <div class="date-option" data-range="custom">Custom...</div>
        </div>
      </div>

      <!-- Custom date pickers -->
      <input type="date" id="startDate" style="display:none;">
      <input type="date" id="endDate" style="display:none;">

      <button id="applyFilterBtn" style="padding:6px 12px; cursor:pointer; background:#2c3e50; color:white;">Apply Filter</button>
      <button onclick="exportPurchasesCSV()" style="margin-left:auto; padding:6px 12px; cursor:pointer;">Export</button>
    </div>

    <!-- Purchases Table -->
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Supplier</th>
          <th>Total (KES)</th>
          <th>Paid (KES)</th>
          <th>Balance (KES)</th>
          <th>Payment Method</th>
          <th>Reference No</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchasesTable">
        <tr><td colspan="10">Loading...</td></tr>
      </tbody>
    </table>

    <!-- Purchase Details Modal -->
    <div id="purchaseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
      <div style="background:white; padding:20px; width:500px; max-height:80%; overflow:auto; border-radius:8px;">
        <h3>Purchase Details</h3>
        <div id="purchaseModalContent"></div>
        <div style="text-align:right; margin-top:15px;">
          <button onclick="closePurchaseModal()">Close</button>
        </div>
      </div>
    </div>
  `;

  // Load dropdowns for suppliers & locations
  loadFilterOptions();

  // Setup date filter menu toggle
  const dateBtn = document.getElementById("dateFilterBtn");
  const dateMenu = document.getElementById("dateFilterMenu");
  dateBtn.addEventListener("click", () => {
    dateMenu.style.display = (dateMenu.style.display === "none" ? "block" : "none");
  });

  // Handle date menu clicks
  dateMenu.querySelectorAll(".date-option").forEach(opt => {
    opt.addEventListener("click", (e) => {
      const range = e.target.dataset.range;
      selectedDateRange = range;
      dateBtn.textContent = "Date: " + e.target.textContent;
      dateMenu.style.display = "none";

      if (range === "custom") {
        document.getElementById("startDate").style.display = "inline-block";
        document.getElementById("endDate").style.display = "inline-block";
      } else {
        document.getElementById("startDate").style.display = "none";
        document.getElementById("endDate").style.display = "none";
      }
    });
  });

  // Apply filter button
  document.getElementById("applyFilterBtn").addEventListener("click", () => {
    loadFilteredPurchases();
  });

  // Load all purchases initially
  loadFilteredPurchases();
}
let selectedDateRange = "all";

async function loadFilterOptions() {
  const locSelect = document.getElementById("filterLocation");
  const supSelect = document.getElementById("filterSupplier");

  const snapshot = await firebase.firestore().collection("purchases").get();

  const locations = new Set();
  const suppliers = new Set();

  snapshot.forEach(doc => {
    const p = doc.data();
    if (p.location) locations.add(p.location.trim());
    if (p.supplier) suppliers.add(p.supplier.trim());
  });

  locations.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc;
    opt.textContent = loc;
    locSelect.appendChild(opt);
  });

  suppliers.forEach(sup => {
    const opt = document.createElement("option");
    opt.value = sup;
    opt.textContent = sup;
    supSelect.appendChild(opt);
  });
}


async function loadFilteredPurchases() {
  const table = document.getElementById("purchasesTable");
  table.innerHTML = "<tr><td colspan='10'>Loading...</td></tr>";

  let query = firebase.firestore().collection("purchases");

  // Apply Location filter
  const loc = document.getElementById("filterLocation").value;
  if (loc && loc !== "all") {
    query = query.where("location", "==", loc);
  }

  // Apply Supplier filter
  const sup = document.getElementById("filterSupplier").value;
  if (sup && sup !== "all") {
    query = query.where("supplier", "==", sup);
  }

  // Apply Date filter
  const { start, end } = getDateRange(selectedDateRange);
  if (start && end) {
    query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
  }

  query = query.orderBy("purchaseDate", "desc");

  try {
    const snapshot = await query.get();
    table.innerHTML = "";

    if (snapshot.empty) {
      table.innerHTML = "<tr><td colspan='10'>No purchases found.</td></tr>";
      return;
    }

    // ✅ Totals accumulators
    let totalSum = 0;
    let paidSum = 0;
    let balanceSum = 0;

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      // ✅ Ensure numeric values
      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      totalSum += total;
      paidSum += paid;
      balanceSum += balance;

      // ✅ Smarter status handling
      let status = "";
      if (balance > 0) {
        status = `<span style="color:red;font-weight:bold;">Due</span>`;
      } else if (balance < 0) {
        status = `<span style="color:#27ae60;font-weight:bold;">Overpaid</span>`; // lighter green
      } else {
        status = `<span style="color:green;">Paid</span>`;
      }

      table.innerHTML += `
        <tr>
          <td>${date}</td>
          <td>${p.location || ""}</td>
          <td>${p.supplier || ""}</td>
          <td>${total.toFixed(2)}</td>
          <td>${paid.toFixed(2)}</td>
          <td style="color:${balance > 0 ? 'red' : balance < 0 ? '#27ae60' : 'black'};">
            ${balance.toFixed(2)}
          </td>
          <td>${p.paymentMethod || ""}</td>
          <td>${p.referenceNo || ""}</td>
          <td>${status}</td>
          <td>
            <span title="View" style="cursor:pointer; color:green;" onclick="viewPurchase('${doc.id}')">👁</span>
            <span title="Print" style="cursor:pointer; color:orange; margin-left:5px;" onclick="printPurchase('${doc.id}')">🖨</span>
            <span title="Edit" style="cursor:pointer; color:blue; margin-left:5px;" onclick="editPurchase('${doc.id}')">✏</span>
            <span title="Delete" style="cursor:pointer; color:red; margin-left:5px;" onclick="deletePurchase('${doc.id}')">🗑</span>
          </td>
        </tr>
      `;
    });

    // ✅ Totals row at bottom
    table.innerHTML += `
      <tr style="background:#f9f9f9; font-weight:bold;">
        <td colspan="3" style="text-align:right;">Totals:</td>
        <td>${totalSum.toFixed(2)}</td>
        <td>${paidSum.toFixed(2)}</td>
        <td>${balanceSum.toFixed(2)}</td>
        <td colspan="4"></td>
      </tr>
    `;

  } catch (err) {
    table.innerHTML = `<tr><td colspan="10">Error: ${err.message}</td></tr>`;
  }
}


async function exportPurchasesCSV() {
  const rows = [];
  
  // CSV headers
  rows.push([
    "Date",
    "Location",
    "Supplier",
    "Total (KES)",
    "Paid (KES)",
    "Balance (KES)",
    "Payment Method",
    "Reference No",
    "Status"
  ]);

  try {
    let query = firebase.firestore().collection("purchases");

    // Apply Location filter
    const loc = document.getElementById("filterLocation").value;
    if (loc && loc !== "all") {
      query = query.where("location", "==", loc);
    }

    // Apply Supplier filter
    const sup = document.getElementById("filterSupplier").value;
    if (sup && sup !== "all") {
      query = query.where("supplier", "==", sup);
    }

    // Apply Date filter
    const { start, end } = getDateRange(selectedDateRange);
    if (start && end) {
      query = query.where("purchaseDate", ">=", start).where("purchaseDate", "<=", end);
    }

    query = query.orderBy("purchaseDate", "desc");

    const snapshot = await query.get();

    if (snapshot.empty) {
      alert("No purchases found to export with current filters.");
      return;
    }

    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";

      const total = Number(p.totalAmount) || 0;
      const paid = Number(p.amountPaid) || 0;
      const balance = total - paid;

      let status = "";
      if (balance > 0) {
        status = "Due";
      } else if (balance < 0) {
        status = "Overpaid";
      } else {
        status = "Paid";
      }

      rows.push([
        date,
        p.location || "",
        p.supplier || "",
        total.toFixed(2),
        paid.toFixed(2),
        balance.toFixed(2),
        p.paymentMethod || "",
        p.referenceNo || "",
        status
      ]);
    });

    // Build CSV string
    const csvContent = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

    // Trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "purchases_export.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // ✅ Show success toast
    if (typeof showSuccess === "function") {
      showSuccess("Purchases exported successfully!");
    }

  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function getDateRange(range) {
  const today = new Date();
  let start = null, end = null;

  switch (range) {
    case "today":
      start = new Date(today.setHours(0,0,0,0));
      end = new Date(today.setHours(23,59,59,999));
      break;
    case "yesterday":
      const y = new Date();
      y.setDate(y.getDate() - 1);
      start = new Date(y.setHours(0,0,0,0));
      end = new Date(y.setHours(23,59,59,999));
      break;
    case "thisWeek":
      const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
      start = new Date(firstDay.setHours(0,0,0,0));
      end = new Date();
      break;
    case "lastWeek":
      const lastWeekStart = new Date();
      lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
      start = new Date(lastWeekStart.setHours(0,0,0,0));
      const lastWeekEnd = new Date(start);
      lastWeekEnd.setDate(start.getDate() + 6);
      end = new Date(lastWeekEnd.setHours(23,59,59,999));
      break;
    case "thisMonth":
      start = new Date(today.getFullYear(), today.getMonth(), 1);
      end = new Date();
      break;
    case "lastMonth":
      start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      end = new Date(today.getFullYear(), today.getMonth(), 0, 23,59,59,999);
      break;
    case "thisYear":
      start = new Date(today.getFullYear(), 0, 1);
      end = new Date();
      break;
    case "lastYear":
      start = new Date(today.getFullYear() - 1, 0, 1);
      end = new Date(today.getFullYear() - 1, 11, 31, 23,59,59,999);
      break;
    case "custom":
      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (s && e) {
        start = new Date(s);
        end = new Date(e);
        end.setHours(23,59,59,999);
      }
      break;
  }
  return { start, end };
}


// Modal functions
async function viewPurchase(purchaseId) {
  try {
    const docSnap = await firebase.firestore().collection("purchases").doc(purchaseId).get();
    if (!docSnap.exists) {
      alert("Purchase not found");
      return;
    }

    const p = docSnap.data();
    const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
    const balance = (p.totalAmount || 0) - (p.amountPaid || 0);

    let itemsHTML = "";
    if (p.items && p.items.length > 0) {
      itemsHTML = `
        <table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead style="background:#f0f0f0;">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price (KES)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${p.items.map(item => `
              <tr>
                <td>${item.productName}</td>
                <td>${item.quantity}</td>
                <td>${item.price}</td>
                <td>${(item.quantity * item.price).toFixed(2)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    document.getElementById("purchaseModalContent").innerHTML = `
      <p><strong>Date:</strong> ${date}</p>
      <p><strong>Supplier:</strong> ${p.supplier || ""}</p>
      <p><strong>Location:</strong> ${p.location || ""}</p>
      <p><strong>Reference No:</strong> ${p.referenceNo || ""}</p>
      <p><strong>Payment Method:</strong> ${p.paymentMethod || ""}</p>
      <p><strong>Total Amount:</strong> ${p.totalAmount || 0}</p>
      <p><strong>Amount Paid:</strong> ${p.amountPaid || 0}</p>
      <p><strong>Balance:</strong> <span style="color:${balance > 0 ? 'red' : 'black'};">${balance}</span></p>
      <p><strong>Notes:</strong> ${p.notes || ""}</p>
      ${itemsHTML}
    `;

    document.getElementById("purchaseModal").style.display = "flex";

  } catch (error) {
    alert("Error loading purchase: " + error.message);
  }
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").style.display = "none";
}

// Firestore actions
async function printPurchase(id) {
  const docSnap = await firebase.firestore().collection("purchases").doc(id).get();
  if (!docSnap.exists) return alert("Purchase not found");
  const p = docSnap.data();

  const paid = p.amountPaid || 0;
  const balance = (p.totalAmount || 0) - paid;

  const html = `
    <html>
      <head>
        <title>Purchase Receipt</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
          h1, h2, h3 { margin: 0; }
          .header { text-align: center; margin-bottom: 20px; }
          .header h1 { font-size: 22px; color: #2c3e50; }
          .header p { margin: 2px 0; font-size: 12px; color: #555; }
          .info { margin-bottom: 20px; }
          .info p { margin: 4px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f4f4f4; }
          tr:nth-child(even) { background: #fafafa; }
          .totals { margin-top: 20px; text-align: right; }
          .totals p { margin: 4px 0; font-size: 14px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1><!-- Business Name here --></h1>
          <p><!-- Address line here --></p>
          <p><!-- Phone | Email here --></p>
          <hr/>
        </div>

        <div class="info">
          <p><b>Date:</b> ${p.purchaseDate.toDate().toLocaleDateString()}</p>
          <p><b>Supplier:</b> ${p.supplier}</p>
          <p><b>Reference:</b> ${p.referenceNo || "-"}</p>
          <p><b>Payment Method:</b> ${p.paymentMethod || "-"}</p>
          <p><b>Location:</b> ${p.location || "-"}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price (KES)</th>
              <th>Subtotal (KES)</th>
            </tr>
          </thead>
          <tbody>
            ${p.items && p.items.length > 0
              ? p.items.map((i, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${i.productName}</td>
                  <td>${i.quantity}</td>
                  <td style="text-align:right;">${i.price.toFixed(2)}</td>
                  <td style="text-align:right;">${i.subtotal ? i.subtotal.toFixed(2) : (i.quantity * i.price).toFixed(2)}</td>
                </tr>`).join("")
              : "<tr><td colspan='5'>No items</td></tr>"}
          </tbody>
        </table>

        <div class="totals">
          <p><b>Total:</b> KES ${p.totalAmount.toFixed(2)}</p>
          <p><b>Paid:</b> KES ${paid.toFixed(2)}</p>
          <p><b>Balance:</b> KES ${balance.toFixed(2)}</p>
        </div>

        <div class="footer">
          <p><!-- Footer message here --></p>
        </div>
      </body>
    </html>
  `;

  const w = window.open("", "_blank", "width=800,height=600");
  w.document.write(html);
  w.document.close();
  w.print();
}



function editPurchase(id) {
  alert(`Open edit form for purchase: ${id}`);
}

async function deletePurchase(id) {
  if (!confirm("Are you sure you want to delete this purchase?")) return;
  await firebase.firestore().collection("purchases").doc(id).delete();
  alert("Purchase deleted");
  showListPurchases();
}

async function exportPurchasesCSV() {
  try {
    const snapshot = await firebase.firestore().collection("purchases")
      .orderBy("purchaseDate", "desc")
      .get();

    if (snapshot.empty) {
      alert("No purchases to export");
      return;
    }

    let csv = "Date,Supplier,Total Amount,Amount Paid,Balance,Payment Method,Reference No\n";
    snapshot.forEach(doc => {
      const p = doc.data();
      const date = p.purchaseDate ? p.purchaseDate.toDate().toISOString().split("T")[0] : "";
      const balance = (p.totalAmount || 0) - (p.amountPaid || 0);
      csv += `${date},"${p.supplier}",${p.totalAmount || 0},${p.amountPaid || 0},${balance},"${p.paymentMethod || ""}","${p.referenceNo || ""}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `purchases_${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  } catch (err) {
    alert("Error exporting purchases: " + err.message);
  }
}


function showPurchaseReturn() {
  saveLastPage("showPurchaseReturn");
  document.getElementById("content").innerHTML = `<h2>Purchase Return</h2><p>Coming soon...</p>`;
}


    function showRoles() { saveLastPage("showRoles"); document.getElementById("content").innerHTML = `<h2>Roles</h2><p>Define and manage user roles and permissions.</p>`; }
    function showFieldSales() { saveLastPage("showFieldSales"); document.getElementById("content").innerHTML = `<h2>Field Salespersons</h2><p>Assign and track sales agents working in the field.</p>`; }
    
	function showSuppliers() {
  saveLastPage("showSuppliers");
  document.getElementById("content").innerHTML = `
    <h2>Suppliers</h2>
    <input type="text" id="supplierName" placeholder="Supplier Name" required>
    <input type="text" id="supplierPhone" placeholder="Phone">
    <input type="email" id="supplierEmail" placeholder="Email">
    <input type="text" id="supplierAddress" placeholder="Address">
    <button onclick="addSupplier()">Add Supplier</button>
    <div id="supplierMessage" style="margin-top:10px; color:red;"></div>

    <h3>Existing Suppliers</h3>
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#eee;">
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="suppliersTable"></tbody>
    </table>
  `;

  loadSuppliers();
}

function addSupplier() {
  const name = document.getElementById("supplierName").value.trim();
  const phone = document.getElementById("supplierPhone").value.trim();
  const email = document.getElementById("supplierEmail").value.trim();
  const address = document.getElementById("supplierAddress").value.trim();
  const msg = document.getElementById("supplierMessage");

  if (!name) {
    msg.textContent = "Supplier name is required.";
    return;
  }

  firebase.firestore().collection("suppliers").add({
    name, phone, email, address,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    msg.style.color = "green";
    msg.textContent = "Supplier added successfully.";
    document.getElementById("supplierName").value = "";
    document.getElementById("supplierPhone").value = "";
    document.getElementById("supplierEmail").value = "";
    document.getElementById("supplierAddress").value = "";
    loadSuppliers();
  })
  .catch(err => {
    msg.style.color = "red";
    msg.textContent = "Error: " + err.message;
  });
}

function loadSuppliers() {
  const table = document.getElementById("suppliersTable");
  table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("suppliers").orderBy("name").get()
    .then(snapshot => {
      table.innerHTML = "";
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='5'>No suppliers found.</td></tr>";
        return;
      }
      snapshot.forEach(doc => {
        const s = doc.data();
        table.innerHTML += `
          <tr>
            <td>${s.name}</td>
            <td>${s.phone || ""}</td>
            <td>${s.email || ""}</td>
            <td>${s.address || ""}</td>
            <td><button style="background:red;color:white;" onclick="deleteSupplier('${doc.id}')">Delete</button></td>
          </tr>
        `;
      });
    })
    .catch(err => {
      table.innerHTML = `<tr><td colspan='5'>Error loading suppliers: ${err.message}</td></tr>`;
    });
}

function deleteSupplier(id) {
  if (!confirm("Delete this supplier?")) return;
  firebase.firestore().collection("suppliers").doc(id).delete()
    .then(() => loadSuppliers())
    .catch(err => alert("Error deleting: " + err.message));
}

    
	function showCustomers() { saveLastPage("showCustomers"); document.getElementById("content").innerHTML = `<h2>Customers</h2><p>View and manage your customer records here.</p>`; }
  </script>
</body>
</html>
