/* -------------------------------
   üîπ Load Sales Data with Filters (Sorted by Latest Sale Date + Sticky Totals Row + expensesTotal + Updated Formula)
   üîπ Formula: Due = Total Sales ‚àí Field Expenses ‚àí Paid
-------------------------------- */
async function loadSalesData(filters = {}) {
  const tbody = document.getElementById("salesTableBody");
  tbody.innerHTML = "";

  let totalSales = 0,
    totalPaid = 0,
    totalDue = 0,
    totalExpense = 0;

  try {
    let query = firebase.firestore().collection("sales");

    // ‚úÖ Apply filters safely
    if (filters.location) query = query.where("location", "==", filters.location);
    if (filters.salesperson) query = query.where("salesperson", "==", filters.salesperson);
    if (filters.customer) query = query.where("customer", "==", filters.customer);

    // ‚úÖ Date range filters
    let hasDateFilter = false;
    if (filters.startDate && filters.endDate) {
      const start = new Date(filters.startDate);
      const end = new Date(filters.endDate);
      end.setHours(23, 59, 59, 999);
      query = query.where("saleDate", ">=", start).where("saleDate", "<=", end);
      hasDateFilter = true;
    } else if (filters.startDate) {
      const start = new Date(filters.startDate);
      query = query.where("saleDate", ">=", start);
      hasDateFilter = true;
    } else if (filters.endDate) {
      const end = new Date(filters.endDate);
      end.setHours(23, 59, 59, 999);
      query = query.where("saleDate", "<=", end);
      hasDateFilter = true;
    }

    // ‚úÖ Only order if no filters (to prevent Firestore index errors)
    const hasOtherFilters = filters.location || filters.salesperson || filters.customer;
    if (!hasOtherFilters && !hasDateFilter) {
      query = query.orderBy("saleDate", "desc");
    }

    const snapshot = await query.get();

    if (snapshot.empty) {
      tbody.innerHTML = `
        <tr><td colspan="10" style="text-align:center;">No sales records found.</td></tr>
      `;
      updateSalesSummary(0, 0, 0, 0);
      return;
    }

    const searchTerm = (filters.search || "").toLowerCase();

    // ‚úÖ Preload customer names
    const customerIds = new Set();
    snapshot.forEach(doc => {
      const sale = doc.data();
      if (sale.customer) customerIds.add(sale.customer);
    });

    const customerCache = {};
    await Promise.all(
      Array.from(customerIds).map(async id => {
        try {
          const docSnap = await firebase.firestore().collection("customers").doc(id).get();
          customerCache[id] = docSnap.exists ? (docSnap.data().name || id) : id;
        } catch {
          customerCache[id] = id;
        }
      })
    );

    // ‚úÖ Convert to array & sort by date (latest first)
    let salesDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    salesDocs.sort((a, b) => {
      const aDate = a.saleDate?.toDate ? a.saleDate.toDate() : new Date(a.saleDate || 0);
      const bDate = b.saleDate?.toDate ? b.saleDate.toDate() : new Date(b.saleDate || 0);
      return bDate - aDate;
    });

    // ‚úÖ Render rows
    for (const sale of salesDocs) {
      const note = sale.note || "-";
      if (searchTerm && !note.toLowerCase().includes(searchTerm)) continue;

      const saleDate = sale.saleDate
        ? (sale.saleDate.toDate ? sale.saleDate.toDate().toLocaleDateString() : sale.saleDate)
        : "N/A";
      const location = sale.location || "N/A";
      const salesperson = sale.salesperson || "-";
      const customer = customerCache[sale.customer] || sale.customer || "-";

      // ‚úÖ Compute total sales
      let total = 0;
      if (Array.isArray(sale.saleItems)) {
        total = sale.saleItems.reduce((sum, item) => {
          const qty = Number(item.quantity) || 0;
          const price = Number(item.price) || 0;
          return sum + qty * price;
        }, 0);
      }
      total = total || Number(sale.totalSales) || Number(sale.totalAmount) || Number(sale.total) || 0;

      // ‚úÖ Payments
      let paid = 0;
      if (Array.isArray(sale.payments)) {
        paid = sale.payments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
      } else {
        paid = Number(sale.paid) || 0;
      }

      // ‚úÖ Use Firestore field `expensesTotal`
      const expense = Number(sale.expensesTotal) || 0;

      // ‚úÖ Updated Formula: Due = Total Sales - Field Expenses - Paid
      const due = total - expense - paid;

      totalSales += total;
      totalPaid += paid;
      totalDue += due;
      totalExpense += expense;

      // ‚úÖ Table row
      tbody.innerHTML += `
        <tr>
          <td>${saleDate}</td>
          <td>${location}</td>
          <td>${salesperson}</td>
          <td>${customer}</td>
          <td>KES ${total.toLocaleString()}</td>
          <td>KES ${expense.toLocaleString()}</td>
          <td>
            KES ${paid.toLocaleString()}
            <span title="View Payments" style="cursor:pointer; color:#007bff; margin-left:6px;" onclick="viewPayments('${sale.id}')">üí∞</span>
          </td>
          <td style="font-weight:bold;">KES ${due.toLocaleString()}</td>
          <td>${note}</td>
          <td style="text-align:center;">
            <span title="View" style="cursor:pointer; color:green;" onclick="viewSale('${sale.id}')">üëÅ</span>
            <span title="Delete" style="cursor:pointer; color:red; margin-left:8px;" onclick="deleteSale('${sale.id}')">üóë</span>
          </td>
        </tr>
      `;
    }

    // ‚úÖ Sticky Totals Row (footer stays visible)
    const table = tbody.closest("table");
    let tfoot = table.querySelector("tfoot");
    if (!tfoot) {
      tfoot = document.createElement("tfoot");
      table.appendChild(tfoot);
    }

    tfoot.innerHTML = `
      <tr style="
        position: sticky;
        bottom: 0;
        background: #f8f9fa;
        font-weight: bold;
        border-top: 3px solid #000;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.15);
      ">
        <td colspan="4" style="text-align:right;">Totals:</td>
        <td style="color:#007bff;">KES ${totalSales.toLocaleString()}</td>
        <td style="color:#dc3545;">KES ${totalExpense.toLocaleString()}</td>
        <td style="color:#198754;">KES ${totalPaid.toLocaleString()}</td>
        <td style="color:#ffc107;">KES ${totalDue.toLocaleString()}</td>
        <td colspan="2"></td>
      </tr>
    `;

    // ‚úÖ Update summary cards (same formula)
    updateSalesSummary(totalSales, totalPaid, totalDue, totalExpense);

  } catch (error) {
    console.error("Error loading sales:", error);
    tbody.innerHTML = `
      <tr><td colspan="10" style="text-align:center; color:red;">
        Error loading sales: ${error.message}
      </td></tr>
    `;
  }
}
