<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tharua Firm Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 230px;
  background-color: #2c3e50;
  color: white;
  padding-top: 20px;
  overflow-y: auto;
  transition: transform 0.3s ease;
}
.sidebar.collapsed {
  transform: translateX(-100%);
}
.sidebar h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 18px;
}
.sidebar a {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  color: white;
  text-decoration: none;
  transition: background 0.3s ease;
  font-size: 14px;
  cursor: pointer;
}
.main-content {
  margin-left: 230px;
  padding: 20px;
  transition: margin-left 0.3s ease;
}
.main-content.collapsed {
  margin-left: 0;
}
.toggle-btn {
  position: fixed; /* Changed to fixed to ensure visibility regardless of main-content position */
  top: 20px;
  left: 10px; /* Positioned on the left side of the screen when sidebar is collapsed */
  background-color: #2c3e50;
  color: white;
  padding: 4px;
  cursor: pointer;
  border: none;
  z-index: 2000; /* Increased z-index to ensure it’s above other elements */
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: transform 0.2s ease, background-color 0.2s ease;
  outline: 2px solid red; /* Temporary outline for debugging visibility */
}
.toggle-btn:hover {
  background-color: #34495e;
  transform: scale(1.1); /* Slightly enlarge on hover for visibility */
}
.toggle-btn i.rotate-90 {
  transform: rotate(90deg);
  transition: transform 0.3s ease;
}
.sidebar.collapsed ~ .main-content .toggle-btn {
  left: 10px; /* Ensure button stays visible when sidebar is collapsed */
}
    .content-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 8px; margin: 8px 0 16px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #2c3e50; color: white; cursor: pointer; }
    button:hover { background-color: #34495e; }
    .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; text-align: center; }
    .button-grid div { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: transform 0.2s ease; }
    .button-grid div:hover { transform: scale(1.05); }
    .button-grid img { width: 50px; height: 50px; margin-bottom: 10px; }
	.edit-input {
  width: 80px;
  padding: 4px;
}

.btn-edit, .btn-save, .btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-edit {
  background-color: #2980b9;
}
.btn-save {
  background-color: #27ae60;
}
.btn-cancel {
  background-color: #c0392b;
}
/* General styles */
.user-form {
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.user-form input,
.user-form select,
.user-form button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.submit-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  cursor: pointer;
  padding: 8px 16px;
}

.submit-btn:hover {
  background-color: #34495e;
}

.table-container {
  overflow-x: auto;
}

.users-table {
  width: 100%;
  border-collapse: collapse;
}

.users-table th,
.users-table td {
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
}

.users-table th {
  background-color: #eee;
}

/* Desktop mode (default) */
.desktop-cell {
  white-space: nowrap;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.desktop-actions {
  white-space: nowrap;
}

/* Mobile mode */
@media (max-width: 768px) {
  .form-group {
    flex-direction: column;
  }

  .user-form input,
  .user-form select,
  .user-form button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 16px;
  }

  .table-container {
    overflow-x: auto;
  }

  .users-table {
    min-width: 600px;
  }

  .desktop-cell {
    display: block;
    word-wrap: break-word;
    max-width: 120px;
    padding: 6px;
  }

  .desktop-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 5px;
  }

  .desktop-actions span {
    margin: 0 !important;
    font-size: 18px;
  }

  .edit-input {
    width: 100px;
    padding: 6px;
    font-size: 14px;
  }
}

/* Ensure buttons are tappable */
button {
  min-height: 40px;
  touch-action: manipulation;
}

/* Edit mode buttons */
.btn-save,
.btn-cancel {
  margin-right: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: white;
}

.btn-save {
  background-color: #27ae60;
}

.btn-cancel {
  background-color: #c0392b;
}

 <!-- Inline CSS -->
 
      .spinner {
        display: inline-block;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2c3e50;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .edit-input {
        width: 100%;
        padding: 4px;
        box-sizing: border-box;
      }
      .error-row {
        color: red;
        text-align: center;
      }
	  .actions-cell button {
  font-size: 10px;    /* tiny icons */
  padding: 2px 4px;   /* shrink button area */
  margin: 0 1px;
  line-height: 1;     /* keep buttons compact */
}


.loading-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  background: rgba(255, 255, 255, 0.9);
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.form-container {
  max-width: 600px;
  width: 90%;
  margin: 20px auto;
  padding: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.form-container h2 {
  color: #333;
  font-size: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
  font-size: 14px;
}

.form-group input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  box-sizing: border-box;
}

.form-group button {
  padding: 10px;
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.form-group button:hover {
  background: #2980b9;
}

#locationMessage {
  text-align: center;
  font-size: 14px;
}

.table-container {
  max-height: 400px;
  overflow-y: auto;
  width: 100%;
  position: relative;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.table-container table {
  width: 100%;
  border-collapse: collapse;
}

.table-container thead {
  position: sticky;
  top: 0;
  background: #f0f0f0;
  z-index: 1;
}

.table-container th, .table-container td {
  padding: 12px;
  border: 1px solid #ddd;
  font-size: 14px;
}

.table-container th {
  font-weight: 600;
  color: #333;
}

.pagination-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  font-size: 14px;
}

.pagination-section button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.pagination-section button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.pagination-section .prev-btn, .pagination-section .next-btn {
  background: #007bff;
  color: white;
}

.pagination-section .prev-btn:hover:not(:disabled), .pagination-section .next-btn:hover:not(:disabled) {
  background: #0056b3;
}

.pagination-section select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  position: relative;
}

.modal-content h2 {
  margin-top: 0;
  color: #333;
  font-size: 20px;
}

.modal-content p {
  font-size: 14px;
  color: #333;
  margin: 10px 0;
}

.modal-content .modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.modal-content button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.modal-content .btn-danger {
  background: #dc3545;
  color: white;
}

.modal-content .btn-danger:hover {
  background: #c82333;
}

.modal-content .btn-secondary {
  background: #6c757d;
  color: white;
}

.modal-content .btn-secondary:hover {
  background: #5a6268;
}

.modal-content .close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 20px;
  cursor: pointer;
  color: #333;
}

@media (max-width: 600px) {
  .form-container {
    width: 95%;
    padding: 15px;
  }
  .form-container h2 {
    font-size: 20px;
  }
  .form-group {
    flex-direction: column;
  }
  .form-group input {
    font-size: 12px;
    padding: 8px;
  }
  .form-group button {
    font-size: 14px;
    padding: 10px;
  }
  .table-container th, .table-container td {
    font-size: 12px;
    padding: 8px;
  }
  .pagination-section {
    flex-direction: column;
    gap: 10px;
  }
}

/* General styles */
.loading-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  text-align: center;
}
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.form-container {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
}
.form-container h2 {
  margin-top: 0;
}
.form-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.form-group input {
  padding: 6px;
  flex: 1;
}
.submit-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 4px;
}
.submit-btn:hover {
  background: #2980b9;
}

.users-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.users-table th, .users-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.desktop-actions span {
  cursor: pointer;
  color: red;
  font-size: 18px;
}

.pagination-section {
  margin-top: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.pagination-section select, 
.pagination-section button {
  padding: 5px 10px;
  margin-left: 5px;
}
.prev-btn, .next-btn {
  background: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.prev-btn:disabled, .next-btn:disabled {
  background: #aaa;
  cursor: not-allowed;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  padding-top: 80px;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
}
.modal-content {
  background: white;
  margin: auto;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  border-radius: 8px;
}
.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.btn-danger {
  background: red;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-secondary {
  background: #aaa;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
}
.close-btn {
  float: right;
  font-size: 20px;
  cursor: pointer;
}

.summary-table {
  width: 100%;
  max-width: 500px;
  border-collapse: collapse;
  margin: 10px 0;
}

.summary-table td {
  padding: 8px;
  font-size: 16px;
}

.summary-input {
  width: 100%;
  padding: 5px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.highlight-net {
  background-color: #f0f8ff; /* Light blue background */
  font-weight: bold;
}

.net-sales {
  font-size: 18px;
  color: #2e7d32; /* Green to highlight net sales */
  font-weight: bold;
}

.remove-cell {
  text-align: center;
  color: red;
  cursor: pointer;
  font-size: 18px;
  font-weight: normal;
  transition: color 0.2s, font-weight 0.2s;
}

.remove-cell:hover {
  color: darkred;
  font-weight: bold;
}


  </style>
</head>
<body>
<div class="sidebar" id="sidebar">
    <h2>THARUA</h2>
    <a onclick="showHome()"><i class="fas fa-home"></i> <span>Home</span></a>
    <div class="dropdown">
      <a onclick="toggleUserManagement()" id="userMgmtMenu"><i class="fas fa-users-cog"></i> <span>User Management</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="userMgmtSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showUsers()"><span>Users</span></a>
        <a onclick="showRoles()"><span>Roles</span></a>
<a onclick="showFieldSalespersons()"><span>Field Salespersons</span></a>
      </div>
    </div>
    <div class="dropdown">
      <a onclick="toggleContacts()" id="contactsMenu"><i class="fas fa-address-book"></i> <span>Contacts</span> <i class="fas fa-caret-down" style="margin-left:auto;"></i></a>
      <div id="contactsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showSuppliers()"><span>Suppliers</span></a>
        <a onclick="showCustomers()"><span>Customers</span></a>
<a onclick="showCustomerGroups()"><span>Customer Groups</span></a>
        <a onclick="clearContent()"><span>Import Contacts</span></a>
      </div>
    </div>
<div class="dropdown">
  <a onclick="toggleProducts()" id="productsMenu"><i class="fas fa-boxes"></i> 
    <span>Products</span> 
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="productsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddProduct()"><span>Add Product</span></a>
    <a onclick="showListProducts()"><span>List of Products</span></a>
    <a onclick="showBusinessLocations()"><span>Business Location</span></a>
    <a onclick="showCategory()"><span>Category</span></a>
    <a onclick="showBrand()"><span>Brand</span></a>
    <a onclick="showPriceList()"><span>Price List</span></a>
    <a onclick="showPriceGroups()"><span>Price Groups</span></a>
    <a onclick="showUnits()"><span>Units</span></a>
  </div>
</div>


    <a onclick="clearContent()"><i class="fas fa-industry"></i> <span>Manufacturing</span></a>
    <div class="dropdown">
      <a onclick="togglePurchases()" id="purchasesMenu">
        <i class="fas fa-shopping-cart"></i>
        <span>Purchases</span>
        <i class="fas fa-caret-down" style="margin-left:auto;"></i>
      </a>
      <div id="purchasesSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
        <a onclick="showAddPurchase()"><span>Add Purchase</span></a>
        <a onclick="showListPurchases()"><span>List of Purchases</span></a>
        <a onclick="showPurchaseReturn()"><span>Purchase Return</span></a>
      </div>
    </div>
  <div class="dropdown">
  <a onclick="toggleSell()" id="sellMenu">
    <i class="fas fa-cash-register"></i>
    <span>Sell</span>
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="sellSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showAddSale()"><span>Add Sale</span></a>
    <a onclick="showListSales()"><span>List of Sales</span></a>
    <a onclick="showDraftSales()"><span>Draft Sales / Quotations</span></a>
    <a onclick="showCashRegister()"><span>POS Register</span></a>
    <a onclick="showCreditSales()"><span>Credit Sales</span></a>
    <a onclick="showSalesReturn()"><span>Sales Return</span></a>
    <a onclick="showInvoices()"><span>Invoices & Receipts</span></a>
    <a onclick="showDiscounts()"><span>Discounts & Offers</span></a>
    <a onclick="showImportSales()"><span>Import Sales</span></a>
  </div>
</div>

    <a onclick="clearContent()"><i class="fas fa-truck-moving"></i> <span>Stock Transfers</span></a>
    <a onclick="clearContent()"><i class="fas fa-balance-scale-left"></i> <span>Stock Adjustment</span></a>
<div class="dropdown">
  <a onclick="toggleExpenses()" id="expensesMenu">
    <i class="fas fa-file-invoice-dollar"></i>
    <span>Expenses</span>
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="expensesSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showListExpenses()"><span>List of Expenses</span></a>
    <a onclick="showAddExpense()"><span>Add Expense</span></a>
    <a onclick="showExpenseCategories()"><span>Expense Categories</span></a>
  </div>
</div>

    <a onclick="clearContent()"><i class="fas fa-calculator"></i> <span>Accounting</span></a>
    <a onclick="clearContent()"><i class="fas fa-robot"></i> <span>AI Assistance</span></a>
<div class="dropdown">
  <a onclick="toggleReports()" id="reportsMenu">
    <i class="fas fa-chart-line"></i>
    <span>Reports</span>
    <i class="fas fa-caret-down" style="margin-left:auto;"></i>
  </a>
  <div id="reportsSubmenu" style="display:none; flex-direction: column; padding-left: 20px;">
    <a onclick="showSalesReport()"><span>Sales Report</span></a>
    <a onclick="showPurchaseReport()"><span>Purchase Report</span></a>
    <a onclick="showInventoryReport()"><span>Inventory Report</span></a>
    <a onclick="showFinancialSummary()"><span>Financial Summary</span></a>
    <a onclick="showCustomerReport()"><span>Customer Report</span></a>
    <a onclick="showExpenseReport()"><span>Expense Report</span></a>
  </div>
</div>

    <a onclick="clearContent()"><i class="fas fa-envelope"></i> <span>Notification Templates</span></a>
    <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
</div>

<div class="main-content" id="mainContent">
  <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle Sidebar">
    <i class="fas fa-arrows-alt-h"></i>
  </button>
  <div id="content" class="content-section">
    <h1>Welcome to Tharua Firm</h1>
    <p>Click a menu item on the left to view more details.</p>
  </div>
</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /* ---------- Toast + Sound helpers ---------- */
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime); // low pitch
    g.gain.setValueAtTime(0.002, ctx.currentTime);    // very low volume

    o.connect(g);
    g.connect(ctx.destination);
    o.start();

    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);

    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showSuccessNotification(message = "Success") {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;

  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: "#27ae60",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });

  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });

  playSuccessSound();

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

    const firebaseConfig = {
      apiKey: "AIzaSyCLRiUG0ePdP68nbjtptb5pbY34ohiUP30",
      authDomain: "tharuasystem.firebaseapp.com",
      projectId: "tharuasystem",
      storageBucket: "tharuasystem.appspot.com",
      messagingSenderId: "438210516373",
      appId: "1:438210516373:web:83c188e315a69165d5129c"
    };
    firebase.initializeApp(firebaseConfig);

    function saveLastPage(name) { localStorage.setItem("lastPage", name); }
    function saveSidebarState(state) { localStorage.setItem("sidebarState", state); }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; return; }
      restoreUIState();
    });

    function restoreUIState() {
      const sidebarState = localStorage.getItem("sidebarState");
      if (sidebarState === "collapsed") {
        document.getElementById("sidebar").classList.add("collapsed");
        document.getElementById("mainContent").classList.add("collapsed");
      }
      const lastPage = localStorage.getItem("lastPage");
      if (lastPage && typeof window[lastPage] === "function") {
        window[lastPage]();
      } else { showHome(); }
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        alert("Logged out successfully.");
        window.location.href = "login.html";
      }).catch(err => alert("Error logging out: " + err.message));
    }

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.getElementById("mainContent");
  const toggleBtn = document.querySelector(".toggle-btn i");

  sidebar.classList.toggle("collapsed");
  mainContent.classList.toggle("collapsed");

  if (sidebar.classList.contains("collapsed")) {
    toggleBtn.classList.add("rotate-90");
  } else {
    toggleBtn.classList.remove("rotate-90");
  }

  saveSidebarState(sidebar.classList.contains("collapsed") ? "collapsed" : "expanded");
}

    function showHome() {
      saveLastPage("showHome");

      const savedLocation = localStorage.getItem("dashboardLocation") || "all";
      const savedStartDate = localStorage.getItem("dashboardStartDate") || "";
      const savedEndDate = localStorage.getItem("dashboardEndDate") || "";

      document.getElementById("content").innerHTML = `
        <h2>Dashboard Overview</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
          <select id="locationFilter" style="flex:1;">
            <option value="all">All Locations</option>
          </select>
          <input type="date" id="startDateFilter" style="flex:1;" />
          <input type="date" id="endDateFilter" style="flex:1;" />
          <button onclick="applyFilters()">Apply</button>
        </div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Sales</h3>
            <p id="salesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Purchases</h3>
            <p id="purchasesTotal">Loading...</p>
          </div>
          <div style="flex:1; min-width:200px; background:#f9f9f9; padding:20px; border-radius:8px;">
            <h3>Expenses</h3>
            <p id="expensesTotal">Loading...</p>
          </div>
        </div>
      `;

      document.getElementById("startDateFilter").value = savedStartDate;
      document.getElementById("endDateFilter").value = savedEndDate;

      loadLocations(savedLocation);
      loadTotal("sales", "salesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("purchases", "purchasesTotal", savedLocation, savedStartDate, savedEndDate);
      loadTotal("expenses", "expensesTotal", savedLocation, savedStartDate, savedEndDate);
    }

 async function loadLocations(selectedValue) {
  const locationSelect = document.getElementById("locationFilter");
  if (!locationSelect) {
    console.error("Location filter element (#locationFilter) not found in DOM");
    return;
  }

  // Set initial state
  locationSelect.innerHTML = `<option value="all">All Locations</option>`;
  locationSelect.disabled = true; // Disable while loading

  try {
    const snapshot = await firebase.firestore().collection("businessLocations").orderBy("name").get();
    
    if (snapshot.empty) {
      console.warn("No locations found in businessLocations collection");
      locationSelect.disabled = false;
      return;
    }

    snapshot.forEach(doc => {
      const loc = doc.data();
      if (loc.name) { // Ensure name exists
        const opt = document.createElement("option");
        opt.value = loc.name;
        opt.textContent = loc.name;
        if (loc.name === selectedValue) opt.selected = true;
        locationSelect.appendChild(opt);
      }
    });

    locationSelect.disabled = false;
  } catch (err) {
    console.error("Error loading locations:", err);
    locationSelect.innerHTML = `<option value="all">Error loading locations</option>`;
    locationSelect.disabled = true;
    showNotification("Failed to load locations: " + err.message, "error"); // Use existing notification function
  }
}

    function applyFilters() {
      const loc = document.getElementById("locationFilter").value;
      const start = document.getElementById("startDateFilter").value;
      const end = document.getElementById("endDateFilter").value;

      localStorage.setItem("dashboardLocation", loc);
      localStorage.setItem("dashboardStartDate", start);
      localStorage.setItem("dashboardEndDate", end);

      showHome();
    }

    function loadTotal(type, elementId, location, startDate, endDate) {
  // Map each collection to its date and amount fields
  const dateFieldMap = { sales: "saleDate", purchases: "purchaseDate", expenses: "expenseDate" };
  const amountFieldMap = { sales: "totalAmount", purchases: "totalAmount", expenses: "amount" };

  const dateField = dateFieldMap[type] || "date";
  const amountField = amountFieldMap[type] || "amount";

  let query = firebase.firestore().collection(type);

  if (location && location !== "all") {
    query = query.where("location", "==", location);
  }

  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setDate(end.getDate() + 1); // make end exclusive
    query = query.where(dateField, ">=", start).where(dateField, "<", end);
  }

  query.get().then(snap => {
    let total = 0;
    snap.forEach(doc => {
      const data = doc.data();
      // Prefer the mapped amount field, but fall back gracefully
      const value =
        (data && (
          (amountField in data ? data[amountField] : undefined) ??
          data.totalAmount ??
          data.amount ??
          data.net ??
          0
        )) || 0;
      total += Number(value) || 0;
    });

    const el = document.getElementById(elementId);
    if (el) el.textContent = "KES " + total.toLocaleString();
  }).catch(err => {
    console.error("loadTotal error:", err);
    const el = document.getElementById(elementId);
    if (el) el.textContent = "Error";
  });
}

function clearContent() { saveLastPage("clearContent"); document.getElementById("content").innerHTML = `<h2>Section Under Development</h2><p>Content will be added soon. Please check back later.</p>`; }
    function toggleContacts() { const s = document.getElementById("contactsSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
    function toggleUserManagement() { const s = document.getElementById("userMgmtSubmenu"); s.style.display = s.style.display === "none" ? "flex" : "none"; }
	
function showUsers() {
  saveLastPage("showUsers");
  document.getElementById("content").innerHTML = `
    <h2>Manage Users</h2>

    <!-- Create User Form -->
    <div class="user-form">
      <div class="form-group">
        <input type="text" id="newName" placeholder="Full Name" required>
        <input type="email" id="newEmail" placeholder="Email" required>
        <input type="password" id="newPassword" placeholder="Password" required>
        <select id="newRole">
          <option value="">Select Role</option>
          <option value="admin">Admin</option>
          <option value="cashier">Cashier</option>
          <option value="salesperson">Salesperson</option>
        </select>
        <button onclick="createUser()" class="submit-btn">Create User</button>
      </div>
    </div>

    <!-- Existing Users Table -->
    <h3>Existing Users</h3>
    <div class="table-container">
      <table border="1" cellpadding="8" cellspacing="0" class="users-table">
        <thead>
          <tr style="background:#eee;">
            <th>Username</th>
            <th>Name</th>
            <th>Role</th>
            <th>Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  `;

  loadUsers();
}

function loadUsers() {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("users").get()
    .then(snapshot => {
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const u = doc.data();
        tbody.innerHTML += `
          <tr data-id="${doc.id}">
            <td class="desktop-cell">${doc.id || ""}</td>
            <td class="editable desktop-cell" data-field="name">${u.name || ""}</td>
            <td class="editable desktop-cell" data-field="role">${u.role || ""}</td>
            <td class="editable desktop-cell" data-field="email">${u.email || ""}</td>
            <td class="desktop-actions">
              <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
              <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${doc.id}')">👁</span>
              <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${doc.id}')">🗑</span>
            </td>
          </tr>
        `;
      });
    })
    .catch(err => {
      tbody.innerHTML = `<tr><td colspan='5'>Error loading users: ${err.message}</td></tr>`;
    });
}

// Enter edit mode for a user row
function enterEditMode(editSpan) {
  const row = editSpan.closest('tr');
  const userId = row.getAttribute('data-id');
  const cells = row.querySelectorAll('.editable');

  const originalData = {};
  cells.forEach(cell => {
    originalData[cell.getAttribute('data-field')] = cell.textContent;
  });

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    let input;
    if (field === 'role') {
      input = document.createElement('select');
      input.className = 'edit-input';
      ['admin', 'cashier', 'salesperson'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (role === cell.textContent) option.selected = true;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = field === 'email' ? 'email' : 'text';
      input.className = 'edit-input';
      input.value = cell.textContent || '';
    }
    cell.innerHTML = '';
    cell.appendChild(input);
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <button class="btn-save submit-btn" onclick="saveUser('${userId}', this)">Save</button>
    <button class="btn-cancel submit-btn" onclick="cancelEdit(this, ${JSON.stringify(originalData)})">Cancel</button>
  `;
}

// Save edited user data
async function saveUser(userId, saveButton) {
  const row = saveButton.closest('tr');
  const cells = row.querySelectorAll('.editable');
  const updatedData = {};

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    const input = cell.querySelector('input, select');
    updatedData[field] = input.value;
  });

  try {
    await firebase.firestore().collection("users").doc(userId).update(updatedData);
    showSuccessNotification("User updated successfully.");
    loadUsers();
  } catch (err) {
    alert("Error updating user: " + err.message);
  }
}

// Cancel edit mode and revert to original values
function cancelEdit(cancelButton, originalData) {
  const row = cancelButton.closest('tr');
  const cells = row.querySelectorAll('.editable');

  cells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    cell.innerHTML = originalData[field] || '';
  });

  const actionCell = row.querySelector('td:last-child');
  actionCell.innerHTML = `
    <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="enterEditMode(this)">✏</span>
    <span title="View" style="cursor:pointer; color:green; margin-left:6px;" onclick="viewUser('${row.getAttribute('data-id')}')">👁</span>
    <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteUser('${row.getAttribute('data-id')}')">🗑</span>
  `;
}

// Existing functions remain unchanged
function createUser() {
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if (!name || !email || !password || !role) {
    alert("Please fill in all fields and select a role.");
    return;
  }

  firebase.firestore().collection("users").add({
    name: name,
    email: email,
    password: password,
    role: role,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("User created successfully.");
    document.getElementById("newName").value = "";
    document.getElementById("newEmail").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("newRole").value = "";
    loadUsers();
  })
  .catch(error => {
    alert("Error creating user: " + error.message);
  });
}

function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  firebase.firestore().collection("users").doc(userId).delete()
  .then(() => {
    alert("User deleted successfully.");
    loadUsers();
  })
  .catch(err => alert("Error deleting user: " + err.message));
}

function editUser(userId) {
  alert("Edit feature coming soon for user ID: " + userId);
}

function viewUser(userId) {
  alert("View feature coming soon for user ID: " + userId);
}

function toggleProducts() {
  const submenu = document.getElementById("productsSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

// Initialize page on load to restore last page
window.addEventListener("load", async () => {
  const lastPage = localStorage.getItem("lastPage");
  if (lastPage === "showAddProduct") {
    await showAddProduct();
  }
});

async function showAddProduct() {
  // Save page state
  saveLastPage("showAddProduct");

  // Show loading overlay
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading product form...</p>
    </div>
  `;

  // Load categories, brands, and locations from Firestore
  const categories = await getCollectionOptions("categories");
  const brands = await getCollectionOptions("brands");
  const locations = await getCollectionOptions("businessLocations");

  // Render professional, responsive form
  document.getElementById("content").innerHTML = `
    <style>
      .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .form-container {
        max-width: 600px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group select[multiple] {
        height: 100px;
        padding: 5px;
      }
      .form-group input[type="checkbox"],
      .form-group input[type="radio"] {
        width: auto;
        margin-right: 10px;
      }
      .form-group .radio-group {
        display: flex;
        flex-direction: row;
        gap: 20px;
        flex-wrap: wrap;
      }
      .submit-btn {
        background: #3498db;
        color: #fff;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background 0.3s;
      }
      .submit-btn:hover {
        background: #2980b9;
      }
      #addProductMessage {
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
      }
      /* Mobile responsiveness */
      @media (max-width: 600px) {
        .form-container {
          width: 95%;
          padding: 15px;
        }
        .form-container h2 {
          font-size: 20px;
        }
        .form-group label {
          font-size: 12px;
        }
        .form-group input,
        .form-group select {
          font-size: 12px;
          padding: 8px;
        }
        .form-group select[multiple] {
          height: 80px;
        }
        .submit-btn {
          font-size: 14px;
          padding: 10px;
        }
        .radio-group {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
    <div class="form-container">
      <h2>Add New Product</h2>
      <form id="addProductForm">
        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input type="text" id="productName" placeholder="Enter product name" required aria-label="Product Name" />
        </div>

        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required aria-label="Category">
            <option value="">Select category</option>
            ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="brand">Brand *</label>
          <select id="brand" required aria-label="Brand">
            <option value="">Select brand</option>
            ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="buyingPrice">Buying Price (KES) *</label>
          <input type="number" id="buyingPrice" min="0" step="0.01" placeholder="Enter buying price" required aria-label="Buying Price" />
        </div>

        <div class="form-group">
          <label for="sellingPrice">Selling Price (KES) *</label>
          <input type="number" id="sellingPrice" min="0" step="0.01" placeholder="Enter selling price" required aria-label="Selling Price" />
        </div>

        <div class="form-group">
          <label for="openingStock">Opening Stock</label>
          <input type="number" id="openingStock" min="0" step="1" placeholder="Enter opening stock" aria-label="Opening Stock" />
        </div>

        <div class="form-group">
          <label for="businessLocations">Business Locations *</label>
          <select id="businessLocations" multiple required aria-label="Business Locations">
            ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="vatable" aria-label="Vatable Product" /> Vatable Product
          </label>
        </div>

        <div class="form-group" id="vatOptions" style="display: none;">
          <label for="vatPercentage">VAT Percentage (%)</label>
          <input type="number" id="vatPercentage" min="0" max="100" step="0.01" value="16" placeholder="Enter VAT percentage" aria-label="VAT Percentage" />

          <label>VAT Inclusion *</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="vatInclusion" value="inclusive" checked /> Inclusive of Buying Price
            </label>
            <label>
              <input type="radio" name="vatInclusion" value="exclusive" /> Exclusive of Buying Price
            </label>
          </div>
        </div>

        <button type="submit" class="submit-btn">Add Product</button>
      </form>
      <div id="addProductMessage" style="color: red;"></div>
    </div>
  `;

  // Show/hide VAT options based on vatable checkbox
  const vatableCheckbox = document.getElementById("vatable");
  const vatOptions = document.getElementById("vatOptions");
  vatableCheckbox.addEventListener("change", () => {
    vatOptions.style.display = vatableCheckbox.checked ? "block" : "none";
  });

  document.getElementById("addProductForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addProductSubmit();
  });
}

async function getCollectionOptions(collectionName) {
  try {
    const snapshot = await firebase.firestore().collection(collectionName).get();
    return snapshot.docs.map(doc => doc.data().name || doc.id);
  } catch (error) {
    console.error(`Error loading ${collectionName}:`, error);
    return [];
  }
}

async function addProductSubmit() {
  const name = escapeHTML(document.getElementById("productName").value.trim());
  const category = document.getElementById("category").value;
  const brand = document.getElementById("brand").value;
  const buyingPrice = parseFloat(document.getElementById("buyingPrice").value);
  const sellingPrice = parseFloat(document.getElementById("sellingPrice").value);
  const openingStock = parseInt(document.getElementById("openingStock").value) || 0;
  const locationSelect = document.getElementById("businessLocations");
  const locations = Array.from(locationSelect.selectedOptions).map(option => option.value);
  const vatable = document.getElementById("vatable").checked;
  const vatPercentage = vatable ? parseFloat(document.getElementById("vatPercentage").value) : 0;
  const vatInclusion = vatable ? document.querySelector('input[name="vatInclusion"]:checked').value : null;

  const messageEl = document.getElementById("addProductMessage");
  messageEl.style.color = "red";

  // Basic validation
  if (!name || !category || !brand || isNaN(buyingPrice) || isNaN(sellingPrice) || locations.length === 0) {
    messageEl.textContent = "Please fill in all required fields correctly.";
    return;
  }

  if (buyingPrice < 0 || sellingPrice < 0 || openingStock < 0) {
    messageEl.textContent = "Prices and stock cannot be negative.";
    return;
  }

  // Validate selling price >= buying price
  if (sellingPrice < buyingPrice) {
    messageEl.textContent = "Selling price cannot be less than buying price.";
    return;
  }

  // Validate VAT percentage and inclusion
  if (vatable) {
    if (isNaN(vatPercentage) || vatPercentage < 0 || vatPercentage > 100) {
      messageEl.textContent = "VAT percentage must be between 0 and 100.";
      return;
    }
    if (!vatInclusion) {
      messageEl.textContent = "Please select whether VAT is inclusive or exclusive.";
      return;
    }
  }

  // Check for duplicate product by name
  const existing = await firebase.firestore().collection("products")
    .where("name", "==", name)
    .get();
  if (!existing.empty) {
    messageEl.textContent = "Product name already exists.";
    return;
  }

  // Generate SKU with category code
  const catCode = category.substring(0, 3).toUpperCase();
  const sku = `PROD-${catCode}-${Date.now()}`;

  const productData = {
    name,
    sku,
    category,
    brand,
    buyingPrice,
    sellingPrice,
    openingStock,
    locations, // Store as array
    vatable,
    vatRate: vatable ? vatPercentage / 100 : 0, // Store as decimal
    vatInclusion: vatable ? vatInclusion : null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  messageEl.innerHTML = `<span class="spinner"></span> Saving...`;
  try {
    await firebase.firestore().collection("products").add(productData);
    messageEl.style.color = "green";
    messageEl.textContent = `Product added successfully with SKU: ${sku}`;
    showSuccessNotification(`Product added successfully with SKU: ${sku}`);
    document.getElementById("addProductForm").reset();
    document.getElementById("vatOptions").style.display = "none"; // Reset VAT options visibility
  } catch (error) {
    messageEl.style.color = "red";
    messageEl.textContent = error.code === "permission-denied"
      ? "You do not have permission to add products."
      : `Error adding product: ${error.message}`;
    console.error("Error adding product:", error);
  }
}


// Initialize productManager with default filter values and pagination
const productManager = {
  products: [],
  locations: [],
  categories: [],
  brands: [],
  selectedLocation: "",
  selectedCategory: "",
  selectedBrand: "",
  currentPage: 1,
  itemsPerPage: 10
};

// Toast notification functions
function playSuccessSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(360, ctx.currentTime);
    g.gain.setValueAtTime(0.8, ctx.currentTime); // Increased volume for louder sound
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.35);
    o.stop(ctx.currentTime + 0.36);
    setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
  } catch (e) {
    console.warn("playSuccessSound error:", e);
  }
}

function showToast(message, type) {
  const prev = document.getElementById("globalToast");
  if (prev) prev.remove();

  const toast = document.createElement("div");
  toast.id = "globalToast";
  toast.textContent = message;
  Object.assign(toast.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    background: type === "success" ? "#27ae60" : "#dc3545",
    color: "white",
    padding: "12px 16px",
    borderRadius: "8px",
    boxShadow: "0 6px 18px rgba(0,0,0,0.15)",
    zIndex: 99999,
    opacity: "0",
    transform: "translateY(-8px)",
    transition: "opacity 300ms ease, transform 300ms ease",
    fontFamily: "Arial, sans-serif",
    fontSize: "14px"
  });
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  });
  if (type === "success") playSuccessSound();
  if (type === "error") document.getElementById("errorSound").play();
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => { try { toast.remove(); } catch (e) {} }, 350);
  }, 3000);
}

function showListProducts() {
  if (typeof saveLastPage === "function") saveLastPage("showListProducts");

  document.getElementById("content").innerHTML = `
    <style>
      .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        border: 1px solid #e0e0e0;
      }
      .filter-section label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-right: 8px;
      }
      .filter-section select, .filter-section input[type="text"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .filter-section select {
        width: 140px;
      }
      .filter-section input[type="text"] {
        width: 180px;
      }
      .filter-section select:focus, .filter-section input[type="text"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
      }
      .filter-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .filter-section button:hover {
        transform: translateY(-1px);
      }
      .filter-section .apply-btn {
        background: #0056b3;
        color: white;
      }
      .filter-section .apply-btn:hover {
        background: #003d82;
      }
      .filter-section .export-btn {
        background: #218838;
        color: white;
      }
      .filter-section .export-btn:hover {
        background: #1a6d2e;
      }
      .filter-section .search-help {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
      .filter-section .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
        width: 100%;
        position: relative;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .table-container table {
        width: 100%;
        border-collapse: collapse;
      }
      .table-container thead {
        position: sticky;
        top: 0;
        background: #f0f0f0;
        z-index: 1;
      }
      .table-container th, .table-container td {
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      .table-container th {
        font-weight: 600;
        color: #333;
      }
      .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        font-size: 14px;
      }
      .pagination-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .pagination-section button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .pagination-section .prev-btn, .pagination-section .next-btn {
        background: #007bff;
        color: white;
      }
      .pagination-section .prev-btn:hover:not(:disabled), .pagination-section .next-btn:hover:not(:disabled) {
        background: #0056b3;
      }
      .pagination-section select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        position: relative;
      }
      .modal-content h2 {
        margin-top: 0;
        color: #333;
        font-size: 20px;
      }
      .modal-content p, .modal-content label {
        font-size: 14px;
        color: #333;
        margin: 10px 0;
      }
      .modal-content input, .modal-content select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
      }
      .modal-content .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-content button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .modal-content .btn-primary {
        background: #007bff;
        color: white;
      }
      .modal-content .btn-primary:hover {
        background: #0056b3;
      }
      .modal-content .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .modal-content .btn-secondary:hover {
        background: #5a6268;
      }
      .modal-content .btn-danger {
        background: #dc3545;
        color: white;
      }
      .modal-content .btn-danger:hover {
        background: #c82333;
      }
      .modal-content .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        color: #333;
      }
      .modal-content .error-text {
        color: #dc3545;
        font-size: 12px;
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
      }
      @media (min-width: 601px) {
        .filter-section {
          flex-wrap: nowrap;
          justify-content: space-between;
        }
        .filter-section .filter-group {
          flex: 1;
          max-width: 200px;
        }
        .filter-section input[type="text"] {
          width: 180px;
        }
        .filter-section .search-group {
          display: flex;
          align-items: center;
          gap: 8px;
        }
      }
      @media (max-width: 600px) {
        .filter-section {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-section select, .filter-section input[type="text"] {
          width: 100%;
        }
        .filter-section .filter-group {
          width: 100%;
        }
        .pagination-section {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
    <h2>List of Products</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-group">
        <label for="locationFilter">Location:</label>
        <select id="locationFilter" aria-label="Filter by location">
          <option value="">Select Location</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="categoryFilter">Category:</label>
        <select id="categoryFilter" aria-label="Filter by category">
          <option value="">Select Category</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="brandFilter">Brand:</label>
        <select id="brandFilter" aria-label="Filter by brand">
          <option value="">Select Brand</option>
        </select>
      </div>
      <div class="search-group">
        <label for="searchProduct">Search:</label>
        <input
          type="text"
          id="searchProduct"
          placeholder="3+ chars..."
          aria-label="Search products by name"
          aria-describedby="searchHelpText"
        />
        <span id="searchHelpText" class="search-help">3+ chars</span>
      </div>
      <button id="applyProductFilterBtn" class="apply-btn">Apply</button>
      <button id="exportBtn" class="export-btn">Export</button>
    </div>

    <!-- Products Table -->
    <div class="table-container">
      <table role="grid" border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th scope="col">Product Name</th>
            <th scope="col">Category</th>
            <th scope="col">Brand</th>
            <th scope="col">Buying Price (KES)</th>
            <th scope="col">Selling Price (KES)</th>
            <th scope="col">Opening Stock</th>
            <th scope="col">Location</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTbody" aria-live="polite" aria-busy="true">
          <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Section -->
    <div class="pagination-section">
      <div>
        <label for="itemsPerPage">Show:</label>
        <select id="itemsPerPage" aria-label="Select items per page">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="1000">1000</option>
          <option value="all">All</option>
        </select>
        <span id="paginationInfo"></span>
      </div>
      <div>
        <button id="prevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextPageBtn" class="next-btn">Next</button>
      </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('viewModal')">&times;</span>
        <h2>Product Details</h2>
        <div id="viewModalContent"></div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="closeModal('viewModal')">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
  // Update the edit modal HTML in showListProducts
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editModal')">&times;</span>
    <h2>Edit Product</h2>
    <form id="editProductForm">
      <label for="editName">Product Name:</label>
      <input type="text" id="editName" required>
      <label for="editCategory">Category:</label>
      <select id="editCategory" required>
        <option value="">Select Category</option>
      </select>
      <label for="editBrand">Brand:</label>
      <select id="editBrand" required>
        <option value="">Select Brand</option>
      </select>
      <label for="editBuyingPrice">Buying Price (KES):</label>
      <input type="number" id="editBuyingPrice" min="0" step="0.01" required>
      <label for="editSellingPrice">Selling Price (KES):</label>
      <input type="number" id="editSellingPrice" min="0" step="0.01" required>
      <span id="priceError" class="error-text">Selling price must be greater than buying price.</span>
      <label for="editStock">Opening Stock:</label>
      <input type="number" id="editStock" min="0" step="1" required>
      <label for="editLocation">Locations:</label>
      <select id="editLocation" multiple required>
        <option value="">Select Locations</option>
      </select>
      <div class="modal-buttons">
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" class="btn-secondary" onclick="closeModal('editModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteModalMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Load all data and then render the table
  Promise.all([
    loadLocations(),
    loadCategories(),
    loadBrands(),
    loadProducts()
  ]).then(() => {
    renderProductsTable();
  }).catch(err => {
    console.error("Error loading data:", err);
    const tbody = document.getElementById("productsTbody");
    tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load data: ${escapeHTML(err.message)}</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
    showToast(`Failed to load data: ${err.message}`, "error");
  });

  // Debounced search (3+ chars)
  let debounceTimeout;
  document.getElementById("searchProduct").addEventListener("input", () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      productManager.currentPage = 1;
      const searchText = document.getElementById("searchProduct").value.toLowerCase();
      renderProductsTable(searchText);
    }, 300);
  });

  // Apply filter button
  document.getElementById("applyProductFilterBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    applyFilters(searchText);
  });

  // Instant filter on location change
  document.getElementById("locationFilter").addEventListener("change", () => {
    productManager.selectedLocation = document.getElementById("locationFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on category change
  document.getElementById("categoryFilter").addEventListener("change", () => {
    productManager.selectedCategory = document.getElementById("categoryFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Instant filter on brand change
  document.getElementById("brandFilter").addEventListener("change", () => {
    productManager.selectedBrand = document.getElementById("brandFilter").value;
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Items per page change
  document.getElementById("itemsPerPage").addEventListener("change", () => {
    const value = document.getElementById("itemsPerPage").value;
    productManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    productManager.currentPage = 1;
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    renderProductsTable(searchText);
  });

  // Previous page button
  document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (productManager.currentPage > 1) {
      productManager.currentPage--;
      const searchText = document.getElementById("searchProduct").value.toLowerCase();
      renderProductsTable(searchText);
    }
  });

  // Next page button
  document.getElementById("nextPageBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    const filteredProducts = getFilteredProducts(searchText);
    const maxPage = Math.ceil(filteredProducts.length / productManager.itemsPerPage);
    if (productManager.currentPage < maxPage) {
      productManager.currentPage++;
      renderProductsTable(searchText);
    }
  });

  // Export (uses filtered + searched list)
  document.getElementById("exportBtn").addEventListener("click", () => {
    const searchText = document.getElementById("searchProduct").value.toLowerCase();
    exportProductsCSV(searchText);
    showToast("Products exported successfully!", "success");
  });
}

// Helpers / Config
const MIN_SEARCH_CHARS = 3;
const fmtKES = (v) => (Number(v) || 0).toLocaleString("en-KE", { style: "currency", currency: "KES" });

// Modal helper functions
function openModal(modalId) {
  document.getElementById(modalId).style.display = "flex";
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}

// Apply filters
function applyFilters(searchText) {
  productManager.selectedLocation = document.getElementById("locationFilter").value;
  productManager.selectedCategory = document.getElementById("categoryFilter").value;
  productManager.selectedBrand = document.getElementById("brandFilter").value;
  productManager.currentPage = 1;
  renderProductsTable(searchText);
}

// Load Locations
function loadLocations() {
  return firebase.firestore().collection("businessLocations").get()
    .then(snapshot => {
      productManager.locations = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.name) productManager.locations.push(data.name);
      });

      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="">Select Location</option>`;
      productManager.locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
      });

      // Update edit modal location dropdown
      const editLocationSelect = document.getElementById("editLocation");
      editLocationSelect.innerHTML = `<option value="">Select Location</option>`;
      productManager.locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        editLocationSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading locations:", err);
      const select = document.getElementById("locationFilter");
      select.innerHTML = `<option value="">Select Location</option>`;
      showToast(`Error loading locations: ${err.message}`, "error");
    });
}

// Load Categories
function loadCategories() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.categories = [];
      const categorySet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.category) categorySet.add(data.category);
      });
      productManager.categories = Array.from(categorySet).sort();

      const filterSelect = document.getElementById("categoryFilter");
      filterSelect.innerHTML = `<option value="">Select Category</option>`;
      productManager.categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
      });

      // Update edit modal category dropdown
      const editCategorySelect = document.getElementById("editCategory");
      editCategorySelect.innerHTML = `<option value="">Select Category</option>`;
      productManager.categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        editCategorySelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading categories:", err);
      const filterSelect = document.getElementById("categoryFilter");
      filterSelect.innerHTML = `<option value="">Select Category</option>`;
      const editCategorySelect = document.getElementById("editCategory");
      editCategorySelect.innerHTML = `<option value="">Select Category</option>`;
      showToast(`Error loading categories: ${err.message}`, "error");
    });
}

// Load Brands
function loadBrands() {
  return firebase.firestore().collection("products").get()
    .then(snapshot => {
      productManager.brands = [];
      const brandSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.brand) brandSet.add(data.brand);
      });
      productManager.brands = Array.from(brandSet).sort();

      const filterSelect = document.getElementById("brandFilter");
      filterSelect.innerHTML = `<option value="">Select Brand</option>`;
      productManager.brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        filterSelect.appendChild(option);
      });

      // Update edit modal brand dropdown
      const editBrandSelect = document.getElementById("editBrand");
      editBrandSelect.innerHTML = `<option value="">Select Brand</option>`;
      productManager.brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        editBrandSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Error loading brands:", err);
      const filterSelect = document.getElementById("brandFilter");
      filterSelect.innerHTML = `<option value="">Select Brand</option>`;
      const editBrandSelect = document.getElementById("editBrand");
      editBrandSelect.innerHTML = `<option value="">Select Brand</option>`;
      showToast(`Error loading brands: ${err.message}`, "error");
    });
}

// Load Products
function loadProducts() {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");
  tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><span class="spinner"></span>Loading...</td></tr>`;

  return firebase.firestore().collection("products").orderBy("name").get()
    .then(snapshot => {
      productManager.products = [];
      snapshot.forEach(doc => {
        productManager.products.push({ id: doc.id, ...doc.data() });
      });
    })
    .catch(err => {
      console.error("Error loading products:", err);
      const tbody = document.getElementById("productsTbody");
      tbody.innerHTML = `<tr><td colspan="8" class="error-row">Failed to load products: ${escapeHTML(err.message)}</td></tr>`;
      tbody.setAttribute("aria-busy", "false");
      showToast(`Error loading products: ${err.message}`, "error");
    });
}

// Common filter logic
function getFilteredProducts(searchText = "") {
  let filtered = productManager.products;

  if (productManager.selectedLocation) {
    filtered = filtered.filter(p => Array.isArray(p.locations) && p.locations.includes(productManager.selectedLocation));
  }

  if (productManager.selectedCategory) {
    filtered = filtered.filter(p => p.category === productManager.selectedCategory);
  }

  if (productManager.selectedBrand) {
    filtered = filtered.filter(p => p.brand === productManager.selectedBrand);
  }

  const q = (searchText || "").toLowerCase();
  if (q.length >= MIN_SEARCH_CHARS) {
    filtered = filtered.filter(p =>
      (p.name && String(p.name).toLowerCase().includes(q))
    );
  }
  return filtered;
}

// Render Products + Totals
function renderProductsTable(searchText = "") {
  const tbody = document.getElementById("productsTbody");
  tbody.setAttribute("aria-busy", "true");

  const filteredProducts = getFilteredProducts(searchText);
  const totalItems = filteredProducts.length;
  const itemsPerPage = productManager.itemsPerPage;
  const currentPage = productManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("paginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No products found.";

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  if (!paginatedProducts.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No products found.</td></tr>`;
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  paginatedProducts.forEach(product => {
    fragment.appendChild(createProductRow(product));

    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;
  });

  if (paginatedProducts.length > 0) {
    const tr = document.createElement("tr");
    tr.style.background = "#f9f9f9";
    tr.style.fontWeight = "bold";
    tr.innerHTML = `
      <td colspan="3" style="text-align:right;">Totals:</td>
      <td>${fmtKES(totalBuying)}</td>
      <td>${fmtKES(totalSelling)}</td>
      <td>${totalStock}</td>
      <td colspan="2"></td>
    `;
    fragment.appendChild(tr);
  }

  tbody.innerHTML = "";
  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Create Row
function createProductRow(product) {
  const buying = fmtKES(product.buyingPrice);
  const selling = fmtKES(product.sellingPrice);
  const stock = Number(product.openingStock) || 0;
  // Join the locations array into a comma-separated string
  const locationsDisplay = Array.isArray(product.locations) ? product.locations.join(", ") : product.location || "";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="name-cell">${escapeHTML(product.name)}</td>
    <td class="category-cell">${escapeHTML(product.category)}</td>
    <td class="brand-cell">${escapeHTML(product.brand)}</td>
    <td class="buying-price-cell">${buying}</td>
    <td class="selling-price-cell">${selling}</td>
    <td class="stock-cell">${stock}</td>
    <td class="location-cell">${escapeHTML(locationsDisplay)}</td>
    <td class="actions-cell" style="white-space:nowrap;">
      <span title="View" style="cursor:pointer; color:green; margin-right:8px;">👁</span>
      <span title="Edit" style="cursor:pointer; color:#2980b9; margin-right:8px;">✏</span>
      <span title="Delete" style="cursor:pointer; color:red;">🗑</span>
    </td>
  `;

  // View action
  tr.querySelector('[title="View"]').addEventListener("click", () => {
    const viewModalContent = document.getElementById("viewModalContent");
    viewModalContent.innerHTML = `
      <p><strong>Name:</strong> ${escapeHTML(product.name)}</p>
      <p><strong>Category:</strong> ${escapeHTML(product.category)}</p>
      <p><strong>Brand:</strong> ${escapeHTML(product.brand)}</p>
      <p><strong>Buying Price:</strong> ${buying}</p>
      <p><strong>Selling Price:</strong> ${selling}</p>
      <p><strong>Opening Stock:</strong> ${stock}</p>
      <p><strong>Locations:</strong> ${escapeHTML(locationsDisplay)}</p>
    `;
    openModal("viewModal");
  });

  // Edit action
  tr.querySelector('[title="Edit"]').addEventListener("click", () => {
    document.getElementById("editName").value = product.name;
    document.getElementById("editCategory").value = product.category;
    document.getElementById("editBrand").value = product.brand;
    document.getElementById("editBuyingPrice").value = Number(product.buyingPrice) || 0;
    document.getElementById("editSellingPrice").value = Number(product.sellingPrice) || 0;
    document.getElementById("editStock").value = Number(product.openingStock) || 0;
    // Update editLocation to support multiple selections
    const editLocationSelect = document.getElementById("editLocation");
    editLocationSelect.innerHTML = productManager.locations.map(loc => `
      <option value="${loc}" ${Array.isArray(product.locations) && product.locations.includes(loc) ? "selected" : ""}>${loc}</option>
    `).join("");
    document.getElementById("priceError").style.display = "none";

    const editForm = document.getElementById("editProductForm");
    editForm.onsubmit = async (e) => {
      e.preventDefault();
      const newData = {
        name: document.getElementById("editName").value.trim(),
        category: document.getElementById("editCategory").value,
        brand: document.getElementById("editBrand").value,
        buyingPrice: Number(document.getElementById("editBuyingPrice").value),
        sellingPrice: Number(document.getElementById("editSellingPrice").value),
        openingStock: parseInt(document.getElementById("editStock").value, 10),
        locations: Array.from(document.getElementById("editLocation").selectedOptions).map(opt => opt.value),
      };

      if (!newData.name || !newData.category || !newData.brand || newData.locations.length === 0) {
        showToast("Please fill in all required fields.", "error");
        return;
      }
      if (isNaN(newData.buyingPrice) || newData.buyingPrice < 0) {
        showToast("Buying price must be a valid non-negative number.", "error");
        return;
      }
      if (isNaN(newData.sellingPrice) || newData.sellingPrice < 0) {
        showToast("Selling price must be a valid non-negative number.", "error");
        return;
      }
      if (newData.sellingPrice <= newData.buyingPrice) {
        document.getElementById("priceError").style.display = "block";
        showToast("Selling price must be greater than buying price.", "error");
        return;
      }
      if (isNaN(newData.openingStock) || newData.openingStock < 0) {
        showToast("Opening stock must be a valid non-negative number.", "error");
        return;
      }

      try {
        await firebase.firestore().collection("products").doc(product.id).update(newData);
        Object.assign(product, newData);
        Promise.all([loadCategories(), loadBrands()]).then(() => {
          closeModal("editModal");
          renderProductsTable(document.getElementById("searchProduct").value.toLowerCase());
          showToast("Product updated successfully!", "success");
        });
      } catch (err) {
        showToast(`Error updating product: ${err.message}`, "error");
      }
    };
    openModal("editModal");
  });

  // Delete action
  tr.querySelector('[title="Delete"]').addEventListener("click", () => {
    document.getElementById("deleteModalMessage").textContent = `Are you sure you want to delete ${escapeHTML(product.name)}?`;
    openModal("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
    confirmDeleteBtn.replaceWith(newConfirmDeleteBtn);
    newConfirmDeleteBtn.addEventListener("click", async () => {
      try {
        await firebase.firestore().collection("products").doc(product.id).delete();
        productManager.products = productManager.products.filter(p => p.id !== product.id);
        const searchText = document.getElementById("searchProduct").value.toLowerCase();
        const filteredProducts = getFilteredProducts(searchText);
        const maxPage = Math.ceil(filteredProducts.length / productManager.itemsPerPage);
        if (productManager.currentPage > maxPage && maxPage > 0) {
          productManager.currentPage = maxPage;
        }
        closeModal("deleteModal");
        renderProductsTable(searchText);
        showToast("Product deleted successfully!", "success");
      } catch (err) {
        showToast(`Error deleting product: ${err.message}`, "error");
      }
    });
  });

  return tr;
}

// Export CSV with Current Filters
function exportProductsCSV(searchText = "") {
  const headers = ["Name", "Category", "Brand", "Buying Price", "Selling Price", "Opening Stock", "Locations"];
  const csvRows = [headers.join(",")];

  const list = getFilteredProducts(searchText);

  let totalStock = 0;
  let totalBuying = 0;
  let totalSelling = 0;

  list.forEach(product => {
    const stock = Number(product.openingStock) || 0;
    const buy = Number(product.buyingPrice) || 0;
    const sell = Number(product.sellingPrice) || 0;

    totalStock += stock;
    totalBuying += stock * buy;
    totalSelling += stock * sell;

    const row = [
      `"${(product.name ?? "").replace(/"/g, '""')}"`,
      `"${(product.category ?? "").replace(/"/g, '""')}"`,
      `"${(product.brand ?? "").replace(/"/g, '""')}"`,
      (Number(product.buyingPrice) || 0).toFixed(2),
      (Number(product.sellingPrice) || 0).toFixed(2),
      stock,
      `"${(Array.isArray(product.locations) ? product.locations.join(";") : product.location ?? "").replace(/"/g, '""')}"`,
    ];
    csvRows.push(row.join(","));
  });

  csvRows.push([
    "Totals", "", "",
    totalBuying.toFixed(2),
    totalSelling.toFixed(2),
    totalStock,
    ""
  ].join(","));

  const csvContent = csvRows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "products.csv";
  link.click();
  URL.revokeObjectURL(link.href);
}

// Escape HTML
function escapeHTML(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  })[m]);
}


// Initialize locationManager for pagination
const locationManager = {
  locations: [],
  currentPage: 1,
  itemsPerPage: 10
};

async function showBusinessLocations() {
  saveLastPage("showBusinessLocations");

  // Show loading state
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading business locations...</p>
    </div>
  `;

  // Load existing business locations
  const locations = await loadCollection("businessLocations");

  // Render the business locations management interface
  document.getElementById("content").innerHTML = `
    <div class="form-container">
      <h2>Manage Business Locations</h2>
      <form id="addLocationForm">
        <div class="form-group">
          <div>
            <label for="newLocationName">Location Name *</label>
            <input type="text" id="newLocationName" placeholder="Location Name" required aria-label="Location Name">
          </div>
          <div>
            <label for="newLocationAddress">Address (Optional)</label>
            <input type="text" id="newLocationAddress" placeholder="Address" aria-label="Location Address">
          </div>
          <button type="submit" class="submit-btn">Add Location</button>
        </div>
      </form>
      <div id="locationMessage" style="color: red;"></div>
    </div>
    <h3>Existing Locations</h3>
    <div class="table-container">
      <table class="users-table" role="grid" border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Address</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="locationsTable" aria-live="polite" aria-busy="true"></tbody>
      </table>
    </div>
    <div class="pagination-section">
      <div>
        <label for="locationsPerPage">Show:</label>
        <select id="locationsPerPage" aria-label="Select items per page">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="paginationInfo"></span>
      </div>
      <div>
        <button id="prevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextPageBtn" class="next-btn">Next</button>
      </div>
    </div>
    <div id="deleteLocationModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteLocationModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteLocationMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteLocationBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteLocationModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Initialize pagination controls
  document.getElementById("locationsPerPage").addEventListener("change", () => {
    const value = document.getElementById("locationsPerPage").value;
    locationManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    locationManager.currentPage = 1;
    renderLocationList(locations);
  });

  document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (locationManager.currentPage > 1) {
      locationManager.currentPage--;
      renderLocationList(locations);
    }
  });

  document.getElementById("nextPageBtn").addEventListener("click", () => {
    const maxPage = Math.ceil(locationManager.locations.length / locationManager.itemsPerPage);
    if (locationManager.currentPage < maxPage) {
      locationManager.currentPage++;
      renderLocationList(locations);
    }
  });

  // Initialize form submission
  document.getElementById("addLocationForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addBusinessLocation();
  });

  // Render the list of locations
  locationManager.locations = locations;
  renderLocationList(locations);
}

// Render the list of business locations with pagination
function renderLocationList(locations) {
  const tbody = document.getElementById("locationsTable");
  tbody.setAttribute("aria-busy", "true");

  const totalItems = locations.length;
  const itemsPerPage = locationManager.itemsPerPage;
  const currentPage = locationManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedLocations = locations.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("paginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No locations found.";

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  tbody.innerHTML = "";
  if (paginatedLocations.length === 0) {
    tbody.innerHTML = "<tr><td colspan='3'>No locations found.</td></tr>";
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  paginatedLocations.forEach(loc => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", loc.id);
    tr.innerHTML = `
      <td class="desktop-cell">${escapeHTML(loc.name || "")}</td>
      <td class="desktop-cell">${escapeHTML(loc.address || "")}</td>
      <td class="desktop-actions">
        <span title="Delete" style="cursor:pointer; color:red;" onclick="deleteBusinessLocation('${loc.id}', '${escapeHTML(loc.name)}')">🗑</span>
      </td>
    `;
    fragment.appendChild(tr);
  });

  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Add a new business location
async function addBusinessLocation() {
  const nameInput = document.getElementById("newLocationName");
  const addressInput = document.getElementById("newLocationAddress");
  const messageEl = document.getElementById("locationMessage");

  const name = nameInput.value.trim();
  const address = addressInput.value.trim();

  messageEl.style.color = "red";
  if (!name) {
    messageEl.textContent = "Location name is required.";
    showToast("Location name is required.", "error");
    return;
  }

  try {
    // Check for duplicate location name
    const existing = await firebase.firestore().collection("businessLocations")
      .where("name", "==", name)
      .get();
    if (!existing.empty) {
      messageEl.textContent = "Location name already exists.";
      showToast("Location name already exists.", "error");
      return;
    }

    // Add new location to Firebase
    await firebase.firestore().collection("businessLocations").add({
      name,
      address: address || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Show success message and reset form
    messageEl.style.color = "green";
    messageEl.textContent = `Location "${name}" added successfully.`;
    showSuccessNotification(`Location "${name}" added successfully.`);
    nameInput.value = "";
    addressInput.value = "";

    // Reload and render the updated list
    const locations = await loadCollection("businessLocations");
    locationManager.locations = locations;
    renderLocationList(locations);
  } catch (error) {
    console.error("Error adding location:", error);
    messageEl.textContent = `Error adding location: ${error.message}`;
    showToast(`Error adding location: ${error.message}`, "error");
  }
}

// Delete a business location
async function deleteBusinessLocation(id, name) {
  document.getElementById("deleteLocationMessage").textContent = `Are you sure you want to delete the location "${name}"?`;
  openModal("deleteLocationModal");

  const confirmDeleteBtn = document.getElementById("confirmDeleteLocationBtn");
  const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
  confirmDeleteBtn.replaceWith(newConfirmDeleteBtn);

  newConfirmDeleteBtn.addEventListener("click", async () => {
    try {
      await firebase.firestore().collection("businessLocations").doc(id).delete();
      closeModal("deleteLocationModal");
      showSuccessNotification("Location deleted successfully.");
      const locations = await loadCollection("businessLocations");
      locationManager.locations = locations;
      renderLocationList(locations);
    } catch (error) {
      console.error("Error deleting location:", error);
      closeModal("deleteLocationModal");
      showToast(`Error deleting location: ${error.message}`, "error");
    }
  });
}

// Initialize categoryManager for pagination
const categoryManager = {
  categories: [],
  currentPage: 1,
  itemsPerPage: 10
};

async function showCategory() {
  saveLastPage("showCategory");

  // Show loading state
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading categories...</p>
    </div>
  `;

  // Try to load categories, fallback to []
  let categories = [];
  try {
    categories = await loadCollection("categories");
  } catch (err) {
    console.error("Error loading categories:", err);
    categories = [];
    showToast("Failed to load categories: " + err.message, "error");
  }

  // Render layout (always, even if error)
  document.getElementById("content").innerHTML = `
    <div class="form-container">
      <h2>Manage Categories</h2>
      <form id="addCategoryForm">
        <div class="form-group">
          <input type="text" id="newCategoryName" placeholder="Category Name *" required>
          <button type="submit" class="submit-btn">Add Category</button>
        </div>
      </form>
      <div id="categoryMessage" style="color: red;"></div>
    </div>

    <h3>Existing Categories</h3>
    <div class="table-container">
      <table class="users-table" role="grid">
        <thead>
          <tr>
            <th scope="col">Category Name</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="categoriesTable" aria-live="polite" aria-busy="true"></tbody>
      </table>
    </div>

    <div class="pagination-section">
      <div>
        <label for="categoriesPerPage">Show:</label>
        <select id="categoriesPerPage">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="paginationInfo"></span>
      </div>
      <div>
        <button id="prevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextPageBtn" class="next-btn">Next</button>
      </div>
    </div>

    <div id="deleteCategoryModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteCategoryModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteCategoryMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteCategoryBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteCategoryModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Initialize pagination controls
  document.getElementById("categoriesPerPage").addEventListener("change", () => {
    const value = document.getElementById("categoriesPerPage").value;
    categoryManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    categoryManager.currentPage = 1;
    renderCategoryList(categories);
  });

  document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (categoryManager.currentPage > 1) {
      categoryManager.currentPage--;
      renderCategoryList(categories);
    }
  });

  document.getElementById("nextPageBtn").addEventListener("click", () => {
    const maxPage = Math.ceil(categoryManager.categories.length / categoryManager.itemsPerPage);
    if (categoryManager.currentPage < maxPage) {
      categoryManager.currentPage++;
      renderCategoryList(categories);
    }
  });

  // Form submission
  document.getElementById("addCategoryForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addCategory();
  });

  // Render list
  categoryManager.categories = categories;
  renderCategoryList(categories);
}

// Render categories with pagination
function renderCategoryList(categories) {
  const tbody = document.getElementById("categoriesTable");
  tbody.setAttribute("aria-busy", "true");

  const totalItems = categories.length;
  const itemsPerPage = categoryManager.itemsPerPage;
  const currentPage = categoryManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedCategories = categories.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("paginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No categories found.";

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  tbody.innerHTML = "";
  if (paginatedCategories.length === 0) {
    tbody.innerHTML = "<tr><td colspan='2'>No categories found.</td></tr>";
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  paginatedCategories.forEach(cat => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", cat.id);
    tr.innerHTML = `
      <td>${escapeHTML(cat.name || "")}</td>
      <td class="desktop-actions">
        <span title="Delete" onclick="deleteCategory('${cat.id}', '${escapeHTML(cat.name)}')">🗑</span>
      </td>
    `;
    fragment.appendChild(tr);
  });

  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Add category
async function addCategory() {
  const nameInput = document.getElementById("newCategoryName");
  const name = nameInput.value.trim();

  if (!name) {
    showToast("Category name cannot be empty.", "error");
    return;
  }

  try {
    const existing = await firebase.firestore().collection("categories").where("name", "==", name).get();
    if (!existing.empty) {
      showToast("Category already exists.", "error");
      return;
    }

    await firebase.firestore().collection("categories").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(`Category "${name}" added successfully.`, "success");
    nameInput.value = "";

    const categories = await loadCollection("categories");
    categoryManager.categories = categories;
    renderCategoryList(categories);
  } catch (error) {
    console.error("Error adding category:", error);
    showToast("Error adding category: " + error.message, "error");
  }
}

// Delete category (with modal + toast)
async function deleteCategory(id, name) {
  document.getElementById("deleteCategoryMessage").textContent =
    `Are you sure you want to delete the category "${name}"?`;
  openModal("deleteCategoryModal");

  const confirmDeleteBtn = document.getElementById("confirmDeleteCategoryBtn");
  const newBtn = confirmDeleteBtn.cloneNode(true);
  confirmDeleteBtn.replaceWith(newBtn);

  newBtn.addEventListener("click", async () => {
    try {
      await firebase.firestore().collection("categories").doc(id).delete();
      closeModal("deleteCategoryModal");

      const categories = await loadCollection("categories");
      categoryManager.categories = categories;
      renderCategoryList(categories);

      showToast(`Category "${name}" deleted successfully.`, "success");
    } catch (error) {
      console.error("Error deleting category:", error);
      closeModal("deleteCategoryModal");
      showToast("Error deleting category: " + error.message, "error");
    }
  });
}

// Load Firestore collection safely
async function loadCollection(collectionName) {
  try {
    const snapshot = await firebase.firestore()
      .collection(collectionName)
      .orderBy("name")
      .get();

    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    console.error(`Error loading ${collectionName}:`, err);
    showToast(`Error loading ${collectionName}: ${err.message}`, "error");
    return []; // Prevent blocking UI
  }
}

// Initialize brandManager for pagination
const brandManager = {
  brands: [],
  currentPage: 1,
  itemsPerPage: 10
};

async function showBrand() {
  saveLastPage("showBrand");

  // Show loading state
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading brands...</p>
    </div>
  `;

  // Try to load brands
  let brands = [];
  try {
    brands = await loadCollection("brands");
    if (brands.length > 0) {
      showToast("Brands loaded successfully.", "success");
    } else {
      showToast("No brands found.", "error");
    }
  } catch (err) {
    console.error("Error loading brands:", err);
    brands = [];
    showToast("Failed to load brands: " + err.message, "error");
  }

  // Render layout
  document.getElementById("content").innerHTML = `
    <div class="form-container">
      <h2>Manage Brands</h2>
      <form id="addBrandForm">
        <div class="form-group">
          <input type="text" id="newBrandName" placeholder="Brand Name *" required>
          <button type="submit" class="submit-btn">Add Brand</button>
        </div>
      </form>
    </div>

    <h3>Existing Brands</h3>
    <div class="table-container">
      <table class="users-table" role="grid">
        <thead>
          <tr>
            <th scope="col">Brand Name</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="brandsTable" aria-live="polite" aria-busy="true"></tbody>
      </table>
    </div>

    <div class="pagination-section">
      <div>
        <label for="brandsPerPage">Show:</label>
        <select id="brandsPerPage">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="brandPaginationInfo"></span>
      </div>
      <div>
        <button id="prevBrandPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="nextBrandPageBtn" class="next-btn">Next</button>
      </div>
    </div>

    <div id="deleteBrandModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('deleteBrandModal')">&times;</span>
        <h2>Confirm Delete</h2>
        <p id="deleteBrandMessage"></p>
        <div class="modal-buttons">
          <button id="confirmDeleteBrandBtn" class="btn-danger">Delete</button>
          <button class="btn-secondary" onclick="closeModal('deleteBrandModal')">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Pagination controls
  document.getElementById("brandsPerPage").addEventListener("change", () => {
    const value = document.getElementById("brandsPerPage").value;
    brandManager.itemsPerPage = value === "all" ? Infinity : parseInt(value, 10);
    brandManager.currentPage = 1;
    renderBrandList(brands);
  });

  document.getElementById("prevBrandPageBtn").addEventListener("click", () => {
    if (brandManager.currentPage > 1) {
      brandManager.currentPage--;
      renderBrandList(brands);
    }
  });

  document.getElementById("nextBrandPageBtn").addEventListener("click", () => {
    const maxPage = Math.ceil(brandManager.brands.length / brandManager.itemsPerPage);
    if (brandManager.currentPage < maxPage) {
      brandManager.currentPage++;
      renderBrandList(brands);
    }
  });

  // Add brand form
  document.getElementById("addBrandForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addBrand();
  });

  // Render list
  brandManager.brands = brands;
  renderBrandList(brands);
}

// Render brands with pagination
function renderBrandList(brands) {
  const tbody = document.getElementById("brandsTable");
  tbody.setAttribute("aria-busy", "true");

  const totalItems = brands.length;
  const itemsPerPage = brandManager.itemsPerPage;
  const currentPage = brandManager.currentPage;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const paginatedBrands = brands.slice(startIndex, endIndex);

  const paginationInfo = document.getElementById("brandPaginationInfo");
  paginationInfo.textContent = totalItems > 0
    ? `Showing ${startIndex + 1} to ${endIndex} of ${totalItems}`
    : "No brands found.";

  const prevBtn = document.getElementById("prevBrandPageBtn");
  const nextBtn = document.getElementById("nextBrandPageBtn");
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);

  tbody.innerHTML = "";
  if (paginatedBrands.length === 0) {
    tbody.innerHTML = "<tr><td colspan='2'>No brands found.</td></tr>";
    tbody.setAttribute("aria-busy", "false");
    return;
  }

  const fragment = document.createDocumentFragment();
  paginatedBrands.forEach(brand => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", brand.id);
    tr.innerHTML = `
      <td>${escapeHTML(brand.name || "")}</td>
      <td class="desktop-actions">
        <span title="Delete" onclick="deleteBrand('${brand.id}', '${escapeHTML(brand.name)}')">🗑</span>
      </td>
    `;
    fragment.appendChild(tr);
  });

  tbody.appendChild(fragment);
  tbody.setAttribute("aria-busy", "false");
}

// Add brand
async function addBrand() {
  const nameInput = document.getElementById("newBrandName");
  const name = nameInput.value.trim();

  if (!name) {
    showToast("Brand name cannot be empty.", "error");
    return;
  }

  try {
    const existing = await firebase.firestore().collection("brands").where("name", "==", name).get();
    if (!existing.empty) {
      showToast("Brand already exists.", "error");
      return;
    }

    await firebase.firestore().collection("brands").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(`Brand "${name}" added successfully.`, "success");
    nameInput.value = "";

    const brands = await loadCollection("brands");
    brandManager.brands = brands;
    renderBrandList(brands);
  } catch (error) {
    console.error("Error adding brand:", error);
    showToast("Error adding brand: " + error.message, "error");
  }
}

// Delete brand (with modal + toast)
async function deleteBrand(id, name) {
  document.getElementById("deleteBrandMessage").textContent =
    `Are you sure you want to delete the brand "${name}"?`;
  openModal("deleteBrandModal");

  const confirmDeleteBtn = document.getElementById("confirmDeleteBrandBtn");
  const newBtn = confirmDeleteBtn.cloneNode(true);
  confirmDeleteBtn.replaceWith(newBtn);

  newBtn.addEventListener("click", async () => {
    try {
      await firebase.firestore().collection("brands").doc(id).delete();
      closeModal("deleteBrandModal");

      const brands = await loadCollection("brands");
      brandManager.brands = brands;
      renderBrandList(brands);

      showToast(`Brand "${name}" deleted successfully.`, "success");
    } catch (error) {
      console.error("Error deleting brand:", error);
      closeModal("deleteBrandModal");
      showToast("Error deleting brand: " + error.message, "error");
    }
  });
}

async function showPriceList() {
  saveLastPage("showPriceList");
  document.getElementById("content").innerHTML = `
    <style>
      .header-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
      }
      .header-bar h2 { margin: 0; font-size: 22px; }
      .search-bar { flex: 1; max-width: 300px; }
      .search-bar input {
        width: 100%; padding: 8px 10px;
        border: 1px solid #ccc; border-radius: 6px;
        font-size: 14px;
      }
      .update-menu { position: relative; }
      .update-btn {
        background: #007bff; color: white;
        border: none; border-radius: 6px;
        padding: 8px 12px; cursor: pointer;
        font-size: 14px; display: flex; align-items: center; gap: 6px;
      }
      .update-btn:hover { background: #0056b3; }
      .dropdown-content {
        display: none; position: absolute; right: 0; top: 100%;
        background: white; min-width: 180px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border-radius: 6px; overflow: hidden; z-index: 10;
      }
      .dropdown-content button, .dropdown-content label {
        display: block; width: 100%; text-align: left;
        padding: 10px; border: none; background: none;
        cursor: pointer; font-size: 14px;
      }
      .dropdown-content button:hover, .dropdown-content label:hover {
        background: #f5f5f5;
      }
      .update-menu:hover .dropdown-content { display: block; }
      .table-container {
        background: white; border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
      }
      table { width: 100%; border-collapse: collapse; min-width: 1000px; }
      th, td {
        border: 1px solid #ddd; padding: 8px;
        font-size: 13px; text-align: center;
      }
      th { background: #f0f0f0; }
      input.price-input {
        width: 80px; padding: 4px; text-align: right;
        border: none; background: transparent;
      }
      input.price-input.editing {
        border: 1px solid #ccc; background: #fff;
      }
      .action-btn { border: none; background: transparent; cursor: pointer; font-size: 16px; }
      .edit-icon { color: #007bff; }
      .save-icon { color: #28a745; }
    </style>

    <div class="header-bar">
      <h2>Product Price List</h2>
      <div class="search-bar">
        <input type="text" id="productSearch" placeholder="Search product...">
      </div>
      <div class="update-menu">
        <button class="update-btn">
          <i class="fas fa-sync-alt"></i> Update Price List
        </button>
        <div class="dropdown-content">
          <button onclick="exportPriceList()">
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
          <label for="importExcel">
            <i class="fas fa-upload"></i> Import from Excel
          </label>
          <input type="file" id="importExcel" accept=".xlsx, .xls" style="display:none" onchange="importPriceList(event)">
        </div>
      </div>
    </div>

    <div class="table-container">
      <table id="priceMatrixTable">
        <thead id="priceMatrixHead">
          <tr><th>Product</th><th>Buying Price</th><th>Default Selling Price</th></tr>
        </thead>
        <tbody id="priceMatrixBody">
          <tr><td colspan="100%" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  `;

  await loadPriceMatrix();
  document.getElementById("productSearch").addEventListener("input", filterProducts);
}

let allProductRows = [];
let productMap = {}; // { name -> id }
let groupMap = {};   // { groupName -> id }

async function loadPriceMatrix() {
  const headRow = document.getElementById("priceMatrixHead").querySelector("tr");
  const body = document.getElementById("priceMatrixBody");

  body.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Loading...</td></tr>";

  const [productsSnap, groupsSnap, pricesSnap] = await Promise.all([
    firebase.firestore().collection("products").orderBy("name").get(),
    firebase.firestore().collection("priceGroups").orderBy("name").get(),
    firebase.firestore().collection("priceList").get()
  ]);

  if (groupsSnap.empty || productsSnap.empty) {
    body.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>No products or groups found.</td></tr>";
    return;
  }

  // build maps
  productMap = {};
  productsSnap.forEach(p => { productMap[p.data().name] = p.id; });
  groupMap = {};
  groupsSnap.forEach(g => { groupMap[g.data().name] = g.id; });

  // existing prices
  const priceMap = {};
  pricesSnap.forEach(doc => {
    const d = doc.data();
    priceMap[`${d.productId}_${d.priceGroupId}`] = d.price;
  });

  // headers
  headRow.innerHTML = "<th>Product</th><th>Buying Price</th><th>Default Selling Price</th>";
  groupsSnap.forEach(group => {
    const g = group.data();
    headRow.innerHTML += `<th>${g.name}</th>`;
  });
  headRow.innerHTML += "<th>Action</th>";

  // rows
  body.innerHTML = "";
  allProductRows = [];
  productsSnap.forEach(product => {
    const p = product.data();
    const row = document.createElement("tr");
    row.setAttribute("data-name", p.name.toLowerCase());
    row.innerHTML = `<td>${p.name}</td><td>${p.buyingPrice || ""}</td><td>${p.sellingPrice || ""}</td>`;

    groupsSnap.forEach(group => {
      const key = `${product.id}_${group.id}`;
      const val = priceMap[key] || "";
      row.innerHTML += `
        <td>
          <input type="number" class="price-input"
            data-product="${product.id}"
            data-group="${group.id}"
            value="${val}" readonly>
        </td>`;
    });

    row.innerHTML += `
      <td>
        <button class="action-btn" onclick="toggleEditRow(this)">
          <i class="fas fa-edit edit-icon"></i>
        </button>
      </td>`;
    body.appendChild(row);
    allProductRows.push(row);
  });
}

function filterProducts() {
  const query = document.getElementById("productSearch").value.toLowerCase();
  allProductRows.forEach(row => {
    const name = row.getAttribute("data-name");
    row.style.display = name.includes(query) ? "" : "none";
  });
}

function toggleEditRow(btn) {
  const row = btn.closest("tr");
  const inputs = row.querySelectorAll("input.price-input");
  const icon = btn.querySelector("i");

  if (icon.classList.contains("fa-edit")) {
    inputs.forEach(input => {
      input.removeAttribute("readonly");
      input.classList.add("editing");
    });
    icon.classList.remove("fa-edit", "edit-icon");
    icon.classList.add("fa-save", "save-icon");
  } else {
    saveMatrixRow(row).then(() => {
      inputs.forEach(input => {
        input.setAttribute("readonly", true);
        input.classList.remove("editing");
      });
      icon.classList.remove("fa-save", "save-icon");
      icon.classList.add("fa-edit", "edit-icon");
    });
  }
}

async function saveMatrixRow(row) {
  const inputs = row.querySelectorAll("input.price-input");
  const batch = firebase.firestore().batch();
  const priceCol = firebase.firestore().collection("priceList");

  inputs.forEach(input => {
    const productId = input.dataset.product;
    const groupId = input.dataset.group;
    const price = parseFloat(input.value);
    if (!isNaN(price)) {
      const docRef = priceCol.doc(`${productId}_${groupId}`);
      batch.set(docRef, { productId, priceGroupId: groupId, price }, { merge: true });
    }
  });

  await batch.commit();
  showSuccessNotification("Prices saved successfully.");
}

// ✅ Export to Excel
function exportPriceList() {
  const wb = XLSX.utils.book_new();
  const ws_data = [];

  const headerCells = Array.from(document.querySelectorAll("#priceMatrixHead th"))
    .map(th => th.innerText);
  ws_data.push(headerCells);

  document.querySelectorAll("#priceMatrixBody tr").forEach(row => {
    const cells = Array.from(row.querySelectorAll("td")).map(td => {
      const input = td.querySelector("input");
      return input ? input.value : td.innerText;
    });
    ws_data.push(cells);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "PriceList");
  XLSX.writeFile(wb, "price_list.xlsx");
}

// ✅ Import from Excel
function importPriceList(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headers = rows[0];
    const batch = firebase.firestore().batch();
    const priceCol = firebase.firestore().collection("priceList");

    rows.slice(1).forEach(row => {
      const productName = row[0];
      const productId = productMap[productName];
      if (!productId) return;

      headers.forEach((h, idx) => {
        if (idx <= 2 || idx === headers.length - 1) return; // skip name/buying/default/Action
        const groupId = groupMap[h];
        const price = parseFloat(row[idx]);
        if (groupId && !isNaN(price)) {
          const docRef = priceCol.doc(`${productId}_${groupId}`);
          batch.set(docRef, { productId, priceGroupId: groupId, price }, { merge: true });
        }
      });
    });

    await batch.commit();
    showSuccessNotification("Price list imported successfully.");
    loadPriceMatrix();
  };
  reader.readAsArrayBuffer(file);
}

function showPriceGroups() {
  saveLastPage("showPriceGroups");
  document.getElementById("content").innerHTML = `
    <style>
      .header-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
      }
      .header-bar h2 { 
        margin: 0;
        font-size: 1.5em;
      }

      .add-button {
        padding: 8px 16px;
        border-radius: 4px;
        background: #007bff;
        color: #fff;
        border: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .add-button:hover { background: #0056b3; }

      .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 400px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 10px;
        font-size: 14px;
        text-align: left;
      }
      th { background: #f0f0f0; }

      .action-icons i {
        cursor: pointer;
        margin: 0 5px;
        font-size: 16px;
      }
      .edit-icon { color: #007bff; }
      .delete-icon { color: #dc3545; }
      .toggle-icon { color: #ffc107; }

      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        position: relative;
      }
      .modal-content h3 { margin-top: 0; }
      .modal-content label { display: block; margin-top: 10px; }
      .modal-content input {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .modal-content button {
        margin-top: 15px;
        padding: 10px 14px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      .close-btn {
        position: absolute;
        top: 10px; right: 15px;
        font-size: 20px;
        cursor: pointer;
      }

      /* Responsive Design */
      @media (max-width: 600px) {
        .header-bar {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-bar h2 {
          font-size: 1.2em;
        }
        .add-button {
          width: 100%;
          justify-content: center;
          padding: 10px;
          font-size: 16px;
        }
        th, td {
          font-size: 12px;
          padding: 8px;
        }
        .action-icons i {
          font-size: 14px;
          margin: 0 3px;
        }
        .modal-content {
          width: 95%;
          padding: 15px;
        }
      }
    </style>

    <div class="header-bar">
      <h2>Price Groups</h2>
      <button class="add-button" onclick="openPriceGroupModal()">
        <i class="fas fa-plus"></i> Add Price Group
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="priceGroupsTbody">
          <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Add/Edit Modal -->
    <div id="priceGroupModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closePriceGroupModal()">&times;</span>
        <h3 id="pgModalTitle">Add Price Group</h3>
        <input type="hidden" id="pgId">
        <label for="pgName">Name *</label>
        <input type="text" id="pgName" required>
        <label for="pgDesc">Description</label>
        <input type="text" id="pgDesc">
        <button onclick="savePriceGroup()">Save</button>
      </div>
    </div>
  `;

  loadPriceGroups();
}

function openPriceGroupModal(id = "") {
  document.getElementById("pgId").value = id || "";
  document.getElementById("pgName").value = "";
  document.getElementById("pgDesc").value = "";
  document.getElementById("pgModalTitle").innerText = id ? "Edit Price Group" : "Add Price Group";
  document.getElementById("priceGroupModal").style.display = "flex";

  if (id) {
    firebase.firestore().collection("priceGroups").doc(id).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        document.getElementById("pgName").value = data.name || "";
        document.getElementById("pgDesc").value = data.description || "";
      }
    });
  }
}

function closePriceGroupModal() {
  document.getElementById("priceGroupModal").style.display = "none";
}

// Save new or updated price group
async function savePriceGroup() {
  const id = document.getElementById("pgId").value;
  const name = document.getElementById("pgName").value.trim();
  const desc = document.getElementById("pgDesc").value.trim();

  if (!name) {
    alert("Name is required.");
    return;
  }

  try {
    if (id) {
      await firebase.firestore().collection("priceGroups").doc(id).update({
        name, description: desc
      });
      showSuccessNotification("Price Group updated.");
    } else {
      await firebase.firestore().collection("priceGroups").add({
        name, description: desc, active: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showSuccessNotification("Price Group added.");
    }
    closePriceGroupModal();
    showPriceGroups();
  } catch (err) {
    alert("Error saving price group: " + err.message);
  }
}

async function loadPriceGroups() {
  const tbody = document.getElementById("priceGroupsTbody");
  tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

  try {
    const snap = await firebase.firestore().collection("priceGroups").orderBy("createdAt", "desc").get();
    if (snap.empty) {
      tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No price groups found.</td></tr>";
      return;
    }
    tbody.innerHTML = "";
    snap.forEach(doc => {
      const pg = doc.data();
      tbody.innerHTML += `
        <tr>
          <td>${pg.name || ""}</td>
          <td>${pg.description || ""}</td>
          <td>${pg.active ? "Active" : "Inactive"}</td>
          <td class="action-icons">
            <i class="fas fa-edit edit-icon" title="Edit" onclick="openPriceGroupModal('${doc.id}')"></i>
            <i class="fas fa-trash delete-icon" title="Delete" onclick="confirmDeletePriceGroup('${doc.id}')"></i>
            <i class="fas fa-power-off toggle-icon" title="${pg.active ? "Deactivate" : "Activate"}" onclick="togglePriceGroup('${doc.id}', ${pg.active})"></i>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="4">Error loading: ${err.message}</td></tr>`;
  }
}

// Sweet confirmation for delete
function confirmDeletePriceGroup(id) {
  Swal.fire({
    title: 'Are you sure?',
    text: "This will permanently delete this Price Group.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Yes, delete it!'
  }).then(async (result) => {
    if (result.isConfirmed) {
      await firebase.firestore().collection("priceGroups").doc(id).delete();
      showSuccessNotification("Price Group deleted.");
      showPriceGroups();
    }
  });
}

async function togglePriceGroup(id, active) {
  await firebase.firestore().collection("priceGroups").doc(id).update({ active: !active });
  showSuccessNotification(`Price Group ${active ? "deactivated" : "activated"}.`);
  showPriceGroups();
}

// ---------- Units Page State ----------
const unitsState = {
  rows: [],
  filtered: [],
  currentPage: 1,
  itemsPerPage: 25,
  searchTerm: "",
  visibleCols: { name: true, shortName: true, allowDecimal: true, actions: true },
};

// ---------- Page Entrypoint ----------
async function showUnits() {
  saveLastPage("showUnits");
  const el = document.getElementById("content");
  el.innerHTML = `
    <style>
      .units-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
      .units-header h2 { margin:0; }
      .units-toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

      /* buttons */
      .units-toolbar .btn { border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
      .btn-primary { background:#5b6ee1; color:#fff; }
      .btn-outline { background:#fff; border:1px solid #ddd; }
      .btn-danger { background:#dc3545; color:#fff; }

      /* gray buttons (for Columns + PDF) */
      .btn-gray { background:#6b7280; color:#fff; border:1px solid #6b7280; }
      .btn-gray:hover { filter:brightness(0.95); }

      /* colored export buttons + compact size */
      .export-group{ display:flex; gap:6px; align-items:center; flex-wrap:nowrap; white-space:nowrap; }
      .btn-sm{ padding:4px 8px; font-size:12px; line-height:1.2; }

      .btn-csv   { background:#0d6efd; color:#fff; }
      .btn-excel { background:#198754; color:#fff; }
      .btn-print { background:#dc3545; color:#fff; }
      .btn-csv:hover, .btn-excel:hover, .btn-print:hover,
      .icon-btn:hover { filter:brightness(0.95); }

      .units-table-wrap { background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.06); padding:14px; }
      .units-flex { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; }
      .units-flex .input { padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
      .units-flex select { min-width:90px; }
      .col-visibility { position:relative; }
      .col-panel { position:absolute; top:40px; left:0; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px 10px; display:none; z-index:10; }
      .col-panel label { display:flex; gap:8px; align-items:center; padding:4px 2px; }

      /* thinner, cleaner table */
      .units-table { width:100%; border-collapse:separate; border-spacing:0; }
      .units-table th, .units-table td { border:0; border-bottom:1px solid #e9ecef; padding:10px; font-size:14px; }
      .units-table thead th { background:#f8f9fa; border-bottom:1px solid #dde1e6; text-align:left; }

      .badge { padding:2px 8px; border-radius:14px; font-size:12px; }
      .badge-yes { background:#e6f4ea; color:#2e7d32; }
      .badge-no { background:#fde7e9; color:#c62828; }

      /* tiny icon action buttons */
      .actions { white-space:nowrap; }
      .icon-btn{
        width:28px; height:28px;
        display:inline-flex; align-items:center; justify-content:center;
        border:none; border-radius:6px; cursor:pointer;
        margin-right:6px;
      }
      .icon-edit{  background:#6f42c1; color:#fff; }
      .icon-delete{background:#ff6b6b; color:#fff; }

      .pagination-section { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
      .pagination-section .pager button { padding:8px 12px; border:none; background:#007bff; color:#fff; border-radius:6px; cursor:pointer; }
      .pagination-section .pager button:disabled { background:#aaa; cursor:not-allowed; }

      @media (max-width:600px){
        .units-header { flex-direction:column; align-items:flex-start; gap:8px; }
        .units-toolbar { width:100%; }
      }
    </style>

    <div class="units-header">
      <h2>Units <small style="color:#6b7280; font-weight:400;">Manage your units</small></h2>
      <button class="btn btn-primary" onclick="openUnitModal()">+ Add</button>
    </div>

    <div class="units-table-wrap">
      <div class="units-flex">
        <div>
          Show
          <select id="unitsPerPage" class="input" onchange="changeUnitsPerPage(this.value)">
            <option>10</option><option selected>25</option><option>50</option><option>100</option><option>1000</option><option value="all">All</option>
          </select>
          entries
        </div>

        <div class="units-toolbar export-group">
          <button class="btn btn-csv btn-sm"   onclick="exportUnitsCSV()">CSV</button>
          <button class="btn btn-excel btn-sm" onclick="exportUnitsExcel()">Excel</button>
          <button class="btn btn-print btn-sm" onclick="printUnits()">Print</button>
          <div class="col-visibility">
            <button class="btn btn-gray btn-sm" onclick="toggleUnitsColPanel()">Columns</button>
            <div id="unitsColPanel" class="col-panel">
              <label><input type="checkbox" checked onchange="setUnitsCol('name', this.checked)"> Name</label>
              <label><input type="checkbox" checked onchange="setUnitsCol('shortName', this.checked)"> Short name</label>
              <label><input type="checkbox" checked onchange="setUnitsCol('allowDecimal', this.checked)"> Allow decimal</label>
              <label><input type="checkbox" checked onchange="setUnitsCol('actions', this.checked)"> Action</label>
            </div>
          </div>
          <button class="btn btn-gray btn-sm" onclick="exportUnitsPDF()">PDF</button>
        </div>

        <div style="margin-left:auto">
          <input id="unitsSearch" class="input" placeholder="Search ..." oninput="searchUnits(this.value)">
        </div>
      </div>

      <div class="table-container">
        <table class="units-table" id="unitsTable">
          <thead>
            <tr>
              <th data-col="name">Name</th>
              <th data-col="shortName">Short name</th>
              <th data-col="allowDecimal">Allow decimal</th>
              <th data-col="actions" style="width:90px;">Action</th>
            </tr>
          </thead>
          <tbody id="unitsTbody">
            <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-section">
        <div id="unitsInfo"></div>
        <div class="pager">
          <button id="unitsPrev" onclick="unitsPrevPage()" disabled>Previous</button>
          <button id="unitsNext" onclick="unitsNextPage()" disabled>Next</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="unitModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('unitModal')">&times;</span>
        <h2 id="unitModalTitle">Add Unit</h2>
        <form id="unitForm" onsubmit="submitUnitForm(event)">
          <input type="hidden" id="unitId">
          <label>Name</label>
          <input id="unitName" required>
          <label>Short name</label>
          <input id="unitShort" required>
          <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <input type="checkbox" id="unitDecimal"> Allow decimal (e.g., 1.5 kg)
          </label>
          <div class="modal-buttons" style="margin-top:18px;">
            <button type="button" class="btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
            <button type="submit" class="btn-primary">Save</button>
          </div>
          <div id="unitFormError" class="error-text" style="display:none;"></div>
        </form>
      </div>
    </div>

    <!-- Delete Confirm -->
    <div id="unitDeleteModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('unitDeleteModal')">&times;</span>
        <h2>Delete Unit</h2>
        <p id="unitDeleteText">Are you sure?</p>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="closeModal('unitDeleteModal')">Cancel</button>
          <button class="btn-danger" onclick="confirmDeleteUnit()">Delete</button>
        </div>
      </div>
    </div>
  `;

  // close column panel when clicking outside
  document.addEventListener("click", (e) => {
    const panel = document.getElementById("unitsColPanel");
    if (!panel) return;
    const trigger = e.target.closest(".col-visibility");
    if (!trigger) panel.style.display = "none";
  });

  await loadUnits();
  renderUnits();
}

// ---------- Firestore I/O ----------
async function loadUnits() {
  const snap = await firebase.firestore().collection("units").orderBy("name").get();
  unitsState.rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  unitsState.filtered = [...unitsState.rows];
  unitsState.currentPage = 1;
}

async function addUnit(data) {
  // prevent duplicate name or shortName (case-insensitive)
  const q = await firebase.firestore().collection("units")
    .where("nameLower", "==", data.name.toLowerCase()).get();
  const q2 = await firebase.firestore().collection("units")
    .where("shortLower", "==", data.shortName.toLowerCase()).get();
  if (!q.empty || !q2.empty) throw new Error("Unit name or short name already exists.");

  await firebase.firestore().collection("units").add({
    name: data.name,
    shortName: data.shortName,
    allowDecimal: !!data.allowDecimal,
    nameLower: data.name.toLowerCase(),
    shortLower: data.shortName.toLowerCase(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

async function updateUnit(id, data) {
  await firebase.firestore().collection("units").doc(id).update({
    name: data.name,
    shortName: data.shortName,
    allowDecimal: !!data.allowDecimal,
    nameLower: data.name.toLowerCase(),
    shortLower: data.shortName.toLowerCase(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

async function deleteUnit(id) {
  await firebase.firestore().collection("units").doc(id).delete();
}

// ---------- UI Handlers ----------
function changeUnitsPerPage(v) {
  unitsState.itemsPerPage = (v === "all") ? "all" : parseInt(v, 10);
  unitsState.currentPage = 1;
  renderUnits();
}

function searchUnits(term) {
  unitsState.searchTerm = term.trim().toLowerCase();
  const t = unitsState.searchTerm;
  unitsState.filtered = unitsState.rows.filter(r =>
    (r.name || "").toLowerCase().includes(t) ||
    (r.shortName || "").toLowerCase().includes(t) ||
    (r.allowDecimal ? "yes" : "no").includes(t)
  );
  unitsState.currentPage = 1;
  renderUnits();
}

function unitsPrevPage() {
  if (unitsState.currentPage > 1) { unitsState.currentPage--; renderUnits(); }
}
function unitsNextPage() {
  const total = unitsState.filtered.length;
  const ipp = unitsState.itemsPerPage === "all" ? total : unitsState.itemsPerPage;
  const pages = Math.max(1, Math.ceil(total / ipp));
  if (unitsState.currentPage < pages) { unitsState.currentPage++; renderUnits(); }
}

function toggleUnitsColPanel() {
  const p = document.getElementById("unitsColPanel");
  p.style.display = (p.style.display === "block" ? "none" : "block");
}
function setUnitsCol(key, val) {
  unitsState.visibleCols[key] = !!val;
  // hide/show headers
  document.querySelectorAll(`#unitsTable [data-col="${key}"]`).forEach(th => {
    th.style.display = val ? "" : "none";
  });
  // rows are re-rendered to apply visibility
  renderUnits();
}

// ---------- Render ----------
function renderUnits() {
  const tbody = document.getElementById("unitsTbody");
  const info = document.getElementById("unitsInfo");
  const btnPrev = document.getElementById("unitsPrev");
  const btnNext = document.getElementById("unitsNext");

  const total = unitsState.filtered.length;
  let start = 0, end = total;
  if (unitsState.itemsPerPage !== "all") {
    const ipp = unitsState.itemsPerPage;
    const pages = Math.max(1, Math.ceil(total / ipp));
    unitsState.currentPage = Math.min(unitsState.currentPage, pages);
    start = (unitsState.currentPage - 1) * ipp;
    end = Math.min(start + ipp, total);
    btnPrev.disabled = unitsState.currentPage <= 1;
    btnNext.disabled = unitsState.currentPage >= pages;
  } else {
    btnPrev.disabled = true; btnNext.disabled = true;
  }

  const slice = unitsState.filtered.slice(start, end);
  if (!slice.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No units found.</td></tr>`;
  } else {
    tbody.innerHTML = slice.map(r => `
      <tr>
        <td style="${!unitsState.visibleCols.name ? 'display:none':''}" data-col="name">${escapeHTML(r.name || "")}</td>
        <td style="${!unitsState.visibleCols.shortName ? 'display:none':''}" data-col="shortName">${escapeHTML(r.shortName || "")}</td>
        <td style="${!unitsState.visibleCols.allowDecimal ? 'display:none':''}" data-col="allowDecimal">
          <span class="badge ${r.allowDecimal ? 'badge-yes':'badge-no'}">${r.allowDecimal ? 'Yes':'No'}</span>
        </td>
        <td class="actions" style="${!unitsState.visibleCols.actions ? 'display:none':''}" data-col="actions">
          <button class="icon-btn icon-edit"   title="Edit"   onclick="openUnitModal('${r.id}')">
            <i class="fas fa-pen"></i>
          </button>
          <button class="icon-btn icon-delete" title="Delete" onclick="openDeleteUnit('${r.id}', '${escapeHTML(r.name || '')}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join("");
  }

  const showing = total ? `${start + 1} to ${end} of ${total}` : `0 of 0`;
  info.textContent = `Showing ${showing} entries`;

  // ensure header visibility matches toggles
  ["name","shortName","allowDecimal","actions"].forEach(k => {
    const th = document.querySelector(`#unitsTable thead [data-col="${k}"]`);
    if (th) th.style.display = unitsState.visibleCols[k] ? "" : "none";
  });
}

// ---------- Modal Logic ----------
function openUnitModal(id = null) {
  const title = document.getElementById("unitModalTitle");
  const idEl = document.getElementById("unitId");
  const nameEl = document.getElementById("unitName");
  const shortEl = document.getElementById("unitShort");
  const decEl = document.getElementById("unitDecimal");
  const err = document.getElementById("unitFormError");
  err.style.display = "none"; err.textContent = "";

  if (id) {
    const row = unitsState.rows.find(r => r.id === id);
    title.textContent = "Edit Unit";
    idEl.value = id;
    nameEl.value = row?.name || "";
    shortEl.value = row?.shortName || "";
    decEl.checked = !!row?.allowDecimal;
  } else {
    title.textContent = "Add Unit";
    idEl.value = "";
    nameEl.value = "";
    shortEl.value = "";
    decEl.checked = false;
  }
  document.getElementById("unitModal").style.display = "block";
}
function openDeleteUnit(id, name) {
  document.getElementById("unitDeleteModal").dataset.id = id;
  document.getElementById("unitDeleteText").textContent =
    `Delete unit "${name}"? This cannot be undone.`;
  document.getElementById("unitDeleteModal").style.display = "block";
}
async function confirmDeleteUnit() {
  const id = document.getElementById("unitDeleteModal").dataset.id;
  try {
    await deleteUnit(id);
    closeModal("unitDeleteModal");
    showSuccessNotification("Unit deleted.");
    await loadUnits();
    renderUnits();
  } catch (e) {
    alert(e.message || "Delete failed");
  }
}
function closeModal(id) {
  const m = document.getElementById(id);
  if (m) m.style.display = "none";
}

async function submitUnitForm(e) {
  e.preventDefault();
  const id = document.getElementById("unitId").value;
  const name = document.getElementById("unitName").value.trim();
  const shortName = document.getElementById("unitShort").value.trim();
  const allowDecimal = document.getElementById("unitDecimal").checked;
  const err = document.getElementById("unitFormError");

  if (!name || !shortName) {
    err.textContent = "Please provide name and short name.";
    err.style.display = "block";
    return;
  }
  if (shortName.length > 12) {
    err.textContent = "Short name is too long.";
    err.style.display = "block";
    return;
  }

  try {
    if (id) {
      await updateUnit(id, { name, shortName, allowDecimal });
      showSuccessNotification("Unit updated.");
    } else {
      await addUnit({ name, shortName, allowDecimal });
      showSuccessNotification("Unit added.");
    }
    closeModal("unitModal");
    await loadUnits();
    searchUnits(unitsState.searchTerm); // keep current filter
  } catch (e) {
    err.textContent = e.message || "Failed to save unit.";
    err.style.display = "block";
  }
}

// ---------- Exports & Print ----------
function exportUnitsCSV() {
  const cols = ["name","shortName","allowDecimal"].filter(c => unitsState.visibleCols[c]);
  const header = cols.map(h => ({ name:"Name", shortName:"Short name", allowDecimal:"Allow decimal" }[h])).join(",");
  const rows = unitsState.filtered.map(r => cols.map(c => {
    let v = (c === "allowDecimal") ? (r.allowDecimal ? "Yes":"No") : (r[c] || "");
    v = String(v).replace(/"/g,'""');
    return `"${v}"`;
  }).join(","));
  const csv = [header, ...rows].join("\n");
  downloadBlob(csv, "units.csv", "text/csv;charset=utf-8;");
}

function exportUnitsExcel() {
  const cols = ["name","shortName","allowDecimal"].filter(c => unitsState.visibleCols[c]);
  const head = cols.map(c => `<th>${({name:"Name",shortName:"Short name",allowDecimal:"Allow decimal"})[c]}</th>`).join("");
  const body = unitsState.filtered.map(r => `
    <tr>
      ${cols.map(c => {
        let v = (c==="allowDecimal") ? (r.allowDecimal ? "Yes":"No") : (escapeHTML(r[c]||""));
        return `<td>${v}</td>`;
      }).join("")}
    </tr>`).join("");
  const html = `
    <html><head><meta charset="UTF-8"></head>
    <body><table border="1"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></body></html>`;
  downloadBlob(html, "units.xls", "application/vnd.ms-excel");
}

function exportUnitsPDF() {
  const w = window.open("", "_blank");
  const cols = ["Name","Short name","Allow decimal"].filter((_,i) => {
    return [unitsState.visibleCols.name, unitsState.visibleCols.shortName, unitsState.visibleCols.allowDecimal][i];
  });
  const rows = unitsState.filtered.map(r => [
    unitsState.visibleCols.name ? escapeHTML(r.name||"") : null,
    unitsState.visibleCols.shortName ? escapeHTML(r.shortName||"") : null,
    unitsState.visibleCols.allowDecimal ? (r.allowDecimal?"Yes":"No") : null
  ].filter(x => x!==null));

  w.document.write(`
    <html><head><title>Units</title>
    <style>
      body{font-family:Arial, sans-serif; padding:16px;}
      table{width:100%; border-collapse:collapse;}
      th,td{border:1px solid #333; padding:8px; font-size:12px;}
      th{background:#eee;}
      h2{margin:0 0 10px;}
    </style>
    </head><body>
      <h2>Units</h2>
      <table><thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>
      <tbody>
        ${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}
      </tbody></table>
      <script>window.onload = () => window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function printUnits() {
  exportUnitsPDF();
}

function downloadBlob(content, filename, type) {
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// ---------- Utility ----------
function escapeHTML(str) {
  return (str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}


function togglePurchases() {
  const submenu = document.getElementById("purchasesSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

async function showAddPurchase() {
  saveLastPage("showAddPurchase");

  const suppliers = await getCollectionOptions("suppliers");
  const locations = await getCollectionOptions("businessLocations");
  const products = await getCollectionOptions("products");

  document.getElementById("content").innerHTML = `
    <h2>Add Purchase</h2>
    <form id="addPurchaseForm">
      <label>Supplier *</label>
      <select id="supplier" required>
        <option value="">Select supplier</option>
        ${suppliers.map(s => `<option value="${s}">${s}</option>`).join("")}
      </select>

      <label>Purchase Date *</label>
      <input type="date" id="purchaseDate" required>

      <label>Business Location *</label>
      <select id="location" required>
        <option value="">Select location</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
      </select>

      <label>Reference No.</label>
      <input type="text" id="referenceNo" placeholder="Optional">

      <h3>Products</h3>
      <div id="purchaseItems"></div>
      <button type="button" onclick="addPurchaseItem('${products.join(",")}')">+ Add Item</button>

      <p><strong>Total Amount:</strong> KES <span id="totalAmount">0</span></p>

      <label>Amount Paid</label>
      <input type="number" id="amountPaid" min="0" step="0.01" value="0">

      <label>Payment Method</label>
      <select id="paymentMethod">
        <option value="Cash">Cash</option>
        <option value="MPesa">MPesa</option>
        <option value="Bank">Bank</option>
        <option value="Credit">Credit</option>
      </select>

      <label>Notes</label>
      <textarea id="notes"></textarea>

      <button type="submit">Save Purchase</button>
    </form>
    <div id="purchaseMessage" style="margin-top:10px; color:red;"></div>
  `;

  document.getElementById("addPurchaseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await savePurchase();
  });
}

function addPurchaseItem(productsList) {
  let table = document.getElementById("purchaseItemsTable");

  // If table doesn't exist yet, create it
  if (!table) {
    const itemsDiv = document.getElementById("purchaseItems");
    itemsDiv.innerHTML = `
      <table id="purchaseItemsTable" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead style="background:#f0f0f0;">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price (KES)</th>
            <th>Subtotal (KES)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="purchaseItemsBody"></tbody>
      </table>
    `;
    table = document.getElementById("purchaseItemsTable");
  }

  const tbody = document.getElementById("purchaseItemsBody");

  // Create a new row
  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="item-index"></td>
    <td>
      <select class="purchaseProduct">
        ${productsList.split(",").map(p => `<option value="${p}">${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" class="purchaseQty" min="1" value="1" style="width:70px;"></td>
    <td><input type="number" class="purchasePrice" min="0" step="0.01" value="0" style="width:90px;"></td>
    <td class="itemSubtotal">0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove(); updatePurchaseIndexes(); updatePurchaseTotal()">Remove</button></td>
  `;

  // Insert row at the TOP (latest item = #1)
  if (tbody.firstChild) {
    tbody.insertBefore(row, tbody.firstChild);
  } else {
    tbody.appendChild(row);
  }

  // Bind input events
  row.querySelector(".purchaseQty").addEventListener("input", () => updateRowSubtotal(row));
  row.querySelector(".purchasePrice").addEventListener("input", () => updateRowSubtotal(row));

  // Update numbering and totals
  updatePurchaseIndexes();
  updateRowSubtotal(row);
  updatePurchaseTotal();
}

function updateRowSubtotal(row) {
  const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
  const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
  const subtotal = qty * price;
  row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  updatePurchaseTotal();
}

function updatePurchaseIndexes() {
  const rows = document.querySelectorAll("#purchaseItemsBody tr");
  rows.forEach((r, i) => {
    r.querySelector(".item-index").textContent = i + 1;
  });
}

function updatePurchaseTotal() {
  let total = 0;

  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".purchaseQty").value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice").value) || 0;
    const subtotal = qty * price;
    total += subtotal;

    // Update the row subtotal cell
    row.querySelector(".itemSubtotal").textContent = subtotal.toFixed(2);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}


async function savePurchase() {
  const supplier = document.getElementById("supplier").value;
  const date = document.getElementById("purchaseDate").value;
  const location = document.getElementById("location").value;
  const referenceNo = document.getElementById("referenceNo").value;
  const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
  const paymentMethod = document.getElementById("paymentMethod").value;
  const notes = document.getElementById("notes").value;

  const items = [];
  let totalAmount = 0;

  // Collect data from the table rows
  document.querySelectorAll("#purchaseItemsBody tr").forEach(row => {
    const productName = row.querySelector(".purchaseProduct")?.value;
    const quantity = parseFloat(row.querySelector(".purchaseQty")?.value) || 0;
    const price = parseFloat(row.querySelector(".purchasePrice")?.value) || 0;
    const subtotal = quantity * price;

    if (productName && quantity > 0 && price >= 0) {
      items.push({ productName, quantity, price, subtotal });
      totalAmount += subtotal;
    }
  });

  if (!supplier || !date || !location || items.length === 0) {
    document.getElementById("purchaseMessage").textContent =
      "Please fill in all required fields and add at least one valid item.";
    return;
  }

  try {
    // 1️⃣ Save purchase in Firestore
    await firebase.firestore().collection("purchases").add({
      supplier,
      purchaseDate: new Date(date),
      location,
      referenceNo,
      items,
      totalAmount,
      amountPaid,
      paymentMethod,
      notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

// 2️⃣ Update only the buying price for each product (do NOT touch opening stock)
for (const item of items) {
  const productRef = firebase.firestore().collection("products").where("name", "==", item.productName);
  const snapshot = await productRef.get();

  snapshot.forEach(async doc => {
    const productData = doc.data();
    const currentStock = productData.openingStock || 0;  // only used for calculation
    const currentBuyingPrice = productData.buyingPrice || 0;

    const newStock = currentStock + item.quantity; // just for weighted average calc
    const newBuyingPrice = newStock > 0
      ? ((currentStock * currentBuyingPrice) + (item.quantity * item.price)) / newStock
      : item.price;

    // ❌ Removed openingStock update
    await firebase.firestore().collection("products").doc(doc.id).update({
      buyingPrice: parseFloat(newBuyingPrice.toFixed(2))
    });
  });
}


    // 3️⃣ Reset form
    document.getElementById("addPurchaseForm").reset();
    document.getElementById("purchaseItems").innerHTML = "";
    document.getElementById("totalAmount").textContent = "0";
    const messageEl = document.getElementById("purchaseMessage");
    if (messageEl) {
      messageEl.style.color = "green";
      messageEl.textContent = ""; // keep toast as primary feedback
    }

    // Show green toast + play low success sound
    showSuccessNotification("Purchase saved successfully.");

  } catch (error) {
    document.getElementById("purchaseMessage").textContent =
      "Error saving purchase: " + error.message;
  }
}

// Track query version to prevent race conditions
let purchasesQueryVersion = 0;

// State management
const purchasesManager = { data: [], currentPage: 1, itemsPerPage: 10 };

// Debounce utility to prevent rapid query calls
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

async function showListPurchases() {
  saveLastPage("showListPurchases");

  document.getElementById("content").innerHTML = `
    <style>
      /* Base styles */
      * { box-sizing: border-box; }
      body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
      h2 { font-size: 1.5rem; margin: 0 0 1rem; text-align: center; }

      /* Filter Section */
      .filter-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        border: 1px solid #e0e0e0;
      }
      .filter-section label { 
        font-weight: 600; 
        color: #333; 
        font-size: 0.9rem; 
      }
      .filter-section select,
      .filter-section input[type="text"],
      .filter-section input[type="date"] {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9rem;
        background: #fff;
        width: 100%;
        max-width: 200px;
      }
      .filter-section button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .filter-section .apply-btn { background: #0056b3; color: white; }
      .filter-section .export-btn { background: #218838; color: white; }

      /* Table Container */
      .table-container {
        max-height: 60vh;
        overflow-y: auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }
      .table-container table { 
        width: 100%; 
        border-collapse: collapse; 
        min-width: 800px; 
      }
      .table-container th, .table-container td {
        padding: 0.75rem;
        border: 1px solid #ddd;
        font-size: 0.9rem;
        text-align: left;
      }
      .table-container thead { 
        position: sticky; 
        top: 0; 
        background: #f0f0f0; 
        z-index: 1; 
      }
      .table-container th:last-child, .table-container td:last-child { 
        min-width: 120px; 
      }

      /* Pagination Section */
      .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .pagination-section button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .pagination-section .prev-btn, .pagination-section .next-btn { 
        background: #007bff; 
        color: white; 
      }
      .pagination-section select {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }
      .modal-content {
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        max-width: 90vw;
        width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        position: relative;
      }
      .modal-content h2 { 
        margin-top: 0; 
        font-size: 1.25rem; 
      }
      .modal-content .close-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.75rem;
        font-size: 1.25rem;
        cursor: pointer;
        color: #333;
      }
      .error-message { 
        color: red; 
        text-align: center; 
        padding: 0.5rem; 
        font-size: 0.9rem; 
      }

      /* View Modal */
      .view-details { 
        line-height: 1.6; 
        font-size: 0.9rem; 
      }
      .view-details table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 0.5rem; 
      }
      .view-details th, .view-details td { 
        border: 1px solid #ddd; 
        padding: 0.5rem; 
        text-align: left; 
      }
      .view-details th { 
        background: #f0f0f0; 
      }
      .view-details tfoot { 
        font-weight: bold; 
        background: #e9ecef; 
      }
      .view-details tfoot td { 
        text-align: right; 
      }
      .view-details tfoot td:first-child { 
        text-align: left; 
      }

      /* Edit Form */
      .edit-form div { 
        margin-bottom: 1rem; 
      }
      .edit-form label { 
        display: block; 
        font-weight: 600; 
        margin-bottom: 0.3rem; 
        font-size: 0.9rem; 
      }
      .edit-form input, .edit-form select { 
        width: 100%; 
        padding: 0.5rem; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        font-size: 0.9rem; 
      }
      .edit-form .item-row { 
        display: flex; 
        gap: 0.5rem; 
        align-items: center; 
        flex-wrap: wrap; 
      }
      .edit-form .item-row input { 
        width: auto; 
        flex: 1; 
        min-width: 100px; 
      }
      .edit-form .remove-item { 
        background: #dc3545; 
        color: white; 
        padding: 0.3rem 0.6rem; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 0.8rem; 
      }
      .edit-form .add-item { 
        background: #28a745; 
        color: white; 
        padding: 0.5rem 1rem; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        margin-top: 0.5rem; 
        font-size: 0.9rem; 
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .filter-section {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-section div {
          width: 100%;
        }
        .filter-section select,
        .filter-section input[type="text"],
        .filter-section input[type="date"] {
          max-width: none;
        }
        .table-container {
          overflow-x: auto;
        }
        .table-container th, .table-container td {
          font-size: 0.8rem;
          padding: 0.5rem;
        }
        .pagination-section {
          flex-direction: column;
          align-items: stretch;
        }
        .pagination-section > div {
          margin-bottom: 0.5rem;
        }
        .modal-content {
          width: 95vw;
          max-height: 90vh;
          padding: 0.75rem;
        }
        .modal-content h2 {
          font-size: 1.1rem;
        }
        .view-details, .edit-form {
          font-size: 0.8rem;
        }
        .view-details table, .edit-form table {
          min-width: 0;
        }
        .view-details th, .view-details td {
          padding: 0.4rem;
        }
        .edit-form .item-row {
          flex-direction: column;
          align-items: stretch;
        }
        .edit-form .item-row input {
          min-width: 0;
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        h2 { font-size: 1.2rem; }
        .filter-section label, .filter-section button, 
        .pagination-section button, .pagination-section select {
          font-size: 0.8rem;
        }
        .table-container th, .table-container td {
          font-size: 0.7rem;
          padding: 0.4rem;
        }
        .modal-content {
          padding: 0.5rem;
        }
      }
    </style>

    <h2>List of Purchases</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <div>
        <label for="purchaseLocFilter">Location:</label>
        <select id="purchaseLocFilter"><option value="">All</option></select>
      </div>
      <div>
        <label for="purchaseSupFilter">Supplier:</label>
        <select id="purchaseSupFilter"><option value="">All</option></select>
      </div>
      <div>
        <label for="purchaseStartDate">From:</label>
        <input type="date" id="purchaseStartDate">
      </div>
      <div>
        <label for="purchaseEndDate">To:</label>
        <input type="date" id="purchaseEndDate">
      </div>
      <div>
        <label for="purchaseSearch">Search:</label>
        <input type="text" id="purchaseSearch" placeholder="Supplier or Ref No">
      </div>
      <button id="applyPurchasesFilterBtn" class="apply-btn">Apply</button>
      <button id="exportPurchasesBtn" class="export-btn">Export</button>
    </div>

    <!-- Purchases Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Location</th>
            <th>Supplier</th>
            <th>Total (KES)</th>
            <th>Paid (KES)</th>
            <th>Balance (KES)</th>
            <th>Payment Method</th>
            <th>Reference No</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="purchasesTbody">
          <tr><td colspan="10" class="error-message">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
      <div>
        <label for="purchasesItemsPerPage">Show:</label>
        <select id="purchasesItemsPerPage">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="purchasesPaginationInfo"></span>
      </div>
      <div>
        <button id="purchasesPrevPage" class="prev-btn" disabled>Previous</button>
        <button id="purchasesNextPage" class="next-btn">Next</button>
      </div>
    </div>

    <!-- View Modal -->
    <div id="purchaseViewModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('purchaseViewModal')">&times;</span>
        <h2>Purchase Details</h2>
        <div id="purchaseViewContent" class="view-details"></div>
        <div style="text-align:right;"><button onclick="closeModal('purchaseViewModal')">Close</button></div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="purchaseEditModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('purchaseEditModal')">&times;</span>
        <h2>Edit Purchase</h2>
        <form id="editPurchaseForm" class="edit-form">
          <div>
            <label for="editPurchaseDate">Purchase Date:</label>
            <input type="date" id="editPurchaseDate" required>
          </div>
          <div>
            <label for="editPurchaseLocation">Location:</label>
            <input type="text" id="editPurchaseLocation" required>
          </div>
          <div>
            <label for="editPurchaseSupplier">Supplier:</label>
            <input type="text" id="editPurchaseSupplier" required>
          </div>
          <div>
            <label for="editPurchasePaymentMethod">Payment Method:</label>
            <select id="editPurchasePaymentMethod" required>
              <option value="Cash">Cash</option>
              <option value="Credit">Credit</option>
              <option value="Bank Transfer">Bank Transfer</option>
            </select>
          </div>
          <div>
            <label for="editPurchaseReferenceNo">Reference No:</label>
            <input type="text" id="editPurchaseReferenceNo">
          </div>
          <div>
            <label for="editPurchaseAmountPaid">Amount Paid (KES):</label>
            <input type="number" id="editPurchaseAmountPaid" step="0.01" required>
          </div>
          <div>
            <label>Items:</label>
            <div id="editPurchaseItems"></div>
            <button type="button" class="add-item" onclick="addItemRow()">Add Item</button>
          </div>
          <div style="text-align:right;">
            <button type="submit">Save</button>
            <button type="button" onclick="closeModal('purchaseEditModal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `;

  // Verify DOM elements exist
  if (!document.getElementById("purchasesTbody")) {
    console.error("Table body not found");
    return;
  }

  // Load dropdowns
  await loadPurchaseFilterOptions();

  // Listeners with debounced loadPurchases
  const debouncedLoadPurchases = debounce(() => {
    purchasesManager.currentPage = 1;
    loadPurchases();
  }, 300);

  document.getElementById("applyPurchasesFilterBtn").addEventListener("click", debouncedLoadPurchases);
  document.getElementById("exportPurchasesBtn").addEventListener("click", exportPurchasesCSV);

  document.getElementById("purchasesPrevPage").addEventListener("click", () => {
    if (purchasesManager.currentPage > 1) {
      purchasesManager.currentPage--;
      renderPurchasesTable();
    }
  });
  document.getElementById("purchasesNextPage").addEventListener("click", () => {
    purchasesManager.currentPage++;
    renderPurchasesTable();
  });
  document.getElementById("purchasesItemsPerPage").addEventListener("change", () => {
    purchasesManager.currentPage = 1;
    renderPurchasesTable();
  });

  // Initial load
  loadPurchases();
}

// Load filter dropdowns
async function loadPurchaseFilterOptions() {
  const locSelect = document.getElementById("purchaseLocFilter");
  const supSelect = document.getElementById("purchaseSupFilter");
  const tbody = document.getElementById("purchasesTbody");

  try {
    if (!firebase.apps.length) throw new Error("Firebase not initialized");
    const snapshot = await firebase.firestore().collection("purchases").get();
    console.log("Filter options snapshot size:", snapshot.size);

    const locs = new Set(), sups = new Set();
    snapshot.forEach(d => {
      const p = d.data();
      if (p.location) locs.add(p.location);
      if (p.supplier) sups.add(p.supplier);
    });

    locSelect.innerHTML = `<option value="">All</option>`;
    supSelect.innerHTML = `<option value="">All</option>`;
    locs.forEach(l => locSelect.innerHTML += `<option>${l}</option>`);
    sups.forEach(s => supSelect.innerHTML += `<option>${s}</option>`);
  } catch (err) {
    console.error("Error loading filter options:", err);
    tbody.innerHTML = `<tr><td colspan="10" class="error-message">Error loading filters: ${err.message}</td></tr>`;
  }
}

// Load purchases
async function loadPurchases() {
  const version = ++purchasesQueryVersion;
  const tbody = document.getElementById("purchasesTbody");
  tbody.innerHTML = `<tr><td colspan="10" class="error-message">Loading...</td></tr>`;

  try {
    if (!firebase.apps.length) throw new Error("Firebase not initialized");
    if (!firebase.auth().currentUser) throw new Error("User not authenticated");

    let q = firebase.firestore().collection("purchases");
    const loc = document.getElementById("purchaseLocFilter").value;
    const sup = document.getElementById("purchaseSupFilter").value;
    const start = document.getElementById("purchaseStartDate").value;
    const end = document.getElementById("purchaseEndDate").value;
    const search = document.getElementById("purchaseSearch").value.toLowerCase();

    console.log("Query filters:", { loc, sup, start, end, search });

    if (loc) q = q.where("location", "==", loc);
    if (sup) q = q.where("supplier", "==", sup);
    if (start && end) {
      q = q.where("purchaseDate", ">=", new Date(start))
           .where("purchaseDate", "<=", new Date(`${end}T23:59:59`));
    }

    const timeout = setTimeout(() => {
      tbody.innerHTML = `<tr><td colspan="10" class="error-message">Error: Request timed out</td></tr>`;
    }, 10000);

    const snap = await q.orderBy("purchaseDate", "desc").get();
    clearTimeout(timeout);

    console.log("Snapshot size:", snap.size, "Docs:", snap.docs.map(d => d.data()));
    if (version !== purchasesQueryVersion) {
      console.log("Discarding outdated query result");
      return;
    }

    if (snap.empty) {
      purchasesManager.data = [];
      renderPurchasesTable();
      return;
    }

    purchasesManager.data = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(p => {
        const matches = !search ||
          (p.supplier || "").toLowerCase().includes(search) ||
          (p.referenceNo || "").toLowerCase().includes(search);
        console.log("Purchase:", p, "Matches search:", matches);
        return matches;
      });

    console.log("Filtered purchases:", purchasesManager.data);
    renderPurchasesTable();
  } catch (err) {
    console.error("Error loading purchases:", err);
    tbody.innerHTML = `<tr><td colspan="10" class="error-message">Error: ${err.message}</td></tr>`;
  }
}

// Render table
function renderPurchasesTable() {
  const tbody = document.getElementById("purchasesTbody");
  const info = document.getElementById("purchasesPaginationInfo");
  const perPage = document.getElementById("purchasesItemsPerPage").value;
  const allData = purchasesManager.data;

  let pageData = [];
  if (perPage === "all") {
    pageData = allData;
  } else {
    const pp = parseInt(perPage);
    const start = (purchasesManager.currentPage - 1) * pp;
    pageData = allData.slice(start, start + pp);
  }

  tbody.innerHTML = pageData.length ? "" : `<tr><td colspan="10" style="text-align:center;">No purchases found.</td></tr>`;
  pageData.forEach(p => {
    let date = "N/A";
    if (p.purchaseDate) {
      if (typeof p.purchaseDate.toDate === "function") {
        date = p.purchaseDate.toDate().toISOString().split("T")[0];
      } else {
        date = p.purchaseDate.toString().split("T")[0];
      }
    }

    // 🔹 Recalculate totals safely
    let calculatedTotal = 0;
    if (p.items && Array.isArray(p.items)) {
      calculatedTotal = p.items.reduce((sum, item) => {
        const price = Number(item.unitPrice || item.buyingPrice || 0);
        return sum + (Number(item.quantity || 0) * price);
      }, 0);
    }
    const total = Number(p.totalAmount || calculatedTotal || 0);
    const paid = Number(p.amountPaid || 0);
    const bal = total - paid;
    const status = bal > 0 ? `<span style="color:red;">Due</span>` :
                   bal < 0 ? `<span style="color:#27ae60;">Overpaid</span>` :
                             `<span style="color:green;">Paid</span>`;

    tbody.innerHTML += `
      <tr>
        <td>${date}</td>
        <td>${p.location || "N/A"}</td>
        <td>${p.supplier || "N/A"}</td>
        <td>${total.toFixed(2)}</td>
        <td>${paid.toFixed(2)}</td>
        <td>${bal.toFixed(2)}</td>
        <td>${p.paymentMethod || "N/A"}</td>
        <td>${p.referenceNo || "N/A"}</td>
        <td>${status}</td>
        <td>
          <span style="cursor:pointer; color:green;" onclick="viewPurchase('${p.id}')">👁</span>
          <span style="cursor:pointer; color:orange; margin-left:6px;" onclick="printPurchase('${p.id}')">🖨</span>
          <span style="cursor:pointer; color:blue; margin-left:6px;" onclick="editPurchase('${p.id}')">✏</span>
          <span style="cursor:pointer; color:red; margin-left:6px;" onclick="deletePurchase('${p.id}')">🗑</span>
        </td>
      </tr>`;
  });

  if (perPage !== "all") {
    const pp = parseInt(perPage);
    const start = (purchasesManager.currentPage - 1) * pp + 1;
    const end = Math.min(start + pageData.length - 1, allData.length);
    info.textContent = `Showing ${start}-${end} of ${allData.length}`;
  } else {
    info.textContent = `Showing all ${allData.length}`;
  }

  document.getElementById("purchasesPrevPage").disabled = purchasesManager.currentPage === 1;
  document.getElementById("purchasesNextPage").disabled = perPage !== "all" &&
    purchasesManager.currentPage * parseInt(perPage) >= allData.length;
}

// Close modal
function closeModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "none";
}

// View purchase details
async function viewPurchase(id) {
  const docSnap = await firebase.firestore().collection("purchases").doc(id).get();
  if (!docSnap.exists) return alert("Purchase not found");
  const p = docSnap.data();

  const paid = p.amountPaid || 0;
  const balance = (p.totalAmount || 0) - paid;

  const html = `
    <html>
      <head>
        <title>Purchase Details</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
          h1, h2, h3 { margin: 0; }
          .header { text-align: center; margin-bottom: 20px; }
          .header h1 { font-size: 22px; color: #2c3e50; }
          .header p { margin: 2px 0; font-size: 12px; color: #555; }
          .info { margin-bottom: 20px; }
          .info p { margin: 4px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f4f4f4; }
          tr:nth-child(even) { background: #fafafa; }
          .totals { margin-top: 20px; text-align: right; }
          .totals p { margin: 4px 0; font-size: 14px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; }
          .actions { text-align: center; margin-top: 20px; }
          .actions button { padding: 10px 20px; font-size: 14px; cursor: pointer; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1><!-- Business Name here --></h1>
          <p><!-- Address line here --></p>
          <p><!-- Phone | Email here --></p>
          <hr/>
        </div>

        <div class="info">
          <p><b>Date:</b> ${p.purchaseDate.toDate().toLocaleDateString()}</p>
          <p><b>Supplier:</b> ${p.supplier}</p>
          <p><b>Reference:</b> ${p.referenceNo || "-"}</p>
          <p><b>Payment Method:</b> ${p.paymentMethod || "-"}</p>
          <p><b>Location:</b> ${p.location || "-"}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price (KES)</th>
              <th>Subtotal (KES)</th>
            </tr>
          </thead>
          <tbody>
            ${p.items && p.items.length > 0
              ? p.items.map((i, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${i.productName}</td>
                  <td>${i.quantity}</td>
                  <td style="text-align:right;">${i.price.toFixed(2)}</td>
                  <td style="text-align:right;">${i.subtotal ? i.subtotal.toFixed(2) : (i.quantity * i.price).toFixed(2)}</td>
                </tr>`).join("")
              : "<tr><td colspan='5'>No items</td></tr>"}
          </tbody>
        </table>

        <div class="totals">
          <p><b>Total:</b> KES ${p.totalAmount.toFixed(2)}</p>
          <p><b>Paid:</b> KES ${paid.toFixed(2)}</p>
          <p><b>Balance:</b> KES ${balance.toFixed(2)}</p>
        </div>

        <div class="actions">
          <button onclick="window.print()">Print Purchase</button>
          <button onclick="window.close()">Close</button>
        </div>

        <div class="footer">
          <p><!-- Footer message here --></p>
        </div>
      </body>
    </html>
  `;

  const w = window.open("", "_blank", "width=800,height=600");
  w.document.write(html);
  w.document.close();
}

// Edit purchase
async function editPurchase(purchaseId) {
  try {
    const doc = await firebase.firestore().collection("purchases").doc(purchaseId).get();
    if (!doc.exists) throw new Error("Purchase not found");

    const p = { id: doc.id, ...doc.data() };
    const date = p.purchaseDate ?
      (typeof p.purchaseDate.toDate === "function" ?
        p.purchaseDate.toDate().toISOString().split("T")[0] :
        p.purchaseDate.toString().split("T")[0]) : "";

    // Populate form fields
    document.getElementById("editPurchaseDate").value = date;
    document.getElementById("editPurchaseLocation").value = p.location || "";
    document.getElementById("editPurchaseSupplier").value = p.supplier || "";
    document.getElementById("editPurchasePaymentMethod").value = p.paymentMethod || "Cash";
    document.getElementById("editPurchaseReferenceNo").value = p.referenceNo || "";
    document.getElementById("editPurchaseAmountPaid").value = p.amountPaid || 0;

    // Populate items
    const itemsContainer = document.getElementById("editPurchaseItems");
    itemsContainer.innerHTML = "";
    (p.items || []).forEach((item, index) => {
      addItemRow(item.productName, item.quantity, item.unitPrice, index);
    });

    // Handle form submission
    const form = document.getElementById("editPurchaseForm");
    form.onsubmit = async (e) => {
      e.preventDefault();
      try {
        const items = Array.from(document.querySelectorAll(".item-row")).map(row => ({
          productName: row.querySelector(".item-name").value,
          quantity: Number(row.querySelector(".item-quantity").value),
          unitPrice: Number(row.querySelector(".item-unit-price").value)
        }));
        const totalAmount = items.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);

        await firebase.firestore().collection("purchases").doc(purchaseId).update({
          purchaseDate: new Date(document.getElementById("editPurchaseDate").value),
          location: document.getElementById("editPurchaseLocation").value,
          supplier: document.getElementById("editPurchaseSupplier").value,
          paymentMethod: document.getElementById("editPurchasePaymentMethod").value,
          referenceNo: document.getElementById("editPurchaseReferenceNo").value,
          amountPaid: Number(document.getElementById("editPurchaseAmountPaid").value),
          totalAmount,
          items
        });

        closeModal("purchaseEditModal");
        loadPurchases();
        Swal.fire({
          icon: "success",
          title: "Purchase Updated",
          text: "The purchase has been updated successfully.",
          timer: 2000
        });
      } catch (err) {
        console.error("Error updating purchase:", err);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Failed to update purchase: " + err.message
        });
      }
    };

    document.getElementById("purchaseEditModal").style.display = "flex";
  } catch (err) {
    console.error("Error loading purchase for edit:", err);
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "Failed to load purchase: " + err.message
    });
  }
}

// Add item row for edit form
function addItemRow(productName = "", quantity = "", unitPrice = "", index = Date.now()) {
  const itemsContainer = document.getElementById("editPurchaseItems");
  const row = document.createElement("div");
  row.className = "item-row";
  row.id = `item-row-${index}`;
  row.innerHTML = `
    <input type="text" class="item-name" placeholder="Product Name" value="${productName}" required>
    <input type="number" class="item-quantity" placeholder="Quantity" value="${quantity}" min="1" required>
    <input type="number" class="item-unit-price" placeholder="Buying Price" value="${unitPrice}" step="0.01" min="0" required>
    <button type="button" class="remove-item" onclick="document.getElementById('item-row-${index}').remove()">Remove</button>
  `;
  itemsContainer.appendChild(row);
}


// Firestore actions
async function printPurchase(id) {
  const docSnap = await firebase.firestore().collection("purchases").doc(id).get();
  if (!docSnap.exists) return alert("Purchase not found");
  const p = docSnap.data();

  const paid = p.amountPaid || 0;
  const balance = (p.totalAmount || 0) - paid;

  const html = `
    <html>
      <head>
        <title>Purchase Receipt</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
          h1, h2, h3 { margin: 0; }
          .header { text-align: center; margin-bottom: 20px; }
          .header h1 { font-size: 22px; color: #2c3e50; }
          .header p { margin: 2px 0; font-size: 12px; color: #555; }
          .info { margin-bottom: 20px; }
          .info p { margin: 4px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f4f4f4; }
          tr:nth-child(even) { background: #fafafa; }
          .totals { margin-top: 20px; text-align: right; }
          .totals p { margin: 4px 0; font-size: 14px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1><!-- Business Name here --></h1>
          <p><!-- Address line here --></p>
          <p><!-- Phone | Email here --></p>
          <hr/>
        </div>

        <div class="info">
          <p><b>Date:</b> ${p.purchaseDate.toDate().toLocaleDateString()}</p>
          <p><b>Supplier:</b> ${p.supplier}</p>
          <p><b>Reference:</b> ${p.referenceNo || "-"}</p>
          <p><b>Payment Method:</b> ${p.paymentMethod || "-"}</p>
          <p><b>Location:</b> ${p.location || "-"}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price (KES)</th>
              <th>Subtotal (KES)</th>
            </tr>
          </thead>
          <tbody>
            ${p.items && p.items.length > 0
              ? p.items.map((i, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${i.productName}</td>
                  <td>${i.quantity}</td>
                  <td style="text-align:right;">${i.price.toFixed(2)}</td>
                  <td style="text-align:right;">${i.subtotal ? i.subtotal.toFixed(2) : (i.quantity * i.price).toFixed(2)}</td>
                </tr>`).join("")
              : "<tr><td colspan='5'>No items</td></tr>"}
          </tbody>
        </table>

        <div class="totals">
          <p><b>Total:</b> KES ${p.totalAmount.toFixed(2)}</p>
          <p><b>Paid:</b> KES ${paid.toFixed(2)}</p>
          <p><b>Balance:</b> KES ${balance.toFixed(2)}</p>
        </div>

        <div class="footer">
          <p><!-- Footer message here --></p>
        </div>
      </body>
    </html>
  `;

  const w = window.open("", "_blank", "width=800,height=600");
  w.document.write(html);
  w.document.close();
  w.print();
}


// Delete purchase
async function deletePurchase(purchaseId) {
  Swal.fire({
    title: "Confirm Delete",
    text: "Are you sure you want to delete this purchase? This action cannot be undone.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Delete",
    cancelButtonText: "Cancel",
    reverseButtons: true,
    focusCancel: true
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await firebase.firestore().collection("purchases").doc(purchaseId).delete();
        loadPurchases();
        Swal.fire({
          icon: "success",
          title: "Purchase Deleted",
          text: "The purchase has been deleted successfully.",
          timer: 2000,
          showConfirmButton: false
        });
      } catch (err) {
        console.error("Error deleting purchase:", err);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Failed to delete purchase: " + err.message
        });
      }
    }
  });
}

// Export purchases to CSV
function exportPurchasesCSV() {
  const allData = purchasesManager.data;
  if (!allData.length) {
    Swal.fire({
      icon: "warning",
      title: "No Data",
      text: "No purchases available to export.",
      showConfirmButton: true
    });
    return;
  }

  const headers = ["Date,Location,Supplier,Total (KES),Paid (KES),Balance (KES),Payment Method,Reference No,Status"];
  const rows = allData.map(p => {
    let date = "N/A";
    if (p.purchaseDate) {
      date = typeof p.purchaseDate.toDate === "function" ?
        p.purchaseDate.toDate().toISOString().split("T")[0] :
        p.purchaseDate.toString().split("T")[0];
    }
    const total = Number(p.totalAmount || 0);
    const paid = Number(p.amountPaid || 0);
    const bal = total - paid;
    const status = bal > 0 ? "Due" : bal < 0 ? "Overpaid" : "Paid";
    return `"${date}","${p.location || ""}","${p.supplier || ""}",${total.toFixed(2)},${paid.toFixed(2)},${bal.toFixed(2)},"${p.paymentMethod || ""}","${p.referenceNo || ""}","${status}"`;
  });

  const csv = headers.concat(rows).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `purchases_${new Date().toISOString().split("T")[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
}


function showPurchaseReturn() {
  saveLastPage("showPurchaseReturn");
  document.getElementById("content").innerHTML = `<h2>Purchase Return</h2><p>Coming soon...</p>`;
}


    function showRoles() { saveLastPage("showRoles"); document.getElementById("content").innerHTML = `<h2>Roles</h2><p>Define and manage user roles and permissions.</p>`; }
   
   async function showFieldSalespersons() {
  saveLastPage("showFieldSalespersons");

  document.getElementById("content").innerHTML = `
    <style>
      .form-container {
        max-width: 600px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .submit-btn {
        background: #3498db;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .submit-btn:hover {
        background: #2980b9;
      }
      .table-container {
        margin-top: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background: #f4f4f4;
      }
      .desktop-actions span {
        cursor: pointer;
        margin: 0 6px;
      }
    </style>

    <div class="form-container">
      <h2>Add Field Salesperson</h2>
      <div class="form-group">
        <label for="fsName">Full Name</label>
        <input type="text" id="fsName" placeholder="Enter full name" required />
      </div>
      <div class="form-group">
        <label for="fsEmail">Email</label>
        <input type="email" id="fsEmail" placeholder="Enter email" required />
      </div>
      <div class="form-group">
        <label for="fsPhone">Phone</label>
        <input type="text" id="fsPhone" placeholder="Enter phone number" required />
      </div>
      <div class="form-group">
        <label for="fsLocation">Assigned Location</label>
        <select id="fsLocation" required>
          <option value="">Select Location</option>
        </select>
      </div>
      <button class="submit-btn" onclick="createFieldSalesperson()">Add Salesperson</button>
      <div id="fieldSalesMessage" style="text-align:center; margin-top:10px; color:red;"></div>
    </div>

    <h3>Field Salespersons</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Location</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fieldSalesTable">
          <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  `;

  await loadBusinessLocationsDropdown("fsLocation");
  loadFieldSalespersons();
}

// Load dropdown with business locations
async function loadBusinessLocationsDropdown(selectId) {
  const select = document.getElementById(selectId);
  select.innerHTML = `<option value="">Loading...</option>`;

  try {
    const snapshot = await firebase.firestore().collection("businessLocations").orderBy("name").get();
    select.innerHTML = `<option value="">Select Location</option>`;
    snapshot.forEach(doc => {
      const loc = doc.data();
      if (loc.name) {
        const opt = document.createElement("option");
        opt.value = loc.name;
        opt.textContent = loc.name;
        select.appendChild(opt);
      }
    });
  } catch (err) {
    console.error("Error loading locations:", err);
    select.innerHTML = `<option value="">Error loading locations</option>`;
  }
}

// Create new salesperson
async function createFieldSalesperson() {
  const name = document.getElementById("fsName").value.trim();
  const email = document.getElementById("fsEmail").value.trim();
  const phone = document.getElementById("fsPhone").value.trim();
  const location = document.getElementById("fsLocation").value;

  const msgEl = document.getElementById("fieldSalesMessage");
  msgEl.style.color = "red";

  if (!name || !email || !phone || !location) {
    msgEl.textContent = "Please fill in all fields.";
    return;
  }

  try {
    await firebase.firestore().collection("fieldSalespersons").add({
      name, email, phone, location,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgEl.style.color = "green";
    msgEl.textContent = "Salesperson added successfully.";
    showSuccessNotification("Salesperson added successfully.");
    document.getElementById("fsName").value = "";
    document.getElementById("fsEmail").value = "";
    document.getElementById("fsPhone").value = "";
    document.getElementById("fsLocation").value = "";
    loadFieldSalespersons();
  } catch (error) {
    msgEl.textContent = "Error: " + error.message;
  }
}

// Load salespersons
async function loadFieldSalespersons() {
  const tbody = document.getElementById("fieldSalesTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  try {
    const snapshot = await firebase.firestore().collection("fieldSalespersons").orderBy("name").get();
    tbody.innerHTML = "";
    if (snapshot.empty) {
      tbody.innerHTML = "<tr><td colspan='5'>No salespersons found.</td></tr>";
      return;
    }

    snapshot.forEach(doc => {
      const sp = doc.data();
      tbody.innerHTML += `
        <tr data-id="${doc.id}">
          <td>${sp.name || ""}</td>
          <td>${sp.email || ""}</td>
          <td>${sp.phone || ""}</td>
          <td>${sp.location || ""}</td>
          <td class="desktop-actions">
            <span style="color:#2980b9;" onclick="editFieldSalesperson('${doc.id}')">✏</span>
            <span style="color:red;" onclick="deleteFieldSalesperson('${doc.id}')">🗑</span>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan='5'>Error: ${err.message}</td></tr>`;
  }
}

// Edit salesperson (basic prompt version)
async function editFieldSalesperson(id) {
  const docRef = firebase.firestore().collection("fieldSalespersons").doc(id);
  const docSnap = await docRef.get();
  if (!docSnap.exists) return alert("Salesperson not found");

  const sp = docSnap.data();
  const newName = prompt("Enter new name:", sp.name);
  if (newName === null) return;

  try {
    await docRef.update({ name: newName });
    showSuccessNotification("Updated successfully.");
    loadFieldSalespersons();
  } catch (err) {
    alert("Error updating: " + err.message);
  }
}

// Delete salesperson
async function deleteFieldSalesperson(id) {
  if (!confirm("Are you sure you want to delete this salesperson?")) return;

  try {
    await firebase.firestore().collection("fieldSalespersons").doc(id).delete();
    showSuccessNotification("Deleted successfully.");
    loadFieldSalespersons();
  } catch (err) {
    alert("Error deleting: " + err.message);
  }
}

    
	function showSuppliers() {
  saveLastPage("showSuppliers");
  document.getElementById("content").innerHTML = `
    <h2>Suppliers</h2>
    <input type="text" id="supplierName" placeholder="Supplier Name" required>
    <input type="text" id="supplierPhone" placeholder="Phone">
    <input type="email" id="supplierEmail" placeholder="Email">
    <input type="text" id="supplierAddress" placeholder="Address">
    <button onclick="addSupplier()">Add Supplier</button>
    <div id="supplierMessage" style="margin-top:10px; color:red;"></div>

    <h3>Existing Suppliers</h3>
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#eee;">
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="suppliersTable"></tbody>
    </table>
  `;

  loadSuppliers();
}

function addSupplier() {
  const name = document.getElementById("supplierName").value.trim();
  const phone = document.getElementById("supplierPhone").value.trim();
  const email = document.getElementById("supplierEmail").value.trim();
  const address = document.getElementById("supplierAddress").value.trim();
  const msg = document.getElementById("supplierMessage");

  if (!name) {
    msg.textContent = "Supplier name is required.";
    return;
  }

  firebase.firestore().collection("suppliers").add({
    name, phone, email, address,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    msg.style.color = "green";
    msg.textContent = "Supplier added successfully.";
    document.getElementById("supplierName").value = "";
    document.getElementById("supplierPhone").value = "";
    document.getElementById("supplierEmail").value = "";
    document.getElementById("supplierAddress").value = "";
    loadSuppliers();
  })
  .catch(err => {
    msg.style.color = "red";
    msg.textContent = "Error: " + err.message;
  });
}

function loadSuppliers() {
  const table = document.getElementById("suppliersTable");
  table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  firebase.firestore().collection("suppliers").orderBy("name").get()
    .then(snapshot => {
      table.innerHTML = "";
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='5'>No suppliers found.</td></tr>";
        return;
      }
      snapshot.forEach(doc => {
        const s = doc.data();
        table.innerHTML += `
          <tr>
            <td>${s.name}</td>
            <td>${s.phone || ""}</td>
            <td>${s.email || ""}</td>
            <td>${s.address || ""}</td>
            <td><button style="background:red;color:white;" onclick="deleteSupplier('${doc.id}')">Delete</button></td>
          </tr>
        `;
      });
    })
    .catch(err => {
      table.innerHTML = `<tr><td colspan='5'>Error loading suppliers: ${err.message}</td></tr>`;
    });
}

function deleteSupplier(id) {
  if (!confirm("Delete this supplier?")) return;
  firebase.firestore().collection("suppliers").doc(id).delete()
    .then(() => loadSuppliers())
    .catch(err => alert("Error deleting: " + err.message));
}
 
 // ==========================
// Customer Groups Management
// ==========================
async function showCustomerGroups() {
  saveLastPage("showCustomerGroups");

  document.getElementById("content").innerHTML = `
    <style>
      .form-container {
        max-width: 500px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group { margin-bottom: 15px; }
      .form-group label { display:block; font-weight:600; margin-bottom:5px; }
      .form-group input, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .submit-btn {
        background: #3498db;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .submit-btn:hover { background: #2980b9; }
      .table-container {
        margin-top: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
      }
      table { width:100%; border-collapse:collapse; }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th { background: #f4f4f4; }
      .desktop-actions span {
        cursor: pointer;
        margin: 0 6px;
      }
      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-box {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      .modal-box h3 { margin-bottom: 15px; }
      .modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .btn-confirm {
        background: #e74c3c;
        color:#fff;
        border:none;
        padding:8px 14px;
        border-radius:4px;
        cursor:pointer;
      }
      .btn-cancel {
        background: #ccc;
        color:#000;
        border:none;
        padding:8px 14px;
        border-radius:4px;
        cursor:pointer;
      }
    </style>

    <div class="form-container">
      <h2>Add Customer Group</h2>
      <div class="form-group">
        <label for="cgName">Group Name</label>
        <input type="text" id="cgName" placeholder="e.g. Retail, Wholesale, VIP" required />
      </div>
      <div class="form-group">
        <label for="cgDescription">Description</label>
        <textarea id="cgDescription" rows="2" placeholder="Optional description..."></textarea>
      </div>
      <button class="submit-btn" onclick="createCustomerGroup()">Add Group</button>
      <div id="customerGroupMessage" style="text-align:center; margin-top:10px; color:red;"></div>
    </div>

    <h3>Customer Groups</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Group Name</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customerGroupsTable">
          <tr><td colspan="3" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteGroupModal" class="modal-overlay">
      <div class="modal-box">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this customer group?</p>
        <div class="modal-actions">
          <button class="btn-confirm" id="confirmDeleteGroupBtn">Delete</button>
          <button class="btn-cancel" onclick="closeDeleteGroupModal()">Cancel</button>
        </div>
      </div>
    </div>
  `;

  loadCustomerGroups();
}

// Add new group
async function createCustomerGroup() {
  const name = document.getElementById("cgName").value.trim();
  const description = document.getElementById("cgDescription").value.trim();
  const msgEl = document.getElementById("customerGroupMessage");
  msgEl.style.color = "red";

  if (!name) {
    msgEl.textContent = "Group name is required.";
    return;
  }

  try {
    await firebase.firestore().collection("customerGroups").add({
      name, description,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgEl.style.color = "green";
    msgEl.textContent = "Group added successfully.";
    showSuccessNotification("Customer group added.");
    document.getElementById("cgName").value = "";
    document.getElementById("cgDescription").value = "";
    loadCustomerGroups();
  } catch (err) {
    msgEl.textContent = "Error: " + err.message;
  }
}

// Load groups
async function loadCustomerGroups() {
  const tbody = document.getElementById("customerGroupsTable");
  tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

  try {
    const snapshot = await firebase.firestore().collection("customerGroups").orderBy("name").get();
    tbody.innerHTML = "";
    if (snapshot.empty) {
      tbody.innerHTML = "<tr><td colspan='3'>No customer groups found.</td></tr>";
      return;
    }

    snapshot.forEach(doc => {
      const g = doc.data();
      tbody.innerHTML += `
        <tr data-id="${doc.id}">
          <td>${g.name || ""}</td>
          <td>${g.description || ""}</td>
          <td class="desktop-actions">
            <span style="color:#2980b9;" onclick="editCustomerGroup('${doc.id}')">✏</span>
            <span style="color:red;" onclick="openDeleteGroupModal('${doc.id}')">🗑</span>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="3">Error: ${err.message}</td></tr>`;
  }
}

// Edit group (basic prompt)
async function editCustomerGroup(id) {
  const docRef = firebase.firestore().collection("customerGroups").doc(id);
  const docSnap = await docRef.get();
  if (!docSnap.exists) return alert("Group not found");

  const g = docSnap.data();
  const newName = prompt("Enter new name:", g.name);
  const newDesc = prompt("Enter new description:", g.description || "");
  if (newName === null) return;

  try {
    await docRef.update({ name: newName, description: newDesc });
    showSuccessNotification("Group updated.");
    loadCustomerGroups();
  } catch (err) {
    alert("Error updating: " + err.message);
  }
}

// ---- Delete with modal ----
let deleteGroupId = null;

function openDeleteGroupModal(id) {
  deleteGroupId = id;
  document.getElementById("deleteGroupModal").style.display = "flex";
  document.getElementById("confirmDeleteGroupBtn").onclick = confirmDeleteGroup;
}

function closeDeleteGroupModal() {
  document.getElementById("deleteGroupModal").style.display = "none";
  deleteGroupId = null;
}

async function confirmDeleteGroup() {
  if (!deleteGroupId) return;
  try {
    await firebase.firestore().collection("customerGroups").doc(deleteGroupId).delete();
    showSuccessNotification("Group deleted.");
    closeDeleteGroupModal();
    loadCustomerGroups();
  } catch (err) {
    alert("Error deleting: " + err.message);
  }
}

 
// ==========================
// Customers Management
// ==========================
async function showCustomers() {
  saveLastPage("showCustomers");

  document.getElementById("content").innerHTML = `
    <style>
      .top-controls {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      .filter-row {
        display: flex;
        gap: 10px;
        width: 100%;
        flex-wrap: wrap;
        align-items: center;
      }
      .filter-row input, .filter-row select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        flex: 1;
        min-width: 150px;
        box-sizing: border-box;
      }
      .button-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .add-button-row {
        display: flex;
        justify-content: flex-start;
        width: 100%;
      }
      .btn-primary {
        background: #3498db;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-primary:hover { background: #2980b9; }
      .btn-danger {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-danger:hover { background: #c0392b; }
      .btn-secondary {
        background: #95a5a6;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-secondary:hover { background: #7f8c8d; }
      .table-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
      }
      table { width: 100%; border-collapse: collapse; }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th { background: #f4f4f4; }
      .desktop-actions span {
        cursor: pointer;
        margin: 0 6px;
      }
      .pagination {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-in-out;
      }
      .modal-box {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        width: 100%;
        max-width: 500px;
        max-height: 80vh; /* Limit height to 80% of viewport */
        overflow-y: auto; /* Enable vertical scrolling */
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease-in-out;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      .form-group .error {
        border-color: #e74c3c;
      }
      .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
      }
      .btn-circle {
        background: #3498db;
        color: #fff;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-circle:hover { background: #2980b9; }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @media (max-width: 600px) {
        .filter-row input, .filter-row select {
          min-width: 100%;
        }
      }
    </style>

    <h2>Customers</h2>

    <!-- Filters and Actions -->
    <div class="top-controls">
      <div class="filter-row">
        <input type="text" id="customerSearch" placeholder="Search customers..." oninput="loadCustomers()" />
        <select id="groupFilter">
          <option value="">All Groups</option>
        </select>
        <select id="locationFilter">
          <option value="">All Locations</option>
        </select>
      </div>
      <div class="button-row">
        <button class="btn-primary" onclick="applyFilters()">Apply Filter</button>
        <button class="btn-secondary" onclick="resetFilters()">Reset Filters</button>
        <button class="btn-secondary" onclick="exportCustomers()">Export</button>
      </div>
      <div class="add-button-row">
        <button class="btn-circle" title="Add Customer" onclick="openCustomerModal()">+</button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Group</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Location</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customersTable">
          <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <span id="customersInfo">Showing 0 to 0 of 0 entries</span>
      <div>
        <button class="btn-secondary" onclick="prevCustomersPage()">Prev</button>
        <button class="btn-secondary" onclick="nextCustomersPage()">Next</button>
      </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal-overlay" style="display:none;">
      <div class="modal-box">
        <h3 id="customerModalTitle">Add Customer</h3>
        <div class="form-group">
          <label for="custName">Full Name <span style="color:#e74c3c;">*</span></label>
          <input type="text" id="custName" placeholder="Enter full name" />
          <div id="custNameError" class="error-message">Name is required</div>
        </div>
        <div class="form-group">
          <label for="custEmail">Email</label>
          <input type="email" id="custEmail" placeholder="Enter email" />
          <div id="custEmailError" class="error-message">Invalid email format</div>
        </div>
        <div class="form-group">
          <label for="custPhone">Phone</label>
          <input type="text" id="custPhone" placeholder="Enter phone number" />
        </div>
        <div class="form-group">
          <label for="custGroup">Customer Group <span style="color:#e74c3c;">*</span></label>
          <select id="custGroup">
            <option value="">Select Group</option>
          </select>
          <div id="custGroupError" class="error-message">Group is required</div>
        </div>
        <div class="form-group">
          <label for="custLocation">Location</label>
          <input type="text" id="custLocation" placeholder="Enter location" />
        </div>
        <div class="form-group">
          <label for="custStatus">Status <span style="color:#e74c3c;">*</span></label>
          <select id="custStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label for="custNotes">Notes</label>
          <textarea id="custNotes" placeholder="Enter any additional notes"></textarea>
        </div>
        <div style="margin-top:15px; text-align:right;">
          <button class="btn-secondary" onclick="closeCustomerModal()">Cancel</button>
          <button class="btn-primary" onclick="saveCustomer()">Save</button>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteCustomerModal" class="modal-overlay" style="display:none;">
      <div class="modal-box">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this customer?</p>
        <div class="modal-actions">
          <button class="btn-danger" id="confirmDeleteCustomerBtn">Delete</button>
          <button class="btn-secondary" onclick="closeDeleteCustomerModal()">Cancel</button>
        </div>
      </div>
    </div>
  `;

  await loadCustomerFilters();
  loadCustomers();
}

// ------------------------------
// Filters (Groups + Locations)
// ------------------------------
async function loadCustomerFilters() {
  // Customer groups
  const groupSel = document.getElementById("groupFilter");
  const custGroupSel = document.getElementById("custGroup");
  groupSel.innerHTML = `<option value="">All Groups</option>`;
  custGroupSel.innerHTML = `<option value="">Select Group</option>`;

  const groupsSnap = await firebase.firestore().collection("customerGroups").orderBy("name").get();
  groupsSnap.forEach(doc => {
    const g = doc.data();
    const opt1 = document.createElement("option");
    opt1.value = doc.id;
    opt1.textContent = g.name;
    groupSel.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = doc.id;
    opt2.textContent = g.name;
    custGroupSel.appendChild(opt2);
  });

  // Locations (from existing customers)
  const locSel = document.getElementById("locationFilter");
  locSel.innerHTML = `<option value="">All Locations</option>`;
  const locSnap = await firebase.firestore().collection("customers").get();
  const locations = new Set();
  locSnap.forEach(d => { 
    if (d.data().location && d.data().location.trim()) {
      locations.add(d.data().location.trim());
    }
  });
  [...locations].sort().forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc;
    opt.textContent = loc;
    locSel.appendChild(opt);
  });
}

// ------------------------------
// Apply and Reset Filters
// ------------------------------
function applyFilters() {
  loadCustomers("first");
}

function resetFilters() {
  document.getElementById("customerSearch").value = "";
  document.getElementById("groupFilter").value = "";
  document.getElementById("locationFilter").value = "";
  loadCustomers("first");
}

// ------------------------------
// Pagination
// ------------------------------
let customersPageSize = 10;
let customersLastDoc = null;
let customersFirstDoc = null;

async function loadCustomers(direction = "first") {
  const tbody = document.getElementById("customersTable");
  tbody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

  let query = firebase.firestore().collection("customers").orderBy("name").limit(customersPageSize);

  const search = document.getElementById("customerSearch").value.trim().toLowerCase();
  const groupFilter = document.getElementById("groupFilter").value;
  const locationFilter = document.getElementById("locationFilter").value;

  if (groupFilter) query = query.where("groupId", "==", groupFilter);
  if (locationFilter) query = query.where("location", "==", locationFilter);

  if (direction === "next" && customersLastDoc) query = query.startAfter(customersLastDoc);
  if (direction === "prev" && customersFirstDoc) query = query.endBefore(customersFirstDoc).limitToLast(customersPageSize);

  const snapshot = await query.get();

  if (snapshot.empty) {
    tbody.innerHTML = "<tr><td colspan='7'>No customers found.</td></tr>";
    return;
  }

  customersFirstDoc = snapshot.docs[0];
  customersLastDoc = snapshot.docs[snapshot.docs.length - 1];

  tbody.innerHTML = "";
  snapshot.forEach(doc => {
    const c = doc.data();
    if (search && !c.name?.toLowerCase().includes(search) && !c.email?.toLowerCase().includes(search)) return;

    tbody.innerHTML += `
      <tr>
        <td>${c.name || ""}</td>
        <td>${c.groupName || ""}</td>
        <td>${c.email || ""}</td>
        <td>${c.phone || ""}</td>
        <td>${c.location || ""}</td>
        <td>${c.status || ""}</td>
        <td class="desktop-actions">
          <span style="color:#2980b9;" onclick="viewCustomer('${doc.id}')">👁</span>
          <span style="color:#27ae60;" onclick="editCustomer('${doc.id}')">✏</span>
          <span style="color:red;" onclick="openDeleteCustomerModal('${doc.id}')">🗑</span>
        </td>
      </tr>
    `;
  });

  document.getElementById("customersInfo").textContent =
    `Showing ${snapshot.size} customers (paged)`;
}

function nextCustomersPage() { loadCustomers("next"); }
function prevCustomersPage() { loadCustomers("prev"); }

// ------------------------------
// CRUD
// ------------------------------
function openCustomerModal() {
  // Clear form fields
  document.getElementById("custName").value = "";
  document.getElementById("custEmail").value = "";
  document.getElementById("custPhone").value = "";
  document.getElementById("custGroup").value = "";
  document.getElementById("custLocation").value = "";
  document.getElementById("custStatus").value = "active";
  document.getElementById("custNotes").value = "";
  
  // Reset error states
  document.getElementById("custName").classList.remove("error");
  document.getElementById("custNameError").style.display = "none";
  document.getElementById("custEmail").classList.remove("error");
  document.getElementById("custEmailError").style.display = "none";
  document.getElementById("custGroup").classList.remove("error");
  document.getElementById("custGroupError").style.display = "none";

  document.getElementById("customerModalTitle").textContent = "Add Customer";
  document.getElementById("customerModal").style.display = "flex";
}

function closeCustomerModal() { 
  document.getElementById("customerModal").style.display = "none"; 
}

async function saveCustomer() {
  const name = document.getElementById("custName").value.trim();
  const email = document.getElementById("custEmail").value.trim();
  const phone = document.getElementById("custPhone").value.trim();
  const groupId = document.getElementById("custGroup").value;
  const location = document.getElementById("custLocation").value.trim();
  const status = document.getElementById("custStatus").value;
  const notes = document.getElementById("custNotes").value.trim();

  // Reset error states
  document.getElementById("custName").classList.remove("error");
  document.getElementById("custNameError").style.display = "none";
  document.getElementById("custEmail").classList.remove("error");
  document.getElementById("custEmailError").style.display = "none";
  document.getElementById("custGroup").classList.remove("error");
  document.getElementById("custGroupError").style.display = "none";

  // Validation
  let isValid = true;
  if (!name) {
    document.getElementById("custName").classList.add("error");
    document.getElementById("custNameError").style.display = "block";
    isValid = false;
  }
  if (!groupId) {
    document.getElementById("custGroup").classList.add("error");
    document.getElementById("custGroupError").style.display = "block";
    isValid = false;
  }
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById("custEmail").classList.add("error");
    document.getElementById("custEmailError").style.display = "block";
    isValid = false;
  }

  if (!isValid) {
    showErrorNotification("Please correct the errors in the form.");
    return;
  }

  // Lookup group name
  let groupName = "";
  if (groupId) {
    const groupDoc = await firebase.firestore().collection("customerGroups").doc(groupId).get();
    if (groupDoc.exists) groupName = groupDoc.data().name;
  }

  try {
    await firebase.firestore().collection("customers").add({
      name,
      email,
      phone,
      groupId,
      groupName,
      location,
      status,
      notes,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showSuccessNotification("Customer saved.");
    closeCustomerModal();
    await loadCustomerFilters(); // Refresh filters to include new location
    loadCustomers(); // Refresh table to show new customer
  } catch (err) {
    showErrorNotification("Error: " + err.message);
  }
}

function viewCustomer(id) {
  alert("View details for " + id);
}

function editCustomer(id) {
  // TODO: load data into modal for editing
  openCustomerModal();
}

let deleteCustomerId = null;
function openDeleteCustomerModal(id) {
  deleteCustomerId = id;
  document.getElementById("deleteCustomerModal").style.display = "flex";
  document.getElementById("confirmDeleteCustomerBtn").onclick = confirmDeleteCustomer;
}

function closeDeleteCustomerModal() { 
  document.getElementById("deleteCustomerModal").style.display = "none"; 
}

async function confirmDeleteCustomer() {
  try {
    await firebase.firestore().collection("customers").doc(deleteCustomerId).delete();
    showSuccessNotification("Customer deleted.");
    closeDeleteCustomerModal();
    await loadCustomerFilters(); // Refresh filters in case location is no longer used
    loadCustomers();
  } catch (err) {
    showErrorNotification("Error: " + err.message);
  }
}

// ------------------------------
// Export
// ------------------------------
function exportCustomers() {
  alert("Export not implemented yet");
}

function toggleSell() {
  const submenu = document.getElementById("sellSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}


let saleItems = [];    // store sale items globally
let expenseItems = []; // store field expenses globally
// Live expenses listener handle
let expensesUnsub = null;


async function showAddSale() {
  saveLastPage("showAddSale");

  document.getElementById("content").innerHTML = `
    <h2>Add New Sale</h2>
    <!-- Header Section -->
    <div class="form-container">
      <div class="form-group">
        <label for="saleLocation">Business Location</label>
        <select id="saleLocation" required>
          <option value="">Loading...</option>
        </select>

        <label for="saleCustomer">Customer</label>
        <select id="saleCustomer">
          <option value="">Loading...</option>
        </select>

        <label for="saleSalesperson">Field Salesperson *</label>
        <select id="saleSalesperson" required>
          <option value="">Loading...</option>
        </select>
      </div>
    </div>

    <!-- Add Product Section -->
    <div class="form-container">
      <div class="form-group">
        <label for="saleProduct">Product</label>
        <input type="text" id="saleProduct" placeholder="Search product..." list="productsList" />
        <datalist id="productsList"></datalist>

        <label for="saleQty">Quantity</label>
        <input type="number" id="saleQty" min="1" />

        <label for="salePrice">Price</label>
        <input type="number" id="salePrice" min="0" step="0.01" />

        <button type="button" class="submit-btn" onclick="addProductToSale()">Add Product</button>
      </div>
    </div>

    <!-- Sale Items Table -->
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Subtotal</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody id="saleItemsTbody">
          <tr><td colspan="6" style="text-align:center;">No items yet</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Expenses Section -->
    <div class="form-container">
      <h3>Field Expenses (optional)</h3>
      <div class="form-group">
        <label for="expenseCategory">Category</label>
        <select id="expenseCategory">
          <option value="">Loading categories...</option>
        </select>

<label for="expenseDescription">Description</label>
<input type="text" id="expenseDescription" placeholder="Short description" />

<label for="expenseSalesperson">Incurred by (optional)</label>
<select id="expenseSalesperson">
  <option value="">(Use sale salesperson)</option>
</select>

<label for="expenseAmount">Amount (KES)</label>
<input type="number" id="expenseAmount" min="0" step="0.01" />

<button type="button" class="submit-btn" onclick="addFieldExpense()">Add Expense</button>

      </div>
    </div>

    <!-- Expense Items Table -->
    <div class="table-container">
      <table class="users-table">
     <thead>
  <tr>
    <th>#</th>
    <th>Category</th>
    <th>Description</th>
    <th>Salesperson</th>
    <th>Amount (KES)</th>
    <th>Remove</th>
  </tr>
</thead>

        <tbody id="expenseItemsTbody">
          <tr><td colspan="5" style="text-align:center;">No expenses yet</td></tr>
        </tbody>
      </table>
    </div>

<!-- Payment Section -->
<div class="form-container">
  <h3>Payment Summary</h3>
  <div class="form-group">
    <table class="summary-table" id="paymentSummaryTable">
      <tr>
        <td><strong>Total Sales (KES):</strong></td>
        <td><input type="text" id="saleTotal" readonly class="summary-input" /></td>
      </tr>
      <tr>
        <td><strong>Total Expenses (KES):</strong></td>
        <td><input type="text" id="saleExpensesDisplay" readonly class="summary-input" /></td>
      </tr>
      <tr class="highlight-net">
        <td><strong>Net Sales (after expenses, KES):</strong></td>
        <td><input type="text" id="saleNet" readonly class="summary-input net-sales" /></td>
      </tr>
      <tr>
        <td><strong>Balance Due (KES):</strong></td>
        <td><input type="text" id="saleBalance" readonly class="summary-input" /></td>
      </tr>
      <!-- First Payment Method Row -->
      <tr class="payment-method-row">
        <td><strong>Payment Method:</strong></td>
        <td style="display: flex; gap: 5px; align-items: center;">
          <select class="summary-input paymentMethodSelect" style="flex: 1;">
            <option value="">-- Select Method --</option>
            <option value="cash">Cash</option>
            <option value="mpesa">M-Pesa</option>
            <option value="bank">Bank Agent</option>
			<option value="bank">Bank Transfer</option>
			<option value="bank">Cheque</option>
			<option value="bank">Customer Mobile Deposite</option>
          </select>
          <input type="number" 
       class="summary-input paymentAmountInput" 
       placeholder="Amount (KES)" 
       min="0" step="0.01" 
       style="flex: 1;" 
       oninput="calculateTotals()" />
          <button type="button" id="addPaymentMethod" class="btn btn-sm">+</button>
        </td>
      </tr>
    </table>
  </div>
</div>
<style>
  .payment-method-row button {
    width: 35px;
    height: 35px;
    padding: 0;
    font-size: 18px;
    line-height: 1;
    text-align: center;
  }
</style>



    <button type="button" class="submit-btn" onclick="saveSale()">Save & Print</button>
    <div id="addSaleMessage" style="margin-top:10px;color:red;"></div>
  `;

  // 🔹 Load expense categories
  const catSnap = await firebase.firestore().collection("expenseCategories").orderBy("name").get();
  const catSelect = document.getElementById("expenseCategory");
  catSelect.innerHTML = `<option value="">Select Category</option>`;
  catSnap.forEach(doc => {
    const c = doc.data();
    catSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
  });

  // 🔹 Load business locations
  const locSnap = await firebase.firestore().collection("businessLocations").get();
  const locSelect = document.getElementById("saleLocation");
  locSelect.innerHTML = `<option value="">Select Location</option>`;
  locSnap.forEach(doc => {
    const l = doc.data();
    locSelect.innerHTML += `<option value="${l.name}">${l.name}</option>`;
  });

  // 🔹 Load customers
  const custSnap = await firebase.firestore().collection("customers").orderBy("name").get();
  const custSelect = document.getElementById("saleCustomer");
  custSelect.innerHTML = `<option value="">Walk-in (Optional)</option>`;
  custSnap.forEach(doc => {
    const c = doc.data();
    custSelect.innerHTML += `<option value="${doc.id}">${c.name || doc.id}</option>`;
  });

// 🔹 Load salespersons and populate both sale and expense selects
const salesSnap = await firebase.firestore().collection("fieldSalespersons").orderBy("name").get();
const salesSelect = document.getElementById("saleSalesperson");
const expenseSalesSelect = document.getElementById("expenseSalesperson");

// safety: if element missing, skip gracefully
if (!salesSelect) throw new Error("saleSalesperson element not found");
if (!expenseSalesSelect) {
  console.warn("expenseSalesperson element not found - skipping");
}

salesSelect.innerHTML = `<option value="">-- Select Salesperson --</option>`;
if (expenseSalesSelect) expenseSalesSelect.innerHTML = `<option value="">(Use sale salesperson)</option>`;

// build in-memory map for id -> name
window.salespersonsMap = {};

salesSnap.forEach(doc => {
  const s = doc.data();
  const id = doc.id;
  const name = s.name || id;
  window.salespersonsMap[id] = name;
  salesSelect.innerHTML += `<option value="${id}">${name}</option>`;
  if (expenseSalesSelect) expenseSalesSelect.innerHTML += `<option value="${id}">${name}</option>`;
});


  // 🔹 Load products with stock balances
  const prodSnap = await firebase.firestore().collection("products").orderBy("name").get();
  const prodList = document.getElementById("productsList");
  window.productsMap = {};

  for (const doc of prodSnap.docs) {
    const p = doc.data();
    const prodName = p.name;

    // Opening stock
    const openingStock = parseFloat(p.openingStock || 0);

    // Purchases total
    let totalPurchased = 0;
    const purchasesSnap = await firebase.firestore().collection("purchases").get();
    purchasesSnap.forEach(purDoc => {
      const pur = purDoc.data();
      if (pur.items && Array.isArray(pur.items)) {
        pur.items.forEach(item => {
          if (item.productName === prodName) {
            totalPurchased += parseFloat(item.quantity || 0);
          }
        });
      }
    });

    // Sales total
    let totalSold = 0;
    const salesSnap2 = await firebase.firestore().collection("sales").get();
    salesSnap2.forEach(saleDoc => {
      const sale = saleDoc.data();
      if (sale.items && Array.isArray(sale.items)) {
        sale.items.forEach(item => {
          if (item.prodName === prodName) {
            totalSold += parseFloat(item.qty || 0);
          }
        });
      }
    });

    // Stock balance
    const stock = openingStock + totalPurchased - totalSold;

    // Add to datalist with stock shown
    const opt = document.createElement("option");
    opt.value = prodName;
    opt.label = `${prodName} (Stock: ${stock})`;
    prodList.appendChild(opt);

    // Save product info
    window.productsMap[prodName] = {
      id: doc.id,
      price: p.sellingPrice || 0,
      stock: stock
    };
  }

  // Auto-fill price when product selected
  document.getElementById("saleProduct").addEventListener("change", e => {
    const prodName = e.target.value.trim();
    if (window.productsMap[prodName]) {
      document.getElementById("salePrice").value = window.productsMap[prodName].price;
    }
  });

  calculateTotals();
}

/* -------------------
   Sale Items Functions
-------------------- */
function addProductToSale() {
  const prodName = document.getElementById("saleProduct").value.trim();
  const qty = parseFloat(document.getElementById("saleQty").value);
  const price = parseFloat(document.getElementById("salePrice").value);

  if (!prodName || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) {
    alert("Please enter valid product, quantity, and price.");
    return;
  }

  const subtotal = qty * price;
  saleItems.push({ prodName, qty, price, subtotal });

  renderSaleItems();
  calculateTotals();

  document.getElementById("saleProduct").value = "";
  document.getElementById("saleQty").value = "";
  document.getElementById("salePrice").value = "";
}

function renderSaleItems() {
  const tbody = document.getElementById("saleItemsTbody");
  tbody.innerHTML = "";

  if (saleItems.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No items yet</td></tr>`;
    return;
  }

  let totalQty = 0;
  let totalAmount = 0;

  saleItems.forEach((item, index) => {
    totalQty += item.qty;
    totalAmount += item.subtotal;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.prodName}</td>
      <td>${item.qty}</td>
      <td>${item.price.toFixed(2)}</td>
      <td>${item.subtotal.toFixed(2)}</td>
      <td class="remove-cell" onclick="removeSaleItem(${index})">&times;</td>
    `;
    tbody.appendChild(tr);
  });

  // Add totals row
  const totalsRow = document.createElement("tr");
  totalsRow.style.backgroundColor = "#f8f9fa";
  totalsRow.style.fontWeight = "bold";
  totalsRow.innerHTML = `
    <td colspan="2" style="text-align:right;">Totals:</td>
    <td>${totalQty}</td>
    <td></td>
    <td>${totalAmount.toFixed(2)}</td>
    <td></td>
  `;
  tbody.appendChild(totalsRow);
}

function removeSaleItem(index) {
  saleItems.splice(index, 1);
  renderSaleItems();
  calculateTotals();
}

/* -------------------
   Expense Functions
-------------------- */
function addFieldExpense() {
  const category = document.getElementById("expenseCategory").value;
  const description = document.getElementById("expenseDescription").value.trim();
  const salespersonId = document.getElementById("expenseSalesperson")?.value || ""; // optional
  const amount = parseFloat(document.getElementById("expenseAmount").value);

  if (!category || isNaN(amount) || amount <= 0) {
    alert("Please select a category and enter a valid amount.");
    return;
  }

  expenseItems.push({ category, description, amount, salespersonId });
  renderFieldExpenses();
  calculateTotals();

  // reset fields
  document.getElementById("expenseCategory").value = "";
  document.getElementById("expenseDescription").value = "";
  if (document.getElementById("expenseSalesperson")) document.getElementById("expenseSalesperson").value = "";
  document.getElementById("expenseAmount").value = "";
}


function renderFieldExpenses() {
  const tbody = document.getElementById("expenseItemsTbody");
  tbody.innerHTML = "";

  if (expenseItems.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No expenses yet</td></tr>`;
    return;
  }

  let total = 0;
  expenseItems.forEach((item, index) => {
    total += item.amount;
    const salespersonName = item.salespersonId
      ? (window.salespersonsMap?.[item.salespersonId] || item.salespersonId)
      : "(Use sale salesperson)";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.category}</td>
      <td>${item.description}</td>
      <td>${salespersonName}</td>
      <td>${item.amount.toFixed(2)}</td>
      <td class="remove-cell" onclick="removeFieldExpense(${index})">&times;</td>
    `;
    tbody.appendChild(tr);
  });

  const totalsRow = document.createElement("tr");
  totalsRow.style.backgroundColor = "#f8f9fa";
  totalsRow.style.fontWeight = "bold";
  totalsRow.innerHTML = `
    <td colspan="4" style="text-align:right;">Total Expenses:</td>
    <td>${total.toFixed(2)}</td>
    <td></td>
  `;
  tbody.appendChild(totalsRow);
}


function removeFieldExpense(index) {
  expenseItems.splice(index, 1);
  renderFieldExpenses();
  calculateTotals();
}

/* -------------------
   Totals & Save
-------------------- */
function calculateTotals() {
  // Totals before payments
  const total = saleItems.reduce((sum, i) => sum + i.subtotal, 0);
  const expenses = expenseItems.reduce((sum, e) => sum + e.amount, 0);
  const net = total - expenses;

  // --- NEW: sum all payment method amounts ---
  let totalPayments = 0;
  document.querySelectorAll(".paymentAmountInput").forEach(input => {
    totalPayments += parseFloat(input.value) || 0;
  });

  const balance = net - totalPayments;

  // Update fields
  document.getElementById("saleTotal").value = total.toFixed(2);
  document.getElementById("saleExpensesDisplay").value = expenses.toFixed(2);
  document.getElementById("saleNet").value = net.toFixed(2);

  const balanceEl = document.getElementById("saleBalance");
  balanceEl.value = balance.toFixed(2);

  // --- NEW: apply colors + weight ---
  balanceEl.style.fontWeight = "bold";
  if (balance > 0) {
    balanceEl.style.color = "red";     // still owed
  } else if (balance === 0) {
    balanceEl.style.color = "black";   // cleared
    balanceEl.style.fontWeight = "normal";
  } else {
    balanceEl.style.color = "green";   // overpaid
  }
}


// Replace your existing saveSale() with this function
async function saveSale() {
  if (!saleItems || saleItems.length === 0) {
    Swal.fire("Warning", "Please add at least one product.", "warning");
    return;
  }

  // Ask the user for the sale date via SweetAlert
  const { value: saleDate } = await Swal.fire({
    title: "Select Sale Date",
    html: `<input type="date" id="saleDateInput" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">`,
    focusConfirm: false,
    preConfirm: () => {
      const val = document.getElementById("saleDateInput").value;
      if (!val) {
        Swal.showValidationMessage("Please select a date");
        return null;
      }
      return val;
    }
  });

  if (!saleDate) return; // user cancelled

  // Basic fields
  const location = document.getElementById("saleLocation")?.value || "";
  const customer = document.getElementById("saleCustomer")?.value || "Walk-in";
  const salesperson = document.getElementById("saleSalesperson")?.value || "";
  const total = parseFloat(document.getElementById("saleTotal")?.value) || 0;
  const expensesTotal = parseFloat(document.getElementById("saleExpensesDisplay")?.value) || 0;
  const net = parseFloat(document.getElementById("saleNet")?.value) || 0;

  if (!salesperson) {
    Swal.fire("Missing data", "Please select a salesperson before saving the sale.", "warning");
    return;
  }

  // Collect payment-method rows (robust to either class names you might have)
  const payments = [];
  const rows = document.querySelectorAll(".payment-method-row");
  rows.forEach(row => {
    const methodEl = row.querySelector(".paymentMethodSelect") || row.querySelector("select");
    const amountEl = row.querySelector(".paymentAmountInput") || row.querySelector(".paymentAmount") || row.querySelector("input[type='number']");
    const method = (methodEl && methodEl.value) ? methodEl.value : "";
    const amount = parseFloat(amountEl?.value) || 0;
    // only record rows that matter
    if (method || amount > 0) payments.push({ method: method || "unknown", amount: Number(amount) });
  });

  const paid = payments.reduce((s, p) => s + (Number(p.amount) || 0), 0);
  const balance = Number((net - paid).toFixed(2));
  const chosenDate = new Date(saleDate);

  // Resolve salesperson display name (keeps your previous logic)
  let saleSalespersonName = salesperson;
  try {
    const spDoc = await firebase.firestore().collection("fieldSalespersons").doc(salesperson).get();
    if (spDoc.exists) saleSalespersonName = spDoc.data().name || salesperson;
  } catch (err) {
    console.warn("Could not fetch salesperson name:", err);
  }

  // Assemble sale object (saves payments array on the sale doc)
  const saleData = {
    location,
    customer,
    salespersonId: salesperson,
    salesperson: saleSalespersonName,
    expenses: expenseItems || [],
    total,
    expensesTotal,
    net,
    paid,
    balance,
    payments,       // important: saved with the sale
    items: saleItems || [],
    saleDate: chosenDate,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    // Save sale
    const saleRef = await firebase.firestore().collection("sales").add(saleData);

    // Save each payment as subcollection entry for history / reporting
    if (payments && payments.length) {
      for (const p of payments) {
        if (!p.amount || p.amount <= 0) continue;
        await firebase.firestore()
          .collection("sales")
          .doc(saleRef.id)
          .collection("payments")
          .add({
            method: p.method || "unknown",
            amount: Number(p.amount),
            date: chosenDate,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
      }
    }

    // Save each field expense into your expenses collection and link it to the sale (preserves your existing behavior)
    for (const exp of (expenseItems || [])) {
      const expenseSalespersonId = exp.salespersonId || salesperson || "";
      const expenseSalespersonName = expenseSalespersonId
        ? (window.salespersonsMap?.[expenseSalespersonId] || (expenseSalespersonId === salesperson ? saleSalespersonName : expenseSalespersonId))
        : saleSalespersonName;

      const expenseData = {
        category: exp.category,
        description: exp.description,
        totalAmount: Number(exp.amount) || 0,
        paidAmount: Number(exp.amount) || 0,
        dueAmount: 0,
        paymentMethod: "Field",
        salesperson: expenseSalespersonName,
        salespersonId: expenseSalespersonId || null,
        linkedSaleId: saleRef.id,
        location,
        expenseDate: chosenDate,
        status: "Paid",
        note: exp.description || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      const expRef = await firebase.firestore().collection("expenses").add(expenseData);

      // add payments subcollection for this expense (keeps your previous pattern)
      try {
        await expRef.collection("payments").add({
          amount: Number(exp.amount) || 0,
          date: chosenDate,
          method: "Field",
          note: exp.description || ""
        });
      } catch (err) {
        console.warn("Could not add payments subcollection for expense:", err);
      }
    }

    // UI / Feedback: SweetAlert success + sound + toast
    try { playSuccessSound(); } catch (e) { /* ignore */ }
    if (typeof showSuccessNotification === "function") showSuccessNotification("Sale saved successfully.");

    Swal.fire({
      icon: "success",
      title: "Sale Saved",
      text: "Sale, payments and expenses have been recorded.",
      timer: 1500,
      showConfirmButton: false
    });

    // Reset local arrays/UI
    saleItems = [];
    expenseItems = [];
    renderSaleItems();
    renderFieldExpenses();
    calculateTotals();

    // Build printable receipt and auto-open print dialog (small delay so popup settles)
    (function openPrintWindow() {
      const p = saleData;
      const paymentsHtml = (payments.length
        ? payments.map((pt, i) => `<tr><td>${i+1}</td><td>${(pt.method || "").toUpperCase()}</td><td style="text-align:right;">KES ${Number(pt.amount).toFixed(2)}</td></tr>`).join("")
        : `<tr><td colspan="3">No payments recorded</td></tr>`);

      const itemsHtml = (p.items && p.items.length)
        ? p.items.map((it, idx) => `
            <tr>
              <td>${idx+1}</td>
              <td>${it.prodName || it.productName || ""}</td>
              <td style="text-align:right;">${Number(it.qty || it.quantity || 0)}</td>
              <td style="text-align:right;">${Number(it.price || it.unitPrice || 0).toFixed(2)}</td>
              <td style="text-align:right;">${Number(it.subtotal || ((it.qty||0)*(it.price||0)) || 0).toFixed(2)}</td>
            </tr>`).join("")
        : `<tr><td colspan="5">No items</td></tr>`;

      const html = `
        <html>
          <head>
            <title>Sale Receipt</title>
            <style>
              body{font-family:Arial, sans-serif; color:#222; margin:20px}
              .header{text-align:center}
              table{width:100%; border-collapse:collapse; margin-top:10px}
              th,td{border:1px solid #ddd; padding:6px; font-size:13px}
              th{background:#f4f4f4}
              .right{text-align:right}
              .totals{margin-top:10px; float:right; width:320px}
            </style>
          </head>
          <body>
            <div class="header">
              <h2>Sale Receipt</h2>
              <p><b>Date:</b> ${chosenDate.toLocaleString()}</p>
              <p><b>Customer:</b> ${p.customer}</p>
              <p><b>Salesperson:</b> ${p.salesperson}</p>
              <p><b>Location:</b> ${p.location || "-"}</p>
            </div>

            <table>
              <thead><tr><th>#</th><th>Product</th><th>Qty</th><th>Unit (KES)</th><th>Subtotal (KES)</th></tr></thead>
              <tbody>${itemsHtml}</tbody>
            </table>

            <div class="totals">
              <table>
                <tr><td><b>Total</b></td><td style="text-align:right;">KES ${Number(p.total).toFixed(2)}</td></tr>
                <tr><td><b>Expenses</b></td><td style="text-align:right;">KES ${Number(p.expensesTotal || 0).toFixed(2)}</td></tr>
                <tr><td><b>Net</b></td><td style="text-align:right;">KES ${Number(p.net).toFixed(2)}</td></tr>
                <tr><td><b>Paid</b></td><td style="text-align:right;">KES ${Number(p.paid).toFixed(2)}</td></tr>
                <tr><td><b>Balance</b></td><td style="text-align:right;">KES ${Number(p.balance).toFixed(2)}</td></tr>
              </table>
            </div>

            <h4>Payments</h4>
            <table>
              <thead><tr><th>#</th><th>Method</th><th class="right">Amount</th></tr></thead>
              <tbody>${paymentsHtml}</tbody>
            </table>

            <p style="margin-top:40px;font-size:12px;color:#666;">Receipt ID: ${saleRef.id}</p>
          </body>
        </html>
      `;

      const w = window.open("", "_blank", "width=900,height=700");
      w.document.write(html);
      w.document.close();
      setTimeout(() => { try { w.print(); } catch (e) { console.warn("Print error", e); } }, 700);
    })();

  } catch (err) {
    console.error("saveSale error:", err);
    Swal.fire("Error", "Failed to save sale: " + (err && err.message ? err.message : err), "error");
  }
}

async function showListSales() {
  saveLastPage("showListSales");
  document.getElementById("content").innerHTML = `
    <h2 style="margin-bottom:20px;">List of Sales</h2>

    <!-- Filter Section -->
    <div class="filter-section"
         style="display:flex; flex-wrap:wrap; gap:10px; background:#f8f9fa; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <div class="filter-group">
        <label>Location:</label>
        <select id="locationFilter" class="form-select">
          <option value="">All Locations</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Salesperson:</label>
        <input list="salespersonList" id="salespersonFilter" class="form-control" placeholder="All Salespersons">
        <datalist id="salespersonList"></datalist>
      </div>

      <div class="filter-group">
        <label>Customer:</label>
        <input list="customerList" id="customerFilter" class="form-control" placeholder="All Customers">
        <datalist id="customerList"></datalist>
      </div>

      <div class="filter-group">
        <label>Date From:</label>
        <input type="date" id="startDateFilter" class="form-control">
      </div>

      <div class="filter-group">
        <label>Date To:</label>
        <input type="date" id="endDateFilter" class="form-control">
      </div>

      <div class="filter-group" style="flex:1;">
        <label>Search:</label>
        <input type="text" id="searchNotes" placeholder="Notes / Reference..." class="form-control">
      </div>

      <div class="filter-buttons" style="display:flex; align-items:end; gap:10px;">
        <button class="btn" style="background:#007bff; color:white;" onclick="applySalesFilters()">Apply</button>
        <button class="btn" style="background:#198754; color:white;" onclick="exportSalesToExcel()">Export to Excel</button>
        <button class="btn" style="background:#dc3545; color:white;" onclick="exportSalesToPDF()">Export to PDF</button>
      </div>
    </div>

    <!-- Summary Cards (Reordered + Updated Labels) -->
    <div class="summary-cards"
         style="display:flex; gap:15px; flex-wrap:wrap; justify-content:space-between; margin-top:20px;">
      
      <!-- 1. Total Sales -->
      <div class="summary-card" style="flex:1; min-width:180px; background:white; padding:15px; border-radius:8px;
           box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; border-top:3px solid #007bff;">
        <h4 style="color:#007bff; font-size:16px;">Total Sales</h4>
        <p id="totalSales" style="font-size:16px; font-weight:bold;">KES 0</p>
      </div>

      <!-- 2. Total Field Expense -->
      <div class="summary-card" style="flex:1; min-width:180px; background:white; padding:15px; border-radius:8px;
           box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; border-top:3px solid #dc3545;">
        <h4 style="color:#dc3545; font-size:16px;">Total Field Expense</h4>
        <p id="totalExpense" style="font-size:16px; font-weight:bold;">KES 0</p>
      </div>

      <!-- 3. Total Paid -->
      <div class="summary-card" style="flex:1; min-width:180px; background:white; padding:15px; border-radius:8px;
           box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; border-top:3px solid #198754;">
        <h4 style="color:#198754; font-size:16px;">Total Paid</h4>
        <p id="totalPaid" style="font-size:16px; font-weight:bold;">KES 0</p>
      </div>

      <!-- 4. Total Due -->
      <div class="summary-card" style="flex:1; min-width:180px; background:white; padding:15px; border-radius:8px;
           box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; border-top:3px solid #ffc107;">
        <h4 style="color:#ffc107; font-size:16px;">Total Due</h4>
        <p id="totalDue" style="font-size:16px; font-weight:bold;">KES 0</p>
      </div>
    </div>

    <!-- Sales Table -->
    <div class="table-container" style="margin-top:20px;">
      <table class="table table-bordered table-striped" style="width:100%; border-collapse:collapse; border:1px solid #dee2e6;">
 <thead style="background:#007bff; color:white;">
  <tr>
    <th>Date</th>
    <th>Location</th>
    <th>Salesperson</th>
    <th>Customer</th>
    <th>Total Sales (KES)</th>
    <th>Field Expenses (KES)</th> <!-- ✅ Added here -->
    <th>Paid (KES)</th>
    <th>Due (KES)</th>
    <th>Note</th>
    <th style="text-align:center;">Actions</th>
  </tr>
</thead>


        <tbody id="salesTableBody">
          <tr><td colspan="9" style="text-align:center;">Loading sales...</td></tr>
        </tbody>
      </table>
    </div>
  `;

  await populateSalesFilters();
  loadSalesData();
}

/* -------------------------------
   🔹 Load unique filter values
-------------------------------- */
async function populateSalesFilters() {
  const locationSelect = document.getElementById("locationFilter");
  const salespersonList = document.getElementById("salespersonList");
  const customerList = document.getElementById("customerList");

  try {
    const snapshot = await firebase.firestore().collection("sales").get();
    const locations = new Set();
    const salespersons = new Set();
    const customers = new Set();

    snapshot.forEach(doc => {
      const sale = doc.data();
      if (sale.location) locations.add(sale.location);
      if (sale.salesperson) salespersons.add(sale.salesperson);
      if (sale.customer) customers.add(sale.customer);
    });

    // Populate dropdowns and datalists
    Array.from(locations).sort().forEach(loc => {
      const opt = document.createElement("option");
      opt.value = loc;
      opt.textContent = loc;
      locationSelect.appendChild(opt);
    });

    Array.from(salespersons).sort().forEach(sp => {
      const opt = document.createElement("option");
      opt.value = sp;
      salespersonList.appendChild(opt);
    });

    Array.from(customers).sort().forEach(cust => {
      const opt = document.createElement("option");
      opt.value = cust;
      customerList.appendChild(opt);
    });

  } catch (error) {
    console.error("Error loading filter options:", error);
  }
}

/* -------------------------------
   🔹 Load Sales Data (Optimized + Parallel Payments Fetch)
   🔹 Formula: Due = Total Sales − Field Expenses − Paid
-------------------------------- */
async function loadSalesData(filters = {}) {
  const tbody = document.getElementById("salesTableBody");
  tbody.innerHTML = "";

  let totalSales = 0,
    totalPaid = 0,
    totalDue = 0,
    totalExpense = 0;

  try {
    let query = firebase.firestore().collection("sales");

    // ✅ Apply filters safely
    if (filters.location) query = query.where("location", "==", filters.location);
    if (filters.salesperson) query = query.where("salesperson", "==", filters.salesperson);
    if (filters.customer) query = query.where("customer", "==", filters.customer);

    // ✅ Date range filters
    let hasDateFilter = false;
    if (filters.startDate && filters.endDate) {
      const start = new Date(filters.startDate);
      const end = new Date(filters.endDate);
      end.setHours(23, 59, 59, 999);
      query = query.where("saleDate", ">=", start).where("saleDate", "<=", end);
      hasDateFilter = true;
    } else if (filters.startDate) {
      const start = new Date(filters.startDate);
      query = query.where("saleDate", ">=", start);
      hasDateFilter = true;
    } else if (filters.endDate) {
      const end = new Date(filters.endDate);
      end.setHours(23, 59, 59, 999);
      query = query.where("saleDate", "<=", end);
      hasDateFilter = true;
    }

    // ✅ Only order if no filters (to prevent Firestore index errors)
    const hasOtherFilters = filters.location || filters.salesperson || filters.customer;
    if (!hasOtherFilters && !hasDateFilter) {
      query = query.orderBy("saleDate", "desc");
    }

    const snapshot = await query.get();

    if (snapshot.empty) {
      tbody.innerHTML = `
        <tr><td colspan="10" style="text-align:center;">No sales records found.</td></tr>
      `;
      updateSalesSummary(0, 0, 0, 0);
      return;
    }

    const searchTerm = (filters.search || "").toLowerCase();

    // ✅ Preload customer names
    const customerIds = new Set();
    snapshot.forEach(doc => {
      const sale = doc.data();
      if (sale.customer) customerIds.add(sale.customer);
    });

    const customerCache = {};
    await Promise.all(
      Array.from(customerIds).map(async id => {
        try {
          const docSnap = await firebase.firestore().collection("customers").doc(id).get();
          customerCache[id] = docSnap.exists ? (docSnap.data().name || id) : id;
        } catch {
          customerCache[id] = id;
        }
      })
    );

    // ✅ Convert to array & sort
    let salesDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    salesDocs.sort((a, b) => {
      const aDate = a.saleDate?.toDate ? a.saleDate.toDate() : new Date(a.saleDate || 0);
      const bDate = b.saleDate?.toDate ? b.saleDate.toDate() : new Date(b.saleDate || 0);
      return bDate - aDate;
    });

    // ✅ Fetch all payments in parallel
    const paymentsMap = {};
    await Promise.all(
      salesDocs.map(async sale => {
        try {
          const paymentsSnap = await firebase.firestore()
            .collection("sales")
            .doc(sale.id)
            .collection("payments")
            .get();
          let totalPaidForSale = 0;
          paymentsSnap.forEach(p => totalPaidForSale += Number(p.data().amount) || 0);
          paymentsMap[sale.id] = totalPaidForSale;
        } catch {
          paymentsMap[sale.id] = 0;
        }
      })
    );

    // ✅ Render rows
    for (const sale of salesDocs) {
      const note = sale.note || "-";
      if (searchTerm && !note.toLowerCase().includes(searchTerm)) continue;

      const saleDate = sale.saleDate
        ? (sale.saleDate.toDate ? sale.saleDate.toDate().toLocaleDateString() : sale.saleDate)
        : "N/A";
      const location = sale.location || "N/A";
      const salesperson = sale.salesperson || "-";
      const customer = customerCache[sale.customer] || sale.customer || "-";

      // ✅ Compute totals
      let total = 0;
      if (Array.isArray(sale.saleItems)) {
        total = sale.saleItems.reduce((sum, item) => {
          const qty = Number(item.quantity) || 0;
          const price = Number(item.price) || 0;
          return sum + qty * price;
        }, 0);
      }
      total = total || Number(sale.totalSales) || Number(sale.totalAmount) || Number(sale.total) || 0;

      const expense = Number(sale.expensesTotal) || 0;
      const paid = paymentsMap[sale.id] || 0;

      const due = total - expense - paid;

      totalSales += total;
      totalPaid += paid;
      totalDue += due;
      totalExpense += expense;

      tbody.innerHTML += `
        <tr>
          <td>${saleDate}</td>
          <td>${location}</td>
          <td>${salesperson}</td>
          <td>${customer}</td>
          <td>KES ${total.toLocaleString()}</td>
          <td>
  KES ${expense.toLocaleString()}
  <span 
    title="Manage Field Expenses" 
    style="cursor:pointer; color:#dc3545; margin-left:6px;" 
    onclick="viewExpenses('${sale.id}')"
  >💸</span>
</td>

          <td>
            KES ${paid.toLocaleString()}
            <span title="View Payments" style="cursor:pointer; color:#007bff; margin-left:6px;" onclick="viewPayments('${sale.id}')">💰</span>
          </td>
          <td style="font-weight:bold;">KES ${due.toLocaleString()}</td>
          <td>${note}</td>
          <td style="text-align:center;">
            <span title="View" style="cursor:pointer; color:green;" onclick="viewSale('${sale.id}')">👁</span>
            <span title="Delete" style="cursor:pointer; color:red; margin-left:8px;" onclick="deleteSale('${sale.id}')">🗑</span>
          </td>
        </tr>
      `;
    }

    // ✅ Sticky totals
    const table = tbody.closest("table");
    let tfoot = table.querySelector("tfoot");
    if (!tfoot) {
      tfoot = document.createElement("tfoot");
      table.appendChild(tfoot);
    }

    tfoot.innerHTML = `
      <tr style="
        position: sticky;
        bottom: 0;
        background: #f8f9fa;
        font-weight: bold;
        border-top: 3px solid #000;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.15);
      ">
        <td colspan="4" style="text-align:right;">Totals:</td>
        <td style="color:#007bff;">KES ${totalSales.toLocaleString()}</td>
        <td style="color:#dc3545;">KES ${totalExpense.toLocaleString()}</td>
        <td style="color:#198754;">KES ${totalPaid.toLocaleString()}</td>
        <td style="color:#ffc107;">KES ${totalDue.toLocaleString()}</td>
        <td colspan="2"></td>
      </tr>
    `;

    // ✅ Update summary
    updateSalesSummary(totalSales, totalPaid, totalDue, totalExpense);

  } catch (error) {
    console.error("Error loading sales:", error);
    tbody.innerHTML = `
      <tr><td colspan="10" style="text-align:center; color:red;">
        Error loading sales: ${error.message}
      </td></tr>
    `;
  }
}


/* -------------------------------
   🔹 Apply Filters from UI
-------------------------------- */
function applySalesFilters() {
  const filters = {
    location: document.getElementById("locationFilter").value,
    salesperson: document.getElementById("salespersonFilter").value,
    customer: document.getElementById("customerFilter").value,
    startDate: document.getElementById("startDateFilter").value,
    endDate: document.getElementById("endDateFilter").value,
    search: document.getElementById("searchNotes").value
  };
  loadSalesData(filters);
}

/* -------------------------------
   🔹 Instant Autocomplete Filtering
-------------------------------- */
document.addEventListener("input", e => {
  if (["salespersonFilter", "customerFilter"].includes(e.target.id)) {
    applySalesFilters();
  }
});

/* -------------------------------
   🔹 Update Summary Cards
-------------------------------- */
function updateSalesSummary(totalSales, totalPaid, totalDue, totalExpense) {
  // Update numeric totals
  document.getElementById("totalSales").textContent = "KES " + totalSales.toLocaleString();
  document.getElementById("totalExpense").textContent = "KES " + totalExpense.toLocaleString();
  document.getElementById("totalPaid").textContent = "KES " + totalPaid.toLocaleString();

  const totalDueElement = document.getElementById("totalDue");
  const totalDueCard = totalDueElement.closest(".summary-card"); // grab the card container
  const totalDueTitle = totalDueCard.querySelector("h4"); // grab the card title

  totalDueElement.textContent = "KES " + totalDue.toLocaleString();

  // Apply color, background, and title logic
  if (totalDue > 0) {
    // 🔴 Positive (customer owes)
    totalDueTitle.textContent = "Total Due";
    totalDueElement.style.color = "red";
    totalDueElement.style.fontWeight = "bold";
    totalDueCard.style.backgroundColor = "#ffe5e5"; // light red tint
  } else if (totalDue < 0) {
    // 🟢 Negative (overpayment)
    totalDueTitle.textContent = "Overpayment";
    totalDueElement.style.color = "green";
    totalDueElement.style.fontWeight = "bold";
    totalDueCard.style.backgroundColor = "#e6ffea"; // light green tint
  } else {
    // ⚫ Zero (balanced)
    totalDueTitle.textContent = "Cleared";
    totalDueElement.style.color = "black";
    totalDueElement.style.fontWeight = "normal";
    totalDueCard.style.backgroundColor = "white";
  }
}


/* -------------------------------
   🔹 View & Delete Actions
-------------------------------- */
function viewSale(id) {
  alert("View sale details feature coming soon for Sale ID: " + id);
}

function deleteSale(id) {
  if (!confirm("Are you sure you want to delete this sale?")) return;
  firebase.firestore().collection("sales").doc(id).delete()
    .then(() => {
      showSuccessNotification("Sale deleted successfully.");
      loadSalesData();
    })
    .catch(err => alert("Error deleting sale: " + err.message));
}


/* -------------------------------
   🔹 View & Manage Payments Modal (with Firestore Persistence)
-------------------------------- */
async function viewPayments(saleId) {
  try {
    const paymentsSnap = await firebase.firestore()
      .collection("sales")
      .doc(saleId)
      .collection("payments")
      .orderBy("date", "desc")
      .get();

    const payments = paymentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // Build payments table
    const paymentRows = payments.length
      ? payments.map(p => `
          <tr>
            <td>${p.date ? (p.date.toDate ? p.date.toDate().toLocaleDateString() : p.date) : "N/A"}</td>
            <td>${p.method || "-"}</td>
            <td>KES ${Number(p.amount).toLocaleString()}</td>
            <td style="text-align:center;">
              <span title="Delete Payment" style="cursor:pointer; color:red; font-size:16px;"
                onclick="deletePayment('${saleId}', '${p.id}')">🗑</span>
            </td>
          </tr>
        `).join("")
      : `<tr><td colspan="4" style="text-align:center;">No payments recorded yet.</td></tr>`;

    // SweetAlert modal
    Swal.fire({
      title: "Payments",
      width: 600,
      html: `
        <div style="max-height:300px; overflow:auto; text-align:left;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f1f1f1;">
                <th style="padding:6px;">Date</th>
                <th style="padding:6px;">Method</th>
                <th style="padding:6px;">Amount</th>
                <th style="padding:6px; text-align:center;">Action</th>
              </tr>
            </thead>
            <tbody>${paymentRows}</tbody>
          </table>
        </div>
        <hr>
        <h5>Add New Payment</h5>
        <input type="date" id="newPaymentDate" class="swal2-input" style="width:80%;" placeholder="Date">
        <select id="newPaymentMethod" class="swal2-input" style="width:80%;">
          <option value="mpesa">Mpesa</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank</option>
          <option value="cheque">Cheque</option>
        </select>
        <input type="number" id="newPaymentAmount" class="swal2-input" style="width:80%;" placeholder="Amount (KES)">
      `,
      showCancelButton: true,
      confirmButtonText: "➕ Add Payment",
      cancelButtonText: "Close",
      preConfirm: async () => {
        const date = document.getElementById("newPaymentDate").value;
        const method = document.getElementById("newPaymentMethod").value;
        const amount = Number(document.getElementById("newPaymentAmount").value);

        if (!date || !method || !amount) {
          Swal.showValidationMessage("Please fill in all fields!");
          return false;
        }

        // Save payment to Firestore
        await firebase.firestore()
          .collection("sales")
          .doc(saleId)
          .collection("payments")
          .add({
            date: new Date(date),
            method,
            amount,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

        // ✅ Persist updates to sale and refresh all data
        await updatePaidColumnForSale(saleId, true);

        Swal.fire("Saved!", "Payment added successfully.", "success");
        setTimeout(() => viewPayments(saleId), 800);
      }
    });

  } catch (error) {
    console.error("Error loading payments:", error);
    Swal.fire("Error", "Could not load payments: " + error.message, "error");
  }
}

/* -------------------------------
   🔹 Delete Payment Function
-------------------------------- */
async function deletePayment(saleId, paymentId) {
  const confirmDelete = await Swal.fire({
    title: "Delete Payment?",
    text: "Are you sure you want to delete this payment?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, delete it!",
  });

  if (!confirmDelete.isConfirmed) return;

  try {
    await firebase.firestore()
      .collection("sales")
      .doc(saleId)
      .collection("payments")
      .doc(paymentId)
      .delete();

    // ✅ Persist updates to Firestore + refresh UI + summary
    await updatePaidColumnForSale(saleId, true);

    Swal.fire("Deleted!", "Payment removed successfully.", "success");
    setTimeout(() => viewPayments(saleId), 800);
  } catch (error) {
    Swal.fire("Error", "Could not delete payment: " + error.message, "error");
    console.error("Error deleting payment:", error);
  }
}

/* -------------------------------
   🔹 Update Firestore + Table + Summary Cards
-------------------------------- */
async function updatePaidColumnForSale(saleId, refreshSummary = false) {
  const saleRef = firebase.firestore().collection("sales").doc(saleId);
  const saleDoc = await saleRef.get();
  const saleData = saleDoc.data();

  const paymentsSnap = await saleRef.collection("payments").get();
  const totalPaid = paymentsSnap.docs.reduce((sum, p) => sum + (Number(p.data().amount) || 0), 0);
  const totalSales = Number(saleData.totalSales) || Number(saleData.totalAmount) || 0;
  const due = totalSales - totalPaid;

  // ✅ Permanently update Firestore with new totals
  await saleRef.update({
    paid: totalPaid,
    due: due,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  });

  // ✅ Update UI instantly
  const rows = document.querySelectorAll("#salesTableBody tr");
  rows.forEach(row => {
    if (row.innerHTML.includes(`viewSale('${saleId}')`)) {
      const tds = row.querySelectorAll("td");
      if (tds[5]) tds[5].textContent = `KES ${totalPaid.toLocaleString()}`;
      if (tds[6]) tds[6].textContent = `KES ${due.toLocaleString()}`;
    }
  });

  // ✅ Optional: refresh full summary cards (if requested)
  if (refreshSummary) {
    loadSalesData(); // ensures total cards recompute from fresh Firestore data
  }
}

/* -------------------------------
   🔹 View & Manage Field Expenses Modal (Auto Refresh + Synced with 'expenses')
-------------------------------- */
async function viewExpenses(saleId) {
  try {
    const saleRef = firebase.firestore().collection("sales").doc(saleId);
    const saleSnap = await saleRef.get();
    if (!saleSnap.exists) return Swal.fire("Error", "Sale not found", "error");

    // fresh snapshot each open
    const sale = saleSnap.data();
    let expenses = Array.isArray(sale.expenses) ? [...sale.expenses] : [];

    // Fetch categories
    const categoriesSnap = await firebase.firestore().collection("expenseCategories").get();
    const categoryOptions = categoriesSnap.docs
      .map(doc => {
        const name = (doc.data().name || "").toString().replace(/"/g, "&quot;");
        return `<option value="${name}">${name}</option>`;
      })
      .join("");

    const saleDate = sale.saleDate?.toDate ? sale.saleDate.toDate() : new Date(sale.saleDate || Date.now());

    const buildExpenseRows = (arr) => {
      if (!arr.length) return `<tr><td colspan="4" style="text-align:center;">No expenses yet</td></tr>`;
      return arr.map((e, i) => `
        <tr id="expRow${i}">
          <td>${e.category || "-"}</td>
          <td>${e.description || "-"}</td>
          <td>${Number(e.amount).toLocaleString()}</td>
          <td style="text-align:center;">
            <span style="color:red; cursor:pointer;" onclick="handleExpenseDelete('${saleId}', ${i})">🗑</span>
          </td>
        </tr>`).join("");
    };

    const html = `
      <table border="1" width="100%" style="border-collapse:collapse; text-align:left;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th>Category</th>
            <th>Description</th>
            <th>Amount (KES)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="expenseRows">${buildExpenseRows(expenses)}</tbody>
      </table>
      <hr>
      <h4>Add New Expense</h4>
      <select id="expCategory" class="swal2-select" style="width:90%;">
        <option value="">-- Select Category --</option>
        ${categoryOptions}
      </select>
      <input id="expDesc" placeholder="Description" class="swal2-input" style="width:90%;">
      <input id="expAmount" type="number" placeholder="Amount" class="swal2-input" style="width:90%;">
    `;

    const { value: formValues } = await Swal.fire({
      title: "Field Expenses",
      html,
      width: 700,
      showCancelButton: true,
      confirmButtonText: "Add Expense",
      cancelButtonText: "Close",
      didOpen: () => {
        // keep a small local reference so deletes can access saleRef if needed
        window.currentExpenses = { saleId, saleRef, saleDate };
      },
      preConfirm: () => ({
        category: (document.getElementById("expCategory")?.value || "").trim(),
        description: (document.getElementById("expDesc")?.value || "").trim(),
        amount: Number(document.getElementById("expAmount")?.value || 0),
      }),
    });

    // Add new expense flow
    if (formValues && formValues.amount > 0 && formValues.category) {
      // update local array and sale doc
      expenses.push(formValues);
      const total = expenses.reduce((s, x) => s + (Number(x.amount) || 0), 0);
      await saleRef.update({ expenses, expensesTotal: total });

      // add to central 'expenses' collection with saleDate (so it shows on Expenses page)
      await firebase.firestore().collection("expenses").add({
        amount: formValues.amount,
        category: formValues.category,
        description: formValues.description,
        saleId,
        saleDate: firebase.firestore.Timestamp.fromDate(saleDate),
        salespersonId: sale.salespersonId || "",
        salesperson: sale.salesperson || "",
        location: sale.location || "",
        customer: sale.customer || "",
        type: "Field Expense",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      showSuccessNotification("Expense added successfully.");
      loadSalesData(); // refresh sales table totals

      // ensure the List of Expenses page (if open) refreshes
      if (typeof loadExpenses === "function") loadExpenses();

      // reopen modal to show fresh data (small delay to allow Firestore to settle)
      setTimeout(() => viewExpenses(saleId), 500);
    }
  } catch (err) {
    console.error("Error viewing expenses:", err);
    Swal.fire("Error", (err && err.message) ? err.message : err, "error");
  }
}
/* -------------------------------
   🔹 Delete Expense (Live + Reflect in 'expenses' collection)
-------------------------------- */
async function handleExpenseDelete(saleId, index) {
  try {
    const confirm = await Swal.fire({
      title: "Delete Expense?",
      text: "This will remove the expense from both Sales and Expenses records.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it!",
    });
    if (!confirm.isConfirmed) return;

    const { saleRef } = window.currentExpenses || {};
    const ref = saleRef || firebase.firestore().collection("sales").doc(saleId);
    const snap = await ref.get();
    if (!snap.exists) return Swal.fire("Error", "Sale not found", "error");

    const sale = snap.data();
    const expenses = Array.isArray(sale.expenses) ? [...sale.expenses] : [];
    const deletedExpense = expenses[index];
    if (!deletedExpense) return Swal.fire("Error", "Expense not found", "error");

    // remove locally and update sale totals
    expenses.splice(index, 1);
    const total = expenses.reduce((s, x) => s + (Number(x.amount) || 0), 0);
    await ref.update({ expenses, expensesTotal: total });

    // delete matching documents from central 'expenses' collection
    const expSnap = await firebase.firestore()
      .collection("expenses")
      .where("saleId", "==", saleId)
      .where("category", "==", deletedExpense.category)
      .where("description", "==", deletedExpense.description)
      .where("amount", "==", deletedExpense.amount)
      .get();

    const batch = firebase.firestore().batch();
    expSnap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    showSuccessNotification("Expense deleted successfully.");
    loadSalesData();

    // Refresh List of Expenses page if present
    if (typeof loadExpenses === "function") loadExpenses();

    // reopen modal to show updated list
    setTimeout(() => viewExpenses(saleId), 400);
  } catch (err) {
    console.error("Error deleting expense:", err);
    Swal.fire("Error", (err && err.message) ? err.message : err, "error");
  }
}


/* -------------------------------
   EXPENSES DROPDOWN + PAGES
--------------------------------*/

// Toggle dropdown
function toggleExpenses() {
  const submenu = document.getElementById("expensesSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

/* -------------------------------
   EXPENSE CATEGORIES PAGE
--------------------------------*/
  function showExpenseCategories() {
      saveLastPage("showExpenseCategories");

      document.getElementById("content").innerHTML = `
        <h2>Expense Categories</h2>

        <!-- Add New Category -->
        <div class="form-container">
          <div class="form-group">
            <input type="text" id="newExpenseCategory" placeholder="New Category" />
            <button onclick="addExpenseCategory()" class="submit-btn">Add Category</button>
          </div>
        </div>

        <!-- List Categories -->
        <div class="table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="expenseCategoriesTable"></tbody>
          </table>
        </div>
      `;

      loadExpenseCategories();
    }

    // Add category
    async function addExpenseCategory() {
      const name = document.getElementById("newExpenseCategory").value.trim();
      if (!name) return alert("Category name required");

      // Prevent duplicates
      const existing = await firebase.firestore()
        .collection("expenseCategories")
        .where("name", "==", name)
        .get();
      if (!existing.empty) {
        alert("Category already exists.");
        return;
      }

      try {
        await firebase.firestore().collection("expenseCategories").add({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("newExpenseCategory").value = "";
        showSuccessNotification("Category added successfully");
        loadExpenseCategories();
      } catch (err) {
        alert("Error adding category: " + err.message);
      }
    }

    // Load categories
    async function loadExpenseCategories() {
      const tbody = document.getElementById("expenseCategoriesTable");
      tbody.innerHTML = "<tr><td colspan='2'>Loading...</td></tr>";

      try {
        const snapshot = await firebase.firestore()
          .collection("expenseCategories")
          .orderBy("name")
          .get();

        if (snapshot.empty) {
          tbody.innerHTML = "<tr><td colspan='2'>No categories found.</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const cat = doc.data();
          tbody.innerHTML += `
            <tr data-id="${doc.id}">
              <td class="editable">${cat.name}</td>
              <td class="desktop-actions">
                <span title="Edit" style="cursor:pointer; color:#2980b9;" onclick="editExpenseCategory('${doc.id}', '${cat.name}')">✏</span>
                <span title="Delete" style="cursor:pointer; color:red; margin-left:6px;" onclick="deleteExpenseCategory('${doc.id}')">🗑</span>
              </td>
            </tr>
          `;
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan='2'>Error: ${err.message}</td></tr>`;
      }
    }

    // Edit category inline
    function editExpenseCategory(id, currentName) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      const cell = row.querySelector(".editable");
      const actionsCell = row.querySelector(".desktop-actions");

      cell.innerHTML = `<input type="text" id="editCategoryInput_${id}" value="${currentName}" class="edit-input" />`;

      actionsCell.innerHTML = `
        <button class="btn-save" onclick="saveExpenseCategory('${id}')">Save</button>
        <button class="btn-cancel" onclick="loadExpenseCategories()">Cancel</button>
      `;
    }

    // Save edited category
    async function saveExpenseCategory(id) {
      const input = document.getElementById(`editCategoryInput_${id}`);
      const newName = input.value.trim();
      if (!newName) return alert("Category name cannot be empty");

      try {
        await firebase.firestore().collection("expenseCategories").doc(id).update({ name: newName });
        showSuccessNotification("Category updated successfully");
        loadExpenseCategories();
      } catch (err) {
        alert("Error updating category: " + err.message);
      }
    }

    // Delete category with SweetAlert2 confirmation
    async function deleteExpenseCategory(id) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to delete this category?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      });

      if (result.isConfirmed) {
        try {
          await firebase.firestore().collection("expenseCategories").doc(id).delete();
          showSuccessNotification("Category deleted successfully");
          loadExpenseCategories();
        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error deleting category: ' + err.message
          });
        }
      }
    }

    // Success notification
    function showSuccessNotification(message) {
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: message,
        timer: 1500,
        showConfirmButton: false
      });
    }

    /* -------------------------------
       EXPENSES LIST + ADD (PLACEHOLDERS)
    --------------------------------*/
async function showListExpenses() {
  saveLastPage("showListExpenses");

  document.getElementById("content").innerHTML = `
    <style>
      .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }
      .filter-section label {
        font-weight: 600;
        font-size: 14px;
      }
      .filter-section button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      .filter-section button:hover {
        background: #0056b3;
      }
      .filter-actions {
        display: flex;
        gap: 10px;
      }
      .summary-cards {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }
      .summary-card {
        flex: 1;
        min-width: 200px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        text-align: center;
      }
      .summary-card h3 {
        margin: 0;
        font-size: 16px;
        color: #666;
      }
      .summary-card p {
        margin: 5px 0 0;
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        position: sticky;
        top: 0;
        background: #f0f0f0;
        z-index: 1;
      }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      th {
        font-weight: 600;
        color: #333;
      }
      tfoot td {
        font-weight: bold;
        background: #f9f9f9;
      }
      .pagination-section {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }
      .pagination-section button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
      }
      .pagination-section button:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }
      .pagination-section select {
        padding: 5px;
        border-radius: 5px;
      }
    </style>

    <h2>List of Expenses</h2>

    <!-- Filters -->
    <div class="filter-section">
      <div>
        <label>Location:</label>
        <select id="filterLocation"></select>
      </div>
      <div>
        <label>Category:</label>
        <select id="filterCategory"></select>
      </div>
      <div>
        <label>Salesperson:</label>
        <select id="filterSalesperson"></select>
      </div>
      <div>
        <label>Date From:</label>
        <input type="date" id="filterStart" />
      </div>
      <div>
        <label>Date To:</label>
        <input type="date" id="filterEnd" />
      </div>
      <div>
        <label>Search:</label>
        <input type="text" id="filterSearch" placeholder="Notes..." />
      </div>
      <div class="filter-actions">
        <button onclick="loadExpenses()">Apply</button>
        <button onclick="exportExpensesExcel()">Export to Excel</button>
        <button onclick="exportExpensesPDF()">Export to PDF</button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <h3>Total Expenses</h3>
        <p id="summaryTotal">KES 0</p>
      </div>
      <div class="summary-card">
        <h3>Total Paid</h3>
        <p id="summaryPaid">KES 0</p>
      </div>
      <div class="summary-card">
        <h3>Total Due</h3>
        <p id="summaryDue">KES 0</p>
      </div>
    </div>

    <!-- Expenses Table -->
    <div class="table-container">
      <table id="expensesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Location</th>
            <th>Category</th>
            <th>Salesperson</th>
            <th>Total (KES)</th>
            <th>Paid (KES)</th>
            <th>Due (KES)</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="expensesTbody">
          <tr><td colspan="9" style="text-align:center;">Loading...</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" style="text-align:right;">TOTAL:</td>
            <td id="tableTotal">KES 0</td>
            <td id="tablePaid">KES 0</td>
            <td id="tableDue">KES 0</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
      <div>
        Show: 
        <select id="itemsPerPage" onchange="loadExpenses()">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
      </div>
      <div>
        <button id="prevPageBtn" onclick="prevExpensesPage()">Prev</button>
        <span id="pageInfo"></span>
        <button id="nextPageBtn" onclick="nextExpensesPage()">Next</button>
      </div>
    </div>
  `;

  await loadExpenseFilters();
  await loadExpenses();
}

// Load filters dynamically
async function loadExpenseFilters() {
  await populateDropdown("businessLocations", "filterLocation", "All Locations");
  await populateDropdown("expenseCategories", "filterCategory", "All Categories");
  await populateDropdown("fieldSalespersons", "filterSalesperson", "All Salespersons");
}

// Helper for dropdowns
async function populateDropdown(collection, elementId, defaultText) {
  const select = document.getElementById(elementId);
  select.innerHTML = `<option value="">${defaultText}</option>`;
  const snap = await firebase.firestore().collection(collection).orderBy("name").get();
  snap.forEach(doc => {
    const d = doc.data();
    if (d.name) {
      select.innerHTML += `<option value="${d.name}">${d.name}</option>`;
    }
  });
}

// Pagination state
let expensePage = { current: 1, perPage: 10, total: 0, items: [] };
let allFilteredExpenses = [];

// 🔹 Load expenses with filters (merged: normal + linked field expenses)
async function loadExpenses() {
  const tbody = document.getElementById("expensesTbody");
  tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Loading...</td></tr>`;

  const loc = document.getElementById("filterLocation").value;
  const cat = document.getElementById("filterCategory").value;
  const sp = document.getElementById("filterSalesperson").value;
  const start = document.getElementById("filterStart").value;
  const end = document.getElementById("filterEnd").value;
  const search = document.getElementById("filterSearch").value.toLowerCase();

  expensePage.perPage =
    document.getElementById("itemsPerPage").value === "all"
      ? Infinity
      : parseInt(document.getElementById("itemsPerPage").value);

  // ✅ Load from 'expenses' collection (all types)
  const snap = await firebase.firestore()
    .collection("expenses")
    .get();

  let rows = [];
  let total = 0, paid = 0, due = 0;
  allFilteredExpenses = [];

  // ✅ Collect all expenses in an array with a unified date field
  const expenses = [];
  snap.forEach((doc) => {
    const e = doc.data();
    const date =
      e.saleDate?.toDate?.() ||
      e.expenseDate?.toDate?.() ||
      e.createdAt?.toDate?.() ||
      new Date(0);

    expenses.push({ id: doc.id, ...e, _date: date });
  });

  // ✅ Sort by latest date (descending)
  expenses.sort((a, b) => b._date - a._date);

  // ✅ Now process filtered + sorted data
  expenses.forEach((e) => {
    if (loc && e.location !== loc) return;
    if (cat && e.category !== cat) return;
    if (sp && e.salesperson !== sp) return;

    if (start && end) {
      const d = e._date;
      const s = new Date(start);
      const ed = new Date(end + "T23:59:59");
      if (!d || d < s || d > ed) return;
    }

    if (search && !(e.note || e.description || "").toLowerCase().includes(search)) return;

    const isFieldExpense =
      e.type === "Field Expense" || e.linkedSaleId || e.saleId;

    // ✅ Mark field expenses as fully paid
    const expenseAmount = e.amount || e.totalAmount || 0;
    const paidAmount = isFieldExpense ? expenseAmount : (e.paidAmount || 0);
    const dueAmount = isFieldExpense ? 0 : (e.dueAmount || 0);

    total += expenseAmount;
    paid += paidAmount;
    due += dueAmount;

    const expenseDate = e._date.toLocaleDateString?.() || "";

    rows.push(`
      <tr>
        <td>${expenseDate}</td>
        <td>${e.location || ""}</td>
        <td>${e.category || ""}</td>
        <td>${e.salesperson || ""}</td>
        <td>KES ${Number(expenseAmount).toLocaleString()}</td>
        <td>KES ${Number(paidAmount).toLocaleString()}</td>
        <td>
          ${
            isFieldExpense
              ? "—"
              : `KES ${Number(dueAmount).toLocaleString()}
                 <span style='color:purple; margin-left:6px; cursor:pointer;'
                   onclick="addPayment('${e.id}', ${expenseAmount}, ${paidAmount})">💰</span>`
          }
        </td>
        <td>${e.note || e.description || ""}</td>
        <td>
          <span style="color:#2980b9;cursor:pointer;" onclick="viewExpense('${e.id}')">👁</span>
          <span style="color:green;margin-left:6px;cursor:pointer;" onclick="editExpense('${e.id}')">✏</span>
          <span style="color:red;margin-left:6px;cursor:pointer;" onclick="deleteExpense('${e.id}')">🗑</span>
          ${
            e.saleId || e.linkedSaleId
              ? `<span style="color:orange;margin-left:6px;cursor:pointer;"
                   onclick="viewLinkedSale('${e.saleId || e.linkedSaleId}')">🔗</span>`
              : ""
          }
        </td>
      </tr>
    `);
  });

  // ✅ Pagination setup
  expensePage.total = rows.length;
  const startIdx = (expensePage.current - 1) * expensePage.perPage;
  const endIdx = startIdx + expensePage.perPage;
  const pageRows =
    expensePage.perPage === Infinity ? rows : rows.slice(startIdx, endIdx);

  tbody.innerHTML = pageRows.length
    ? pageRows.join("")
    : `<tr><td colspan="9" style="text-align:center;">No expenses found.</td></tr>`;

  // ✅ Totals & summary
  document.getElementById("tableTotal").textContent = "KES " + total.toLocaleString();
  document.getElementById("tablePaid").textContent = "KES " + paid.toLocaleString();
  document.getElementById("tableDue").textContent = "KES " + due.toLocaleString();

  document.getElementById("summaryTotal").textContent = "KES " + total.toLocaleString();
  document.getElementById("summaryPaid").textContent = "KES " + paid.toLocaleString();
  document.getElementById("summaryDue").textContent = "KES " + due.toLocaleString();

  document.getElementById("pageInfo").textContent =
    expensePage.perPage === Infinity
      ? `Showing all ${rows.length}`
      : `Page ${expensePage.current} of ${Math.ceil(expensePage.total / expensePage.perPage)}`;

  document.getElementById("prevPageBtn").disabled = expensePage.current <= 1;
  document.getElementById("nextPageBtn").disabled = endIdx >= expensePage.total;
}


// Export Functions
async function exportExpensesExcel() {
  let csv = "Date,Location,Category,Salesperson,Total, Paid, Due, Note\n";

  for (let e of allFilteredExpenses) {
    csv += `${e.date},${e.location},${e.category},${e.salesperson},${e.total},${e.paid},${e.due},${e.note}\n`;

    // Fetch payments for this expense
    const expRef = await firebase.firestore().collection("expenses")
      .where("expenseDate", "==", new Date(e.date)) // safer is by ID, but allFilteredExpenses has no ID now
      .get();

    if (!expRef.empty) {
      const doc = expRef.docs[0]; // get first match
      const paymentsSnap = await doc.ref.collection("payments").orderBy("date", "asc").get();
      paymentsSnap.forEach(p => {
        const d = p.data();
        const dt = d.date?.toDate ? d.date.toDate().toLocaleString() : new Date(d.date).toLocaleString();
        csv += `,,PAYMENT,, ,${d.amount}, Balance After: ${d.balanceAfter}, ${dt}\n`;
      });
    }
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "expenses_with_payments.csv";
  a.click();
  URL.revokeObjectURL(url);
}


async function exportExpensesPDF() {
  const printWin = window.open("", "_blank");
  printWin.document.write("<h2>Expenses Report</h2>");
  printWin.document.write("<table border='1' style='border-collapse:collapse;width:100%;'>");
  printWin.document.write("<tr><th>Date</th><th>Location</th><th>Category</th><th>Salesperson</th><th>Total</th><th>Paid</th><th>Due</th><th>Note</th></tr>");

  for (let e of allFilteredExpenses) {
    printWin.document.write(
      `<tr>
        <td>${e.date}</td>
        <td>${e.location}</td>
        <td>${e.category}</td>
        <td>${e.salesperson}</td>
        <td>KES ${e.total.toLocaleString()}</td>
        <td>KES ${e.paid.toLocaleString()}</td>
        <td>KES ${e.due.toLocaleString()}</td>
        <td>${e.note}</td>
      </tr>`
    );

    // Fetch payments
    const expRef = await firebase.firestore().collection("expenses")
      .where("expenseDate", "==", new Date(e.date)) // safer is by ID
      .get();

    if (!expRef.empty) {
      const doc = expRef.docs[0];
      const paymentsSnap = await doc.ref.collection("payments").orderBy("date", "asc").get();
      if (!paymentsSnap.empty) {
        printWin.document.write(`<tr><td colspan="8"><b>Payment History</b></td></tr>`);
        printWin.document.write(`<tr><th colspan="2">Date</th><th colspan="2">Amount</th><th colspan="2">Balance After</th><th colspan="2">---</th></tr>`);
        paymentsSnap.forEach(p => {
          const d = p.data();
          const dt = d.date?.toDate ? d.date.toDate().toLocaleString() : new Date(d.date).toLocaleString();
          printWin.document.write(
            `<tr>
              <td colspan="2">${dt}</td>
              <td colspan="2">KES ${d.amount.toLocaleString()}</td>
              <td colspan="2">KES ${d.balanceAfter.toLocaleString()}</td>
              <td colspan="2"></td>
            </tr>`
          );
        });
      }
    }
  }

  printWin.document.write("</table>");
  printWin.document.close();
  printWin.print();
}

// ✅ Enhanced Add Payment Modal (with history + date input)
async function addPayment(id, total, currentPaid) {
  const expenseRef = firebase.firestore().collection("expenses").doc(id);
  const expenseSnap = await expenseRef.get();
  if (!expenseSnap.exists) {
    Swal.fire("Error", "Expense not found", "error");
    return;
  }

  const e = expenseSnap.data();

  // 🔹 Load existing payments sorted by date
  const paymentsSnap = await expenseRef
    .collection("payments")
    .orderBy("date", "desc")
    .get();

  let paymentsHTML = "";
  paymentsSnap.forEach((p) => {
    const d = p.data();
    const dt = d.date?.toDate
      ? d.date.toDate().toLocaleString()
      : new Date(d.date).toLocaleString();
    paymentsHTML += `
      <tr>
        <td>${dt}</td>
        <td>KES ${Number(d.amount).toLocaleString()}</td>
        <td>KES ${Number(d.balanceAfter).toLocaleString()}</td>
      </tr>`;
  });

  if (!paymentsHTML)
    paymentsHTML = `<tr><td colspan="3" style="text-align:center;">No payments yet</td></tr>`;

  // 🔹 Show modal with history + new payment form
  const { value: formValues } = await Swal.fire({
    title: "Manage Payments",
    width: 700,
    html: `
      <p><b>Total:</b> KES ${Number(total).toLocaleString()} | 
         <b>Paid:</b> KES ${Number(currentPaid).toLocaleString()} | 
         <b>Due:</b> KES ${(total - currentPaid).toLocaleString()}</p>

      <h3>Add Payment</h3>
      <input id="payAmount" type="number" class="swal2-input" placeholder="Amount" min="1" max="${total - currentPaid}">
      <input id="payDate" type="date" class="swal2-input" value="${new Date().toISOString().split("T")[0]}">

      <h3>Existing Payments</h3>
      <div style="max-height:200px;overflow-y:auto;">
        <table border="1" style="width:100%;border-collapse:collapse;">
          <tr><th>Date</th><th>Amount</th><th>Balance After</th></tr>
          ${paymentsHTML}
        </table>
      </div>
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: "Save Payment",
    preConfirm: () => {
      const amount = Number(document.getElementById("payAmount").value);
      const date = document.getElementById("payDate").value;
      if (!amount || amount <= 0) return Swal.showValidationMessage("Enter valid payment amount");
      if (!date) return Swal.showValidationMessage("Select a payment date");
      return { amount, date };
    },
  });

  if (!formValues) return; // cancelled

  const { amount, date } = formValues;
  const newPaid = currentPaid + amount;
  const newDue = total - newPaid;

  const batch = firebase.firestore().batch();

  // 🔹 Update totals
  batch.update(expenseRef, {
    paidAmount: newPaid,
    dueAmount: newDue,
  });

  // 🔹 Add to payments subcollection
  const payRef = expenseRef.collection("payments").doc();
  batch.set(payRef, {
    amount,
    date: new Date(date),
    balanceAfter: newDue,
  });

  await batch.commit();

  Swal.fire("Success", `Payment of KES ${amount.toLocaleString()} saved!`, "success");
  loadExpenses();
}


// Placeholders for actions
async function viewExpense(id) {
  const expenseRef = firebase.firestore().collection("expenses").doc(id);
  const docSnap = await expenseRef.get();
  if (!docSnap.exists) {
    Swal.fire("Error", "Expense not found", "error");
    return;
  }

  const e = docSnap.data();

  // Load payments sub-collection
  const paymentsSnap = await expenseRef.collection("payments").orderBy("date", "asc").get();
  let paymentRows = "";
  paymentsSnap.forEach(p => {
    const d = p.data();
    const dt = d.date?.toDate ? d.date.toDate().toLocaleString() : new Date(d.date).toLocaleString();
    paymentRows += `<tr>
      <td>${dt}</td>
      <td>KES ${d.amount.toLocaleString()}</td>
      <td>KES ${d.balanceAfter.toLocaleString()}</td>
    </tr>`;
  });

  if (!paymentRows) {
    paymentRows = `<tr><td colspan="3" style="text-align:center;">No payments yet</td></tr>`;
  }

  Swal.fire({
    title: "Expense Details",
    width: 700,
    html: `
      <p><b>Date:</b> ${e.expenseDate?.toDate().toLocaleDateString() || ""}</p>
      <p><b>Location:</b> ${e.location || ""}</p>
      <p><b>Category:</b> ${e.category || ""}</p>
      <p><b>Salesperson:</b> ${e.salesperson || ""}</p>
      <p><b>Total:</b> KES ${Number(e.totalAmount || 0).toLocaleString()}</p>
      <p><b>Paid:</b> KES ${Number(e.paidAmount || 0).toLocaleString()}</p>
      <p><b>Due:</b> KES ${Number(e.dueAmount || 0).toLocaleString()}</p>

      <h3>Payment History</h3>
      <table border="1" style="width:100%; border-collapse:collapse; text-align:left;">
        <tr><th>Date</th><th>Amount</th><th>Balance After</th></tr>
        ${paymentRows}
      </table>
    `,
    confirmButtonText: "Close"
  });
}

async function editExpense(id) {
  const doc = await firebase.firestore().collection("expenses").doc(id).get();
  if (!doc.exists) {
    Swal.fire("Error", "Expense not found", "error");
    return;
  }
  const e = doc.data();

  const { value: formValues } = await Swal.fire({
    title: "Edit Expense",
    html: `
      <div style="max-height:300px; overflow-y:auto; text-align:left; padding-right:10px;">
        <label>Category:</label>
        <input id="swalCategory" class="swal2-input" value="${e.category || ""}">
        
        <label>Total Amount (KES):</label>
        <input id="swalTotal" type="number" class="swal2-input" value="${e.totalAmount || 0}">
        
        <label>Paid Amount (KES):</label>
        <input id="swalPaid" type="number" class="swal2-input" value="${e.paidAmount || 0}">
        
        <label>Note:</label>
        <input id="swalNote" class="swal2-input" value="${e.note || ""}">
      </div>
    `,
    focusConfirm: false,
    width: 500,
    preConfirm: () => {
      return {
        category: document.getElementById("swalCategory").value,
        totalAmount: Number(document.getElementById("swalTotal").value),
        paidAmount: Number(document.getElementById("swalPaid").value),
        note: document.getElementById("swalNote").value
      };
    },
    showCancelButton: true
  });

  if (formValues) {
    const dueAmount = formValues.totalAmount - formValues.paidAmount;
    await firebase.firestore().collection("expenses").doc(id).update({
      category: formValues.category,
      totalAmount: formValues.totalAmount,
      paidAmount: formValues.paidAmount,
      dueAmount: dueAmount,
      note: formValues.note
    });
    Swal.fire("Updated", "Expense updated successfully", "success");
    loadExpenses();
  }
}


async function deleteExpense(id) {
  const confirm = await Swal.fire({
    title: "Are you sure?",
    text: "This will permanently delete the expense.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, delete it!",
    cancelButtonText: "Cancel"
  });

  if (confirm.isConfirmed) {
    await firebase.firestore().collection("expenses").doc(id).delete();
    Swal.fire("Deleted!", "Expense has been deleted.", "success");
    loadExpenses();
  }
}

// Open linked sale details from field expense
async function viewLinkedSale(saleId) {
  if (!saleId) {
    Swal.fire("Error", "No linked sale found.", "error");
    return;
  }

  const saleRef = firebase.firestore().collection("sales").doc(saleId);
  const saleSnap = await saleRef.get();

  if (!saleSnap.exists) {
    Swal.fire("Error", "Linked sale not found.", "error");
    return;
  }

  const s = saleSnap.data();

  // Build sale items table
  let itemsHtml = "";
  if (s.items && Array.isArray(s.items)) {
    itemsHtml = s.items.map(i => `
      <tr>
        <td>${i.prodName}</td>
        <td>${i.qty}</td>
        <td>${i.price.toFixed(2)}</td>
        <td>${i.subtotal.toFixed(2)}</td>
      </tr>
    `).join("");
  } else {
    itemsHtml = `<tr><td colspan="4" style="text-align:center;">No items</td></tr>`;
  }

  Swal.fire({
    title: "Linked Sale",
    width: 800,
    html: `
      <p><b>Date:</b> ${s.createdAt?.toDate?.().toLocaleDateString() || ""}</p>
      <p><b>Location:</b> ${s.location || ""}</p>
      <p><b>Customer:</b> ${s.customer || ""}</p>
      <p><b>Salesperson:</b> ${s.salesperson || ""}</p>
      <p><b>Total:</b> KES ${Number(s.total || 0).toLocaleString()}</p>
      <p><b>Net:</b> KES ${Number(s.net || 0).toLocaleString()}</p>
      <p><b>Paid:</b> KES ${Number(s.paid || 0).toLocaleString()}</p>
      <p><b>Balance:</b> KES ${Number(s.balance || 0).toLocaleString()}</p>

      <h3>Sale Items</h3>
      <table border="1" style="width:100%; border-collapse:collapse;">
        <tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>
        ${itemsHtml}
      </table>
    `,
    confirmButtonText: "Close"
  });
}


async function showAddExpense() {
  saveLastPage("showAddExpense");

  // Show loading while fetching dropdown options
  document.getElementById("content").innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading expense form...</p>
    </div>
  `;

  // Load dropdown data
  const locations = await getCollectionOptions("businessLocations");
  const categories = await getCollectionOptions("expenseCategories");
  const salespersons = await getCollectionOptions("fieldSalespersons");

  // Render form
  document.getElementById("content").innerHTML = `
    <style>
      .form-container {
        max-width: 700px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .form-container h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 22px;
        color: #333;
      }
      .form-group { margin-bottom: 15px; }
      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 14px;
        color: #444;
      }
      .form-group input, 
      .form-group select, 
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }
      .submit-btn {
        width: 100%;
        padding: 12px;
        background: #007bff;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      .submit-btn:hover { background: #0056b3; }
      #addExpenseMessage {
        margin-top: 12px;
        font-size: 14px;
        text-align: center;
      }
    </style>

    <div class="form-container">
      <h2>Add Expense</h2>
      <form id="addExpenseForm">
        
        <div class="form-group">
          <label for="expenseLocation">Business Location *</label>
          <select id="expenseLocation" required>
            <option value="">Select location</option>
            ${locations.map(l => `<option value="${l}">${l}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="expenseCategory">Expense Category *</label>
          <select id="expenseCategory" required>
            <option value="">Select category</option>
            ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="expenseSalesperson">Assign to Field Salesperson</label>
          <select id="expenseSalesperson">
            <option value="">-- Optional --</option>
            ${salespersons.map(s => `<option value="${s}">${s}</option>`).join("")}
          </select>
        </div>

        <div class="form-group">
          <label for="expenseDate">Date of Expense *</label>
          <input type="date" id="expenseDate" required />
        </div>

        <div class="form-group">
          <label for="expenseAmount">Total Amount (KES) *</label>
          <input type="number" id="expenseAmount" min="0" step="0.01" required placeholder="Enter total amount" />
        </div>

        <div class="form-group">
          <label for="expensePaid">Paid Amount (KES)</label>
          <input type="number" id="expensePaid" min="0" step="0.01" value="0" />
        </div>

        <div class="form-group">
          <label for="expenseNote">Expense Note</label>
          <textarea id="expenseNote" placeholder="Enter notes (optional)"></textarea>
        </div>

        <button type="submit" class="submit-btn">Save Expense</button>
      </form>
      <div id="addExpenseMessage"></div>
    </div>
  `;

  document.getElementById("addExpenseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await addExpenseSubmit();
  });
}

// Submit handler
async function addExpenseSubmit() {
  const location = document.getElementById("expenseLocation").value;
  const category = document.getElementById("expenseCategory").value;
  const salesperson = document.getElementById("expenseSalesperson").value;
  const expenseDate = document.getElementById("expenseDate").value;
  const totalAmount = parseFloat(document.getElementById("expenseAmount").value);
  const paidAmount = parseFloat(document.getElementById("expensePaid").value) || 0;
  const note = document.getElementById("expenseNote").value.trim();

  const messageEl = document.getElementById("addExpenseMessage");
  messageEl.style.color = "red";

  // Validation
  if (!location || !category || !expenseDate || isNaN(totalAmount)) {
    messageEl.textContent = "Please fill in all required fields.";
    return;
  }
  if (totalAmount < 0 || paidAmount < 0) {
    messageEl.textContent = "Amounts cannot be negative.";
    return;
  }
  if (paidAmount > totalAmount) {
    messageEl.textContent = "Paid amount cannot exceed total.";
    return;
  }

  const dueAmount = totalAmount - paidAmount;

  // Build expense record
  const expenseData = {
    location,
    category,
    salesperson: salesperson || null,
    expenseDate: new Date(expenseDate),
    totalAmount,
    paidAmount,
    dueAmount,
    note,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  messageEl.innerHTML = `<span class="spinner"></span> Saving...`;

  try {
    await firebase.firestore().collection("expenses").add(expenseData);
    messageEl.style.color = "green";
    messageEl.textContent = "Expense saved successfully.";
    showSuccessNotification("Expense saved successfully.");
    document.getElementById("addExpenseForm").reset();
  } catch (err) {
    console.error("Error adding expense:", err);
    messageEl.style.color = "red";
    messageEl.textContent = "Error: " + err.message;
  }
}

function toggleReports() {
  const submenu = document.getElementById("reportsSubmenu");
  submenu.style.display = submenu.style.display === "none" ? "flex" : "none";
}

// Placeholder report functions
function showSalesReport() {
  saveLastPage("showSalesReport");
  document.getElementById("content").innerHTML = `
    <h2>Sales Report</h2>
    <p>Section Under Development</p>
  `;
}

function showPurchaseReport() {
  saveLastPage("showPurchaseReport");
  document.getElementById("content").innerHTML = `
    <h2>Purchase Report</h2>
    <p>Section Under Development</p>
  `;
}

async function showInventoryReport() {
  saveLastPage("showInventoryReport");

  document.getElementById("content").innerHTML = `
    <style>
      .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        border: 1px solid #e0e0e0;
      }
      .filter-section label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-right: 8px;
      }
      .filter-section select, .filter-section input[type="text"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .filter-section select { width: 140px; }
      .filter-section input[type="text"] { width: 180px; }
      .filter-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
      }
      .filter-section .apply-btn { background: #0056b3; color: white; }
      .filter-section .apply-btn:hover { background: #003d82; }
      .filter-section .export-btn { background: #218838; color: white; }
      .filter-section .export-btn:hover { background: #1a6d2e; }

      .table-container {
        max-height: 500px;
        overflow-y: auto;
        width: 100%;
        position: relative;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .table-container table { width: 100%; border-collapse: collapse; }
      .table-container th, .table-container td {
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      .table-container th { font-weight: 600; color: #333; }

      .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        font-size: 14px;
      }
      .pagination-section button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .pagination-section .prev-btn, .pagination-section .next-btn {
        background: #007bff; color: white;
      }
      .pagination-section button:disabled { background: #ccc; cursor: not-allowed; }
    </style>

    <h2>Inventory Report</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-group">
        <label for="locationFilter">Location:</label>
        <select id="locationFilter"><option value="">Select Location</option></select>
      </div>
      <div class="filter-group">
        <label for="categoryFilter">Category:</label>
        <select id="categoryFilter"><option value="">Select Category</option></select>
      </div>
      <div class="filter-group">
        <label for="brandFilter">Brand:</label>
        <select id="brandFilter"><option value="">Select Brand</option></select>
      </div>
      <div class="search-group">
        <label for="searchInventory">Search:</label>
        <input type="text" id="searchInventory" placeholder="3+ chars..."/>
      </div>
      <button id="applyInventoryFilterBtn" class="apply-btn">Apply</button>
      <button id="exportInventoryBtn" class="export-btn">Export</button>
    </div>

    <!-- Inventory Table -->
    <div class="table-container">
      <table border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th>Product</th>
            <th>Category</th>
            <th>Brand</th>
            <th>Location</th>
            <th>Opening Stock</th>
            <th>Purchased</th>
            <th>Sold</th>
            <th>Closing Stock</th>
          </tr>
        </thead>
        <tbody id="inventoryTbody">
          <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
      <div>
        <label for="inventoryItemsPerPage">Show:</label>
        <select id="inventoryItemsPerPage">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span id="inventoryPaginationInfo"></span>
      </div>
      <div>
        <button id="inventoryPrevPageBtn" class="prev-btn" disabled>Previous</button>
        <button id="inventoryNextPageBtn" class="next-btn">Next</button>
      </div>
    </div>
  `;

  // Load filters (locations, categories, brands)
  await loadInventoryFilters();

  // Fetch first set of reports
  fetchInventoryReports();

  // Event listeners
  document.getElementById("applyInventoryFilterBtn").addEventListener("click", fetchInventoryReports);
  document.getElementById("searchInventory").addEventListener("input", () => {
    if (document.getElementById("searchInventory").value.length >= 3 || document.getElementById("searchInventory").value === "") {
      fetchInventoryReports();
    }
  });
  document.getElementById("inventoryItemsPerPage").addEventListener("change", fetchInventoryReports);
  document.getElementById("inventoryPrevPageBtn").addEventListener("click", () => changeInventoryPage(-1));
  document.getElementById("inventoryNextPageBtn").addEventListener("click", () => changeInventoryPage(1));
  document.getElementById("exportInventoryBtn").addEventListener("click", exportInventoryReport);
}

// Load dropdown filter options
async function loadInventoryFilters() {
  const locSnap = await firebase.firestore().collection("businessLocations").get();
  const catSnap = await firebase.firestore().collection("categories").get();
  const brandSnap = await firebase.firestore().collection("brands").get();

  const locationFilter = document.getElementById("locationFilter");
  const categoryFilter = document.getElementById("categoryFilter");
  const brandFilter = document.getElementById("brandFilter");

  locSnap.forEach(doc => locationFilter.innerHTML += `<option value="${doc.data().name}">${doc.data().name}</option>`);
  catSnap.forEach(doc => categoryFilter.innerHTML += `<option value="${doc.data().name}">${doc.data().name}</option>`);
  brandSnap.forEach(doc => brandFilter.innerHTML += `<option value="${doc.data().name}">${doc.data().name}</option>`);
}

// Fetch reports based on filters
async function fetchInventoryReports() {
  const tbody = document.getElementById("inventoryTbody");
  tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>`;

  const loc = document.getElementById("locationFilter").value;
  const cat = document.getElementById("categoryFilter").value;
  const brand = document.getElementById("brandFilter").value;
  const search = document.getElementById("searchInventory").value.toLowerCase();

  // 🔹 Step 1: get all products
  const snapshot = await firebase.firestore().collection("products").get();
  let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  // 🔹 Step 2: apply filters in JS
  if (loc) data = data.filter(d => d.locations && d.locations.includes(loc));
  if (cat) data = data.filter(d => d.category === cat);
  if (brand) data = data.filter(d => d.brand === brand);
  if (search) data = data.filter(d => d.name && d.name.toLowerCase().includes(search));

  // 🔹 Step 3: build purchases totals map (productName + location → qty)
  const purchasesSnap = await firebase.firestore().collection("purchases").get();
  const purchaseTotals = {}; // key = productName|location
  purchasesSnap.forEach(pDoc => {
    const pdata = pDoc.data();
    const purchaseLoc = pdata.location || "";
    if (pdata.items && Array.isArray(pdata.items)) {
      pdata.items.forEach(item => {
        const pname = (item.productName || "").trim();
        const qty = Number(item.quantity) || 0;
        const key = `${pname}|${purchaseLoc}`;
        if (!purchaseTotals[key]) purchaseTotals[key] = 0;
        purchaseTotals[key] += qty;
      });
    }
  });

  // 🔹 Step 4: render table
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No inventory records found.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(d => {
    const displayLocations = loc ? [loc] : (d.locations || []);

    return displayLocations.map(location => {
      // 🔹 Opening stock: always read original value from Firestore
      let opening = 0;
      if (d.openingStock && typeof d.openingStock === "object") {
        opening = Number(d.openingStock[location]) || 0;
      } else if (typeof d.openingStock === "number") {
        opening = d.openingStock;
      }

      // 🔹 Purchases (added separately, does NOT change opening)
      const purchased = purchaseTotals[`${d.name}|${location}`] || 0;

      // 🔹 Placeholder for sales (will deduct later if needed)
      const sold = 0;

      // 🔹 Closing = Opening + Purchases - Sales
      const closing = opening + purchased - sold;

      return `
        <tr>
          <td>${d.name || ""}</td>
          <td>${d.category || ""}</td>
          <td>${d.brand || ""}</td>
          <td>${location}</td>
          <td>${opening}</td>
          <td>${purchased}</td>
          <td>${sold}</td>
          <td>${closing}</td>
        </tr>
      `;
    }).join("");
  }).join("");
}

// Pagination helpers
function changeInventoryPage(direction) {
  // Optional: implement pagination logic if needed
}

// Export function
function exportInventoryReport() {
  alert("Exporting Inventory Report... (implement PDF/CSV export here)");
}



function showFinancialSummary() {
  saveLastPage("showFinancialSummary");
  document.getElementById("content").innerHTML = `
    <h2>Financial Summary</h2>
    <p>Section Under Development</p>
  `;
}

function showCustomerReport() {
  saveLastPage("showCustomerReport");
  document.getElementById("content").innerHTML = `
    <h2>Customer Report</h2>
    <p>Section Under Development</p>
  `;
}

function showExpenseReport() {
  saveLastPage("showExpenseReport");
  document.getElementById("content").innerHTML = `
    <h2>Expense Report</h2>
    <p>Section Under Development</p>
  `;
}


  // Handle adding and removing payment method rows
document.addEventListener("click", function (e) {
  // ➕ Add new row
  if (e.target && e.target.id === "addPaymentMethod") {
    const table = document.getElementById("paymentSummaryTable");
    const lastRow = e.target.closest("tr");
    const newRow = lastRow.cloneNode(true);

    // reset select + amount
    const select = newRow.querySelector("select.paymentMethodSelect");
    const amount = newRow.querySelector("input");
    if (select) select.value = "";
    if (amount) {
      amount.value = "";
      // ✅ ensure correct class + oninput handler
      amount.classList.remove("paymentAmount");
      amount.classList.add("paymentAmountInput");
      amount.setAttribute("oninput", "calculateTotals()");
    }

    // change ➕ button → 🗑 button
    const btn = newRow.querySelector("button");
    if (btn) {
      btn.textContent = "🗑";
      btn.removeAttribute("id");
      btn.classList.remove("btn-sm");
      btn.classList.add("removePaymentMethod");
    }

    table.appendChild(newRow);
    calculateTotals(); // update after adding
  }

  // 🗑 Remove row
  if (e.target && e.target.classList.contains("removePaymentMethod")) {
    const row = e.target.closest("tr");
    if (row) {
      row.remove();
      calculateTotals(); // update after removing
    }
  }
});

  
</script>

<!-- External libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
